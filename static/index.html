<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Violetas - Sistema de Gestión</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Flatpickr para calendarios con formato español -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }


        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            box-sizing: border-box;
        }

        .logo {
            text-align: left;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .logo img {
            max-height: 80px;
            width: auto;
            display: block;
        }

        .logo p {
            color: #8d2f77;
            font-size: 14px;
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header-logo {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo-text {
            display: flex;
            flex-direction: column;
        }

        .header-logo h1 {
            color: #667eea;
            font-size: 32px;
            margin: 0;
            margin-bottom: 5px;
        }


        .header-logo img {
            max-height: 60px;
            width: auto;
            display: block;
        }

        .user-menu-container {
            position: relative;
        }

        .user-icon-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .user-icon-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .user-icon-btn img {
            filter: brightness(0) invert(1);
        }

        .user-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .user-menu.show {
            display: block;
        }

        .user-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            font-size: 14px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .user-menu-item:hover {
            background: #f5f5f5;
        }

        .user-menu-item:first-child {
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .user-menu-item:last-child {
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        .user-menu-item.logout {
            color: #dc3545;
            border-top: 1px solid #e0e0e0;
        }

        .user-menu-item.logout:hover {
            background: #fee;
        }

        .user-menu-info {
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f9f9f9;
        }

        .user-menu-info-item {
            font-size: 11px;
            color: #666;
            margin: 4px 0;
            line-height: 1.4;
        }

        .user-menu-info-item strong {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background-color: #ffffff;
            color: #333333;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background-color: #ffffff;
            color: #333333;
        }

        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            background-color: #ffffff;
            color: #333333;
            transition: all 0.3s;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert.success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        .token-display {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            display: none;
        }

        .token-display h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .token-value {
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            color: #666;
            border: 1px solid #ddd;
        }

        .copy-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: #667eea;
            font-size: 14px;
        }

        .user-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 10px;
            display: none;
        }

        .user-info h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .logout-btn {
            margin-top: 15px;
            background: #dc3545;
        }

        .logout-btn:hover {
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .module-btn {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .module-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .module-btn img {
            filter: brightness(0) invert(1);
        }

        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            position: relative;
            top: 2px;
        }

        .tab:hover {
            color: #667eea;
            background: #f0f7ff;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .module-content {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            overflow-x: auto;
            max-width: 100%;
            box-sizing: border-box;
        }

        .data-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .data-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            background: white;
            color: #333;
        }

        .data-table tr:hover {
            background: #f0f0f0;
        }

        .data-table tr:hover td {
            background: #f0f0f0;
        }

        .add-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .add-btn:hover {
            background: #218838;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .close-modal:hover {
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header para login -->
        <div class="logo" id="loginHeader">
            <img src="/static/logotipoRLV.svg" alt="Violetas Sistema de Gestión de Residencias" style="max-height: 80px; width: auto;">
            <p>Gestión Residencias</p>
        </div>

        <!-- Header para dashboard con menú de usuario -->
        <div class="header" id="dashboardHeader" style="display: none;">
            <div class="header-logo">
                <img src="/static/logotipoRLV.svg" alt="Violetas Sistema de Gestión de Residencias" style="max-height: 60px; width: auto;">
                <div class="header-logo-text">
                    <h1>Gestión Residencias</h1>
                </div>
            </div>
            <div class="user-menu-container">
                <button class="user-icon-btn" onclick="toggleUserMenu()" title="Menú de usuario">
                    <img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 24px; height: 24px;">
                </button>
                <div class="user-menu" id="userMenu">
                    <div class="user-menu-info" id="userMenuInfo">
                        <div class="user-menu-info-item"><strong>ID Usuario:</strong> -</div>
                        <div class="user-menu-info-item"><strong>Rol ID:</strong> -</div>
                        <div class="user-menu-info-item"><strong>Residencia ID:</strong> -</div>
                        <div class="user-menu-info-item"><strong>Expira:</strong> -</div>
                    </div>
                    <button class="user-menu-item" onclick="showConfiguracion()">
                        <img src="/static/icons/medical/settings.svg" alt="Configuración" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Configuración
                    </button>
                    <button class="user-menu-item logout" onclick="logout()">
                        <img src="/static/icons/medical/log-out.svg" alt="Cerrar Sesión" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>

        <div id="loginForm">
            <div id="alert" class="alert"></div>
            
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required 
                           placeholder="admin@violetas1.com" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" required 
                           placeholder="••••••••" autocomplete="current-password">
                </div>

                <button type="submit" id="loginBtn">Iniciar Sesión</button>
            </form>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="user-info" id="userInfo" style="display: none;"></div>
            
            <div style="margin-top: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Módulos" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"> Módulos del Sistema</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <button class="module-btn" onclick="showModule('residentes')">
                        <img src="/static/icons/medical/users.svg" alt="Residentes" style="width: 20px; height: 20px; margin-right: 8px;"> Residentes
                    </button>
                    <button class="module-btn" onclick="showModule('facturacion')">
                        <span style="font-size: 20px; margin-right: 8px;">€</span> Facturación
                    </button>
                    <button class="module-btn" onclick="showModule('personal')">
                        <img src="/static/icons/medical/user-medical.svg" alt="Personal" style="width: 20px; height: 20px; margin-right: 8px;"> Personal
                    </button>
                </div>
            </div>

            <div id="moduleContent" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Modal para ver/editar residente -->
    <div id="modalViewResidente" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Detalle del Residente</h2>
                <button class="close-modal" onclick="closeModal('modalViewResidente')">&times;</button>
            </div>
            <div id="viewResidenteContent">
                <p>Cargando...</p>
            </div>
        </div>
    </div>

    <!-- Modal para agregar residente -->
    <div id="modalResidente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Residente</h2>
                <button class="close-modal" onclick="closeModal('modalResidente')">&times;</button>
            </div>
            <form id="formResidente" onsubmit="saveResidente(event)">
                
                <!-- SECCIÓN: Información de Residencia -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/home.svg" alt="Residencia" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Residencia</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="res_id_residencia">Residencia *</label>
                            <select id="res_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione una residencia</option>
                                <option value="1">Violetas 1</option>
                                <option value="2">Violetas 2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="res_habitacion">Habitación *</label>
                            <select id="res_habitacion" name="habitacion" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione una habitación</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="res_fecha_ingreso">Fecha de Ingreso</label>
                            <input type="text" id="res_fecha_ingreso" name="fecha_ingreso" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)" readonly style="cursor: pointer; background-color: white;">
                        </div>
                        <div class="form-group">
                            <label for="res_costo_habitacion">Costo de Habitación (€)</label>
                            <input type="number" id="res_costo_habitacion" name="costo_habitacion" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="res_metodo_pago_preferido">Método de Pago Preferido</label>
                            <select id="res_metodo_pago_preferido" name="metodo_pago_preferido" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un método</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="remesa">Remesa</option>
                                <option value="metálico">Metálico</option>
                                <option value="bizum">Bizum</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información Personal -->
                <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                    <h3 style="color: #f56565; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Personal</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="res_nombre">Nombre *</label>
                            <input type="text" id="res_nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="res_apellido">Apellido *</label>
                            <input type="text" id="res_apellido" name="apellido" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="res_documento">Documento de Identidad</label>
                            <input type="text" id="res_documento" name="documento_identidad">
                        </div>
                        <div class="form-group">
                            <label for="res_fecha_nacimiento">Fecha de Nacimiento</label>
                            <input type="text" id="res_fecha_nacimiento" name="fecha_nacimiento" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this); actualizarEdad('res_fecha_nacimiento', 'res_edad')" readonly style="cursor: pointer; background-color: white;">
                        </div>
                        <div class="form-group">
                            <label for="res_edad">Edad</label>
                            <input type="text" id="res_edad" name="edad" readonly style="background-color: #f5f5f5; color: #666; cursor: not-allowed;" placeholder="Se calculará automáticamente">
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información de Contacto -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/phone.svg" alt="Contacto" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Contacto</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="res_telefono">Teléfono</label>
                            <input type="tel" id="res_telefono" name="telefono">
                        </div>
                        <div class="form-group">
                            <label for="res_direccion">Dirección</label>
                            <input type="text" id="res_direccion" name="direccion">
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <h4 style="color: #48bb78; margin-bottom: 10px; font-size: 14px; font-weight: 600;">Contacto de Emergencia</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="res_contacto_emergencia">Nombre del Contacto</label>
                                <input type="text" id="res_contacto_emergencia" name="contacto_emergencia">
                            </div>
                            <div class="form-group">
                                <label for="res_telefono_emergencia">Teléfono de Emergencia</label>
                                <input type="tel" id="res_telefono_emergencia" name="telefono_emergencia">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información Médica y Servicios -->
                <div style="background: #fffaf0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                    <h3 style="color: #ed8936; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Información Médica" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Médica y Servicios</h3>
                    
                    <!-- Datos Médicos Esenciales -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                            <label for="res_grupo_sanguineo">Grupo Sanguíneo</label>
                            <select id="res_grupo_sanguineo" name="grupo_sanguineo" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="res_nivel_dependencia">Nivel de Dependencia</label>
                            <select id="res_nivel_dependencia" name="nivel_dependencia" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione</option>
                                <option value="Autónomo">Autónomo</option>
                                <option value="Dependencia leve">Dependencia leve</option>
                                <option value="Dependencia moderada">Dependencia moderada</option>
                                <option value="Dependencia severa">Dependencia severa</option>
                                <option value="Gran dependencia">Gran dependencia</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="res_alergias">Alergias</label>
                            <textarea id="res_alergias" name="alergias" rows="2" placeholder="Ej: Penicilina, Lácteos, Polen"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="res_diagnosticos">Enfermedades Crónicas / Diagnósticos</label>
                            <textarea id="res_diagnosticos" name="diagnosticos" rows="2" placeholder="Ej: Diabetes tipo 2, Hipertensión, Artritis"></textarea>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="res_restricciones_dieteticas">Restricciones Dietéticas</label>
                            <textarea id="res_restricciones_dieteticas" name="restricciones_dieteticas" rows="2" placeholder="Ej: Sin sal, Textura triturada, Sin gluten"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="res_movilidad">Movilidad / Ayudas Técnicas</label>
                            <select id="res_movilidad" name="movilidad" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione</option>
                                <option value="Deambulación autónoma">Deambulación autónoma</option>
                                <option value="Bastón">Bastón</option>
                                <option value="Andador">Andador</option>
                                <option value="Silla de ruedas">Silla de ruedas</option>
                                <option value="Cama">Cama</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="res_medico_referencia">Médico de Referencia</label>
                            <input type="text" id="res_medico_referencia" name="medico_referencia" placeholder="Nombre del médico o centro de salud">
                        </div>
                        <div class="form-group">
                            <label for="res_telefono_medico">Teléfono Médico</label>
                            <input type="text" id="res_telefono_medico" name="telefono_medico" placeholder="Teléfono del médico o centro">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="res_medicaciones">Medicaciones</label>
                        <textarea id="res_medicaciones" name="medicaciones" rows="3" placeholder="Lista de medicaciones y horarios"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Servicios Extra</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" name="servicio_extra" value="Peluquería" style="width: auto; margin-right: 8px;">
                                Peluquería
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" name="servicio_extra" value="Podólogo" style="width: auto; margin-right: 8px;">
                                Podólogo
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" name="servicio_extra" value="Fisio" style="width: auto; margin-right: 8px;">
                                Fisio
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" name="servicio_extra" value="Farmacia" style="width: auto; margin-right: 8px;">
                                Farmacia
                            </label>
                    </div>
                        <input type="text" id="res_servicios_extra_otros" name="servicios_extra_otros" placeholder="Otros servicios (separados por comas, ej: Lavandería, Masajes)" style="margin-top: 5px;">
                        <input type="hidden" id="res_servicios_extra" name="servicios_extra" value="">
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="res_peculiaridades">Peculiaridades / Notas Importantes</label>
                        <textarea id="res_peculiaridades" name="peculiaridades" rows="3" placeholder="Información adicional relevante"></textarea>
                    </div>
                </div>
                
                <!-- Los nuevos residentes siempre son activos -->
                <input type="hidden" id="res_activo" name="activo" value="true">
                <div id="modalAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveResidenteBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalResidente')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar personal -->
    <div id="modalPersonal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Personal</h2>
                <button class="close-modal" onclick="closeModal('modalPersonal')">&times;</button>
            </div>
            <form id="formPersonal" onsubmit="savePersonal(event)">
                
                <!-- SECCIÓN: Información de Residencia -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/home.svg" alt="Residencia" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Residencia</h3>
                    <div class="form-group">
                        <label for="per_id_residencia">Residencia *</label>
                        <select id="per_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Seleccione una residencia</option>
                            <option value="1">Violetas 1</option>
                            <option value="2">Violetas 2</option>
                        </select>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información Personal -->
                <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                    <h3 style="color: #f56565; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Personal</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="per_nombre">Nombre *</label>
                            <input type="text" id="per_nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="per_apellido">Apellido *</label>
                            <input type="text" id="per_apellido" name="apellido" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="per_documento">Documento de Identidad</label>
                            <input type="text" id="per_documento" name="documento_identidad">
                        </div>
                        <div class="form-group">
                            <label for="per_cargo">Cargo</label>
                            <input type="text" id="per_cargo" name="cargo" placeholder="Ej: Enfermero/a, Auxiliar, Director/a">
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información de Contacto -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/phone.svg" alt="Contacto" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Contacto</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="per_telefono">Teléfono</label>
                            <input type="tel" id="per_telefono" name="telefono">
                        </div>
                        <div class="form-group">
                            <label for="per_email">Email</label>
                            <input type="email" id="per_email" name="email">
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información Laboral -->
                <div style="background: #fffaf0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                    <h3 style="color: #ed8936; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Laboral" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Laboral</h3>
                    <div class="form-group">
                        <label for="per_fecha_contratacion">Fecha de Contratación</label>
                        <input type="text" id="per_fecha_contratacion" name="fecha_contratacion" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)" readonly style="cursor: pointer; background-color: white;">
                    </div>
                </div>
                
                <!-- Los nuevos empleados siempre son activos -->
                <input type="hidden" id="per_activo" name="activo" value="true">
                <div id="modalPersonalAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="savePersonalBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalPersonal')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar/editar turno extra -->
    <div id="modalTurnoExtra" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/clock.svg" alt="Turno Extra" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> <span id="modalTurnoExtraTitle">Agregar Turno Extra</span></h2>
                <button class="close-modal" onclick="closeModal('modalTurnoExtra')">&times;</button>
            </div>
            <form id="formTurnoExtra" onsubmit="saveTurnoExtra(event)">
                <input type="hidden" id="turno_id_turno_extra" name="id_turno_extra" value="">
                
                <!-- SECCIÓN: Información del Turno -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/user-medical.svg" alt="Empleado" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Empleado</h3>
                    <div class="form-group">
                        <label for="turno_id_personal">Empleado *</label>
                        <select id="turno_id_personal" name="id_personal" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Seleccione un empleado</option>
                        </select>
                    </div>
                </div>
                
                <!-- SECCIÓN: Fecha y Horas -->
                <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                    <h3 style="color: #f56565; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/calendar.svg" alt="Fecha" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Fecha y Horas</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="turno_fecha">Fecha *</label>
                            <input type="text" id="turno_fecha" name="fecha" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)" readonly style="cursor: pointer; background-color: white;" required>
                        </div>
                        <div class="form-group">
                            <label for="turno_hora_entrada">Hora Entrada *</label>
                            <input type="time" id="turno_hora_entrada" name="hora_entrada" required>
                        </div>
                        <div class="form-group">
                            <label for="turno_hora_salida">Hora Salida *</label>
                            <input type="time" id="turno_hora_salida" name="hora_salida" required>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Motivo -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Motivo" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Motivo</h3>
                    <div class="form-group">
                        <label for="turno_motivo">Motivo del Turno Extra</label>
                        <textarea id="turno_motivo" name="motivo" rows="3" placeholder="Describa el motivo del turno extra..."></textarea>
                    </div>
                </div>
                
                <div id="modalTurnoExtraAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveTurnoExtraBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalTurnoExtra')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar proveedor -->
    <div id="modalProveedor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Proveedor</h2>
                <button class="close-modal" onclick="closeModal('modalProveedor')">&times;</button>
            </div>
            <form id="formProveedor" onsubmit="saveProveedor(event)">
                <input type="hidden" id="prov_id_proveedor" name="id_proveedor" value="">
                
                <!-- SECCIÓN: Información Básica -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Información" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Básica</h3>
                    <div class="form-group">
                        <label for="prov_nombre">Nombre del Proveedor *</label>
                        <input type="text" id="prov_nombre" name="nombre" required placeholder="Ej: Empresa de Limpieza SL">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="prov_nif_cif">NIF/CIF</label>
                            <input type="text" id="prov_nif_cif" name="nif_cif" placeholder="B12345678">
                        </div>
                        <div class="form-group">
                            <label for="prov_tipo_servicio">Tipo de Servicio</label>
                            <select id="prov_tipo_servicio" name="tipo_servicio" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un tipo</option>
                                <option value="Limpieza">Limpieza</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Alimentación">Alimentación</option>
                                <option value="Farmacia">Farmacia</option>
                                <option value="Servicios Médicos">Servicios Médicos</option>
                                <option value="Suministros">Suministros</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información de Contacto -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/phone.svg" alt="Contacto" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Contacto</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="prov_telefono">Teléfono</label>
                            <input type="tel" id="prov_telefono" name="telefono" placeholder="666 555 444">
                        </div>
                        <div class="form-group">
                            <label for="prov_email">Email</label>
                            <input type="email" id="prov_email" name="email" placeholder="contacto@proveedor.com">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="prov_direccion">Dirección</label>
                            <input type="text" id="prov_direccion" name="direccion" placeholder="Calle, número, ciudad">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="prov_contacto">Persona de Contacto</label>
                            <input type="text" id="prov_contacto" name="contacto" placeholder="Nombre del contacto principal">
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Estado y Observaciones -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #718096;">
                    <h3 style="color: #718096; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/settings.svg" alt="Estado" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Estado y Observaciones</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="prov_activo" name="activo" checked style="width: auto; margin-right: 8px;">
                            Proveedor Activo
                        </label>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="prov_observaciones">Observaciones</label>
                        <textarea id="prov_observaciones" name="observaciones" rows="3" placeholder="Notas adicionales sobre el proveedor"></textarea>
                    </div>
                </div>
                
                <div id="modalProveedorAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveProveedorBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalProveedor')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar cobro manual -->
    <div id="modalCobro" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalCobroTitulo"><img src="/static/icons/medical/bill.svg" alt="Cobro" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Cobro</h2>
                <button class="close-modal" onclick="closeModal('modalCobro')">&times;</button>
            </div>
            <form id="formCobro" onsubmit="saveCobro(event)">
                <input type="hidden" id="cobro_id_pago" name="id_pago" value="">
                <!-- SECCIÓN: Información del Cobro -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">💳 Información del Cobro</h3>
                    <div class="form-group">
                        <label for="cobro_id_residente">Residente *</label>
                        <select id="cobro_id_residente" name="id_residente" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Cargando residentes...</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="cobro_monto">Monto (€) *</label>
                            <input type="number" id="cobro_monto" name="monto" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="cobro_metodo_pago">Tipo de Pago</label>
                            <select id="cobro_metodo_pago" name="metodo_pago" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un método</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="remesa">Remesa</option>
                                <option value="metálico">Metálico</option>
                                <option value="bizum">Bizum</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="cobro_concepto">Concepto *</label>
                        <select id="cobro_concepto" name="concepto" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;" onchange="actualizarCampoConceptoOtros()">
                            <option value="">Seleccione un concepto</option>
                            <option value="Pago mensual habitación">Pago mensual habitación</option>
                            <option value="otros">Otros</option>
                        </select>
                        <input type="text" id="cobro_concepto_otros" name="concepto_otros" placeholder="Escriba el concepto personalizado" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333; margin-top: 10px; display: none;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="cobro_fecha_prevista">Fecha Prevista</label>
                            <input type="text" id="cobro_fecha_prevista" name="fecha_prevista" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)" readonly style="cursor: pointer; background-color: white;">
                        </div>
                        <div class="form-group">
                            <label for="cobro_fecha_pago">Fecha de Pago </label>
                            <input type="text" id="cobro_fecha_pago" name="fecha_pago" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)" readonly style="cursor: pointer; background-color: white;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="cobro_observaciones">Observaciones</label>
                        <textarea id="cobro_observaciones" name="observaciones" rows="3" placeholder="Notas adicionales sobre el cobro"></textarea>
                    </div>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        💡 <strong>Nota:</strong> Si no tiene fecha de pago, será un cobro previsto. Si tiene fecha de pago, será un cobro completado.
                    </p>
                </div>
                
                <div id="modalCobroAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveCobroBtn" style="flex: 1;">Guardar</button>
                    <button type="button" id="deleteCobroBtn" onclick="confirmarEliminarCobro()" style="flex: 1; background: #dc3545; display: none;">Eliminar</button>
                    <button type="button" onclick="closeModal('modalCobro')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para dar de baja a un residente -->
    <div id="modalBajaResidente" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/user-x.svg" alt="Dar de baja" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Dar de Baja a Residente</h2>
                <button class="close-modal" onclick="closeModal('modalBajaResidente')">&times;</button>
            </div>
            <form id="formBajaResidente" onsubmit="confirmarBajaResidente(event)">
                <input type="hidden" id="baja_id_residente" name="id_residente">
                <div class="form-group">
                    <label for="baja_motivo">Motivo de la Baja *</label>
                    <select id="baja_motivo" name="motivo_baja" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                        <option value="">Seleccione un motivo</option>
                        <option value="Fallecimiento">Fallecimiento</option>
                        <option value="Traslado a hospital">Traslado a hospital</option>
                        <option value="Traslado a otra residencia">Traslado a otra residencia</option>
                        <option value="Alta médica">Alta médica</option>
                        <option value="Solicitud familiar">Solicitud familiar</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="baja_observaciones">Observaciones (opcional)</label>
                    <textarea id="baja_observaciones" name="observaciones" rows="3" placeholder="Información adicional sobre la baja"></textarea>
                </div>
                <div id="modalBajaAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="confirmarBajaBtn" style="flex: 1; background: #dc3545;">Confirmar Baja</button>
                    <button type="button" onclick="closeModal('modalBajaResidente')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para listar proveedores -->
    <div id="modalListaProveedores" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/package.svg" alt="Proveedores" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Listado de Proveedores</h2>
                <button class="close-modal" onclick="closeModal('modalListaProveedores')">&times;</button>
            </div>
            <div id="listaProveedoresContent" style="padding: 20px;">
                <div style="text-align: center; padding: 40px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 15px; color: #666;">Cargando proveedores...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar pago a proveedor -->
    <div id="modalPagoProveedor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/money.svg" alt="Pago" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Pago a Proveedor</h2>
                <button class="close-modal" onclick="closeModal('modalPagoProveedor')">&times;</button>
            </div>
            <form id="formPagoProveedor" onsubmit="savePagoProveedor(event)">
                <input type="hidden" id="pago_id_pago" name="id_pago" value="">
                
                <!-- SECCIÓN: Información del Pago -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">💳 Información del Pago</h3>
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label for="pago_id_proveedor">Proveedor *</label>
                            <button type="button" id="btnNuevoProveedor" style="padding: 4px 10px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">+ Nuevo Proveedor</button>
                        </div>
                        <select id="pago_id_proveedor" name="id_proveedor" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Cargando proveedores...</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_concepto">Concepto *</label>
                            <input type="text" id="pago_concepto" name="concepto" required placeholder="Ej: Servicio de limpieza mensual">
                        </div>
                        <div class="form-group">
                            <label for="pago_monto">Monto (€) *</label>
                            <input type="number" id="pago_monto" name="monto" step="0.01" required placeholder="0.00">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_fecha_prevista">Fecha Prevista</label>
                            <input type="text" id="pago_fecha_prevista" name="fecha_prevista" placeholder="DD/MM/YYYY" maxlength="10" readonly style="cursor: pointer; background-color: white;">
                        </div>
                        <div class="form-group">
                            <label for="pago_fecha_pago">Fecha de Pago</label>
                            <input type="text" id="pago_fecha_pago" name="fecha_pago" placeholder="DD/MM/YYYY" maxlength="10" readonly style="cursor: pointer; background-color: white;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_metodo_pago">Método de Pago</label>
                            <select id="pago_metodo_pago" name="metodo_pago" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un método</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="remesa">Remesa</option>
                                <option value="metálico">Metálico</option>
                                <option value="cheque">Cheque</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pago_numero_factura">Número de Factura</label>
                            <input type="text" id="pago_numero_factura" name="numero_factura" placeholder="FAC-2025-001">
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Observaciones -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #718096;">
                    <h3 style="color: #718096; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/settings.svg" alt="Observaciones" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Observaciones</h3>
                    <div class="form-group">
                        <label for="pago_observaciones">Observaciones</label>
                        <textarea id="pago_observaciones" name="observaciones" rows="3" placeholder="Notas adicionales sobre el pago"></textarea>
                    </div>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        💡 <strong>Nota:</strong> Si tiene fecha de pago, será un pago completado. Si no tiene fecha de pago, será un pago pendiente.
                    </p>
                </div>
                
                <div id="modalPagoProveedorAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="savePagoProveedorBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalPagoProveedor')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentToken = null;
        
        // Función helper para insertar iconos SVG inline
        function getIconSVG(iconName, size = 20, color = 'currentColor') {
            const icons = {
                'hospital': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M3 21h18"/><path d="M5 21V7l8-4v18"/><path d="M19 21V11l-6-4"/><line x1="9" y1="9" x2="9" y2="9.01"/><line x1="9" y1="12" x2="9" y2="12.01"/><line x1="9" y1="15" x2="9" y2="15.01"/><line x1="9" y1="18" x2="9" y2="18.01"/></svg>`,
                'user': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
                'users': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
                'user-medical': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 11v6"/><path d="M19 14h6"/></svg>`,
                'money': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
                'clipboard': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><rect x="9" y="2" width="6" height="4" rx="1"/><path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"/><path d="M12 11h4"/><path d="M12 15h4"/><path d="M14 13v4"/></svg>`,
                'plus': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
                'check': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
                'alert': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
                'activity': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
                'package': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>`,
                'file': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
                'settings': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
                'log-out': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`
            };
            return icons[iconName] || '';
        }

        // Verificar si hay token guardado
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('violetas_token');
            if (savedToken) {
                verifyToken(savedToken);
            }
        });

        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const alert = document.getElementById('alert');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando sesión...';
            hideAlert();

            try {
                const response = await fetch(`${API_URL}/api/v1/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentToken = data.token;
                    localStorage.setItem('violetas_token', currentToken);
                    showSuccess('¡Login exitoso!');
                    showDashboard(currentToken);
                } else {
                    showError(data.error || 'Error al iniciar sesión');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesión';
                }
            } catch (error) {
                showError('Error de conexión. Verifica que el servidor esté corriendo.');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
            }
        });

        async function verifyToken(token) {
            try {
                // Decodificar el token (sin verificar, solo para mostrar info)
                const payload = JSON.parse(atob(token.split('.')[1]));
                
                // Mostrar dashboard
                showDashboard(token);
                
                // Actualizar información del usuario en el menú
                const userMenuInfo = document.getElementById('userMenuInfo');
                if (userMenuInfo) {
                    userMenuInfo.innerHTML = `
                        <div class="user-menu-info-item"><strong>ID Usuario:</strong> ${payload.id_usuario}</div>
                        <div class="user-menu-info-item"><strong>Rol ID:</strong> ${payload.id_rol}</div>
                        <div class="user-menu-info-item"><strong>Residencia ID:</strong> ${payload.id_residencia}</div>
                        <div class="user-menu-info-item"><strong>Expira:</strong> ${new Date(payload.exp * 1000).toLocaleString('es-ES')}</div>
                    `;
                }
                
                // Ocultar la sección userInfo antigua
                document.getElementById('userInfo').style.display = 'none';
            } catch (error) {
                console.error('Error al verificar token:', error);
                logout();
            }
        }

        function showDashboard(token) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('loginHeader').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('dashboardHeader').style.display = 'flex';
            // tokenValue solo existe cuando se muestra el módulo de token, así que verificamos primero
            const tokenValueEl = document.getElementById('tokenValue');
            if (tokenValueEl) {
                tokenValueEl.textContent = token;
            }
            // tokenDisplay no existe en el HTML inicial, solo se crea dinámicamente
            // No intentamos acceder a él aquí para evitar errores
        }

        function logout() {
            localStorage.removeItem('violetas_token');
            currentToken = null;
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('loginHeader').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('dashboardHeader').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            hideAlert();
            closeUserMenu();
        }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('show');
        }

        function closeUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.remove('show');
        }

        function showConfiguracion() {
            closeUserMenu();
            alert('Configuración - Próximamente');
        }

        // Cerrar el menú al hacer clic fuera
        document.addEventListener('click', function(event) {
            const menuContainer = document.querySelector('.user-menu-container');
            const menu = document.getElementById('userMenu');
            if (menuContainer && !menuContainer.contains(event.target) && menu.classList.contains('show')) {
                closeUserMenu();
            }
        });

        // Función eliminada - módulo Token JWT ya no se usa
        /*
        function copyToken() {
            const tokenValue = document.getElementById('tokenValue').textContent;
            navigator.clipboard.writeText(tokenValue).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '¡Copiado!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
        */

        function showError(message) {
            const alert = document.getElementById('alert');
            alert.className = 'alert error';
            alert.textContent = message;
            alert.style.display = 'block';
        }

        function showSuccess(message) {
            const alert = document.getElementById('alert');
            alert.className = 'alert success';
            alert.textContent = message;
            alert.style.display = 'block';
        }

        function hideAlert() {
            document.getElementById('alert').style.display = 'none';
        }

        function showModule(module) {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            if (module === 'residentes') {
                loadResidentes();
            } else if (module === 'facturacion') {
                loadFacturacion();
            } else if (module === 'personal') {
                loadPersonal();
            }
        }

        async function loadResidentes() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando residentes...</p>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON:', text);
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${response.status}</p></div>`;
                    return;
                }
                
                if (response.ok) {
                    // Separar residentes activos e inactivos
                    const residentesActivos = (data.residentes || []).filter(r => r.activo);
                    const residentesInactivos = (data.residentes || []).filter(r => !r.activo);
                    
                    // Agrupar residentes activos por residencia
                    const residentesVioletas1 = residentesActivos.filter(r => r.id_residencia === 1);
                    const residentesVioletas2 = residentesActivos.filter(r => r.id_residencia === 2);
                    const residentesOtrasResidencias = residentesActivos.filter(r => r.id_residencia !== 1 && r.id_residencia !== 2);
                    
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 15px;"><img src="/static/icons/medical/users.svg" alt="Residentes" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Residentes Activos (${residentesActivos.length})</h3>
                            <button class="add-btn" onclick="openModal('modalResidente')" style="display: inline-flex; align-items: center; gap: 6px;"><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 16px; height: 16px; filter: brightness(0) invert(1);"> Agregar Residente</button>
                    `;
                    
                    // Contenedor para Violetas 1
                    if (residentesVioletas1.length > 0) {
                        html += `
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea;">
                                <h4 style="color: #667eea; margin-bottom: 15px; font-size: 18px; font-weight: 600;">Violetas 1 (${residentesVioletas1.length})</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                            <th>Habitación</th>
                                        <th>Nombre</th>
                                            <th>Contacto de Emergencia</th>
                                            <th>Teléfono de Emergencia</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        residentesVioletas1.forEach(res => {
                            html += `
                                <tr style="cursor: pointer;" onclick="viewResidente(${res.id_residente})">
                                    <td>${res.habitacion || '-'}</td>
                                    <td>${res.nombre} ${res.apellido}</td>
                                    <td>${res.contacto_emergencia || '-'}</td>
                                    <td>${res.telefono_emergencia || '-'}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: white; font-weight: 600;">
                                            <td colspan="4" style="padding: 10px; text-align: right; color: #667eea; border-top: 2px solid #e0e0e0;">
                                                Total: ${residentesVioletas1.length}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        `;
                    }
                    
                    // Contenedor para Violetas 2
                    if (residentesVioletas2.length > 0) {
                        html += `
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #48bb78;">
                                <h4 style="color: #48bb78; margin-bottom: 15px; font-size: 18px; font-weight: 600;">Violetas 2 (${residentesVioletas2.length})</h4>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                        <th>Habitación</th>
                                            <th>Nombre</th>
                                            <th>Contacto de Emergencia</th>
                                            <th>Teléfono de Emergencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        residentesVioletas2.forEach(res => {
                            html += `
                                <tr style="cursor: pointer;" onclick="viewResidente(${res.id_residente})">
                                    <td>${res.habitacion || '-'}</td>
                                    <td>${res.nombre} ${res.apellido}</td>
                                    <td>${res.contacto_emergencia || '-'}</td>
                                    <td>${res.telefono_emergencia || '-'}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: white; font-weight: 600;">
                                            <td colspan="4" style="padding: 10px; text-align: right; color: #48bb78; border-top: 2px solid #e0e0e0;">
                                                Total: ${residentesVioletas2.length}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        `;
                    }
                    
                    // Otras residencias (por si hay más en el futuro)
                    if (residentesOtrasResidencias.length > 0) {
                        const residenciasAgrupadas = {};
                        residentesOtrasResidencias.forEach(res => {
                            const residenciaId = res.id_residencia;
                            if (!residenciasAgrupadas[residenciaId]) {
                                residenciasAgrupadas[residenciaId] = [];
                            }
                            residenciasAgrupadas[residenciaId].push(res);
                        });
                        
                        Object.keys(residenciasAgrupadas).forEach(residenciaId => {
                            const residentesResidencia = residenciasAgrupadas[residenciaId];
                            const nombreResidencia = residentesResidencia[0].nombre_residencia || `Residencia ${residenciaId}`;
                            
                            html += `
                                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #718096;">
                                    <h4 style="color: #718096; margin-bottom: 15px; font-size: 18px; font-weight: 600;">${nombreResidencia} (${residentesResidencia.length})</h4>
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Habitación</th>
                                                <th>Nombre</th>
                                                <th>Contacto de Emergencia</th>
                                                <th>Teléfono de Emergencia</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            residentesResidencia.forEach(res => {
                                html += `
                                    <tr style="cursor: pointer;" onclick="viewResidente(${res.id_residente})">
                                    <td>${res.habitacion || '-'}</td>
                                        <td>${res.nombre} ${res.apellido}</td>
                                        <td>${res.contacto_emergencia || '-'}</td>
                                        <td>${res.telefono_emergencia || '-'}</td>
                                </tr>
                            `;
                        });
                        
                            html += `
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: white; font-weight: 600;">
                                                <td colspan="4" style="padding: 10px; text-align: right; color: #718096; border-top: 2px solid #e0e0e0;">
                                                    Total: ${residentesResidencia.length}
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            `;
                        });
                    }
                    
                    if (residentesActivos.length === 0) {
                        html += '<p style="margin-top: 20px;">No hay residentes activos registrados.</p>';
                    }
                    
                    // Lista de residentes inactivos (usuarios de baja)
                    if (residentesInactivos.length > 0) {
                        // Agrupar residentes inactivos por residencia
                        const inactivosVioletas1 = residentesInactivos.filter(r => r.id_residencia === 1);
                        const inactivosVioletas2 = residentesInactivos.filter(r => r.id_residencia === 2);
                        const inactivosOtrasResidencias = residentesInactivos.filter(r => r.id_residencia !== 1 && r.id_residencia !== 2);
                        
                        html += `
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                                <h3 style="color: #dc3545; margin-bottom: 20px;"><img src="/static/icons/medical/user-x.svg" alt="Bajas" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Usuarios de Baja (${residentesInactivos.length})</h3>
                        `;
                        
                        // Contenedor para Violetas 1 - Inactivos
                        if (inactivosVioletas1.length > 0) {
                            html += `
                                <div style="margin-top: 20px; padding: 20px; background: #fff5f5; border-radius: 10px; border-left: 4px solid #dc3545;">
                                    <h4 style="color: #dc3545; margin-bottom: 15px; font-size: 18px; font-weight: 600;">Violetas 1 (${inactivosVioletas1.length})</h4>
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Habitación</th>
                                                <th>Nombre</th>
                                                <th>Motivo de Baja</th>
                                                <th>Fecha de Baja</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            inactivosVioletas1.forEach(res => {
                                // Debug: verificar datos recibidos
                                console.log('Residente inactivo:', {
                                    id: res.id_residente,
                                    nombre: res.nombre,
                                    habitacion: res.habitacion,
                                    motivo_baja: res.motivo_baja,
                                    fecha_baja: res.fecha_baja
                                });
                                
                                const fechaBaja = res.fecha_baja ? fechaISOToEspanol(res.fecha_baja) : '-';
                                const motivoBaja = res.motivo_baja || '-';
                                html += `
                                    <tr style="cursor: pointer;" onclick="viewResidente(${res.id_residente})">
                                        <td>${res.habitacion || '-'}</td>
                                        <td>${res.nombre} ${res.apellido}</td>
                                        <td>${motivoBaja}</td>
                                        <td>${fechaBaja}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: white; font-weight: 600;">
                                                <td colspan="4" style="padding: 10px; text-align: right; color: #dc3545; border-top: 2px solid #e0e0e0;">
                                                    Total: ${inactivosVioletas1.length}
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            `;
                        }
                        
                        // Contenedor para Violetas 2 - Inactivos
                        if (inactivosVioletas2.length > 0) {
                            html += `
                                <div style="margin-top: 20px; padding: 20px; background: #fff5f5; border-radius: 10px; border-left: 4px solid #dc3545;">
                                    <h4 style="color: #dc3545; margin-bottom: 15px; font-size: 18px; font-weight: 600;">Violetas 2 (${inactivosVioletas2.length})</h4>
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Habitación</th>
                                                <th>Nombre</th>
                                                <th>Motivo de Baja</th>
                                                <th>Fecha de Baja</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            inactivosVioletas2.forEach(res => {
                                // Debug: verificar datos recibidos
                                console.log('Residente inactivo:', {
                                    id: res.id_residente,
                                    nombre: res.nombre,
                                    habitacion: res.habitacion,
                                    motivo_baja: res.motivo_baja,
                                    fecha_baja: res.fecha_baja
                                });
                                
                                const fechaBaja = res.fecha_baja ? fechaISOToEspanol(res.fecha_baja) : '-';
                                const motivoBaja = res.motivo_baja || '-';
                                html += `
                                    <tr style="cursor: pointer;" onclick="viewResidente(${res.id_residente})">
                                        <td>${res.habitacion || '-'}</td>
                                        <td>${res.nombre} ${res.apellido}</td>
                                        <td>${motivoBaja}</td>
                                        <td>${fechaBaja}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: white; font-weight: 600;">
                                                <td colspan="4" style="padding: 10px; text-align: right; color: #dc3545; border-top: 2px solid #e0e0e0;">
                                                    Total: ${inactivosVioletas2.length}
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            `;
                        }
                        
                        // Otras residencias inactivas (por si hay más en el futuro)
                        if (inactivosOtrasResidencias.length > 0) {
                            const residenciasAgrupadas = {};
                            inactivosOtrasResidencias.forEach(res => {
                                const residenciaId = res.id_residencia;
                                if (!residenciasAgrupadas[residenciaId]) {
                                    residenciasAgrupadas[residenciaId] = [];
                                }
                                residenciasAgrupadas[residenciaId].push(res);
                            });
                            
                            Object.keys(residenciasAgrupadas).forEach(residenciaId => {
                                const residentesResidencia = residenciasAgrupadas[residenciaId];
                                const nombreResidencia = residentesResidencia[0].nombre_residencia || `Residencia ${residenciaId}`;
                                
                                html += `
                                    <div style="margin-top: 20px; padding: 20px; background: #fff5f5; border-radius: 10px; border-left: 4px solid #dc3545;">
                                        <h4 style="color: #dc3545; margin-bottom: 15px; font-size: 18px; font-weight: 600;">${nombreResidencia} (${residentesResidencia.length})</h4>
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Habitación</th>
                                                    <th>Nombre</th>
                                                    <th>Motivo de Baja</th>
                                                    <th>Fecha de Baja</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                `;
                                
                                residentesResidencia.forEach(res => {
                                    // Debug: verificar datos recibidos
                                    console.log('Residente inactivo:', {
                                        id: res.id_residente,
                                        nombre: res.nombre,
                                        habitacion: res.habitacion,
                                        motivo_baja: res.motivo_baja,
                                        fecha_baja: res.fecha_baja
                                    });
                                    
                                    const fechaBaja = res.fecha_baja ? fechaISOToEspanol(res.fecha_baja) : '-';
                                    const motivoBaja = res.motivo_baja || '-';
                                    html += `
                                        <tr style="cursor: pointer;" onclick="viewResidente(${res.id_residente})">
                                            <td>${res.habitacion || '-'}</td>
                                            <td>${res.nombre} ${res.apellido}</td>
                                            <td>${motivoBaja}</td>
                                            <td>${fechaBaja}</td>
                                        </tr>
                                    `;
                                });
                                
                                html += `
                                            </tbody>
                                            <tfoot>
                                                <tr style="background: white; font-weight: 600;">
                                                    <td colspan="4" style="padding: 10px; text-align: right; color: #dc3545; border-top: 2px solid #e0e0e0;">
                                                        Total: ${residentesResidencia.length}
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                `;
                            });
                        }
                        
                        html += `</div>`;
                    }
                    
                    // Calcular totales para el resumen
                    const totalResidentes = residentesActivos.length + residentesInactivos.length;
                    
                    html += `
                        <div style="margin-top: 40px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                            <h3 style="color: white; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/users.svg" alt="Total" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; filter: brightness(0) invert(1);"> Resumen Total</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                                <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${residentesVioletas1.length}</div>
                                    <div style="font-size: 13px; opacity: 0.9;">Violetas 1 Activos</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${residentesVioletas2.length}</div>
                                    <div style="font-size: 13px; opacity: 0.9;">Violetas 2 Activos</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${residentesInactivos.length}</div>
                                    <div style="font-size: 13px; opacity: 0.9;">Usuarios de Baja</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.3); padding: 15px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.5);">
                                    <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${totalResidentes}</div>
                                    <div style="font-size: 14px; opacity: 0.9; font-weight: 600;">Total de Residentes</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        content.innerHTML = `<div class="module-content"><p style="color: red;">Error: Sesión expirada. Por favor, <a href="javascript:location.reload()">recarga la página</a> para iniciar sesión nuevamente.</p></div>`;
                        localStorage.removeItem('violetas_token');
                    } else {
                        content.innerHTML = `<div class="module-content"><p style="color: red;">Error (${response.status}): ${data.error || 'Error desconocido'}</p></div>`;
                    }
                    console.error('Error al cargar residentes:', response.status, data);
                }
            } catch (error) {
                console.error('Error de conexión al cargar residentes:', error);
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexión: ${error.message}. Verifica que el servidor esté corriendo.</p></div>`;
            }
        }

        async function loadFacturacion() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando facturación...</p>
                    </div>
                </div>
            `;
            
            try {
                // Cargar cobros y pagos a proveedores
                let cobrosRes = await fetch(`${API_URL}/api/v1/facturacion/cobros`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const cobrosContentType = cobrosRes.headers.get('content-type');
                let cobrosData;
                
                if (cobrosContentType && cobrosContentType.includes('application/json')) {
                    cobrosData = await cobrosRes.json();
                } else {
                    const text = await cobrosRes.text();
                    console.error('Respuesta de cobros no es JSON:', text);
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${cobrosRes.status}</p></div>`;
                    return;
                }
                
                // Verificar si hay residentes que necesitan cobros previstos
                // Lógica: Si un residente NO tiene cobro completado en el mes actual,
                // debe tener un cobro previsto
                const mesActual = new Date().toISOString().slice(0, 7); // YYYY-MM
                const tieneCobrosPrevistos = cobrosRes.ok && cobrosData.cobros && cobrosData.cobros.length > 0 && 
                                            cobrosData.cobros.some(c => {
                                                if (!c || !c.es_cobro_previsto) return false;
                                                const mesCobro = c.mes_pagado || (c.fecha_prevista ? c.fecha_prevista.slice(0, 7) : null);
                                                return mesCobro === mesActual;
                                            });
                
                // Verificar si hay cobros con conceptos antiguos o si no hay cobros previstos
                const tieneConceptosAntiguos = cobrosData.cobros && cobrosData.cobros.some(c => {
                    const esPrevisto = c.es_cobro_previsto === true || 
                                      c.es_cobro_previsto === 'true' || 
                                      c.es_cobro_previsto === 'True' ||
                                      c.es_cobro_previsto === 1;
                    if (!esPrevisto) return false;
                    const estado = (c.estado || '').toLowerCase().trim();
                    const esPendiente = estado === 'pendiente' || estado === '' || !c.estado;
                    if (!esPendiente) return false;
                    // Verificar si tiene concepto antiguo
                    const concepto = (c.concepto || '').toLowerCase();
                    return concepto.includes('mensual habitación') || concepto.includes('pepe') || concepto.includes('maría');
                });
                
                // Si no hay cobros previstos o hay conceptos antiguos, regenerar
                if (cobrosRes.ok && (!tieneCobrosPrevistos || tieneConceptosAntiguos)) {
                    try {
                        console.log('Generando cobros previstos automáticamente...');
                        const generarRes = await fetch(`${API_URL}/api/v1/facturacion/cobros/generar-previstos`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({})
                        });
                        
                        const generarContentType = generarRes.headers.get('content-type');
                        if (generarContentType && generarContentType.includes('application/json')) {
                        const generarData = await generarRes.json();
                        
                        if (generarRes.ok) {
                                console.log(`✅ Cobros generados: ${generarData.cobros_generados || 0}, eliminados: ${generarData.cobros_eliminados || 0}`);
                            // Recargar los cobros después de generarlos
                            cobrosRes = await fetch(`${API_URL}/api/v1/facturacion/cobros`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                                const reloadContentType = cobrosRes.headers.get('content-type');
                                if (reloadContentType && reloadContentType.includes('application/json')) {
                            cobrosData = await cobrosRes.json();
                                }
                        } else {
                            console.warn('⚠️ No se pudieron generar cobros previstos:', generarData.error || 'Error desconocido');
                            }
                        }
                    } catch (e) {
                        console.error('❌ Error al generar cobros previstos automáticamente:', e);
                    }
                }
                
                const proveedoresRes = await fetch(`${API_URL}/api/v1/facturacion/proveedores`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const proveedoresContentType = proveedoresRes.headers.get('content-type');
                let proveedoresData;
                
                if (proveedoresContentType && proveedoresContentType.includes('application/json')) {
                    proveedoresData = await proveedoresRes.json();
                } else {
                    const text = await proveedoresRes.text();
                    console.error('Respuesta de proveedores no es JSON:', text);
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${proveedoresRes.status}</p></div>`;
                    return;
                }
                
                if (cobrosRes.ok && proveedoresRes.ok) {
                    // Filtrar cobros previstos: pendientes y completados
                    // Usar estructura agrupada si está disponible
                    const cobrosAgrupados = cobrosData.cobros_agrupados || [];
                    
                    // Si no hay estructura agrupada, crear una desde la lista plana
                    let cobrosPorResidencia = {};
                    if (cobrosAgrupados.length === 0 && cobrosData.cobros) {
                        cobrosData.cobros.forEach(c => {
                            // Intentar obtener id_residencia del nombre o usar un valor por defecto
                            const nombreRes = c.nombre_residencia || '';
                            let idRes = null;
                            if (nombreRes.includes('Violetas 1') || nombreRes.includes('1')) {
                                idRes = 1;
                            } else if (nombreRes.includes('Violetas 2') || nombreRes.includes('2')) {
                                idRes = 2;
                            }
                            
                            if (idRes) {
                                if (!cobrosPorResidencia[idRes]) {
                                    cobrosPorResidencia[idRes] = {
                                        id_residencia: idRes,
                                        nombre_residencia: c.nombre_residencia || `Residencia ${idRes}`,
                                        cobros: []
                                    };
                                }
                                cobrosPorResidencia[idRes].cobros.push(c);
                            }
                        });
                    } else {
                        cobrosAgrupados.forEach(grupo => {
                            cobrosPorResidencia[grupo.id_residencia] = grupo;
                        });
                    }
                    
                    // Filtrar y agrupar cobros previstos y completados por residencia
                    const cobrosPrevistosPorResidencia = {};
                    const cobrosCompletadosPorResidencia = {};
                    
                    Object.keys(cobrosPorResidencia).forEach(idRes => {
                        const grupo = cobrosPorResidencia[idRes];
                        
                        // Filtrar previstos pendientes
                        const previstos = grupo.cobros.filter(c => {
                            const esPrevisto = c.es_cobro_previsto === true || 
                                              c.es_cobro_previsto === 'true' || 
                                              c.es_cobro_previsto === 'True' ||
                                              c.es_cobro_previsto === 1;
                            const estado = (c.estado || '').toLowerCase().trim();
                            const esPendiente = estado === 'pendiente' || estado === '' || !c.estado;
                            return esPrevisto && esPendiente;
                        });
                        
                        // Ordenar previstos por fecha más cercana a hoy (ascendente - más cercanos primero)
                        previstos.sort((a, b) => {
                            const fechaA = a.fecha_prevista ? new Date(a.fecha_prevista) : new Date('9999-12-31');
                            const fechaB = b.fecha_prevista ? new Date(b.fecha_prevista) : new Date('9999-12-31');
                            return fechaA - fechaB;
                        });
                        
                        // Filtrar completados
                        const completados = grupo.cobros.filter(c => {
                            const estado = (c.estado || '').toLowerCase().trim();
                            return estado === 'cobrado';
                        });
                        
                        // Ordenar completados por fecha de pago más cercana a hoy (descendente - más recientes primero)
                        completados.sort((a, b) => {
                            const fechaA = a.fecha_pago ? new Date(a.fecha_pago) : new Date('1970-01-01');
                            const fechaB = b.fecha_pago ? new Date(b.fecha_pago) : new Date('1970-01-01');
                            return fechaB - fechaA;
                        });
                        
                        if (previstos.length > 0) {
                            cobrosPrevistosPorResidencia[idRes] = {
                                ...grupo,
                                cobros: previstos
                            };
                        }
                        
                        if (completados.length > 0) {
                            cobrosCompletadosPorResidencia[idRes] = {
                                ...grupo,
                                cobros: completados
                            };
                        }
                    });
                    
                    // Calcular totales
                    const totalPrevistos = Object.values(cobrosPrevistosPorResidencia).reduce((sum, g) => sum + g.cobros.length, 0);
                    const totalCompletados = Object.values(cobrosCompletadosPorResidencia).reduce((sum, g) => sum + g.cobros.length, 0);
                    
                    // Lista plana para compatibilidad (mantener para debug)
                    const cobrosPrevistos = Object.values(cobrosPrevistosPorResidencia).flatMap(g => g.cobros);
                    
                    // Debug: mostrar información de todos los cobros previstos
                    console.log('🔍 Debug cobros previstos:', {
                        totalCobros: cobrosData.cobros?.length || 0,
                        todosPrevistos: cobrosPrevistos.length,
                        pendientes: cobrosPrevistos.length,
                        detalle: cobrosPrevistos.map(c => ({
                            id: c.id_pago,
                            residente: c.residente,
                            estado: c.estado,
                            es_cobro_previsto: c.es_cobro_previsto,
                            metodo_pago: c.metodo_pago,
                            fecha_prevista: c.fecha_prevista,
                            mes_pagado: c.mes_pagado
                        }))
                    });
                    // Obtener últimos cobros completados (mensual y extra) de cada residente
                    let cobrosCompletados = [];
                    try {
                        const ultimosRes = await fetch(`${API_URL}/api/v1/facturacion/cobros/ultimos-completados`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const ultimosContentType = ultimosRes.headers.get('content-type');
                        if (ultimosContentType && ultimosContentType.includes('application/json')) {
                            const ultimosData = await ultimosRes.json();
                            if (ultimosRes.ok && ultimosData.cobros) {
                                cobrosCompletados = ultimosData.cobros;
                            }
                        }
                    } catch (e) {
                        console.error('Error al obtener últimos cobros completados:', e);
                    }
                    
                    // Debug: mostrar información detallada de todos los cobros
                    console.log('🔍 Debug completo de cobros:', {
                        totalCobros: cobrosData.cobros?.length || 0,
                        todosPrevistos: cobrosPrevistos.length,
                        pendientes: cobrosPrevistos.length,
                        completados: cobrosCompletados.length,
                        todosLosPrevistos: cobrosPrevistos.map(c => ({
                            id: c.id_pago,
                            residente: c.residente,
                            estado: c.estado,
                            es_previsto: c.es_cobro_previsto,
                            metodo_pago: c.metodo_pago,
                            fecha_prevista: c.fecha_prevista,
                            fecha_pago: c.fecha_pago,
                            mes_pagado: c.mes_pagado
                        })),
                        pendientesDetalle: cobrosPrevistos.map(c => ({
                            id: c.id_pago,
                            residente: c.residente,
                            estado: c.estado
                        }))
                    });
                    
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 20px;"><span style="font-size: 24px; vertical-align: middle; margin-right: 8px;">€</span> Facturación</h3>
                            
                            <div class="tabs-container">
                                <div class="tabs">
                                    <button class="tab active" onclick="switchFacturacionTab('cobros')"><img src="/static/icons/medical/bill.svg" alt="Cobros" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Cobros</button>
                                    <button class="tab" onclick="switchFacturacionTab('pagos')"><img src="/static/icons/medical/package.svg" alt="Pagos" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Pagos a Proveedores</button>
                                </div>
                                
                                <!-- Pestaña de Cobros -->
                                <div id="tabCobros" class="tab-content active">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <h4 style="color: #667eea; margin: 0;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Cobros" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Cobros Previstos (${totalPrevistos})</h4>
                                        <button class="add-btn" onclick="openModal('modalCobro')" style="padding: 8px 16px; font-size: 14px;">+ Agregar Cobro</button>
                                    </div>
                                    <div style="margin-bottom: 30px;">
                    `;
                    
                    if (totalPrevistos > 0) {
                        // Ordenar residencias por ID
                        const residenciasOrdenadas = Object.keys(cobrosPrevistosPorResidencia)
                            .map(id => parseInt(id))
                            .sort((a, b) => a - b);
                        
                        residenciasOrdenadas.forEach(idRes => {
                            const grupo = cobrosPrevistosPorResidencia[idRes];
                        html += `
                                <div style="margin-bottom: 30px;">
                                    <h5 style="color: #667eea; margin-bottom: 15px; padding: 10px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #667eea;">
                                        🏢 ${grupo.nombre_residencia} (${grupo.cobros.length} cobros pendientes)
                                    </h5>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Residente</th>
                                        <th>Monto</th>
                                                <th>Concepto</th>
                                                <th>Tipo Pago</th>
                                        <th>Fecha Prevista</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                            let totalGrupo = 0;
                            grupo.cobros.forEach(cobro => {
                            const fechaPrevista = cobro.fecha_prevista ? fechaISOToEspanol(cobro.fecha_prevista) : '-';
                                const concepto = cobro.concepto || '-';
                                const tipoPago = cobro.metodo_pago || '-';
                                totalGrupo += parseFloat(cobro.monto) || 0;
                                
                                // Verificar si la fecha prevista ya pasó
                                let fechaPrevistaStyle = 'color: #333;';
                                if (cobro.fecha_prevista) {
                                    const fechaPrevistaDate = new Date(cobro.fecha_prevista);
                                    const hoy = new Date();
                                    hoy.setHours(0, 0, 0, 0);
                                    fechaPrevistaDate.setHours(0, 0, 0, 0);
                                    if (fechaPrevistaDate < hoy) {
                                        fechaPrevistaStyle = 'color: #dc3545; font-weight: 600;';
                                    }
                                }
                                
                            html += `
                                    <tr style="cursor: pointer;" onclick="editarCobro(${cobro.id_pago})" title="Haz clic para editar">
                                    <td style="color: #333;">${cobro.residente}</td>
                                        <td style="color: #333;">${Math.round(parseFloat(cobro.monto))}€</td>
                                        <td style="color: #333;">${concepto}</td>
                                        <td style="color: #333;">${tipoPago}</td>
                                    <td style="${fechaPrevistaStyle}">${fechaPrevista}</td>
                                    <td><span style="color: #ffc107; font-weight: 600;">Pendiente</span></td>
                                        <td onclick="event.stopPropagation();">
                                        <button onclick="cambiarEstadoCobro(${cobro.id_pago}, 'cobrado')" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Marcar como Cobrado</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                            html += `
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #e0e0e0;">
                                                <td style="padding: 10px; text-align: right; color: #667eea;">Total:</td>
                                                <td style="padding: 10px; text-align: left; color: #667eea; font-weight: 600;">${Math.round(totalGrupo)}€</td>
                                                <td colspan="5"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p style="color: #333;">No hay cobros previstos pendientes.</p>';
                    }
                    
                    html += `
                                    </div>
                                    
                                    <div style="margin-bottom: 30px;">
                                        <h4 style="color: #667eea; margin-bottom: 10px;"><img src="/static/icons/medical/check-circle.svg" alt="Completados" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Cobros Completados (${totalCompletados})</h4>
                    `;
                    
                    if (totalCompletados > 0) {
                        // Ordenar residencias por ID
                        const residenciasOrdenadas = Object.keys(cobrosCompletadosPorResidencia)
                            .map(id => parseInt(id))
                            .sort((a, b) => a - b);
                        
                        residenciasOrdenadas.forEach(idRes => {
                            const grupo = cobrosCompletadosPorResidencia[idRes];
                        html += `
                                <div style="margin-bottom: 30px;">
                                    <h5 style="color: #28a745; margin-bottom: 15px; padding: 10px; background: #f0fff4; border-radius: 8px; border-left: 4px solid #28a745;">
                                        🏢 ${grupo.nombre_residencia} (${grupo.cobros.length} cobros completados)
                                    </h5>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Residente</th>
                                        <th>Monto</th>
                                                <th>Concepto</th>
                                                <th>Tipo Pago</th>
                                        <th>Fecha Prevista</th>
                                        <th>Fecha de Pago</th>
                                        <th>Estado</th>
                                                <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                            let totalGrupo = 0;
                            grupo.cobros.forEach(cobro => {
                            const fechaPrevista = cobro.fecha_prevista ? fechaISOToEspanol(cobro.fecha_prevista) : '-';
                            const fechaPago = cobro.fecha_pago ? fechaISOToEspanol(cobro.fecha_pago) : '-';
                                const concepto = cobro.concepto || 'Pago mensual habitación';
                                const tipoPago = cobro.metodo_pago || '-';
                                totalGrupo += parseFloat(cobro.monto) || 0;
                                
                                // Verificar si la fecha prevista ya pasó (aunque esté cobrado, para referencia histórica)
                                let fechaPrevistaStyle = 'color: #333;';
                                if (cobro.fecha_prevista) {
                                    const fechaPrevistaDate = new Date(cobro.fecha_prevista);
                                    const hoy = new Date();
                                    hoy.setHours(0, 0, 0, 0);
                                    fechaPrevistaDate.setHours(0, 0, 0, 0);
                                    if (fechaPrevistaDate < hoy) {
                                        fechaPrevistaStyle = 'color: #dc3545; font-weight: 600;';
                                    }
                                }
                                
                            html += `
                                <tr style="cursor: pointer;" onclick="editarCobro(${cobro.id_pago})" title="Haz clic para editar">
                                    <td style="color: #333;">${cobro.residente}</td>
                                        <td style="color: #333;">${Math.round(parseFloat(cobro.monto))}€</td>
                                        <td style="color: #333;">${concepto}</td>
                                        <td style="color: #333;">${tipoPago}</td>
                                    <td style="${fechaPrevistaStyle}">${fechaPrevista}</td>
                                    <td style="color: #333;">${fechaPago}</td>
                                        <td><span style="color: #28a745; font-weight: 600;">Cobrado</span></td>
                                        <td onclick="event.stopPropagation();">
                                            <button onclick="cambiarEstadoCobro(${cobro.id_pago}, 'pendiente')" style="padding: 4px 8px; background: #ffc107; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Revertir</button>
                                        </td>
                                </tr>
                            `;
                        });
                        
                            html += `
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #e0e0e0;">
                                                <td style="padding: 10px; text-align: right; color: #28a745;">Total:</td>
                                                <td style="padding: 10px; text-align: left; color: #28a745; font-weight: 600;">${Math.round(totalGrupo)}€</td>
                                                <td colspan="6"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p style="color: #333;">No hay cobros completados.</p>';
                    }
                    
                    html += `
                                    </div>
                                    
                                    <!-- Gráfico de Estimación Mensual e Histórico -->
                                    <div style="margin-bottom: 30px; margin-top: 30px;">
                                        <h4 style="color: #667eea; margin-bottom: 15px;"><img src="/static/icons/medical/activity.svg" alt="Gráfico" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Estimación Mensual e Histórico de Cobros</h4>
                                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <canvas id="cobrosChart" style="max-height: 400px;"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pestaña de Pagos a Proveedores -->
                                <div id="tabPagos" class="tab-content">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <h4 style="color: #667eea; margin: 0;"><img src="/static/icons/medical/package.svg" alt="Proveedores" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Pagos a Proveedores (${proveedoresData.total || 0})</h4>
                                        <div style="display: flex; gap: 10px;">
                                            <button class="add-btn" onclick="abrirModalListaProveedores()" style="padding: 8px 16px; font-size: 14px; background: #17a2b8;">Ver Proveedores</button>
                                            <button class="add-btn" onclick="resetProveedorForm(); openModal('modalProveedor');" style="padding: 8px 16px; font-size: 14px; background: #6c757d;">+ Proveedor</button>
                                            <button class="add-btn" onclick="openModalProveedor()" style="padding: 8px 16px; font-size: 14px;">+ Pago Proveedor</button>
                                        </div>
                                    </div>
                    `;
                    
                    if (proveedoresData.pagos && proveedoresData.pagos.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Proveedor</th>
                                        <th>Concepto</th>
                                        <th>Monto</th>
                                        <th>Fecha Prevista</th>
                                        <th>Estado</th>
                                        <th>Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        let totalPagos = 0;
                        proveedoresData.pagos.forEach(pago => {
                            const estadoPago = (pago.estado || 'pendiente').toLowerCase();
                            const tipo = estadoPago === 'pagado' ? '<img src="/static/icons/medical/check-circle.svg" alt="Pagado" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"> Pagado' : '<img src="/static/icons/medical/clock.svg" alt="Pendiente" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"> Pendiente';
                            const metodoPago = pago.metodo_pago || pago.tipo_pago || '-';
                            const monto = parseFloat(pago.monto || pago.monto_estimado || 0);
                            totalPagos += monto;
                            html += `
                                <tr style="cursor: pointer;" onclick="editarPagoProveedor(${pago.id_pago})" title="Haz clic para editar">
                                    <td>${pago.proveedor}</td>
                                    <td>${pago.concepto}</td>
                                    <td>${Math.round(monto)}€</td>
                                    <td>${pago.fecha_prevista || pago.fecha_pago || '-'}</td>
                                    <td>${tipo}</td>
                                    <td>${metodoPago}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                </tbody>
                                <tfoot>
                                    <tr style="background: #f8f9fa; font-weight: 600; border-top: 2px solid #e0e0e0;">
                                        <td style="padding: 10px; text-align: right; color: #667eea;">Total:</td>
                                        <td style="padding: 10px; text-align: left; color: #667eea; font-weight: 600;">${Math.round(totalPagos)}€</td>
                                        <td colspan="4"></td>
                                    </tr>
                                </tfoot>
                            </table>`;
                    } else {
                        html += '<p style="color: #333;">No hay pagos a proveedores registrados.</p>';
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                    content.innerHTML = html;
                    
                    // Cargar y mostrar gráfico de cobros
                    await loadCobrosChart();
                } else {
                    // Manejar errores específicos
                    let errorMsg = 'Error al cargar facturación.';
                    if (cobrosRes.status === 401 || proveedoresRes.status === 401) {
                        errorMsg = 'Sesión expirada. Por favor, <a href="javascript:location.reload()">recarga la página</a> para iniciar sesión nuevamente.';
                        localStorage.removeItem('violetas_token');
                    } else {
                        if (!cobrosRes.ok) {
                            errorMsg += ` Error al cargar cobros (${cobrosRes.status}): ${cobrosData?.error || 'Error desconocido'}.`;
                        }
                        if (!proveedoresRes.ok) {
                            errorMsg += ` Error al cargar proveedores (${proveedoresRes.status}): ${proveedoresData?.error || 'Error desconocido'}.`;
                        }
                    }
                    content.innerHTML = `<div class="module-content"><p style="color: red;">${errorMsg}</p></div>`;
                    console.error('Error al cargar facturación:', {
                        cobros: { status: cobrosRes.status, data: cobrosData },
                        proveedores: { status: proveedoresRes.status, data: proveedoresData }
                    });
                }
            } catch (error) {
                console.error('Error de conexión al cargar facturación:', error);
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexión: ${error.message}. Verifica que el servidor esté corriendo.</p></div>`;
            }
        }
        
        async function cambiarEstadoCobro(idPago, nuevoEstado) {
            const token = localStorage.getItem('violetas_token');
            
            const mensaje = nuevoEstado === 'cobrado' 
                ? '¿Está seguro de marcar este cobro como cobrado?'
                : '¿Está seguro de revertir este cobro a pendiente?';
            
            if (!confirm(mensaje)) {
                return;
            }
            
            try {
                // Preparar datos para actualizar
                const data = {
                    estado: nuevoEstado
                };
                
                // Si se marca como cobrado, establecer la fecha de pago a hoy
                if (nuevoEstado === 'cobrado') {
                    const hoy = new Date();
                    const fechaHoy = hoy.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                    data.fecha_pago = fechaHoy;
                } else if (nuevoEstado === 'pendiente') {
                    // Si se revierte a pendiente, limpiar fecha de pago
                    data.fecha_pago = null;
                }
                
                const response = await fetch(`${API_URL}/api/v1/facturacion/cobros/${idPago}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Recargar la lista de cobros
                    await loadFacturacion();
                } else {
                    alert('Error: ' + (result.error || 'Error al actualizar el cobro'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }
        
        // Variables para flatpickr de cobros
        let flatpickrCobroPrevista = null;
        let flatpickrCobroPago = null;
        
        // Variables para flatpickr de pagos a proveedores
        let flatpickrPagoProveedorFechaPago = null;
        let flatpickrPagoProveedorFechaPrevista = null;
        
        async function loadResidentesForCobro(residenteSeleccionadoId = null) {
            const token = localStorage.getItem('violetas_token');
            const select = document.getElementById('cobro_id_residente');
            
            if (!select) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.residentes) {
                    select.innerHTML = '<option value="">Seleccione un residente</option>';
                    data.residentes.forEach(res => {
                        // Mostrar si está activo O si es el residente seleccionado (incluso si está inactivo)
                        if (res.activo || (residenteSeleccionadoId && res.id_residente == residenteSeleccionadoId)) {
                            const option = document.createElement('option');
                            option.value = res.id_residente;
                            option.textContent = `${res.nombre} ${res.apellido}${!res.activo ? ' (Inactivo)' : ''}`;
                            
                            // Marcar como seleccionado si coincide
                            if (residenteSeleccionadoId && res.id_residente == residenteSeleccionadoId) {
                                option.selected = true;
                            }
                            
                            select.appendChild(option);
                        }
                    });
                    
                    // Inicializar conceptos con servicios predefinidos
                    actualizarConceptosCobro([]);
                    
                    // Añadir event listener para cargar servicios extra cuando cambie el residente
                    select.addEventListener('change', function() {
                        const idResidente = this.value;
                        if (idResidente) {
                            cargarServiciosExtraResidente(idResidente);
                        } else {
                            actualizarConceptosCobro([]);
                        }
                    });
                    
                    // Si hay un residente seleccionado, cargar sus servicios extra
                    if (residenteSeleccionadoId) {
                        await cargarServiciosExtraResidente(residenteSeleccionadoId);
                    }
                } else {
                    select.innerHTML = '<option value="">Error al cargar residentes</option>';
                }
            } catch (error) {
                console.error('Error al cargar residentes:', error);
                select.innerHTML = '<option value="">Error al cargar residentes</option>';
            }
        }

        async function cargarServiciosExtraResidente(idResidente) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.residente) {
                    const serviciosExtra = data.residente.servicios_extra || '';
                    // Parsear servicios extra (pueden estar separados por comas)
                    const servicios = serviciosExtra.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    actualizarConceptosCobro(servicios);
                } else {
                    actualizarConceptosCobro([]);
                }
            } catch (error) {
                console.error('Error al cargar servicios extra del residente:', error);
                actualizarConceptosCobro([]);
            }
        }

        function actualizarConceptosCobro(serviciosExtra) {
            const selectConcepto = document.getElementById('cobro_concepto');
            if (!selectConcepto) return;
            
            // Guardar el valor actual si existe
            const valorActual = selectConcepto.value;
            
            // Limpiar opciones
            selectConcepto.innerHTML = '<option value="">Seleccione un concepto</option>';
            
            // Añadir opción básica
            selectConcepto.innerHTML += '<option value="Pago mensual habitación">Pago mensual habitación</option>';
            
            // Servicios extra predefinidos que siempre aparecen
            const serviciosPredefinidos = ['Peluquería', 'Podólogo', 'Fisio', 'Farmacia'];
            serviciosPredefinidos.forEach(servicio => {
                const option = document.createElement('option');
                option.value = servicio;
                option.textContent = servicio;
                selectConcepto.appendChild(option);
            });
            
            // Añadir servicios extra del residente (si no están ya en los predefinidos)
            if (serviciosExtra && serviciosExtra.length > 0) {
                serviciosExtra.forEach(servicio => {
                    // Solo añadir si no está ya en los predefinidos
                    if (!serviciosPredefinidos.includes(servicio)) {
                        const option = document.createElement('option');
                        option.value = servicio;
                        option.textContent = servicio;
                        selectConcepto.appendChild(option);
                    }
                });
            }
            
            // Añadir opción "Otros" al final
            selectConcepto.innerHTML += '<option value="otros">Otros</option>';
            
            // Restaurar el valor anterior si existe
            if (valorActual && Array.from(selectConcepto.options).some(opt => opt.value === valorActual)) {
                selectConcepto.value = valorActual;
            }
        }

        function actualizarCampoConceptoOtros() {
            const selectConcepto = document.getElementById('cobro_concepto');
            const campoOtros = document.getElementById('cobro_concepto_otros');
            
            if (!selectConcepto || !campoOtros) return;
            
            if (selectConcepto.value === 'otros') {
                campoOtros.style.display = 'block';
                campoOtros.required = true;
            } else {
                campoOtros.style.display = 'none';
                campoOtros.required = false;
                campoOtros.value = '';
            }
        }
        
        function initializeCobroDatePickers() {
            const fechaPrevistaInput = document.getElementById('cobro_fecha_prevista');
            const fechaPagoInput = document.getElementById('cobro_fecha_pago');
            
            // Destruir instancias anteriores
            if (flatpickrCobroPrevista) {
                flatpickrCobroPrevista.destroy();
            }
            if (flatpickrCobroPago) {
                flatpickrCobroPago.destroy();
            }
            
            // Verificar si estamos editando (hay id_pago)
            const idPagoOculto = document.getElementById('cobro_id_pago');
            const esEdicion = idPagoOculto && idPagoOculto.value;
            
            // Inicializar flatpickr para fecha prevista
            if (fechaPrevistaInput) {
                // NO establecer fecha prevista por defecto
                // Solo se establece si el usuario la selecciona manualmente
                
                flatpickrCobroPrevista = flatpickr(fechaPrevistaInput, {
                    dateFormat: "d/m/Y",
                    locale: "es",
                    allowInput: true,
                    clickOpens: true,
                    defaultDate: fechaPrevistaInput.value || null,
                    onChange: function(selectedDates, dateStr, instance) {
                        if (dateStr) {
                            const partes = dateStr.split('/');
                            if (partes.length === 3) {
                                const dia = partes[0].padStart(2, '0');
                                const mes = partes[1].padStart(2, '0');
                                const año = partes[2];
                                instance.input.value = `${dia}/${mes}/${año}`;
                            }
                        }
                        // Si se selecciona una fecha prevista, borrar la fecha de pago automáticamente
                        if (dateStr && fechaPagoInput && flatpickrCobroPago) {
                            fechaPagoInput.value = '';
                            flatpickrCobroPago.clear();
                        }
                    }
                });
            }
            
            // Inicializar flatpickr para fecha de pago
            if (fechaPagoInput) {
                // Si no tiene valor y no estamos editando, establecerlo a hoy por defecto
                if (!fechaPagoInput.value && !esEdicion) {
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    fechaPagoInput.value = `${dia}/${mes}/${año}`;
                }
                
                flatpickrCobroPago = flatpickr(fechaPagoInput, {
                    dateFormat: "d/m/Y",
                    locale: "es",
                    allowInput: true,
                    clickOpens: true,
                    maxDate: "today",
                    defaultDate: fechaPagoInput.value || new Date(),
                    onChange: function(selectedDates, dateStr, instance) {
                        if (dateStr) {
                            const partes = dateStr.split('/');
                            if (partes.length === 3) {
                                const dia = partes[0].padStart(2, '0');
                                const mes = partes[1].padStart(2, '0');
                                const año = partes[2];
                                instance.input.value = `${dia}/${mes}/${año}`;
                            }
                        }
                        // Si se selecciona una fecha de pago, borrar la fecha prevista automáticamente
                        if (dateStr && fechaPrevistaInput && flatpickrCobroPrevista) {
                            fechaPrevistaInput.value = '';
                            flatpickrCobroPrevista.clear();
                        }
                    }
                });
            }
        }
        
        async function saveCobro(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveCobroBtn');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            const id_residente = formData.get('id_residente');
            
            if (!id_residente) {
                showCobroModalError('Debe seleccionar un residente');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Obtener el concepto (del select o del campo "otros")
            let concepto = formData.get('concepto');
            if (concepto === 'otros') {
                const conceptoOtros = document.getElementById('cobro_concepto_otros').value.trim();
                if (!conceptoOtros) {
                    showCobroModalError('Debe escribir el concepto personalizado');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }
                concepto = conceptoOtros;
            }
            
            if (!concepto) {
                showCobroModalError('Debe seleccionar o escribir un concepto');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Convertir fechas de formato español a ISO
            const fecha_pago_es = formData.get('fecha_pago');
            let fecha_prevista_es = formData.get('fecha_prevista');
            
            // Si no hay fecha prevista, establecerla a hoy por defecto
            if (!fecha_prevista_es) {
                const hoy = new Date();
                const dia = String(hoy.getDate()).padStart(2, '0');
                const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                const año = hoy.getFullYear();
                fecha_prevista_es = `${dia}/${mes}/${año}`;
                // Actualizar el campo en el formulario
                document.getElementById('cobro_fecha_prevista').value = fecha_prevista_es;
            }
            
            // Determinar si es cobro previsto: si NO tiene fecha_pago, es previsto
            const es_cobro_previsto = !fecha_pago_es || fecha_pago_es.trim() === '';
            
            // Validar fechas
            if (fecha_pago_es && !validarFechaEspanol(fecha_pago_es)) {
                showCobroModalError('La fecha de pago no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            if (fecha_prevista_es && !validarFechaEspanol(fecha_prevista_es)) {
                showCobroModalError('La fecha prevista no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Calcular mes_pagado desde fecha_prevista o fecha_pago
            let mes_pagado = null;
            if (fecha_prevista_es) {
                const partes = fecha_prevista_es.split('/');
                if (partes.length === 3) {
                    mes_pagado = `${partes[2]}-${partes[1]}`;
                }
            } else if (fecha_pago_es) {
                const partes = fecha_pago_es.split('/');
                if (partes.length === 3) {
                    mes_pagado = `${partes[2]}-${partes[1]}`;
                }
            }
            
            const data = {
                id_residente: parseInt(id_residente),
                monto: formData.get('monto') ? parseFloat(formData.get('monto')) : null,
                concepto: concepto,
                metodo_pago: formData.get('metodo_pago') || null,
                fecha_pago: fecha_pago_es ? fechaEspanolToISO(fecha_pago_es) : null,
                fecha_prevista: fecha_prevista_es ? fechaEspanolToISO(fecha_prevista_es) : null,
                mes_pagado: mes_pagado,
                es_cobro_previsto: es_cobro_previsto,  // Automático: true si no hay fecha_pago
                estado: fecha_pago_es ? 'cobrado' : 'pendiente',
                observaciones: formData.get('observaciones') || null
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideCobroModalAlert();
            
            try {
                const idPago = document.getElementById('cobro_id_pago').value;
                const url = idPago 
                    ? `${API_URL}/api/v1/facturacion/cobros/${idPago}`
                    : `${API_URL}/api/v1/facturacion/cobros`;
                const method = idPago ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showCobroModalSuccess(idPago ? 'Cobro actualizado exitosamente' : 'Cobro registrado exitosamente');
                    setTimeout(() => {
                        closeModal('modalCobro');
                        loadFacturacion(); // Recargar la lista
                    }, 1500);
                } else {
                    showCobroModalError(result.error || 'Error al guardar el cobro');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showCobroModalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }
        
        async function editarCobro(idPago) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/cobros/${idPago}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const contentType = response.headers.get('content-type');
                let cobro;
                
                if (contentType && contentType.includes('application/json')) {
                    cobro = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON al obtener cobro:', text);
                    showCobroModalError(`Error: No se pudo obtener el cobro. Status: ${response.status}`);
                    return;
                }
                
                if (response.ok) {
                    // Guardar el id_residente antes de cargar los residentes
                    const idResidenteSeleccionado = cobro.id_residente;
                    
                    // Cargar residentes pasando el ID seleccionado para asegurar que se seleccione
                    await loadResidentesForCobro(idResidenteSeleccionado);
                    
                    // Llenar el formulario con los datos del cobro
                    document.getElementById('cobro_id_pago').value = cobro.id_pago;
                    
                    // Asegurar que el valor esté establecido (redundancia por seguridad)
                    const selectResidente = document.getElementById('cobro_id_residente');
                    if (selectResidente) {
                        selectResidente.value = idResidenteSeleccionado;
                    }
                    
                    document.getElementById('cobro_monto').value = cobro.monto;
                    
                    // Establecer el concepto en el select o en "otros"
                    const selectConcepto = document.getElementById('cobro_concepto');
                    const campoOtros = document.getElementById('cobro_concepto_otros');
                    const concepto = cobro.concepto || '';
                    
                    // Cargar servicios extra del residente para tener todas las opciones disponibles
                    await cargarServiciosExtraResidente(idResidenteSeleccionado);
                    
                    // Verificar si el concepto está en las opciones del select
                    const opciones = Array.from(selectConcepto.options).map(opt => opt.value);
                    if (opciones.includes(concepto)) {
                        selectConcepto.value = concepto;
                        campoOtros.style.display = 'none';
                        campoOtros.value = '';
                    } else if (concepto) {
                        // Si no está en las opciones, usar "otros"
                        selectConcepto.value = 'otros';
                        campoOtros.style.display = 'block';
                        campoOtros.value = concepto;
                    } else {
                        selectConcepto.value = '';
                        campoOtros.style.display = 'none';
                        campoOtros.value = '';
                    }
                    
                    document.getElementById('cobro_metodo_pago').value = cobro.metodo_pago || '';
                    document.getElementById('cobro_observaciones').value = cobro.observaciones || '';
                    
                    // Convertir fechas de ISO a formato español
                    if (cobro.fecha_prevista) {
                        document.getElementById('cobro_fecha_prevista').value = fechaISOToEspanol(cobro.fecha_prevista);
                    } else {
                        // Si no hay fecha prevista, establecerla a hoy
                        const hoy = new Date();
                        const dia = String(hoy.getDate()).padStart(2, '0');
                        const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                        const año = hoy.getFullYear();
                        document.getElementById('cobro_fecha_prevista').value = `${dia}/${mes}/${año}`;
                    }
                    if (cobro.fecha_pago) {
                        document.getElementById('cobro_fecha_pago').value = fechaISOToEspanol(cobro.fecha_pago);
                    }
                    
                    // Cambiar título del modal
                    document.getElementById('modalCobroTitulo').innerHTML = '<img src="/static/icons/medical/bill.svg" alt="Cobro" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Editar Cobro';
                    
                    // Mostrar botón de eliminar cuando se está editando
                    const deleteBtn = document.getElementById('deleteCobroBtn');
                    if (deleteBtn) {
                        deleteBtn.style.display = 'block';
                    }
                    
                    // Abrir modal primero
                    document.getElementById('modalCobro').style.display = 'block';
                    
                    // Inicializar date pickers
                    initializeCobroDatePickers();
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        showCobroModalError('Sesión expirada. Por favor, recarga la página para iniciar sesión nuevamente.');
                        localStorage.removeItem('violetas_token');
                    } else if (response.status === 404) {
                        showCobroModalError('El cobro no se encontró. Puede que haya sido eliminado o no tengas permisos para verlo.');
                        console.error('Cobro no encontrado:', cobro.error || 'Error desconocido');
                    } else {
                        showCobroModalError('Error al obtener el cobro: ' + (cobro.error || `Error ${response.status}`));
                        console.error('Error al obtener cobro:', response.status, cobro);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al obtener cobro:', error);
                showCobroModalError('Error de conexión: ' + error.message + '. Verifica que el servidor esté corriendo.');
            }
        }
        
        function showCobroModalError(message) {
            const alert = document.getElementById('modalCobroAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function showCobroModalSuccess(message) {
            const alert = document.getElementById('modalCobroAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function hideCobroModalAlert() {
            const alert = document.getElementById('modalCobroAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }
        
        function confirmarEliminarCobro() {
            const idPago = document.getElementById('cobro_id_pago').value;
            
            if (!idPago) {
                showCobroModalError('No se puede eliminar: no hay cobro seleccionado');
                return;
            }
            
            if (!confirm('¿Está seguro de que desea eliminar este cobro? Esta acción no se puede deshacer.')) {
                return;
            }
            
            eliminarCobro(idPago);
        }
        
        async function eliminarCobro(idPago) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/cobros/${idPago}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON al eliminar cobro:', text);
                    showCobroModalError(`Error: No se pudo eliminar el cobro. Status: ${response.status}`);
                    return;
                }
                
                if (response.ok) {
                    showCobroModalSuccess('Cobro eliminado exitosamente');
                    setTimeout(() => {
                        closeModal('modalCobro');
                        loadFacturacion(); // Recargar la lista
                    }, 1500);
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        showCobroModalError('Sesión expirada. Por favor, recarga la página para iniciar sesión nuevamente.');
                        localStorage.removeItem('violetas_token');
                    } else {
                        showCobroModalError('Error: ' + (result.error || 'Error al eliminar el cobro'));
                        console.error('Error al eliminar cobro:', response.status, result);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al eliminar cobro:', error);
                showCobroModalError('Error de conexión: ' + error.message + '. Verifica que el servidor esté corriendo.');
            }
        }
        
        async function openModalProveedor() {
            // Resetear formulario para nuevo pago
            resetPagoProveedorForm();
            // Cargar proveedores antes de abrir el modal
            await loadProveedoresForSelect();
            openModal('modalPagoProveedor');
            // Inicializar date pickers
            initializePagoProveedorDatePickers();
        }
        
        function resetPagoProveedorForm() {
            // Limpiar el formulario y restablecer el título
            document.getElementById('formPagoProveedor').reset();
            document.getElementById('pago_id_pago').value = '';
            
            // Restablecer título del modal
            const modalHeader = document.querySelector('#modalPagoProveedor .modal-header h2');
            if (modalHeader) {
                modalHeader.innerHTML = '<img src="/static/icons/medical/money.svg" alt="Pago" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Pago a Proveedor';
            }
            
            // Limpiar alertas
            hidePagoProveedorModalAlert();
        }
        
        function initializePagoProveedorDatePickers() {
            const fechaPagoInput = document.getElementById('pago_fecha_pago');
            const fechaPrevistaInput = document.getElementById('pago_fecha_prevista');
            
            // Destruir instancias anteriores
            if (flatpickrPagoProveedorFechaPago) {
                flatpickrPagoProveedorFechaPago.destroy();
            }
            if (flatpickrPagoProveedorFechaPrevista) {
                flatpickrPagoProveedorFechaPrevista.destroy();
            }
            
            // Inicializar flatpickr para fecha de pago
            if (fechaPagoInput) {
                // Establecer fecha de hoy por defecto si no tiene valor y no estamos editando
                const idPago = document.getElementById('pago_id_pago').value;
                if (!fechaPagoInput.value && !idPago) {
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    fechaPagoInput.value = `${dia}/${mes}/${año}`;
                }
                
                flatpickrPagoProveedorFechaPago = flatpickr(fechaPagoInput, {
                    dateFormat: "d/m/Y",
                    locale: "es",
                    allowInput: true,
                    clickOpens: true,
                    maxDate: "today",
                    defaultDate: fechaPagoInput.value || "today",
                    onChange: function(selectedDates, dateStr, instance) {
                        if (dateStr) {
                            const partes = dateStr.split('/');
                            if (partes.length === 3) {
                                const dia = partes[0].padStart(2, '0');
                                const mes = partes[1].padStart(2, '0');
                                const año = partes[2];
                                instance.input.value = `${dia}/${mes}/${año}`;
                            }
                            // Si se selecciona fecha de pago, limpiar fecha prevista
                            if (fechaPrevistaInput && flatpickrPagoProveedorFechaPrevista) {
                                fechaPrevistaInput.value = '';
                                flatpickrPagoProveedorFechaPrevista.clear();
                            }
                        }
                    }
                });
            }
            
            // Inicializar flatpickr para fecha prevista
            if (fechaPrevistaInput) {
                flatpickrPagoProveedorFechaPrevista = flatpickr(fechaPrevistaInput, {
                    dateFormat: "d/m/Y",
                    locale: "es",
                    allowInput: true,
                    clickOpens: true,
                    defaultDate: fechaPrevistaInput.value || null,
                    onChange: function(selectedDates, dateStr, instance) {
                        if (dateStr) {
                            const partes = dateStr.split('/');
                            if (partes.length === 3) {
                                const dia = partes[0].padStart(2, '0');
                                const mes = partes[1].padStart(2, '0');
                                const año = partes[2];
                                instance.input.value = `${dia}/${mes}/${año}`;
                            }
                            // Si se selecciona fecha prevista, limpiar fecha de pago
                            if (fechaPagoInput && flatpickrPagoProveedorFechaPago) {
                                fechaPagoInput.value = '';
                                flatpickrPagoProveedorFechaPago.clear();
                            }
                        }
                    }
                });
            }
        }
        
        // Función para abrir el modal de dar de baja
        function abrirModalBaja(idResidente) {
            document.getElementById('baja_id_residente').value = idResidente;
            document.getElementById('baja_motivo').value = '';
            document.getElementById('baja_observaciones').value = '';
            document.getElementById('modalBajaAlert').style.display = 'none';
            openModal('modalBajaResidente');
        }
        
        // Función para confirmar la baja de un residente
        async function confirmarBajaResidente(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const confirmarBtn = document.getElementById('confirmarBajaBtn');
            const originalText = confirmarBtn.textContent;
            
            const formData = new FormData(form);
            const idResidente = formData.get('id_residente');
            const motivoBaja = formData.get('motivo_baja');
            const observaciones = formData.get('observaciones');
            
            if (!motivoBaja) {
                showBajaModalError('Debe seleccionar un motivo de baja');
                return;
            }
            
            confirmarBtn.disabled = true;
            confirmarBtn.textContent = 'Procesando...';
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/baja`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        motivo_baja: motivoBaja,
                        observaciones: observaciones || null
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showBajaModalSuccess('Residente dado de baja exitosamente');
                    setTimeout(() => {
                        closeModal('modalBajaResidente');
                        closeModal('modalViewResidente');
                        loadResidentes(); // Recargar la lista
                    }, 1500);
                } else {
                    showBajaModalError(result.error || 'Error al dar de baja al residente');
                    confirmarBtn.disabled = false;
                    confirmarBtn.textContent = originalText;
                }
            } catch (error) {
                showBajaModalError('Error de conexión: ' + error.message);
                confirmarBtn.disabled = false;
                confirmarBtn.textContent = originalText;
            }
        }
        
        // Funciones para mostrar/ocultar alertas en el modal de baja
        function showBajaModalError(message) {
            const alert = document.getElementById('modalBajaAlert');
            alert.className = 'alert error';
            alert.textContent = message;
            alert.style.display = 'block';
        }
        
        function showBajaModalSuccess(message) {
            const alert = document.getElementById('modalBajaAlert');
            alert.className = 'alert success';
            alert.textContent = message;
            alert.style.display = 'block';
        }
        
        function hideBajaModalAlert() {
            document.getElementById('modalBajaAlert').style.display = 'none';
        }
        
        async function reactivarResidente(idResidente) {
            if (!confirm('¿Está seguro de que desea reactivar a este residente? La baja se eliminó por error.')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/alta`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON:', text);
                    alert('Error: No se pudo reactivar al residente. Status: ' + response.status);
                    return;
                }
                
                if (response.ok) {
                    alert('Residente reactivado exitosamente');
                    closeModal('modalViewResidente');
                    loadResidentes();
                } else {
                    alert('Error: ' + (result.error || 'Error al reactivar al residente'));
                }
            } catch (error) {
                console.error('Error al reactivar residente:', error);
                alert('Error de conexión: ' + error.message);
            }
        }
        
        function confirmarEliminarResidente(idResidente) {
            if (!confirm('⚠️ ADVERTENCIA: Esta acción es IRREVERSIBLE.\n\n¿Está seguro de que desea eliminar completamente a este residente?\n\nEsto eliminará todos los datos del residente de la base de datos.')) {
                return;
            }
            
            // Confirmación adicional
            if (!confirm('Esta acción NO se puede deshacer. ¿Está completamente seguro?')) {
                return;
            }
            
            eliminarResidente(idResidente);
        }
        
        async function eliminarResidente(idResidente) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON:', text);
                    alert('Error: No se pudo eliminar al residente. Status: ' + response.status);
                    return;
                }
                
                if (response.ok) {
                    alert('Residente eliminado completamente');
                    closeModal('modalViewResidente');
                    loadResidentes();
                } else {
                    alert('Error: ' + (result.error || 'Error al eliminar al residente'));
                }
            } catch (error) {
                console.error('Error al eliminar residente:', error);
                alert('Error de conexión: ' + error.message);
            }
        }
        
        function openModalProveedorNuevo() {
            // Abrir modal de nuevo proveedor
            event.stopPropagation();
            event.preventDefault();
            resetProveedorForm();
            openModal('modalProveedor');
        }
        
        function resetProveedorForm() {
            // Limpiar el formulario y restablecer el título
            document.getElementById('formProveedor').reset();
            document.getElementById('prov_id_proveedor').value = '';
            document.getElementById('prov_activo').checked = true;
            
            // Restablecer título del modal
            const modalHeader = document.querySelector('#modalProveedor .modal-header h2');
            if (modalHeader) {
                modalHeader.innerHTML = '<img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Proveedor';
            }
            
            // Limpiar alertas
            hideProveedorModalAlert();
        }

        async function loadProveedoresForSelect() {
            const token = localStorage.getItem('violetas_token');
            const select = document.getElementById('pago_id_proveedor');
            
            if (!select) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/proveedores`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    console.error('Respuesta de proveedores no es JSON');
                    select.innerHTML = '<option value="">Error al cargar proveedores</option>';
                    return;
                }
                
                if (response.ok && data.proveedores) {
                    select.innerHTML = '<option value="">Seleccione un proveedor</option>';
                    data.proveedores.filter(p => p.activo).forEach(prov => {
                        select.innerHTML += `<option value="${prov.id_proveedor}">${prov.nombre}${prov.tipo_servicio ? ' - ' + prov.tipo_servicio : ''}</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">No hay proveedores disponibles</option>';
                    if (!response.ok) {
                        console.error('Error al cargar proveedores:', response.status, data.error);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al cargar proveedores:', error);
                select.innerHTML = '<option value="">Error al cargar proveedores</option>';
            }
        }

        async function abrirModalListaProveedores() {
            const token = localStorage.getItem('violetas_token');
            const content = document.getElementById('listaProveedoresContent');
            
            // Mostrar loading
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 15px; color: #666;">Cargando proveedores...</p>
                </div>
            `;
            
            // Abrir modal
            openModal('modalListaProveedores');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/proveedores`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    content.innerHTML = `<p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${response.status}</p>`;
                    return;
                }
                
                if (response.ok && data.proveedores) {
                    if (data.proveedores.length > 0) {
                        let html = `
                            <div style="margin-bottom: 20px;">
                                <p style="color: #666; margin-bottom: 15px;">Total de proveedores: <strong>${data.proveedores.length}</strong></p>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Tipo de Servicio</th>
                                            <th>NIF/CIF</th>
                                            <th>Teléfono</th>
                                            <th>Email</th>
                                            <th>Contacto</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        data.proveedores.forEach(prov => {
                            const estado = prov.activo ? 
                                '<span style="color: #28a745; font-weight: 600;">✅ Activo</span>' : 
                                '<span style="color: #dc3545; font-weight: 600;">❌ Inactivo</span>';
                            
                            // Verificar que id_proveedor existe
                            if (!prov.id_proveedor) {
                                console.error('Proveedor sin id_proveedor:', prov);
                                return; // Saltar este proveedor
                            }
                            
                            html += `
                                <tr style="cursor: pointer;" onclick="editarProveedor(${prov.id_proveedor})" title="Haz clic para editar">
                                    <td style="color: #333; font-weight: 600;">${prov.nombre || '-'}</td>
                                    <td style="color: #333;">${prov.tipo_servicio || '-'}</td>
                                    <td style="color: #333;">${prov.nif_cif || '-'}</td>
                                    <td style="color: #333;">${prov.telefono || '-'}</td>
                                    <td style="color: #333;">${prov.email || '-'}</td>
                                    <td style="color: #333;">${prov.contacto || '-'}</td>
                                    <td>${estado}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        // Añadir información adicional si hay observaciones o dirección
                        const proveedoresConInfo = data.proveedores.filter(p => p.observaciones || p.direccion);
                        if (proveedoresConInfo.length > 0) {
                            html += `<div style="margin-top: 30px;"><h4 style="color: #667eea; margin-bottom: 15px;">Información Adicional</h4>`;
                            proveedoresConInfo.forEach(prov => {
                                html += `
                                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                                        <strong style="color: #667eea;">${prov.nombre}</strong>
                                        ${prov.direccion ? `<p style="margin: 5px 0; color: #666;"><strong>Dirección:</strong> ${prov.direccion}</p>` : ''}
                                        ${prov.observaciones ? `<p style="margin: 5px 0; color: #666;"><strong>Observaciones:</strong> ${prov.observaciones}</p>` : ''}
                                    </div>
                                `;
                            });
                            html += `</div>`;
                        }
                        
                        content.innerHTML = html;
                    } else {
                        content.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 40px;">No hay proveedores registrados.</p>';
                    }
                } else {
                    content.innerHTML = `<p style="color: red;">Error (${response.status}): ${data.error || 'Error desconocido'}</p>`;
                }
            } catch (error) {
                console.error('Error de conexión al cargar proveedores:', error);
                content.innerHTML = `<p style="color: red;">Error de conexión: ${error.message}</p>`;
            }
        }

        async function saveProveedor(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveProveedorBtn');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            const activoCheckbox = document.getElementById('prov_activo');
            
            const data = {
                nombre: formData.get('nombre'),
                nif_cif: formData.get('nif_cif') || null,
                direccion: formData.get('direccion') || null,
                telefono: formData.get('telefono') || null,
                email: formData.get('email') || null,
                contacto: formData.get('contacto') || null,
                tipo_servicio: formData.get('tipo_servicio') || null,
                activo: activoCheckbox ? activoCheckbox.checked : true,
                observaciones: formData.get('observaciones') || null
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideProveedorModalAlert();
            
            const idProveedor = document.getElementById('prov_id_proveedor').value;
            const method = idProveedor ? 'PUT' : 'POST';
            const url = idProveedor ? `${API_URL}/api/v1/proveedores/${idProveedor}` : `${API_URL}/api/v1/proveedores`;
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showProveedorModalSuccess(idProveedor ? 'Proveedor actualizado exitosamente' : 'Proveedor agregado exitosamente');
                    // Guardar si el modal de pago estaba abierto antes de abrir el de proveedor
                    const modalPagoEstabaAbierto = sessionStorage.getItem('modalPagoAbierto') === 'true';
                    const modalListaEstabaAbierto = document.getElementById('modalListaProveedores').style.display === 'block';
                    
                    setTimeout(() => {
                        closeModal('modalProveedor');
                        // Si el modal de pago estaba abierto, volver a abrirlo y recargar proveedores
                        if (modalPagoEstabaAbierto) {
                            setTimeout(async () => {
                                await loadProveedoresForSelect();
                                openModal('modalPagoProveedor');
                                sessionStorage.removeItem('modalPagoAbierto');
                            }, 100);
                        }
                        // Si el modal de lista estaba abierto, recargarlo
                        if (modalListaEstabaAbierto) {
                            setTimeout(async () => {
                                await abrirModalListaProveedores();
                            }, 100);
                        }
                        // Recargar proveedores en el select si existe
                        const selectProveedor = document.getElementById('pago_id_proveedor');
                        if (selectProveedor) {
                            loadProveedoresForSelect();
                        }
                    }, 1500);
                } else {
                    showProveedorModalError(result.error || 'Error al guardar el proveedor');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showProveedorModalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        async function editarProveedor(idProveedor) {
            console.log('editarProveedor llamado con id:', idProveedor);
            
            if (!idProveedor) {
                console.error('idProveedor no está definido');
                showProveedorModalError('Error: ID de proveedor no válido');
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            if (!token) {
                showProveedorModalError('No hay sesión activa. Por favor, inicia sesión nuevamente.');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/v1/proveedores/${idProveedor}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Respuesta del servidor:', response.status);
                
                const contentType = response.headers.get('content-type');
                let proveedor;
                
                if (contentType && contentType.includes('application/json')) {
                    proveedor = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON al obtener proveedor:', text);
                    showProveedorModalError(`Error: No se pudo obtener el proveedor. Status: ${response.status}`);
                    return;
                }
                
                if (response.ok) {
                    console.log('Proveedor obtenido:', proveedor);
                    
                    // Llenar el formulario con los datos del proveedor
                    const idProveedorInput = document.getElementById('prov_id_proveedor');
                    if (!idProveedorInput) {
                        console.error('No se encontró el campo prov_id_proveedor');
                        showProveedorModalError('Error: No se pudo encontrar el formulario de edición');
                        return;
                    }
                    
                    idProveedorInput.value = proveedor.id_proveedor;
                    document.getElementById('prov_nombre').value = proveedor.nombre || '';
                    document.getElementById('prov_nif_cif').value = proveedor.nif_cif || '';
                    document.getElementById('prov_tipo_servicio').value = proveedor.tipo_servicio || '';
                    document.getElementById('prov_telefono').value = proveedor.telefono || '';
                    document.getElementById('prov_email').value = proveedor.email || '';
                    document.getElementById('prov_direccion').value = proveedor.direccion || '';
                    document.getElementById('prov_contacto').value = proveedor.contacto || '';
                    document.getElementById('prov_observaciones').value = proveedor.observaciones || '';
                    document.getElementById('prov_activo').checked = proveedor.activo !== false;
                    
                    // Cambiar título del modal
                    const modalHeader = document.querySelector('#modalProveedor .modal-header h2');
                    if (modalHeader) {
                        modalHeader.innerHTML = '<img src="/static/icons/medical/settings.svg" alt="Editar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Editar Proveedor';
                    }
                    
                    // Cerrar el modal de lista si está abierto
                    closeModal('modalListaProveedores');
                    
                    // Abrir modal de edición
                    openModal('modalProveedor');
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        showProveedorModalError('Sesión expirada. Por favor, recarga la página para iniciar sesión nuevamente.');
                        localStorage.removeItem('violetas_token');
                    } else if (response.status === 404) {
                        showProveedorModalError('El proveedor no se encontró. Puede que haya sido eliminado o no tengas permisos para verlo.');
                        console.error('Proveedor no encontrado:', proveedor.error || 'Error desconocido');
                    } else {
                        showProveedorModalError('Error al obtener el proveedor: ' + (proveedor.error || `Error ${response.status}`));
                        console.error('Error al obtener proveedor:', response.status, proveedor);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al obtener proveedor:', error);
                showProveedorModalError('Error de conexión: ' + error.message + '. Verifica que el servidor esté corriendo.');
            }
        }

        async function savePagoProveedor(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('savePagoProveedorBtn');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            const id_proveedor = formData.get('id_proveedor');
            
            if (!id_proveedor) {
                showPagoProveedorModalError('Debe seleccionar un proveedor');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Obtener nombre del proveedor del select
            const selectProveedor = document.getElementById('pago_id_proveedor');
            const nombreProveedor = selectProveedor.options[selectProveedor.selectedIndex].text.split(' - ')[0];
            
            // Convertir fechas de formato español a ISO
            const fecha_pago_es = formData.get('fecha_pago');
            const fecha_prevista_es = formData.get('fecha_prevista');
            
            // Validar fechas
            if (fecha_pago_es && !validarFechaEspanol(fecha_pago_es)) {
                showPagoProveedorModalError('La fecha de pago no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            if (fecha_prevista_es && !validarFechaEspanol(fecha_prevista_es)) {
                showPagoProveedorModalError('La fecha prevista no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Calcular estado automáticamente basado en las fechas
            // Si tiene fecha_pago → pagado, si tiene fecha_prevista → pendiente
            let estado;
            if (fecha_pago_es) {
                estado = 'pagado';
            } else if (fecha_prevista_es) {
                estado = 'pendiente';
            } else {
                estado = 'pendiente'; // Por defecto
            }
            
            const idPago = document.getElementById('pago_id_pago').value;
            const method = idPago ? 'PUT' : 'POST';
            const url = idPago ? `${API_URL}/api/v1/facturacion/proveedores/${idPago}` : `${API_URL}/api/v1/facturacion/proveedores`;
            
            const data = {
                proveedor: nombreProveedor,
                concepto: formData.get('concepto'),
                monto: formData.get('monto') ? parseFloat(formData.get('monto')) : null,
                fecha_pago: fecha_pago_es ? fechaEspanolToISO(fecha_pago_es) : null,
                fecha_prevista: fecha_prevista_es ? fechaEspanolToISO(fecha_prevista_es) : null,
                metodo_pago: formData.get('metodo_pago') || null,
                numero_factura: formData.get('numero_factura') || null,
                estado: estado,
                observaciones: formData.get('observaciones') || null
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hidePagoProveedorModalAlert();
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showPagoProveedorModalSuccess(idPago ? 'Pago a proveedor actualizado exitosamente' : 'Pago a proveedor registrado exitosamente');
                    setTimeout(() => {
                        closeModal('modalPagoProveedor');
                        loadFacturacion(); // Recargar la lista
                    }, 1500);
                } else {
                    showPagoProveedorModalError(result.error || 'Error al guardar el pago');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showPagoProveedorModalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        async function editarPagoProveedor(idPago) {
            const token = localStorage.getItem('violetas_token');
            
            if (!idPago) {
                console.error('idPago no está definido');
                showPagoProveedorModalError('Error: ID de pago no válido');
                return;
            }
            
            if (!token) {
                showPagoProveedorModalError('No hay sesión activa. Por favor, inicia sesión nuevamente.');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/proveedores/${idPago}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let pago;
                
                if (contentType && contentType.includes('application/json')) {
                    pago = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON al obtener pago:', text);
                    showPagoProveedorModalError(`Error: No se pudo obtener el pago. Status: ${response.status}`);
                    return;
                }
                
                if (response.ok) {
                    // Guardar el nombre del proveedor antes de cargar los proveedores
                    const nombreProveedorSeleccionado = pago.proveedor;
                    
                    // Cargar proveedores para el select
                    await loadProveedoresForSelect();
                    
                    // Llenar el formulario con los datos del pago
                    document.getElementById('pago_id_pago').value = pago.id_pago;
                    
                    // Seleccionar el proveedor en el select
                    const selectProveedor = document.getElementById('pago_id_proveedor');
                    if (selectProveedor) {
                        // Buscar el proveedor por nombre
                        for (let i = 0; i < selectProveedor.options.length; i++) {
                            const optionText = selectProveedor.options[i].text;
                            if (optionText.includes(nombreProveedorSeleccionado)) {
                                selectProveedor.value = selectProveedor.options[i].value;
                                break;
                            }
                        }
                    }
                    
                    document.getElementById('pago_concepto').value = pago.concepto || '';
                    document.getElementById('pago_monto').value = pago.monto || '';
                    document.getElementById('pago_metodo_pago').value = pago.metodo_pago || '';
                    document.getElementById('pago_numero_factura').value = pago.numero_factura || '';
                    document.getElementById('pago_observaciones').value = pago.observaciones || '';
                    
                    // Convertir fechas de ISO a formato español
                    if (pago.fecha_prevista) {
                        document.getElementById('pago_fecha_prevista').value = fechaISOToEspanol(pago.fecha_prevista);
                    } else {
                        document.getElementById('pago_fecha_prevista').value = '';
                    }
                    
                    if (pago.fecha_pago) {
                        document.getElementById('pago_fecha_pago').value = fechaISOToEspanol(pago.fecha_pago);
                    } else {
                        document.getElementById('pago_fecha_pago').value = '';
                    }
                    
                    // Cambiar título del modal
                    const modalHeader = document.querySelector('#modalPagoProveedor .modal-header h2');
                    if (modalHeader) {
                        modalHeader.innerHTML = '<img src="/static/icons/medical/settings.svg" alt="Editar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Editar Pago a Proveedor';
                    }
                    
                    // Inicializar date pickers
                    initializePagoProveedorDatePickers();
                    
                    // Abrir modal de edición
                    openModal('modalPagoProveedor');
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        showPagoProveedorModalError('Sesión expirada. Por favor, recarga la página para iniciar sesión nuevamente.');
                        localStorage.removeItem('violetas_token');
                    } else if (response.status === 404) {
                        showPagoProveedorModalError('El pago no se encontró. Puede que haya sido eliminado o no tengas permisos para verlo.');
                        console.error('Pago no encontrado:', pago.error || 'Error desconocido');
                    } else {
                        showPagoProveedorModalError('Error al obtener el pago: ' + (pago.error || `Error ${response.status}`));
                        console.error('Error al obtener pago:', response.status, pago);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al obtener pago:', error);
                showPagoProveedorModalError('Error de conexión: ' + error.message + '. Verifica que el servidor esté corriendo.');
            }
        }

        function showProveedorModalError(message) {
            const alert = document.getElementById('modalProveedorAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showProveedorModalSuccess(message) {
            const alert = document.getElementById('modalProveedorAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideProveedorModalAlert() {
            const alert = document.getElementById('modalProveedorAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        function showPagoProveedorModalError(message) {
            const alert = document.getElementById('modalPagoProveedorAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showPagoProveedorModalSuccess(message) {
            const alert = document.getElementById('modalPagoProveedorAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hidePagoProveedorModalAlert() {
            const alert = document.getElementById('modalPagoProveedorAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        let cobrosChart = null;

        async function loadCobrosChart() {
            const token = localStorage.getItem('violetas_token');
            const canvas = document.getElementById('cobrosChart');
            
            if (!canvas) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/cobros/estadisticas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Destruir gráfico anterior si existe
                    if (cobrosChart) {
                        cobrosChart.destroy();
                    }
                    
                    // Preparar datos para el gráfico
                    const historico = data.historico || [];
                    const estimaciones = data.estimaciones || [];
                    
                    // Combinar todos los meses (histórico + estimaciones)
                    const todosMeses = new Set();
                    historico.forEach(h => todosMeses.add(h.mes));
                    estimaciones.forEach(e => todosMeses.add(e.mes));
                    
                    const mesesOrdenados = Array.from(todosMeses).sort();
                    
                    // Identificar residencias (si existen en los datos)
                    const residencias = new Map(); // id -> nombre
                    historico.forEach(h => {
                        if (h.id_residencia) residencias.set(h.id_residencia, h.nombre_residencia || `Residencia ${h.id_residencia}`);
                    });
                    estimaciones.forEach(e => {
                         if (e.id_residencia) residencias.set(e.id_residencia, e.nombre_residencia || `Residencia ${e.id_residencia}`);
                    });

                    // Si no hay info de residencia (usuario normal o datos antiguos), usar "General"
                    if (residencias.size === 0) {
                        residencias.set('default', 'General');
                    }
                    
                    const datasets = [];
                    const colorPalette = [
                        '#28a745', // Verde (Principal/Violetas)
                        '#007bff', // Azul (Secundaria)
                        '#6f42c1', // Púrpura
                        '#fd7e14', // Naranja
                    ];
                    
                    let colorIdx = 0;
                    residencias.forEach((nombre, id) => {
                        const color = colorPalette[colorIdx % colorPalette.length];
                        
                        // Preparar datos para esta residencia
                        const datosHistoricos = mesesOrdenados.map(mes => {
                            const entry = historico.find(h => h.mes === mes && (h.id_residencia === id || (id === 'default')));
                            return entry ? entry.total : 0;
                        });
                        
                        const datosEstimaciones = mesesOrdenados.map(mes => {
                            const entry = estimaciones.find(e => e.mes === mes && (e.id_residencia === id || (id === 'default')));
                            return entry ? entry.total : 0;
                        });

                        // Dataset Histórico (Línea sólida)
                        datasets.push({
                            label: `${nombre} (Cobrado)`,
                            data: datosHistoricos,
                            borderColor: color,
                            backgroundColor: color + '1A', // 10% opacity
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        });
                        
                        // Dataset Estimado (Línea punteada)
                        datasets.push({
                            label: `${nombre} (Previsto)`,
                            data: datosEstimaciones,
                            borderColor: color,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4
                        });
                        
                        colorIdx++;
                    });
                    
                    // Preparar etiquetas (Eje X)
                    const labels = mesesOrdenados.map(mes => {
                        const [año, mesNum] = mes.split('-');
                        const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        return `${meses[parseInt(mesNum) - 1]} ${año}`;
                    });
                    
                    // Crear el gráfico
                    const ctx = canvas.getContext('2d');
                    cobrosChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 15,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            label += Math.round(context.parsed.y) + '€';
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return Math.round(value) + '€';
                                        },
                                        font: {
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                } else {
                    console.error('Error al cargar estadísticas:', data.error);
                }
            } catch (error) {
                console.error('Error al cargar gráfico de cobros:', error);
            }
        }

        // Función para cambiar entre pestañas de facturación
        function switchFacturacionTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover clase active de todos los botones
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar la pestaña seleccionada
            const tabContent = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            
            // Activar el botón correspondiente
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((btn, index) => {
                if ((tabName === 'cobros' && index === 0) || (tabName === 'pagos' && index === 1)) {
                    btn.classList.add('active');
                }
            });
            
            if (tabContent) {
                tabContent.classList.add('active');
            }
        }

        function switchPersonalTab(tabName) {
            // Ocultar todas las pestañas dentro del módulo de personal
            const personalModule = document.querySelector('#moduleContent .module-content');
            if (!personalModule) return;
            
            personalModule.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover clase active de todos los botones de personal
            personalModule.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar la pestaña seleccionada
            let tabContentId;
            if (tabName === 'personal') {
                tabContentId = 'tabPersonal';
            } else if (tabName === 'turnos-extra') {
                tabContentId = 'tabTurnosExtra';
                // Cargar turnos extra si no se han cargado aún
                const turnosContent = document.getElementById('turnosExtraContent');
                if (turnosContent && turnosContent.innerHTML.includes('Cargando')) {
                    loadTurnosExtra();
                }
            }
            
            const tabContent = document.getElementById(tabContentId);
            
            // Activar el botón correspondiente
            const tabs = personalModule.querySelectorAll('.tab');
            tabs.forEach((btn, index) => {
                if ((tabName === 'personal' && index === 0) || (tabName === 'turnos-extra' && index === 1)) {
                    btn.classList.add('active');
                }
            });
            
            if (tabContent) {
                tabContent.classList.add('active');
            }
        }

        // Event listeners para el DOM
        document.addEventListener('DOMContentLoaded', function() {
            
            // Event delegation para el botón de nuevo proveedor (funciona incluso si se carga dinámicamente)
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'btnNuevoProveedor') {
                    e.stopPropagation();
                    e.preventDefault();
                    // Guardar que el modal de pago estaba abierto
                    const modalPago = document.getElementById('modalPagoProveedor');
                    if (modalPago && modalPago.style.display === 'block') {
                        sessionStorage.setItem('modalPagoAbierto', 'true');
                    }
                    // Cerrar el modal de pago a proveedor primero
                    closeModal('modalPagoProveedor');
                    // Abrir el modal de nuevo proveedor después de un pequeño delay
                    setTimeout(() => {
                        openModal('modalProveedor');
                    }, 100);
                    return false;
                }
            });
        });

        async function loadPersonal() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando personal...</p>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/personal`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON:', text);
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${response.status}</p></div>`;
                    return;
                }
                
                if (response.ok) {
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 20px;"><img src="/static/icons/medical/user-medical.svg" alt="Personal" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Personal</h3>
                            
                            <div class="tabs-container">
                                <div class="tabs">
                                    <button class="tab active" onclick="switchPersonalTab('personal')"><img src="/static/icons/medical/user-medical.svg" alt="Personal" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Personal (${data.total || 0})</button>
                                    <button class="tab" onclick="switchPersonalTab('turnos-extra')"><img src="/static/icons/medical/clock.svg" alt="Turnos" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Turnos Extra</button>
                                </div>
                                
                                <!-- Pestaña de Personal -->
                                <div id="tabPersonal" class="tab-content active">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <h4 style="color: #667eea; margin: 0;"><img src="/static/icons/medical/user-medical.svg" alt="Personal" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Personal (${data.total || 0})</h4>
                                        <button class="add-btn" onclick="openModal('modalPersonal')" style="padding: 8px 16px; font-size: 14px; display: inline-flex; align-items: center; gap: 6px;"><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 16px; height: 16px; filter: brightness(0) invert(1);"> Agregar Personal</button>
                                    </div>
                    `;
                    
                    if (data.personal && data.personal.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Cargo</th>
                                        <th>Teléfono</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.personal.forEach(p => {
                            html += `
                                <tr>
                                    <td>${p.nombre} ${p.apellido}</td>
                                    <td>${p.cargo || '-'}</td>
                                    <td>${p.telefono || '-'}</td>
                                    <td>${p.activo ? '<img src="/static/icons/medical/check-circle.svg" alt="Activo" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;"> Activo' : '<img src="/static/icons/medical/alert-circle.svg" alt="Inactivo" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;"> Inactivo'}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No hay personal registrado.</p>';
                    }
                    
                    html += `
                                </div>
                                
                                <!-- Pestaña de Turnos Extra -->
                                <div id="tabTurnosExtra" class="tab-content">
                                    <div id="turnosExtraContent">
                                        <div style="text-align: center; padding: 40px;">
                                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                            <p style="margin-top: 15px; color: #666;">Cargando turnos extra...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    content.innerHTML = html;
                    
                    // Cargar turnos extra cuando se muestre la pestaña
                    loadTurnosExtra();
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        content.innerHTML = `<div class="module-content"><p style="color: red;">Error: Sesión expirada. Por favor, <a href="javascript:location.reload()">recarga la página</a> para iniciar sesión nuevamente.</p></div>`;
                        localStorage.removeItem('violetas_token');
                    } else {
                        content.innerHTML = `<div class="module-content"><p style="color: red;">Error (${response.status}): ${data.error || 'Error desconocido'}</p></div>`;
                    }
                    console.error('Error al cargar personal:', response.status, data);
                }
            } catch (error) {
                console.error('Error de conexión al cargar personal:', error);
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexión: ${error.message}. Verifica que el servidor esté corriendo.</p></div>`;
            }
        }

        // Variables para almacenar instancias de flatpickr
        let flatpickrIngreso = null;
        let flatpickrNacimiento = null;
        let flatpickrEditIngreso = null;
        let flatpickrEditNacimiento = null;
        let flatpickrContratacion = null;

        async function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            
            // Si es el modal de agregar cobro, cargar residentes (solo si no estamos editando)
            if (modalId === 'modalCobro') {
                const idPagoOculto = document.getElementById('cobro_id_pago');
                // Solo cargar residentes si no hay id_pago (no estamos editando)
                if (!idPagoOculto || !idPagoOculto.value) {
                    loadResidentesForCobro();
                    initializeCobroDatePickers();
                }
            }
            
            // Si es el modal de pago a proveedor, inicializar date pickers
            if (modalId === 'modalPagoProveedor') {
                initializePagoProveedorDatePickers();
            }
            
            // Si es el modal de agregar residente, establecer residencia por defecto según el token
            if (modalId === 'modalResidente') {
                const token = localStorage.getItem('violetas_token');
                const selectResidencia = document.getElementById('res_id_residencia');
                const selectHabitacion = document.getElementById('res_habitacion');
                
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const residenciaId = payload.id_residencia;
                        if (selectResidencia) {
                            selectResidencia.value = residenciaId; // Establecer como valor por defecto
                            // Actualizar habitaciones según la residencia
                            await actualizarHabitaciones(residenciaId, 'res_habitacion');
                        }
                    } catch (e) {
                        console.error('Error al obtener residencia del token:', e);
                    }
                }
                
                // Añadir event listener para cuando cambie la residencia
                if (selectResidencia) {
                    selectResidencia.addEventListener('change', async function() {
                        await actualizarHabitaciones(this.value, 'res_habitacion');
                    });
                }
                
                // Inicializar calendarios con flatpickr
                const fechaIngresoInput = document.getElementById('res_fecha_ingreso');
                const fechaNacimientoInput = document.getElementById('res_fecha_nacimiento');
                
                // Destruir instancias anteriores si existen
                if (flatpickrIngreso) {
                    flatpickrIngreso.destroy();
                }
                if (flatpickrNacimiento) {
                    flatpickrNacimiento.destroy();
                }
                
                // Inicializar flatpickr para fecha de ingreso
                if (fechaIngresoInput) {
                    // Establecer fecha de hoy por defecto
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    const fechaHoy = `${dia}/${mes}/${año}`;
                    
                    if (!fechaIngresoInput.value) {
                        fechaIngresoInput.value = fechaHoy;
                    }
                    
                    flatpickrIngreso = flatpickr(fechaIngresoInput, {
                        dateFormat: "d/m/Y",
                        locale: "es",
                        allowInput: true,
                        clickOpens: true,
                        maxDate: "today", // La fecha de ingreso no puede ser mayor que hoy
                        onChange: function(selectedDates, dateStr, instance) {
                            // Asegurar formato DD/MM/YYYY
                            if (dateStr) {
                                const partes = dateStr.split('/');
                                if (partes.length === 3) {
                                    const dia = partes[0].padStart(2, '0');
                                    const mes = partes[1].padStart(2, '0');
                                    const año = partes[2];
                                    instance.input.value = `${dia}/${mes}/${año}`;
                                }
                            }
                        }
                    });
                }
                
                // Inicializar flatpickr para fecha de nacimiento
                if (fechaNacimientoInput) {
                    flatpickrNacimiento = flatpickr(fechaNacimientoInput, {
                        dateFormat: "d/m/Y",
                        locale: "es",
                        allowInput: true,
                        clickOpens: true,
                        maxDate: "today", // No permitir fechas futuras
                        onChange: function(selectedDates, dateStr, instance) {
                            // Asegurar formato DD/MM/YYYY
                            if (dateStr) {
                                const partes = dateStr.split('/');
                                if (partes.length === 3) {
                                    const dia = partes[0].padStart(2, '0');
                                    const mes = partes[1].padStart(2, '0');
                                    const año = partes[2];
                                    instance.input.value = `${dia}/${mes}/${año}`;
                                }
                            }
                            // Actualizar edad cuando cambia la fecha
                            actualizarEdad('res_fecha_nacimiento', 'res_edad');
                        }
                    });
                }
            }
            
            // Si es el modal de agregar personal, establecer residencia por defecto según el token
            if (modalId === 'modalPersonal') {
                const token = localStorage.getItem('violetas_token');
                const selectResidencia = document.getElementById('per_id_residencia');
                
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const residenciaId = payload.id_residencia;
                        if (selectResidencia) {
                            selectResidencia.value = residenciaId; // Establecer como valor por defecto
                        }
                    } catch (e) {
                        console.error('Error al obtener residencia del token:', e);
                    }
                }
                
                // Inicializar calendario con flatpickr para fecha de contratación
                const fechaContratacionInput = document.getElementById('per_fecha_contratacion');
                
                // Destruir instancia anterior si existe
                if (flatpickrContratacion) {
                    flatpickrContratacion.destroy();
                }
                
                // Inicializar flatpickr para fecha de contratación
                if (fechaContratacionInput) {
                    // Establecer fecha de hoy por defecto
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    const fechaHoy = `${dia}/${mes}/${año}`;
                    
                    if (!fechaContratacionInput.value) {
                        fechaContratacionInput.value = fechaHoy;
                    }
                    
                    flatpickrContratacion = flatpickr(fechaContratacionInput, {
                        dateFormat: "d/m/Y",
                        locale: "es",
                        allowInput: true,
                        clickOpens: true,
                        maxDate: "today", // La fecha de contratación no puede ser mayor que hoy
                        onChange: function(selectedDates, dateStr, instance) {
                            // Asegurar formato DD/MM/YYYY
                            if (dateStr) {
                                const partes = dateStr.split('/');
                                if (partes.length === 3) {
                                    const dia = partes[0].padStart(2, '0');
                                    const mes = partes[1].padStart(2, '0');
                                    const año = partes[2];
                                    instance.input.value = `${dia}/${mes}/${año}`;
                                }
                            }
                        }
                    });
                }
            }
            
            // Si es el modal de agregar turno extra
            if (modalId === 'modalTurnoExtra') {
                const token = localStorage.getItem('violetas_token');
                const selectPersonal = document.getElementById('turno_id_personal');
                const fechaInput = document.getElementById('turno_fecha');
                
                // Cargar personal para el select
                if (selectPersonal) {
                    fetch(`${API_URL}/api/v1/personal`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                    .then(res => res.json())
                    .then(data => {
                        selectPersonal.innerHTML = '<option value="">Seleccione un empleado</option>';
                        if (data.personal) {
                            data.personal.forEach(p => {
                                selectPersonal.innerHTML += `<option value="${p.id_personal}">${p.nombre} ${p.apellido}${p.cargo ? ' (' + p.cargo + ')' : ''}</option>`;
                            });
                        }
                    })
                    .catch(err => console.error('Error al cargar personal:', err));
                }
                
                // Inicializar date picker para fecha
                if (fechaInput) {
                    // Destruir instancia anterior si existe
                    if (window.flatpickrTurnoExtra) {
                        window.flatpickrTurnoExtra.destroy();
                    }
                    
                    // Establecer fecha de hoy por defecto si está vacío
                    if (!fechaInput.value) {
                        const hoy = new Date();
                        const dia = String(hoy.getDate()).padStart(2, '0');
                        const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                        const año = hoy.getFullYear();
                        fechaInput.value = `${dia}/${mes}/${año}`;
                    }
                    
                    window.flatpickrTurnoExtra = flatpickr(fechaInput, {
                        dateFormat: "d/m/Y",
                        locale: "es",
                        allowInput: true,
                        clickOpens: true,
                        onChange: function(selectedDates, dateStr, instance) {
                            if (dateStr) {
                                const partes = dateStr.split('/');
                                if (partes.length === 3) {
                                    const dia = partes[0].padStart(2, '0');
                                    const mes = partes[1].padStart(2, '0');
                                    const año = partes[2];
                                    instance.input.value = `${dia}/${mes}/${año}`;
                                }
                            }
                        }
                    });
                }
                
                // Resetear título del modal
                const modalTitle = document.getElementById('modalTurnoExtraTitle');
                if (modalTitle) {
                    modalTitle.textContent = 'Agregar Turno Extra';
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Restaurar título del modal de ver residente
            if (modalId === 'modalViewResidente') {
                const modalTitle = document.querySelector('#modalViewResidente .modal-header h2');
                if (modalTitle) {
                    modalTitle.innerHTML = '<img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Detalle del Residente';
                }
            }
            const form = document.getElementById('formResidente');
            if (form) {
                form.reset();
                const activoCheckbox = document.getElementById('res_activo');
                if (activoCheckbox) {
                    activoCheckbox.checked = true;
                }
                
                // Destruir instancias de flatpickr
                if (flatpickrIngreso) {
                    flatpickrIngreso.destroy();
                    flatpickrIngreso = null;
                }
                if (flatpickrNacimiento) {
                    flatpickrNacimiento.destroy();
                    flatpickrNacimiento = null;
                }
                if (flatpickrEditIngreso) {
                    flatpickrEditIngreso.destroy();
                    flatpickrEditIngreso = null;
                }
                if (flatpickrEditNacimiento) {
                    flatpickrEditNacimiento.destroy();
                    flatpickrEditNacimiento = null;
                }
                
                // Establecer fecha de ingreso como hoy después del reset
                const fechaIngresoInput = document.getElementById('res_fecha_ingreso');
                if (fechaIngresoInput) {
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    fechaIngresoInput.value = `${dia}/${mes}/${año}`;
                }
            }
            const formPersonal = document.getElementById('formPersonal');
            if (formPersonal) {
                formPersonal.reset();
                const activoCheckbox = document.getElementById('per_activo');
                if (activoCheckbox) {
                    activoCheckbox.value = 'true';
                }
                
                // Destruir instancia de flatpickr de contratación
                if (flatpickrContratacion) {
                    flatpickrContratacion.destroy();
                    flatpickrContratacion = null;
                }
                
                // Establecer fecha de contratación como hoy después del reset
                const fechaContratacionInput = document.getElementById('per_fecha_contratacion');
                if (fechaContratacionInput) {
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    fechaContratacionInput.value = `${dia}/${mes}/${año}`;
                }
            }
            const formTurnoExtra = document.getElementById('formTurnoExtra');
            if (formTurnoExtra) {
                formTurnoExtra.reset();
                document.getElementById('turno_id_turno_extra').value = '';
                document.getElementById('modalTurnoExtraTitle').textContent = 'Agregar Turno Extra';
                
                // Destruir instancia de flatpickr de turno extra
                if (window.flatpickrTurnoExtra) {
                    window.flatpickrTurnoExtra.destroy();
                    window.flatpickrTurnoExtra = null;
                }
                
                // Establecer fecha como hoy después del reset
                const fechaInput = document.getElementById('turno_fecha');
                if (fechaInput) {
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    fechaInput.value = `${dia}/${mes}/${año}`;
                }
            }
            const formProveedor = document.getElementById('formProveedor');
            if (formProveedor) {
                formProveedor.reset();
                const activoCheckbox = document.getElementById('prov_activo');
                if (activoCheckbox) {
                    activoCheckbox.checked = true;
                }
            }
            const formPagoProveedor = document.getElementById('formPagoProveedor');
            if (formPagoProveedor) {
                formPagoProveedor.reset();
                // Destruir flatpickr de pagos a proveedores
                if (flatpickrPagoProveedorFechaPago) {
                    flatpickrPagoProveedorFechaPago.destroy();
                    flatpickrPagoProveedorFechaPago = null;
                }
            }
            const formCobro = document.getElementById('formCobro');
            if (formCobro) {
                formCobro.reset();
                // Limpiar id_pago oculto
                document.getElementById('cobro_id_pago').value = '';
                // Restaurar título del modal
                document.getElementById('modalCobroTitulo').innerHTML = '<img src="/static/icons/medical/bill.svg" alt="Cobro" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Cobro';
                // Ocultar botón de eliminar cuando se está agregando
                const deleteBtn = document.getElementById('deleteCobroBtn');
                if (deleteBtn) {
                    deleteBtn.style.display = 'none';
                }
                const esPrevisto = document.getElementById('cobro_es_previsto');
                if (esPrevisto) {
                    esPrevisto.checked = true;
                }
                // Limpiar campo de concepto "otros"
                const campoOtros = document.getElementById('cobro_concepto_otros');
                if (campoOtros) {
                    campoOtros.style.display = 'none';
                    campoOtros.value = '';
                    campoOtros.required = false;
                }
                // Resetear select de concepto
                const selectConcepto = document.getElementById('cobro_concepto');
                if (selectConcepto) {
                    selectConcepto.value = '';
                }
                // Destruir flatpickr de cobros
                if (flatpickrCobroPrevista) {
                    flatpickrCobroPrevista.destroy();
                    flatpickrCobroPrevista = null;
                }
                if (flatpickrCobroPago) {
                    flatpickrCobroPago.destroy();
                    flatpickrCobroPago = null;
                }
            }
            hideModalAlert();
            hideProveedorModalAlert();
            hideCobroModalAlert();
            hidePagoProveedorModalAlert();
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modalResidente = document.getElementById('modalResidente');
            const modalViewResidente = document.getElementById('modalViewResidente');
            const modalProveedor = document.getElementById('modalProveedor');
            const modalPagoProveedor = document.getElementById('modalPagoProveedor');
            const modalListaProveedores = document.getElementById('modalListaProveedores');
            if (event.target == modalResidente) {
                closeModal('modalResidente');
            }
            const modalPersonal = document.getElementById('modalPersonal');
            if (event.target == modalPersonal) {
                closeModal('modalPersonal');
            }
            const modalTurnoExtra = document.getElementById('modalTurnoExtra');
            if (event.target == modalTurnoExtra) {
                closeModal('modalTurnoExtra');
            }
            if (event.target == modalViewResidente) {
                closeModal('modalViewResidente');
            }
            if (event.target == modalProveedor) {
                closeModal('modalProveedor');
            }
            if (event.target == modalPagoProveedor) {
                closeModal('modalPagoProveedor');
            }
            if (event.target == modalListaProveedores) {
                closeModal('modalListaProveedores');
            }
        }

        let currentEditingResidenteId = null;

        // Función auxiliar para formatear fechas a formato español (DD/MM/YYYY)
        function formatearFechaEspanol(fechaString) {
            if (!fechaString) return '';
            try {
                const fecha = new Date(fechaString);
                if (isNaN(fecha.getTime())) return fechaString;
                const dia = String(fecha.getDate()).padStart(2, '0');
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const año = fecha.getFullYear();
                return `${dia}/${mes}/${año}`;
            } catch (e) {
                return fechaString;
            }
        }

        // Función auxiliar para convertir fecha española (DD/MM/YYYY) a formato ISO (YYYY-MM-DD)
        function fechaEspanolToISO(fechaEspanol) {
            if (!fechaEspanol) return '';
            try {
                const partes = fechaEspanol.split('/');
                if (partes.length === 3) {
                    const [dia, mes, año] = partes;
                    return `${año}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
                }
                return fechaEspanol;
            } catch (e) {
                return fechaEspanol;
            }
        }

        // Función auxiliar para convertir fecha ISO (YYYY-MM-DD) a formato español (DD/MM/YYYY)
        function fechaISOToEspanol(fechaISO) {
            if (!fechaISO) return '';
            try {
                const partes = fechaISO.split('-');
                if (partes.length === 3) {
                    const [año, mes, dia] = partes;
                    return `${dia}/${mes}/${año}`;
                }
                return fechaISO;
            } catch (e) {
                return fechaISO;
            }
        }

        // Función para actualizar las opciones de habitación según la residencia
        async function actualizarHabitaciones(residenciaId, selectHabitacionId, habitacionSeleccionada = null) {
            const selectHabitacion = document.getElementById(selectHabitacionId);
            if (!selectHabitacion) return;
            
            // Limpiar opciones existentes excepto la primera
            selectHabitacion.innerHTML = '<option value="">Cargando habitaciones...</option>';
            selectHabitacion.disabled = true;
            
            if (!residenciaId) {
                selectHabitacion.innerHTML = '<option value="">Seleccione una residencia primero</option>';
                selectHabitacion.disabled = false;
                return;
            }
            
            // Determinar número de habitaciones según la residencia
            let numHabitaciones = 0;
            if (residenciaId === '1' || residenciaId === 1) {
                numHabitaciones = 8; // Violetas 1 tiene 8 habitaciones
            } else if (residenciaId === '2' || residenciaId === 2) {
                numHabitaciones = 20; // Violetas 2 tiene 20 habitaciones
            } else {
                selectHabitacion.innerHTML = '<option value="">Residencia no válida</option>';
                selectHabitacion.disabled = false;
                return;
            }
            
            // Obtener habitaciones ocupadas del backend
            const token = localStorage.getItem('violetas_token');
            let habitacionesOcupadas = [];
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residencias/${residenciaId}/habitaciones-ocupadas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    habitacionesOcupadas = data.habitaciones_ocupadas || [];
                }
            } catch (error) {
                console.error('Error al obtener habitaciones ocupadas:', error);
            }
            
            // Limpiar y reconstruir el select
            selectHabitacion.innerHTML = '<option value="">Seleccione una habitación</option>';
            
            // Añadir opciones de habitaciones disponibles
            for (let i = 1; i <= numHabitaciones; i++) {
                const habitacionStr = i.toString();
                const estaOcupada = habitacionesOcupadas.includes(habitacionStr);
                
                // Si está ocupada pero es la habitación seleccionada (al editar), incluirla
                const esHabitacionSeleccionada = habitacionSeleccionada && habitacionSeleccionada === habitacionStr;
                
                if (!estaOcupada || esHabitacionSeleccionada) {
                    const option = document.createElement('option');
                    option.value = habitacionStr;
                    option.textContent = `Habitación ${i}${estaOcupada && esHabitacionSeleccionada ? ' (actual)' : ''}`;
                    if (esHabitacionSeleccionada) {
                        option.selected = true;
                    }
                    selectHabitacion.appendChild(option);
                }
            }
            
            selectHabitacion.disabled = false;
        }
        
        // Función para calcular la edad desde una fecha en formato DD/MM/YYYY
        function calcularEdad(fechaEspanol) {
            if (!fechaEspanol || fechaEspanol.length !== 10) return '';
            
            try {
                const partes = fechaEspanol.split('/');
                if (partes.length !== 3) return '';
                
                const dia = parseInt(partes[0], 10);
                const mes = parseInt(partes[1], 10) - 1; // Los meses en JS van de 0-11
                const año = parseInt(partes[2], 10);
                
                if (isNaN(dia) || isNaN(mes) || isNaN(año)) return '';
                
                const fechaNacimiento = new Date(año, mes, dia);
                const hoy = new Date();
                
                // Verificar que la fecha es válida
                if (fechaNacimiento.getDate() !== dia || fechaNacimiento.getMonth() !== mes || fechaNacimiento.getFullYear() !== año) {
                    return '';
                }
                
                // Verificar que la fecha no sea futura
                if (fechaNacimiento > hoy) return '';
                
                let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
                const mesActual = hoy.getMonth();
                const diaActual = hoy.getDate();
                const mesNacimiento = fechaNacimiento.getMonth();
                const diaNacimiento = fechaNacimiento.getDate();
                
                // Ajustar si aún no ha cumplido años este año
                if (mesActual < mesNacimiento || (mesActual === mesNacimiento && diaActual < diaNacimiento)) {
                    edad--;
                }
                
                return edad >= 0 ? edad + ' años' : '';
            } catch (e) {
                return '';
            }
        }
        
        // Función para calcular la edad desde una fecha ISO (YYYY-MM-DD)
        function calcularEdadDesdeISO(fechaISO) {
            if (!fechaISO) return '';
            const fechaEspanol = fechaISOToEspanol(fechaISO);
            return calcularEdad(fechaEspanol);
        }
        
        // Función para actualizar el campo de edad cuando cambia la fecha de nacimiento
        function actualizarEdad(inputFechaId, inputEdadId) {
            const inputFecha = document.getElementById(inputFechaId);
            const inputEdad = document.getElementById(inputEdadId);
            
            if (!inputFecha || !inputEdad) return;
            
            const fechaEspanol = inputFecha.value.trim();
            const edad = calcularEdad(fechaEspanol);
            
            if (edad) {
                inputEdad.value = edad;
                inputEdad.style.color = '#333';
            } else {
                inputEdad.value = '';
                inputEdad.placeholder = 'Se calculará automáticamente';
            }
        }

        // Función para validar formato de fecha española (DD/MM/YYYY)
        function validarFechaEspanol(fecha) {
            if (!fecha) return true; // Permitir vacío
            const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = fecha.match(regex);
            if (!match) return false;
            
            const [, dia, mes, año] = match;
            const diaNum = parseInt(dia, 10);
            const mesNum = parseInt(mes, 10);
            const añoNum = parseInt(año, 10);
            
            // Validar rango de fechas
            if (mesNum < 1 || mesNum > 12) return false;
            if (diaNum < 1 || diaNum > 31) return false;
            if (añoNum < 1900 || añoNum > 2100) return false;
            
            // Validar días del mes
            const fechaObj = new Date(añoNum, mesNum - 1, diaNum);
            if (fechaObj.getDate() !== diaNum || fechaObj.getMonth() !== mesNum - 1 || fechaObj.getFullYear() !== añoNum) {
                return false;
            }
            
            return true;
        }

        // Función para formatear automáticamente mientras se escribe (DD/MM/YYYY)
        function formatearFechaInput(input) {
            let value = input.value.replace(/\D/g, ''); // Solo números
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }
            
            input.value = value;
            
            // Validar y mostrar error si es necesario
            if (value.length === 10) {
                if (!validarFechaEspanol(value)) {
                    input.style.borderColor = '#dc3545';
                } else {
                    input.style.borderColor = '#e0e0e0';
                }
            } else if (value.length > 0) {
                input.style.borderColor = '#e0e0e0';
            }
        }

        async function viewResidente(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const content = document.getElementById('viewResidenteContent');
            
            content.innerHTML = '<p>Cargando información del residente...</p>';
            openModal('modalViewResidente');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const res = await response.json();
                
                if (response.ok) {
                    currentEditingResidenteId = idResidente;
                    
                    // Actualizar el título del modal con el nombre del residente
                    const modalTitle = document.querySelector('#modalViewResidente .modal-header h2');
                    if (modalTitle) {
                        const nombreCompleto = `${res.nombre || ''} ${res.apellido || ''}`.trim();
                        modalTitle.innerHTML = `<img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Detalle del Residente${nombreCompleto ? ': ' + nombreCompleto : ''}`;
                    }
                    
                    // Obtener nombre de residencia
                    const tokenPayload = JSON.parse(atob(token.split('.')[1]));
                    const residenciaNombre = tokenPayload.id_residencia === 1 ? 'Violetas 1' : 
                                           tokenPayload.id_residencia === 2 ? 'Violetas 2' : 
                                           `Residencia ${tokenPayload.id_residencia}`;
                    
                    let html = `
                        <form id="formEditResidente" onsubmit="updateResidente(event, ${idResidente})">
                            
                            <!-- SECCIÓN: Información de Residencia -->
                            <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/home.svg" alt="Residencia" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Residencia</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="edit_id_residencia">Residencia *</label>
                                        <select id="edit_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="1" ${res.id_residencia === 1 ? 'selected' : ''}>Violetas 1</option>
                                            <option value="2" ${res.id_residencia === 2 ? 'selected' : ''}>Violetas 2</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_habitacion">Habitación *</label>
                                        <select id="edit_habitacion" name="habitacion" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione una habitación</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                    <div class="form-group">
                                        <label for="edit_fecha_ingreso">Fecha de Ingreso</label>
                                        <input type="text" id="edit_fecha_ingreso" name="fecha_ingreso" value="${res.fecha_ingreso ? fechaISOToEspanol(res.fecha_ingreso) : ''}" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)" readonly style="cursor: pointer; background-color: white;">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_costo_habitacion">Costo de Habitación (€)</label>
                                        <input type="number" id="edit_costo_habitacion" name="costo_habitacion" step="0.01" value="${res.costo_habitacion || ''}" placeholder="0.00">
                                    </div>
                                </div>
                                <div style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label for="edit_metodo_pago_preferido">Método de Pago Preferido</label>
                                        <select id="edit_metodo_pago_preferido" name="metodo_pago_preferido" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione un método</option>
                                            <option value="transferencia" ${res.metodo_pago_preferido === 'transferencia' ? 'selected' : ''}>Transferencia</option>
                                            <option value="remesa" ${res.metodo_pago_preferido === 'remesa' ? 'selected' : ''}>Remesa</option>
                                            <option value="metálico" ${res.metodo_pago_preferido === 'metálico' ? 'selected' : ''}>Metálico</option>
                                            <option value="bizum" ${res.metodo_pago_preferido === 'bizum' ? 'selected' : ''}>Bizum</option>
                                            <option value="otro" ${res.metodo_pago_preferido && !['transferencia', 'remesa', 'metálico', 'bizum'].includes(res.metodo_pago_preferido) ? 'selected' : ''}>Otro</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN: Información Personal -->
                            <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                                <h3 style="color: #f56565; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Personal</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="edit_nombre">Nombre *</label>
                                        <input type="text" id="edit_nombre" name="nombre" value="${res.nombre || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_apellido">Apellido *</label>
                                        <input type="text" id="edit_apellido" name="apellido" value="${res.apellido || ''}" required>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                    <div class="form-group">
                                        <label for="edit_documento">Documento de Identidad</label>
                                        <input type="text" id="edit_documento" name="documento_identidad" value="${res.documento_identidad || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_fecha_nacimiento">Fecha de Nacimiento</label>
                                        <input type="text" id="edit_fecha_nacimiento" name="fecha_nacimiento" value="${res.fecha_nacimiento ? fechaISOToEspanol(res.fecha_nacimiento) : ''}" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this); actualizarEdad('edit_fecha_nacimiento', 'edit_edad')" readonly style="cursor: pointer; background-color: white;">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_edad">Edad</label>
                                        <input type="text" id="edit_edad" name="edad" readonly style="background-color: #f5f5f5; color: #666; cursor: not-allowed;" placeholder="Se calculará automáticamente" value="${res.fecha_nacimiento ? calcularEdadDesdeISO(res.fecha_nacimiento) : ''}">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN: Información de Contacto -->
                            <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                                <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/phone.svg" alt="Contacto" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Contacto</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="edit_telefono">Teléfono</label>
                                        <input type="tel" id="edit_telefono" name="telefono" value="${res.telefono || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_direccion">Dirección</label>
                                        <input type="text" id="edit_direccion" name="direccion" value="${res.direccion || ''}">
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                    <h4 style="color: #48bb78; margin-bottom: 10px; font-size: 14px; font-weight: 600;">Contacto de Emergencia</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div class="form-group">
                                            <label for="edit_contacto_emergencia">Nombre del Contacto</label>
                                            <input type="text" id="edit_contacto_emergencia" name="contacto_emergencia" value="${res.contacto_emergencia || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit_telefono_emergencia">Teléfono de Emergencia</label>
                                            <input type="tel" id="edit_telefono_emergencia" name="telefono_emergencia" value="${res.telefono_emergencia || ''}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN: Información Médica y Servicios -->
                            <div style="background: #fffaf0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                                <h3 style="color: #ed8936; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Información Médica" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Médica y Servicios</h3>
                                
                                <!-- Datos Médicos Esenciales -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div class="form-group">
                                        <label for="edit_grupo_sanguineo">Grupo Sanguíneo</label>
                                        <select id="edit_grupo_sanguineo" name="grupo_sanguineo" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione</option>
                                            <option value="A+" ${res.grupo_sanguineo === 'A+' ? 'selected' : ''}>A+</option>
                                            <option value="A-" ${res.grupo_sanguineo === 'A-' ? 'selected' : ''}>A-</option>
                                            <option value="B+" ${res.grupo_sanguineo === 'B+' ? 'selected' : ''}>B+</option>
                                            <option value="B-" ${res.grupo_sanguineo === 'B-' ? 'selected' : ''}>B-</option>
                                            <option value="AB+" ${res.grupo_sanguineo === 'AB+' ? 'selected' : ''}>AB+</option>
                                            <option value="AB-" ${res.grupo_sanguineo === 'AB-' ? 'selected' : ''}>AB-</option>
                                            <option value="O+" ${res.grupo_sanguineo === 'O+' ? 'selected' : ''}>O+</option>
                                            <option value="O-" ${res.grupo_sanguineo === 'O-' ? 'selected' : ''}>O-</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_nivel_dependencia">Nivel de Dependencia</label>
                                        <select id="edit_nivel_dependencia" name="nivel_dependencia" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione</option>
                                            <option value="Autónomo" ${res.nivel_dependencia === 'Autónomo' ? 'selected' : ''}>Autónomo</option>
                                            <option value="Dependencia leve" ${res.nivel_dependencia === 'Dependencia leve' ? 'selected' : ''}>Dependencia leve</option>
                                            <option value="Dependencia moderada" ${res.nivel_dependencia === 'Dependencia moderada' ? 'selected' : ''}>Dependencia moderada</option>
                                            <option value="Dependencia severa" ${res.nivel_dependencia === 'Dependencia severa' ? 'selected' : ''}>Dependencia severa</option>
                                            <option value="Gran dependencia" ${res.nivel_dependencia === 'Gran dependencia' ? 'selected' : ''}>Gran dependencia</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label for="edit_alergias">Alergias</label>
                                        <textarea id="edit_alergias" name="alergias" rows="2" placeholder="Ej: Penicilina, Lácteos, Polen">${res.alergias || ''}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_diagnosticos">Enfermedades Crónicas / Diagnósticos</label>
                                        <textarea id="edit_diagnosticos" name="diagnosticos" rows="2" placeholder="Ej: Diabetes tipo 2, Hipertensión, Artritis">${res.diagnosticos || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label for="edit_restricciones_dieteticas">Restricciones Dietéticas</label>
                                        <textarea id="edit_restricciones_dieteticas" name="restricciones_dieteticas" rows="2" placeholder="Ej: Sin sal, Textura triturada, Sin gluten">${res.restricciones_dieteticas || ''}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_movilidad">Movilidad / Ayudas Técnicas</label>
                                        <select id="edit_movilidad" name="movilidad" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione</option>
                                            <option value="Deambulación autónoma" ${res.movilidad === 'Deambulación autónoma' ? 'selected' : ''}>Deambulación autónoma</option>
                                            <option value="Bastón" ${res.movilidad === 'Bastón' ? 'selected' : ''}>Bastón</option>
                                            <option value="Andador" ${res.movilidad === 'Andador' ? 'selected' : ''}>Andador</option>
                                            <option value="Silla de ruedas" ${res.movilidad === 'Silla de ruedas' ? 'selected' : ''}>Silla de ruedas</option>
                                            <option value="Cama" ${res.movilidad === 'Cama' ? 'selected' : ''}>Cama</option>
                                            <option value="Otro" ${res.movilidad && !['Deambulación autónoma', 'Bastón', 'Andador', 'Silla de ruedas', 'Cama'].includes(res.movilidad) ? 'selected' : ''}>Otro</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label for="edit_medico_referencia">Médico de Referencia</label>
                                        <input type="text" id="edit_medico_referencia" name="medico_referencia" value="${res.medico_referencia || ''}" placeholder="Nombre del médico o centro de salud">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_telefono_medico">Teléfono Médico</label>
                                        <input type="text" id="edit_telefono_medico" name="telefono_medico" value="${res.telefono_medico || ''}" placeholder="Teléfono del médico o centro">
                                    </div>
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <label for="edit_medicaciones">Medicaciones</label>
                                    <textarea id="edit_medicaciones" name="medicaciones" rows="3" placeholder="Lista de medicaciones y horarios">${res.medicaciones || ''}</textarea>
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <label>Servicios Extra</label>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                            <input type="checkbox" class="edit_servicio_extra" value="Peluquería" style="width: auto; margin-right: 8px;">
                                            Peluquería
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                            <input type="checkbox" class="edit_servicio_extra" value="Podólogo" style="width: auto; margin-right: 8px;">
                                            Podólogo
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                            <input type="checkbox" class="edit_servicio_extra" value="Fisio" style="width: auto; margin-right: 8px;">
                                            Fisio
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                            <input type="checkbox" class="edit_servicio_extra" value="Farmacia" style="width: auto; margin-right: 8px;">
                                            Farmacia
                                        </label>
                                </div>
                                    <input type="hidden" id="edit_servicios_extra" name="servicios_extra" value="${res.servicios_extra || ''}">
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <label for="edit_peculiaridades">Peculiaridades / Notas Importantes</label>
                                    <textarea id="edit_peculiaridades" name="peculiaridades" rows="3" placeholder="Información adicional relevante">${res.peculiaridades || ''}</textarea>
                                </div>
                            </div>
                            
                            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                            
                            <div class="form-group">
                                <h3 style="color: #667eea; margin-bottom: 15px;"><img src="/static/icons/medical/file-medical.svg" alt="Documentación" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Documentación</h3>
                                
                                <div id="documentosList" style="margin-bottom: 20px;">
                                    <p style="color: #666;">Cargando documentos...</p>
                                </div>
                                
                                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 15px;">
                                    <h4 style="color: #667eea; margin-bottom: 10px; font-size: 14px;">Agregar Nuevo Documento</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px;">
                                        <select id="doc_tipo" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #333;">
                                            <option value="">Tipo de documento</option>
                                            <option value="Médica">Médica</option>
                                            <option value="Bancaria">Bancaria</option>
                                            <option value="Legal">Legal</option>
                                            <option value="Seguro">Seguro</option>
                                            <option value="Identidad">Identidad</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                        <input type="file" id="doc_archivo" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #333;">
                                    </div>
                                    <textarea id="doc_descripcion" placeholder="Descripción (opcional)" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: white; color: #333; font-family: inherit;"></textarea>
                                    <button type="button" onclick="agregarDocumento(${idResidente})" style="width: auto; padding: 8px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">+ Subir Documento</button>
                                </div>
                            </div>
                            
                            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                            
                            <!-- SECCIÓN: Estado -->
                            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #718096;">
                                <h3 style="color: #718096; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/settings.svg" alt="Estado" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Estado</h3>
                                ${res.activo ? `
                                    <div class="form-group">
                                        <p style="color: #28a745; font-weight: 600; margin-bottom: 15px;">
                                            <img src="/static/icons/medical/check-circle.svg" alt="Activo" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Residente Activo
                                        </p>
                                        <button type="button" onclick="abrirModalBaja(${res.id_residente})" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                            <img src="/static/icons/medical/user-x.svg" alt="Dar de baja" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px; filter: brightness(0) invert(1);"> Dar de Baja
                                        </button>
                                    </div>
                                ` : `
                                    <div class="form-group">
                                        <p style="color: #dc3545; font-weight: 600; margin-bottom: 10px;">
                                            <img src="/static/icons/medical/user-x.svg" alt="Inactivo" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Usuario de Baja
                                        </p>
                                        <p style="color: #666; margin-bottom: 5px;"><strong>Motivo:</strong> ${res.motivo_baja || 'No especificado'}</p>
                                        <p style="color: #666; margin-bottom: 15px;"><strong>Fecha de baja:</strong> ${res.fecha_baja ? fechaISOToEspanol(res.fecha_baja) : 'No especificada'}</p>
                                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                                            <button type="button" onclick="reactivarResidente(${res.id_residente})" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                                <img src="/static/icons/medical/check-circle.svg" alt="Dar de alta" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px; filter: brightness(0) invert(1);"> Dar de Alta
                                            </button>
                                            <button type="button" onclick="confirmarEliminarResidente(${res.id_residente})" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                                <img src="/static/icons/medical/alert-circle.svg" alt="Eliminar" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px; filter: brightness(0) invert(1);"> Eliminar Completamente
                                            </button>
                                        </div>
                                    </div>
                                `}
                            </div>
                            
                            <div id="editModalAlert" class="alert" style="display: none;"></div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" id="updateResidenteBtn" style="flex: 1;">Guardar Cambios</button>
                                <button type="button" onclick="closeModal('modalViewResidente')" style="flex: 1; background: #6c757d;">Cerrar</button>
                            </div>
                        </form>
                    `;
                    
                    content.innerHTML = html;
                    
                    // Cargar habitaciones según la residencia actual y establecer la habitación seleccionada
                    const editSelectResidencia = document.getElementById('edit_id_residencia');
                    const editSelectHabitacion = document.getElementById('edit_habitacion');
                    if (editSelectResidencia && editSelectHabitacion) {
                        // Cargar habitaciones para la residencia actual
                        await actualizarHabitaciones(res.id_residencia, 'edit_habitacion', res.habitacion);
                        
                        // Añadir event listener para cuando cambie la residencia
                        editSelectResidencia.addEventListener('change', async function() {
                            await actualizarHabitaciones(this.value, 'edit_habitacion');
                        });
                    }
                    
                    // Inicializar calendarios con flatpickr en el modal de edición
                    const editFechaIngresoInput = document.getElementById('edit_fecha_ingreso');
                    const editFechaNacimientoInput = document.getElementById('edit_fecha_nacimiento');
                    
                    // Destruir instancias anteriores si existen
                    if (flatpickrEditIngreso) {
                        flatpickrEditIngreso.destroy();
                    }
                    if (flatpickrEditNacimiento) {
                        flatpickrEditNacimiento.destroy();
                    }
                    
                    // Inicializar flatpickr para fecha de ingreso (edición)
                    if (editFechaIngresoInput) {
                        flatpickrEditIngreso = flatpickr(editFechaIngresoInput, {
                            dateFormat: "d/m/Y",
                            locale: "es",
                            allowInput: true,
                            clickOpens: true,
                            maxDate: "today", // La fecha de ingreso no puede ser mayor que hoy
                            onChange: function(selectedDates, dateStr, instance) {
                                // Asegurar formato DD/MM/YYYY
                                if (dateStr) {
                                    const partes = dateStr.split('/');
                                    if (partes.length === 3) {
                                        const dia = partes[0].padStart(2, '0');
                                        const mes = partes[1].padStart(2, '0');
                                        const año = partes[2];
                                        instance.input.value = `${dia}/${mes}/${año}`;
                                    }
                                }
                            }
                        });
                    }
                    
                    // Inicializar flatpickr para fecha de nacimiento (edición)
                    if (editFechaNacimientoInput) {
                        flatpickrEditNacimiento = flatpickr(editFechaNacimientoInput, {
                            dateFormat: "d/m/Y",
                            locale: "es",
                            allowInput: true,
                            clickOpens: true,
                            maxDate: "today", // No permitir fechas futuras
                            onChange: function(selectedDates, dateStr, instance) {
                                // Asegurar formato DD/MM/YYYY
                                if (dateStr) {
                                    const partes = dateStr.split('/');
                                    if (partes.length === 3) {
                                        const dia = partes[0].padStart(2, '0');
                                        const mes = partes[1].padStart(2, '0');
                                        const año = partes[2];
                                        instance.input.value = `${dia}/${mes}/${año}`;
                                    }
                                }
                                // Actualizar edad cuando cambia la fecha
                                actualizarEdad('edit_fecha_nacimiento', 'edit_edad');
                            }
                        });
                    }
                    
                    // Cargar servicios extra al editar
                    if (res.servicios_extra) {
                        const serviciosArray = res.servicios_extra.split(',').map(s => s.trim());
                        const serviciosPredefinidos = ['Peluquería', 'Podólogo', 'Fisio', 'Farmacia'];
                        const serviciosOtros = [];
                        
                        serviciosArray.forEach(servicio => {
                            if (serviciosPredefinidos.includes(servicio)) {
                                // Marcar el checkbox correspondiente
                                const checkbox = document.querySelector(`.edit_servicio_extra[value="${servicio}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                }
                            } else {
                                // Añadir a otros servicios
                                serviciosOtros.push(servicio);
                            }
                        });
                    }
                    
                    // Cargar documentos del residente
                    await loadDocumentos(idResidente);
                } else {
                    content.innerHTML = `<div class="alert error">Error: ${res.error}</div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="alert error">Error de conexión: ${error.message}</div>`;
            }
        }

        async function loadDocumentos(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const documentosList = document.getElementById('documentosList');
            
            if (!documentosList) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/documentos`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta de documentos no es JSON:', text);
                    documentosList.innerHTML = `<p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${response.status}</p>`;
                    return;
                }
                
                if (response.ok) {
                    if (data.documentos && data.documentos.length > 0) {
                        let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                        data.documentos.forEach(doc => {
                            const tamaño = doc.tamaño_bytes ? `(${(doc.tamaño_bytes / 1024).toFixed(1)} KB)` : '';
                            html += `
                                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <strong style="color: #667eea;">${doc.tipo_documento}</strong>
                                        <p style="margin: 5px 0; color: #333;">${doc.nombre_archivo} ${tamaño}</p>
                                        ${doc.descripcion ? `<p style="margin: 0; color: #666; font-size: 12px;">${doc.descripcion}</p>` : ''}
                                        <p style="margin: 5px 0 0 0; color: #999; font-size: 11px;">${new Date(doc.fecha_subida).toLocaleDateString('es-ES')}</p>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        ${doc.url_descarga ? `
                                            <button onclick="window.open('${doc.url_descarga}', '_blank')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: inline-flex; align-items: center; gap: 4px;" title="Ver en navegador">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="filter: brightness(0) invert(1);">
                                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                    <circle cx="12" cy="12" r="3"></circle>
                                                </svg>
                                                Ver
                                            </button>
                                            <button onclick="window.open('${doc.url_descarga}', '_blank')" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: inline-flex; align-items: center; gap: 4px;" title="Descargar">
                                                <img src="/static/icons/medical/file-medical.svg" alt="Descargar" style="width: 14px; height: 14px; filter: brightness(0) invert(1);">
                                                Descargar
                                            </button>
                                        ` : ''}
                                        <button onclick="eliminarDocumento(${doc.id_documento}, ${idResidente})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;" title="Eliminar">Eliminar</button>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        documentosList.innerHTML = html;
                    } else {
                        documentosList.innerHTML = '<p style="color: #666; font-style: italic;">No hay documentos registrados.</p>';
                    }
                } else {
                    if (response.status === 401) {
                        documentosList.innerHTML = `<p style="color: red;">Sesión expirada. Por favor, recarga la página.</p>`;
                    } else {
                        documentosList.innerHTML = `<p style="color: red;">Error (${response.status}): ${data.error || 'Error desconocido'}</p>`;
                    }
                    console.error('Error al cargar documentos:', response.status, data);
                }
            } catch (error) {
                console.error('Error de conexión al cargar documentos:', error);
                documentosList.innerHTML = `<p style="color: red;">Error de conexión: ${error.message}</p>`;
            }
        }

        async function agregarDocumento(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const tipo = document.getElementById('doc_tipo').value;
            const archivoInput = document.getElementById('doc_archivo');
            const archivo = archivoInput.files[0];
            const descripcion = document.getElementById('doc_descripcion').value;
            
            if (!tipo) {
                alert('Por favor seleccione el tipo de documento');
                return;
            }
            
            if (!archivo) {
                alert('Por favor seleccione un archivo');
                return;
            }
            
            // Validar tamaño (máximo 10MB)
            if (archivo.size > 10 * 1024 * 1024) {
                alert('El archivo es demasiado grande. Máximo 10MB');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('archivo', archivo);
                formData.append('tipo_documento', tipo);
                if (descripcion) {
                    formData.append('descripcion', descripcion);
                }
                
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/documentos`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Limpiar formulario
                    document.getElementById('doc_tipo').value = '';
                    archivoInput.value = '';
                    document.getElementById('doc_descripcion').value = '';
                    
                    // Recargar lista de documentos
                    await loadDocumentos(idResidente);
                } else {
                    alert('Error: ' + (result.error || 'Error al subir documento'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        async function eliminarDocumento(idDocumento, idResidente) {
            if (!confirm('¿Está seguro de que desea eliminar este documento?')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/documentos/${idDocumento}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Recargar lista de documentos
                    await loadDocumentos(idResidente);
                } else {
                    alert('Error: ' + (result.error || 'Error al eliminar documento'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        async function updateResidente(event, idResidente) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const updateBtn = document.getElementById('updateResidenteBtn');
            const originalText = updateBtn.textContent;
            
            const formData = new FormData(form);
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showEditModalError('Debe seleccionar una residencia');
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
                return;
            }
            
            // Convertir fechas de formato español a ISO antes de enviar
            const fecha_nacimiento_es = formData.get('fecha_nacimiento');
            const fecha_ingreso_es = formData.get('fecha_ingreso');
            
            // Validar fechas antes de convertir
            if (fecha_nacimiento_es && !validarFechaEspanol(fecha_nacimiento_es)) {
                showEditModalError('La fecha de nacimiento no es válida. Use formato DD/MM/YYYY');
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
                return;
            }
            
            if (fecha_ingreso_es && !validarFechaEspanol(fecha_ingreso_es)) {
                showEditModalError('La fecha de ingreso no es válida. Use formato DD/MM/YYYY');
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
                return;
            }
            
            const data = {
                id_residencia: parseInt(id_residencia),
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                habitacion: formData.get('habitacion'),
                documento_identidad: formData.get('documento_identidad') || null,
                telefono: formData.get('telefono') || null,
                fecha_nacimiento: fecha_nacimiento_es ? fechaEspanolToISO(fecha_nacimiento_es) : null,
                direccion: formData.get('direccion') || null,
                contacto_emergencia: formData.get('contacto_emergencia') || null,
                telefono_emergencia: formData.get('telefono_emergencia') || null,
                fecha_ingreso: fecha_ingreso_es ? fechaEspanolToISO(fecha_ingreso_es) : null,
                costo_habitacion: formData.get('costo_habitacion') ? parseFloat(formData.get('costo_habitacion')) : null,
                metodo_pago_preferido: formData.get('metodo_pago_preferido') || null,
                servicios_extra: (() => {
                    // Combinar servicios extra seleccionados en el formulario de edición
                    const serviciosSeleccionados = [];
                    const checkboxesServicios = document.querySelectorAll('.edit_servicio_extra:checked');
                    checkboxesServicios.forEach(cb => {
                        serviciosSeleccionados.push(cb.value);
                    });
                    return serviciosSeleccionados.length > 0 ? serviciosSeleccionados.join(', ') : null;
                })(),
                medicaciones: formData.get('medicaciones') || null,
                peculiaridades: formData.get('peculiaridades') || null,
                grupo_sanguineo: formData.get('grupo_sanguineo') || null,
                alergias: formData.get('alergias') || null,
                diagnosticos: formData.get('diagnosticos') || null,
                restricciones_dieteticas: formData.get('restricciones_dieteticas') || null,
                nivel_dependencia: formData.get('nivel_dependencia') || null,
                movilidad: formData.get('movilidad') || null,
                medico_referencia: formData.get('medico_referencia') || null,
                telefono_medico: formData.get('telefono_medico') || null
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            updateBtn.disabled = true;
            updateBtn.textContent = 'Guardando...';
            hideEditModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showEditModalSuccess('Residente actualizado exitosamente');
                    setTimeout(() => {
                        closeModal('modalViewResidente');
                        loadResidentes(); // Recargar la lista
                    }, 1500);
                } else {
                    showEditModalError(result.error || 'Error al actualizar el residente');
                    updateBtn.disabled = false;
                    updateBtn.textContent = originalText;
                }
            } catch (error) {
                showEditModalError('Error de conexión: ' + error.message);
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
            }
        }

        function showEditModalError(message) {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showEditModalSuccess(message) {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideEditModalAlert() {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        async function saveResidente(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveResidenteBtn');
            const originalText = saveBtn.textContent;
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showModalError('Debe seleccionar una residencia');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Convertir fechas de formato español a ISO antes de enviar
            const fecha_nacimiento_es = formData.get('fecha_nacimiento');
            const fecha_ingreso_es = formData.get('fecha_ingreso');
            
            // Validar fechas antes de convertir
            if (fecha_nacimiento_es && !validarFechaEspanol(fecha_nacimiento_es)) {
                showModalError('La fecha de nacimiento no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            if (fecha_ingreso_es && !validarFechaEspanol(fecha_ingreso_es)) {
                showModalError('La fecha de ingreso no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Combinar servicios extra seleccionados
            const serviciosSeleccionados = [];
            const checkboxesServicios = form.querySelectorAll('input[name="servicio_extra"]:checked');
            checkboxesServicios.forEach(cb => {
                serviciosSeleccionados.push(cb.value);
            });
            const otrosServicios = formData.get('servicios_extra_otros') || '';
            if (otrosServicios.trim()) {
                // Dividir por comas y limpiar espacios
                const otros = otrosServicios.split(',').map(s => s.trim()).filter(s => s);
                serviciosSeleccionados.push(...otros);
            }
            const serviciosExtraCombinados = serviciosSeleccionados.length > 0 ? serviciosSeleccionados.join(', ') : null;
            
            const data = {
                id_residencia: parseInt(id_residencia),
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                habitacion: formData.get('habitacion') || null,
                documento_identidad: formData.get('documento_identidad') || null,
                telefono: formData.get('telefono') || null,
                fecha_nacimiento: fecha_nacimiento_es ? fechaEspanolToISO(fecha_nacimiento_es) : null,
                direccion: formData.get('direccion') || null,
                contacto_emergencia: formData.get('contacto_emergencia') || null,
                telefono_emergencia: formData.get('telefono_emergencia') || null,
                fecha_ingreso: fecha_ingreso_es ? fechaEspanolToISO(fecha_ingreso_es) : null,
                costo_habitacion: formData.get('costo_habitacion') ? parseFloat(formData.get('costo_habitacion')) : null,
                metodo_pago_preferido: formData.get('metodo_pago_preferido') || null,
                servicios_extra: serviciosExtraCombinados,
                medicaciones: formData.get('medicaciones') || null,
                peculiaridades: formData.get('peculiaridades') || null,
                activo: true  // Los nuevos residentes siempre son activos
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showModalSuccess('Residente agregado exitosamente');
                    setTimeout(() => {
                        closeModal('modalResidente');
                        loadResidentes(); // Recargar la lista
                    }, 1500);
                } else {
                    showModalError(result.error || 'Error al guardar el residente');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showModalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        function showModalError(message) {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showModalSuccess(message) {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideModalAlert() {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        async function savePersonal(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('savePersonalBtn');
            const originalText = saveBtn.textContent;
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showModalPersonalError('Debe seleccionar una residencia');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Convertir fecha de formato español a ISO antes de enviar
            const fecha_contratacion_es = formData.get('fecha_contratacion');
            
            // Validar fecha antes de convertir
            if (fecha_contratacion_es && !validarFechaEspanol(fecha_contratacion_es)) {
                showModalPersonalError('La fecha de contratación no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            const data = {
                id_residencia: parseInt(id_residencia),
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                documento_identidad: formData.get('documento_identidad') || null,
                telefono: formData.get('telefono') || null,
                email: formData.get('email') || null,
                cargo: formData.get('cargo') || null,
                fecha_contratacion: fecha_contratacion_es ? fechaEspanolToISO(fecha_contratacion_es) : null,
                activo: true  // Los nuevos empleados siempre son activos
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideModalPersonalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/personal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showModalPersonalSuccess('Personal agregado exitosamente');
                    setTimeout(() => {
                        closeModal('modalPersonal');
                        loadPersonal(); // Recargar la lista
                    }, 1500);
                } else {
                    showModalPersonalError(result.error || 'Error al guardar el personal');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showModalPersonalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        function showModalPersonalError(message) {
            const alert = document.getElementById('modalPersonalAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showModalPersonalSuccess(message) {
            const alert = document.getElementById('modalPersonalAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideModalPersonalAlert() {
            const alert = document.getElementById('modalPersonalAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        async function loadTurnosExtra() {
            const turnosContent = document.getElementById('turnosExtraContent');
            if (!turnosContent) return;
            
            const token = localStorage.getItem('violetas_token');
            
            // Obtener filtros
            const filtroPersonal = document.getElementById('filtroPersonal');
            const filtroAprobado = document.getElementById('filtroAprobado');
            const idPersonal = filtroPersonal ? filtroPersonal.value : '';
            const aprobado = filtroAprobado ? filtroAprobado.value : '';
            
            let url = `${API_URL}/api/v1/turnos-extra`;
            const params = new URLSearchParams();
            if (idPersonal) params.append('id_personal', idPersonal);
            if (aprobado) params.append('aprobado', aprobado);
            if (params.toString()) url += '?' + params.toString();
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON:', text);
                    turnosContent.innerHTML = `<p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${response.status}</p>`;
                    return;
                }
                
                if (response.ok) {
                    let html = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4 style="color: #667eea; margin: 0;"><img src="/static/icons/medical/clock.svg" alt="Turnos" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Turnos Extra (${data.total || 0})</h4>
                            <button class="add-btn" onclick="openModal('modalTurnoExtra')" style="padding: 8px 16px; font-size: 14px; display: inline-flex; align-items: center; gap: 6px;"><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 16px; height: 16px; filter: brightness(0) invert(1);"> Agregar Turno Extra</button>
                        </div>
                        
                        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: 600; color: #666;">Filtros:</label>
                            <select id="filtroPersonal" onchange="loadTurnosExtra()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="">Todos los empleados</option>
                            </select>
                            <select id="filtroAprobado" onchange="loadTurnosExtra()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="">Todos</option>
                                <option value="false">Pendientes</option>
                                <option value="true">Aprobados</option>
                            </select>
                        </div>
                    `;
                    
                    // Cargar lista de personal para el filtro
                    const personalResponse = await fetch(`${API_URL}/api/v1/personal`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    let personalData = { personal: [] };
                    if (personalResponse.ok) {
                        personalData = await personalResponse.json();
                    }
                    
                    // Actualizar select de personal
                    if (filtroPersonal) {
                        const currentValue = filtroPersonal.value;
                        filtroPersonal.innerHTML = '<option value="">Todos los empleados</option>';
                        personalData.personal.forEach(p => {
                            filtroPersonal.innerHTML += `<option value="${p.id_personal}" ${p.id_personal == currentValue ? 'selected' : ''}>${p.nombre} ${p.apellido}</option>`;
                        });
                    }
                    
                    if (filtroAprobado && aprobado) {
                        filtroAprobado.value = aprobado;
                    }
                    
                    if (data.turnos_extra && data.turnos_extra.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Empleado</th>
                                        <th>Fecha</th>
                                        <th>Hora Entrada</th>
                                        <th>Hora Salida</th>
                                        <th>Motivo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.turnos_extra.forEach(t => {
                            const fechaFormateada = t.fecha ? fechaISOToEspanol(t.fecha) : '-';
                            const estadoBadge = t.aprobado 
                                ? '<span style="background: #48bb78; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">✓ Aprobado</span>'
                                : '<span style="background: #ed8936; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">⏳ Pendiente</span>';
                            
                            html += `
                                <tr>
                                    <td>${t.nombre_personal || '-'}${t.cargo ? ' (' + t.cargo + ')' : ''}</td>
                                    <td>${fechaFormateada}</td>
                                    <td>${t.hora_entrada || '-'}</td>
                                    <td>${t.hora_salida || '-'}</td>
                                    <td>${t.motivo || '-'}</td>
                                    <td>${estadoBadge}</td>
                                    <td style="display: flex; gap: 5px;">
                                        ${!t.aprobado ? `<button onclick="aprobarTurnoExtra(${t.id_turno_extra})" style="padding: 6px 12px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Aprobar</button>` : ''}
                                        <button onclick="editarTurnoExtra(${t.id_turno_extra})" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Editar</button>
                                        <button onclick="eliminarTurnoExtra(${t.id_turno_extra})" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Eliminar</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No hay turnos extra registrados.</p>';
                    }
                    
                    turnosContent.innerHTML = html;
                } else {
                    if (response.status === 401) {
                        turnosContent.innerHTML = `<p style="color: red;">Error: Sesión expirada. Por favor, recarga la página.</p>`;
                        localStorage.removeItem('violetas_token');
                    } else {
                        turnosContent.innerHTML = `<p style="color: red;">Error (${response.status}): ${data.error || 'Error desconocido'}</p>`;
                    }
                }
            } catch (error) {
                console.error('Error de conexión al cargar turnos extra:', error);
                if (turnosContent) {
                    turnosContent.innerHTML = `<p style="color: red;">Error de conexión: ${error.message}</p>`;
                }
            }
        }

        async function saveTurnoExtra(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveTurnoExtraBtn');
            const originalText = saveBtn.textContent;
            const idTurnoExtra = document.getElementById('turno_id_turno_extra').value;
            
            const formData = new FormData(form);
            
            const fecha_es = formData.get('fecha');
            if (!fecha_es || !validarFechaEspanol(fecha_es)) {
                showModalTurnoExtraError('La fecha no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            const data = {
                id_personal: parseInt(formData.get('id_personal')),
                fecha: fechaEspanolToISO(fecha_es),
                hora_entrada: formData.get('hora_entrada'),
                hora_salida: formData.get('hora_salida'),
                motivo: formData.get('motivo') || null
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideModalTurnoExtraAlert();
            
            try {
                const url = idTurnoExtra 
                    ? `${API_URL}/api/v1/turnos-extra/${idTurnoExtra}`
                    : `${API_URL}/api/v1/turnos-extra`;
                const method = idTurnoExtra ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showModalTurnoExtraSuccess(idTurnoExtra ? 'Turno extra actualizado exitosamente' : 'Turno extra creado exitosamente');
                    setTimeout(() => {
                        closeModal('modalTurnoExtra');
                        loadTurnosExtra();
                    }, 1500);
                } else {
                    showModalTurnoExtraError(result.error || 'Error al guardar el turno extra');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showModalTurnoExtraError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        async function aprobarTurnoExtra(idTurnoExtra) {
            if (!confirm('¿Está seguro de aprobar este turno extra?')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/turnos-extra/${idTurnoExtra}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ aprobado: true })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Turno extra aprobado exitosamente');
                    loadTurnosExtra();
                } else {
                    alert('Error: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        async function editarTurnoExtra(idTurnoExtra) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/turnos-extra`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.turnos_extra) {
                    const turno = data.turnos_extra.find(t => t.id_turno_extra === idTurnoExtra);
                    
                    if (turno) {
                        // Cargar personal para el select
                        const personalResponse = await fetch(`${API_URL}/api/v1/personal`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const personalData = await personalResponse.json();
                        
                        const selectPersonal = document.getElementById('turno_id_personal');
                        selectPersonal.innerHTML = '<option value="">Seleccione un empleado</option>';
                        personalData.personal.forEach(p => {
                            selectPersonal.innerHTML += `<option value="${p.id_personal}" ${p.id_personal == turno.id_personal ? 'selected' : ''}>${p.nombre} ${p.apellido}</option>`;
                        });
                        
                        // Llenar formulario
                        document.getElementById('turno_id_turno_extra').value = turno.id_turno_extra;
                        document.getElementById('turno_fecha').value = turno.fecha ? fechaISOToEspanol(turno.fecha) : '';
                        document.getElementById('turno_hora_entrada').value = turno.hora_entrada || '';
                        document.getElementById('turno_hora_salida').value = turno.hora_salida || '';
                        document.getElementById('turno_motivo').value = turno.motivo || '';
                        document.getElementById('modalTurnoExtraTitle').textContent = 'Editar Turno Extra';
                        
                        // Inicializar date picker
                        const fechaInput = document.getElementById('turno_fecha');
                        if (fechaInput && !window.flatpickrTurnoExtra) {
                            window.flatpickrTurnoExtra = flatpickr(fechaInput, {
                                dateFormat: "d/m/Y",
                                locale: "es",
                                allowInput: true,
                                clickOpens: true,
                                onChange: function(selectedDates, dateStr, instance) {
                                    if (dateStr) {
                                        const partes = dateStr.split('/');
                                        if (partes.length === 3) {
                                            const dia = partes[0].padStart(2, '0');
                                            const mes = partes[1].padStart(2, '0');
                                            const año = partes[2];
                                            instance.input.value = `${dia}/${mes}/${año}`;
                                        }
                                    }
                                }
                            });
                        }
                        
                        openModal('modalTurnoExtra');
                    } else {
                        alert('Turno extra no encontrado');
                    }
                } else {
                    alert('Error al cargar el turno extra');
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        async function eliminarTurnoExtra(idTurnoExtra) {
            if (!confirm('¿Está seguro de eliminar este turno extra? Esta acción no se puede deshacer.')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/turnos-extra/${idTurnoExtra}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Turno extra eliminado exitosamente');
                    loadTurnosExtra();
                } else {
                    alert('Error: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        function showModalTurnoExtraError(message) {
            const alert = document.getElementById('modalTurnoExtraAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showModalTurnoExtraSuccess(message) {
            const alert = document.getElementById('modalTurnoExtraAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideModalTurnoExtraAlert() {
            const alert = document.getElementById('modalTurnoExtraAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }
    </script>
    
</body>
</html>

