<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Violetas - Sistema de Gesti√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            box-sizing: border-box;
        }

        .logo {
            text-align: left;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #666;
            font-size: 14px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header-logo {
            flex: 1;
        }

        .header-logo h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 5px;
        }

        .header-logo p {
            color: #666;
            font-size: 14px;
            margin: 0;
        }

        .user-menu-container {
            position: relative;
        }

        .user-icon-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .user-icon-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .user-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .user-menu.show {
            display: block;
        }

        .user-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            font-size: 14px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .user-menu-item:hover {
            background: #f5f5f5;
        }

        .user-menu-item:first-child {
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .user-menu-item:last-child {
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        .user-menu-item.logout {
            color: #dc3545;
            border-top: 1px solid #e0e0e0;
        }

        .user-menu-item.logout:hover {
            background: #fee;
        }

        .user-menu-info {
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f9f9f9;
        }

        .user-menu-info-item {
            font-size: 11px;
            color: #666;
            margin: 4px 0;
            line-height: 1.4;
        }

        .user-menu-info-item strong {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background-color: #ffffff;
            color: #333333;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background-color: #ffffff;
            color: #333333;
        }

        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            background-color: #ffffff;
            color: #333333;
            transition: all 0.3s;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert.success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        .token-display {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            display: none;
        }

        .token-display h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .token-value {
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            color: #666;
            border: 1px solid #ddd;
        }

        .copy-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: #667eea;
            font-size: 14px;
        }

        .user-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 10px;
            display: none;
        }

        .user-info h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .logout-btn {
            margin-top: 15px;
            background: #dc3545;
        }

        .logout-btn:hover {
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .module-btn {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .module-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            position: relative;
            top: 2px;
        }

        .tab:hover {
            color: #667eea;
            background: #f0f7ff;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .module-content {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            overflow-x: auto;
            max-width: 100%;
            box-sizing: border-box;
        }

        .data-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .data-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            background: white;
            color: #333;
        }

        .data-table tr:hover {
            background: #f0f0f0;
        }

        .data-table tr:hover td {
            background: #f0f0f0;
        }

        .add-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .add-btn:hover {
            background: #218838;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .close-modal:hover {
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header para login -->
        <div class="logo" id="loginHeader">
            <h1>üè• Violetas Sistema de Gesti√≥n de Residencias</h1>
        </div>

        <!-- Header para dashboard con men√∫ de usuario -->
        <div class="header" id="dashboardHeader" style="display: none;">
            <div class="header-logo">
                <h1>üè• Violetas Sistema de Gesti√≥n de Residencias</h1>
            </div>
            <div class="user-menu-container">
                <button class="user-icon-btn" onclick="toggleUserMenu()" title="Men√∫ de usuario">
                    üë§
                </button>
                <div class="user-menu" id="userMenu">
                    <div class="user-menu-info" id="userMenuInfo">
                        <div class="user-menu-info-item"><strong>ID Usuario:</strong> -</div>
                        <div class="user-menu-info-item"><strong>Rol ID:</strong> -</div>
                        <div class="user-menu-info-item"><strong>Residencia ID:</strong> -</div>
                        <div class="user-menu-info-item"><strong>Expira:</strong> -</div>
                    </div>
                    <button class="user-menu-item" onclick="showConfiguracion()">
                        ‚öôÔ∏è Configuraci√≥n
                    </button>
                    <button class="user-menu-item logout" onclick="logout()">
                        üö™ Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>

        <div id="loginForm">
            <div id="alert" class="alert"></div>
            
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required 
                           placeholder="admin@violetas1.com" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" name="password" required 
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                </div>

                <button type="submit" id="loginBtn">Iniciar Sesi√≥n</button>
            </form>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="user-info" id="userInfo" style="display: none;"></div>
            
            <div style="margin-top: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìã M√≥dulos del Sistema</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <button class="module-btn" onclick="showModule('residentes')">
                        üë• Residentes
                    </button>
                    <button class="module-btn" onclick="showModule('facturacion')">
                        üí∞ Facturaci√≥n
                    </button>
                    <button class="module-btn" onclick="showModule('personal')">
                        üëî Personal
                    </button>
                    <button class="module-btn" onclick="showModule('token')">
                        üîë Token JWT
                    </button>
                </div>
            </div>

            <div id="moduleContent" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Modal para ver/editar residente -->
    <div id="modalViewResidente" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üë§ Detalle del Residente</h2>
                <button class="close-modal" onclick="closeModal('modalViewResidente')">&times;</button>
            </div>
            <div id="viewResidenteContent">
                <p>Cargando...</p>
            </div>
        </div>
    </div>

    <!-- Modal para agregar residente -->
    <div id="modalResidente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Agregar Residente</h2>
                <button class="close-modal" onclick="closeModal('modalResidente')">&times;</button>
            </div>
            <form id="formResidente" onsubmit="saveResidente(event)">
                
                <!-- SECCI√ìN: Informaci√≥n de Residencia -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">üè† Informaci√≥n de Residencia</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="res_id_residencia">Residencia *</label>
                            <select id="res_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione una residencia</option>
                                <option value="1">Violetas 1</option>
                                <option value="2">Violetas 2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="res_habitacion">Habitaci√≥n *</label>
                            <input type="text" id="res_habitacion" name="habitacion" required placeholder="Ej: 101, A-12">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="res_fecha_ingreso">Fecha de Ingreso</label>
                            <input type="text" id="res_fecha_ingreso" name="fecha_ingreso" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)">
                        </div>
                        <div class="form-group">
                            <label for="res_costo_habitacion">Costo de Habitaci√≥n (‚Ç¨)</label>
                            <input type="number" id="res_costo_habitacion" name="costo_habitacion" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="res_metodo_pago_preferido">M√©todo de Pago Preferido</label>
                            <select id="res_metodo_pago_preferido" name="metodo_pago_preferido" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un m√©todo</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="remesa">Remesa</option>
                                <option value="met√°lico">Met√°lico</option>
                                <option value="bizum">Bizum</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN: Informaci√≥n Personal -->
                <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                    <h3 style="color: #f56565; margin-bottom: 15px; font-size: 18px;">üë§ Informaci√≥n Personal</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="res_nombre">Nombre *</label>
                            <input type="text" id="res_nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="res_apellido">Apellido *</label>
                            <input type="text" id="res_apellido" name="apellido" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="res_documento">Documento de Identidad</label>
                            <input type="text" id="res_documento" name="documento_identidad">
                        </div>
                        <div class="form-group">
                            <label for="res_fecha_nacimiento">Fecha de Nacimiento</label>
                            <input type="text" id="res_fecha_nacimiento" name="fecha_nacimiento" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)">
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN: Informaci√≥n de Contacto -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;">üìû Informaci√≥n de Contacto</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="res_telefono">Tel√©fono</label>
                            <input type="tel" id="res_telefono" name="telefono">
                        </div>
                        <div class="form-group">
                            <label for="res_direccion">Direcci√≥n</label>
                            <input type="text" id="res_direccion" name="direccion">
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <h4 style="color: #48bb78; margin-bottom: 10px; font-size: 14px; font-weight: 600;">Contacto de Emergencia</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="res_contacto_emergencia">Nombre del Contacto</label>
                                <input type="text" id="res_contacto_emergencia" name="contacto_emergencia">
                            </div>
                            <div class="form-group">
                                <label for="res_telefono_emergencia">Tel√©fono de Emergencia</label>
                                <input type="tel" id="res_telefono_emergencia" name="telefono_emergencia">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN: Informaci√≥n M√©dica y Servicios -->
                <div style="background: #fffaf0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                    <h3 style="color: #ed8936; margin-bottom: 15px; font-size: 18px;">üè• Informaci√≥n M√©dica y Servicios</h3>
                    <div class="form-group">
                        <label for="res_medicaciones">Medicaciones</label>
                        <textarea id="res_medicaciones" name="medicaciones" rows="3" placeholder="Lista de medicaciones y horarios"></textarea>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="res_servicios_extra">Servicios Extra</label>
                        <textarea id="res_servicios_extra" name="servicios_extra" rows="3" placeholder="Ej: Lavander√≠a, Peluquer√≠a, etc."></textarea>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="res_peculiaridades">Peculiaridades / Notas Importantes</label>
                        <textarea id="res_peculiaridades" name="peculiaridades" rows="3" placeholder="Informaci√≥n adicional relevante"></textarea>
                    </div>
                </div>
                
                <!-- SECCI√ìN: Estado -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #718096;">
                    <h3 style="color: #718096; margin-bottom: 15px; font-size: 18px;">‚öôÔ∏è Estado</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="res_activo" name="activo" checked style="width: auto; margin-right: 8px;">
                            Residente Activo
                        </label>
                    </div>
                </div>
                <div id="modalAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveResidenteBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalResidente')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar proveedor -->
    <div id="modalProveedor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Agregar Proveedor</h2>
                <button class="close-modal" onclick="closeModal('modalProveedor')">&times;</button>
            </div>
            <form id="formProveedor" onsubmit="saveProveedor(event)">
                
                <!-- SECCI√ìN: Informaci√≥n B√°sica -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">üìã Informaci√≥n B√°sica</h3>
                    <div class="form-group">
                        <label for="prov_nombre">Nombre del Proveedor *</label>
                        <input type="text" id="prov_nombre" name="nombre" required placeholder="Ej: Empresa de Limpieza SL">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="prov_nif_cif">NIF/CIF</label>
                            <input type="text" id="prov_nif_cif" name="nif_cif" placeholder="B12345678">
                        </div>
                        <div class="form-group">
                            <label for="prov_tipo_servicio">Tipo de Servicio</label>
                            <select id="prov_tipo_servicio" name="tipo_servicio" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un tipo</option>
                                <option value="Limpieza">Limpieza</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Alimentaci√≥n">Alimentaci√≥n</option>
                                <option value="Farmacia">Farmacia</option>
                                <option value="Servicios M√©dicos">Servicios M√©dicos</option>
                                <option value="Suministros">Suministros</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN: Informaci√≥n de Contacto -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;">üìû Informaci√≥n de Contacto</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="prov_telefono">Tel√©fono</label>
                            <input type="tel" id="prov_telefono" name="telefono" placeholder="666 555 444">
                        </div>
                        <div class="form-group">
                            <label for="prov_email">Email</label>
                            <input type="email" id="prov_email" name="email" placeholder="contacto@proveedor.com">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="prov_direccion">Direcci√≥n</label>
                            <input type="text" id="prov_direccion" name="direccion" placeholder="Calle, n√∫mero, ciudad">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="prov_contacto">Persona de Contacto</label>
                            <input type="text" id="prov_contacto" name="contacto" placeholder="Nombre del contacto principal">
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN: Estado y Observaciones -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #718096;">
                    <h3 style="color: #718096; margin-bottom: 15px; font-size: 18px;">‚öôÔ∏è Estado y Observaciones</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="prov_activo" name="activo" checked style="width: auto; margin-right: 8px;">
                            Proveedor Activo
                        </label>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="prov_observaciones">Observaciones</label>
                        <textarea id="prov_observaciones" name="observaciones" rows="3" placeholder="Notas adicionales sobre el proveedor"></textarea>
                    </div>
                </div>
                
                <div id="modalProveedorAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveProveedorBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalProveedor')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar pago a proveedor -->
    <div id="modalPagoProveedor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∞ Agregar Pago a Proveedor</h2>
                <button class="close-modal" onclick="closeModal('modalPagoProveedor')">&times;</button>
            </div>
            <form id="formPagoProveedor" onsubmit="savePagoProveedor(event)">
                
                <!-- SECCI√ìN: Informaci√≥n del Pago -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">üí≥ Informaci√≥n del Pago</h3>
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label for="pago_id_proveedor">Proveedor *</label>
                            <button type="button" onclick="openModal('modalProveedor')" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">+ Nuevo Proveedor</button>
                        </div>
                        <select id="pago_id_proveedor" name="id_proveedor" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Cargando proveedores...</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_concepto">Concepto *</label>
                            <input type="text" id="pago_concepto" name="concepto" required placeholder="Ej: Servicio de limpieza mensual">
                        </div>
                        <div class="form-group">
                            <label for="pago_monto">Monto (‚Ç¨) *</label>
                            <input type="number" id="pago_monto" name="monto" step="0.01" required placeholder="0.00">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_fecha_pago">Fecha de Pago</label>
                            <input type="text" id="pago_fecha_pago" name="fecha_pago" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)">
                        </div>
                        <div class="form-group">
                            <label for="pago_fecha_prevista">Fecha Prevista</label>
                            <input type="text" id="pago_fecha_prevista" name="fecha_prevista" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_metodo_pago">M√©todo de Pago</label>
                            <select id="pago_metodo_pago" name="metodo_pago" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un m√©todo</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="remesa">Remesa</option>
                                <option value="met√°lico">Met√°lico</option>
                                <option value="cheque">Cheque</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pago_numero_factura">N√∫mero de Factura</label>
                            <input type="text" id="pago_numero_factura" name="numero_factura" placeholder="FAC-2025-001">
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN: Tipo de Pago -->
                <div style="background: #fffaf0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                    <h3 style="color: #ed8936; margin-bottom: 15px; font-size: 18px;">üìä Tipo de Pago</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="pago_es_estimacion" name="es_estimacion" style="width: auto; margin-right: 8px;">
                            Es una Estimaci√≥n (no es un pago real)
                        </label>
                    </div>
                    <div id="estimacionFields" style="display: none; margin-top: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="pago_frecuencia_pago">Frecuencia de Pago</label>
                                <select id="pago_frecuencia_pago" name="frecuencia_pago" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                    <option value="">Seleccione frecuencia</option>
                                    <option value="mensual">Mensual</option>
                                    <option value="trimestral">Trimestral</option>
                                    <option value="semestral">Semestral</option>
                                    <option value="anual">Anual</option>
                                    <option value="puntual">Puntual</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pago_monto_estimado">Monto Estimado (‚Ç¨)</label>
                                <input type="number" id="pago_monto_estimado" name="monto_estimado" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN: Estado y Observaciones -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #718096;">
                    <h3 style="color: #718096; margin-bottom: 15px; font-size: 18px;">‚öôÔ∏è Estado y Observaciones</h3>
                    <div class="form-group">
                        <label for="pago_estado">Estado</label>
                        <select id="pago_estado" name="estado" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="pendiente">Pendiente</option>
                            <option value="pagado">Pagado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="pago_observaciones">Observaciones</label>
                        <textarea id="pago_observaciones" name="observaciones" rows="3" placeholder="Notas adicionales sobre el pago"></textarea>
                    </div>
                </div>
                
                <div id="modalPagoProveedorAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="savePagoProveedorBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalPagoProveedor')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentToken = null;

        // Verificar si hay token guardado
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('violetas_token');
            if (savedToken) {
                verifyToken(savedToken);
            }
        });

        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const alert = document.getElementById('alert');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando sesi√≥n...';
            hideAlert();

            try {
                const response = await fetch(`${API_URL}/api/v1/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentToken = data.token;
                    localStorage.setItem('violetas_token', currentToken);
                    showSuccess('¬°Login exitoso!');
                    showDashboard(currentToken);
                } else {
                    showError(data.error || 'Error al iniciar sesi√≥n');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesi√≥n';
                }
            } catch (error) {
                showError('Error de conexi√≥n. Verifica que el servidor est√© corriendo.');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
            }
        });

        async function verifyToken(token) {
            try {
                // Decodificar el token (sin verificar, solo para mostrar info)
                const payload = JSON.parse(atob(token.split('.')[1]));
                
                // Mostrar dashboard
                showDashboard(token);
                
                // Actualizar informaci√≥n del usuario en el men√∫
                const userMenuInfo = document.getElementById('userMenuInfo');
                if (userMenuInfo) {
                    userMenuInfo.innerHTML = `
                        <div class="user-menu-info-item"><strong>ID Usuario:</strong> ${payload.id_usuario}</div>
                        <div class="user-menu-info-item"><strong>Rol ID:</strong> ${payload.id_rol}</div>
                        <div class="user-menu-info-item"><strong>Residencia ID:</strong> ${payload.id_residencia}</div>
                        <div class="user-menu-info-item"><strong>Expira:</strong> ${new Date(payload.exp * 1000).toLocaleString('es-ES')}</div>
                    `;
                }
                
                // Ocultar la secci√≥n userInfo antigua
                document.getElementById('userInfo').style.display = 'none';
            } catch (error) {
                console.error('Error al verificar token:', error);
                logout();
            }
        }

        function showDashboard(token) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('loginHeader').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('dashboardHeader').style.display = 'flex';
            // tokenValue solo existe cuando se muestra el m√≥dulo de token, as√≠ que verificamos primero
            const tokenValueEl = document.getElementById('tokenValue');
            if (tokenValueEl) {
                tokenValueEl.textContent = token;
            }
            // tokenDisplay no existe en el HTML inicial, solo se crea din√°micamente
            // No intentamos acceder a √©l aqu√≠ para evitar errores
        }

        function logout() {
            localStorage.removeItem('violetas_token');
            currentToken = null;
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('loginHeader').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('dashboardHeader').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            hideAlert();
            closeUserMenu();
        }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('show');
        }

        function closeUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.remove('show');
        }

        function showConfiguracion() {
            closeUserMenu();
            alert('Configuraci√≥n - Pr√≥ximamente');
        }

        // Cerrar el men√∫ al hacer clic fuera
        document.addEventListener('click', function(event) {
            const menuContainer = document.querySelector('.user-menu-container');
            const menu = document.getElementById('userMenu');
            if (menuContainer && !menuContainer.contains(event.target) && menu.classList.contains('show')) {
                closeUserMenu();
            }
        });

        function copyToken() {
            const tokenValue = document.getElementById('tokenValue').textContent;
            navigator.clipboard.writeText(tokenValue).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '¬°Copiado!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function showError(message) {
            const alert = document.getElementById('alert');
            alert.className = 'alert error';
            alert.textContent = message;
            alert.style.display = 'block';
        }

        function showSuccess(message) {
            const alert = document.getElementById('alert');
            alert.className = 'alert success';
            alert.textContent = message;
            alert.style.display = 'block';
        }

        function hideAlert() {
            document.getElementById('alert').style.display = 'none';
        }

        function showModule(module) {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            if (module === 'token') {
                content.innerHTML = `
                    <div class="module-content">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üîë Token JWT</h3>
                        <div class="token-display">
                            <div class="token-value" id="tokenValue">${token}</div>
                            <button class="copy-btn" onclick="copyToken()" style="margin-top: 10px;">Copiar Token</button>
                        </div>
                    </div>
                `;
            } else if (module === 'residentes') {
                loadResidentes();
            } else if (module === 'facturacion') {
                loadFacturacion();
            } else if (module === 'personal') {
                loadPersonal();
            }
        }

        async function loadResidentes() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando residentes...</p>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 15px;">üë• Residentes (${data.total})</h3>
                            <button class="add-btn" onclick="openModal('modalResidente')">+ Agregar Residente</button>
                    `;
                    
                    if (data.residentes && data.residentes.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Residencia</th>
                                        <th>Nombre</th>
                                        <th>Habitaci√≥n</th>
                                        <th>Documento</th>
                                        <th>Tel√©fono</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.residentes.forEach(res => {
                            html += `
                                <tr style="cursor: pointer;" onclick="viewResidente(${res.id_residente})">
                                    <td>${res.nombre_residencia || (res.id_residencia === 1 ? 'Violetas 1' : res.id_residencia === 2 ? 'Violetas 2' : `Residencia ${res.id_residencia}`)}</td>
                                    <td>${res.nombre} ${res.apellido}</td>
                                    <td>${res.habitacion || '-'}</td>
                                    <td>${res.documento_identidad || '-'}</td>
                                    <td>${res.telefono || '-'}</td>
                                    <td>${res.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No hay residentes registrados.</p>';
                    }
                    
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: ${data.error}</p></div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexi√≥n: ${error.message}</p></div>`;
            }
        }

        async function loadFacturacion() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando facturaci√≥n...</p>
                    </div>
                </div>
            `;
            
            try {
                // Cargar cobros y pagos a proveedores
                let cobrosRes = await fetch(`${API_URL}/api/v1/facturacion/cobros`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                let cobrosData = await cobrosRes.json();
                
                // Si no hay cobros previstos, intentar generarlos autom√°ticamente
                const tieneCobrosPrevistos = cobrosData.cobros && cobrosData.cobros.length > 0 && 
                                            cobrosData.cobros.some(c => c && c.es_cobro_previsto === true);
                
                if (cobrosRes.ok && !tieneCobrosPrevistos) {
                    try {
                        console.log('Generando cobros previstos autom√°ticamente...');
                        const generarRes = await fetch(`${API_URL}/api/v1/facturacion/cobros/generar-previstos`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({})
                        });
                        
                        const generarData = await generarRes.json();
                        
                        if (generarRes.ok) {
                            console.log(`‚úÖ Cobros generados: ${generarData.cobros_generados || 0}`);
                            // Recargar los cobros despu√©s de generarlos
                            cobrosRes = await fetch(`${API_URL}/api/v1/facturacion/cobros`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            cobrosData = await cobrosRes.json();
                        } else {
                            console.warn('‚ö†Ô∏è No se pudieron generar cobros previstos:', generarData.error || 'Error desconocido');
                        }
                    } catch (e) {
                        console.error('‚ùå Error al generar cobros previstos autom√°ticamente:', e);
                    }
                }
                
                const proveedoresRes = await fetch(`${API_URL}/api/v1/facturacion/proveedores`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const proveedoresData = await proveedoresRes.json();
                
                if (cobrosRes.ok && proveedoresRes.ok) {
                    // Filtrar cobros previstos: pendientes y completados
                    const todosCobrosPrevistos = cobrosData.cobros ? cobrosData.cobros.filter(c => c.es_cobro_previsto) : [];
                    const cobrosPrevistos = todosCobrosPrevistos.filter(c => c.estado === 'pendiente');
                    const cobrosCompletados = todosCobrosPrevistos.filter(c => c.estado === 'cobrado');
                    
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 20px;">üí∞ Facturaci√≥n</h3>
                            
                            <div class="tabs-container">
                                <div class="tabs">
                                    <button class="tab active" onclick="switchFacturacionTab('cobros')">üíµ Cobros</button>
                                    <button class="tab" onclick="switchFacturacionTab('pagos')">üè¢ Pagos a Proveedores</button>
                                </div>
                                
                                <!-- Pesta√±a de Cobros -->
                                <div id="tabCobros" class="tab-content active">
                                    <div style="margin-bottom: 30px;">
                                        <h4 style="color: #667eea; margin-bottom: 10px;">üìã Cobros Previstos (${cobrosPrevistos.length})</h4>
                    `;
                    
                    if (cobrosPrevistos.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Residente</th>
                                        <th>Monto</th>
                                        <th>Fecha Prevista</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        cobrosPrevistos.forEach(cobro => {
                            const fechaPrevista = cobro.fecha_prevista ? fechaISOToEspanol(cobro.fecha_prevista) : '-';
                            html += `
                                <tr>
                                    <td style="color: #333;">${cobro.residente}</td>
                                    <td style="color: #333;">‚Ç¨${parseFloat(cobro.monto).toFixed(2)}</td>
                                    <td style="color: #333;">${fechaPrevista}</td>
                                    <td><span style="color: #ffc107; font-weight: 600;">Pendiente</span></td>
                                    <td>
                                        <button onclick="cambiarEstadoCobro(${cobro.id_pago}, 'cobrado')" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Marcar como Cobrado</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p style="color: #333;">No hay cobros previstos pendientes.</p>';
                    }
                    
                    html += `
                                    </div>
                                    
                                    <div style="margin-bottom: 30px;">
                                        <h4 style="color: #667eea; margin-bottom: 10px;">‚úÖ Cobros Completados (${cobrosCompletados.length})</h4>
                    `;
                    
                    if (cobrosCompletados.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Residente</th>
                                        <th>Monto</th>
                                        <th>Fecha Prevista</th>
                                        <th>Fecha de Pago</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        cobrosCompletados.forEach(cobro => {
                            const fechaPrevista = cobro.fecha_prevista ? fechaISOToEspanol(cobro.fecha_prevista) : '-';
                            const fechaPago = cobro.fecha_pago ? fechaISOToEspanol(cobro.fecha_pago) : '-';
                            html += `
                                <tr>
                                    <td style="color: #333;">${cobro.residente}</td>
                                    <td style="color: #333;">‚Ç¨${parseFloat(cobro.monto).toFixed(2)}</td>
                                    <td style="color: #333;">${fechaPrevista}</td>
                                    <td style="color: #333;">${fechaPago}</td>
                                    <td><span style="color: #28a745; font-weight: 600;">‚úÖ Cobrado</span></td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p style="color: #333;">No hay cobros completados.</p>';
                    }
                    
                    html += `
                                    </div>
                                    
                                    <!-- Gr√°fico de Estimaci√≥n Mensual e Hist√≥rico -->
                                    <div style="margin-bottom: 30px; margin-top: 30px;">
                                        <h4 style="color: #667eea; margin-bottom: 15px;">üìä Estimaci√≥n Mensual e Hist√≥rico de Cobros</h4>
                                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <canvas id="cobrosChart" style="max-height: 400px;"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pesta√±a de Pagos a Proveedores -->
                                <div id="tabPagos" class="tab-content">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <h4 style="color: #667eea; margin: 0;">üè¢ Pagos a Proveedores (${proveedoresData.total || 0})</h4>
                                        <div style="display: flex; gap: 10px;">
                                            <button class="add-btn" onclick="openModal('modalProveedor')" style="padding: 8px 16px; font-size: 14px; background: #6c757d;">+ Proveedor</button>
                                            <button class="add-btn" onclick="openModalProveedor()" style="padding: 8px 16px; font-size: 14px;">+ Pago Proveedor</button>
                                        </div>
                                    </div>
                    `;
                    
                    if (proveedoresData.pagos && proveedoresData.pagos.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Proveedor</th>
                                        <th>Concepto</th>
                                        <th>Monto</th>
                                        <th>Fecha Prevista</th>
                                        <th>Estado</th>
                                        <th>Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        proveedoresData.pagos.forEach(pago => {
                            const tipo = pago.es_estimacion ? 'üìä Estimaci√≥n' : 'üí∞ Real';
                            html += `
                                <tr>
                                    <td>${pago.proveedor}</td>
                                    <td>${pago.concepto}</td>
                                    <td>‚Ç¨${parseFloat(pago.monto || pago.monto_estimado || 0).toFixed(2)}</td>
                                    <td>${pago.fecha_prevista || pago.fecha_pago || '-'}</td>
                                    <td>${pago.estado}</td>
                                    <td>${tipo}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p style="color: #333;">No hay pagos a proveedores registrados.</p>';
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                    content.innerHTML = html;
                    
                    // Cargar y mostrar gr√°fico de cobros
                    await loadCobrosChart();
                } else {
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error al cargar facturaci√≥n</p></div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexi√≥n: ${error.message}</p></div>`;
            }
        }
        
        async function cambiarEstadoCobro(idPago, nuevoEstado) {
            const token = localStorage.getItem('violetas_token');
            
            if (!confirm(`¬øEst√° seguro de marcar este cobro como "${nuevoEstado}"?`)) {
                return;
            }
            
            try {
                // Preparar datos para actualizar
                const data = {
                    estado: nuevoEstado
                };
                
                // Si se marca como cobrado, establecer la fecha de pago a hoy
                if (nuevoEstado === 'cobrado') {
                    const hoy = new Date();
                    const fechaHoy = hoy.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                    data.fecha_pago = fechaHoy;
                }
                
                const response = await fetch(`${API_URL}/api/v1/facturacion/cobros/${idPago}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Recargar la lista de cobros
                    await loadFacturacion();
                } else {
                    alert('Error: ' + (result.error || 'Error al actualizar el cobro'));
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        }
        
        async function openModalProveedor() {
            // Cargar proveedores antes de abrir el modal
            await loadProveedoresForSelect();
            openModal('modalPagoProveedor');
        }

        async function loadProveedoresForSelect() {
            const token = localStorage.getItem('violetas_token');
            const select = document.getElementById('pago_id_proveedor');
            
            if (!select) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/proveedores`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.proveedores) {
                    select.innerHTML = '<option value="">Seleccione un proveedor</option>';
                    data.proveedores.filter(p => p.activo).forEach(prov => {
                        select.innerHTML += `<option value="${prov.id_proveedor}">${prov.nombre}${prov.tipo_servicio ? ' - ' + prov.tipo_servicio : ''}</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">No hay proveedores disponibles</option>';
                }
            } catch (error) {
                console.error('Error al cargar proveedores:', error);
                select.innerHTML = '<option value="">Error al cargar proveedores</option>';
            }
        }

        async function saveProveedor(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveProveedorBtn');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            const activoCheckbox = document.getElementById('prov_activo');
            
            const data = {
                nombre: formData.get('nombre'),
                nif_cif: formData.get('nif_cif') || null,
                direccion: formData.get('direccion') || null,
                telefono: formData.get('telefono') || null,
                email: formData.get('email') || null,
                contacto: formData.get('contacto') || null,
                tipo_servicio: formData.get('tipo_servicio') || null,
                activo: activoCheckbox ? activoCheckbox.checked : true,
                observaciones: formData.get('observaciones') || null
            };
            
            // Limpiar valores vac√≠os
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideProveedorModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/proveedores`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showProveedorModalSuccess('Proveedor agregado exitosamente');
                    setTimeout(() => {
                        closeModal('modalProveedor');
                        // Recargar el select de proveedores si el modal de pago est√° abierto
                        if (document.getElementById('modalPagoProveedor').style.display === 'block') {
                            loadProveedoresForSelect();
                        }
                    }, 1500);
                } else {
                    showProveedorModalError(result.error || 'Error al guardar el proveedor');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showProveedorModalError('Error de conexi√≥n: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        async function savePagoProveedor(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('savePagoProveedorBtn');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            const id_proveedor = formData.get('id_proveedor');
            const es_estimacion = document.getElementById('pago_es_estimacion').checked;
            
            if (!id_proveedor) {
                showPagoProveedorModalError('Debe seleccionar un proveedor');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Obtener nombre del proveedor del select
            const selectProveedor = document.getElementById('pago_id_proveedor');
            const nombreProveedor = selectProveedor.options[selectProveedor.selectedIndex].text.split(' - ')[0];
            
            // Convertir fechas de formato espa√±ol a ISO
            const fecha_pago_es = formData.get('fecha_pago');
            const fecha_prevista_es = formData.get('fecha_prevista');
            
            // Validar fechas
            if (fecha_pago_es && !validarFechaEspanol(fecha_pago_es)) {
                showPagoProveedorModalError('La fecha de pago no es v√°lida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            if (fecha_prevista_es && !validarFechaEspanol(fecha_prevista_es)) {
                showPagoProveedorModalError('La fecha prevista no es v√°lida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            const data = {
                proveedor: nombreProveedor, // Por ahora usamos el nombre, luego podemos usar id_proveedor
                concepto: formData.get('concepto'),
                monto: formData.get('monto') ? parseFloat(formData.get('monto')) : null,
                fecha_pago: fecha_pago_es ? fechaEspanolToISO(fecha_pago_es) : null,
                fecha_prevista: fecha_prevista_es ? fechaEspanolToISO(fecha_prevista_es) : null,
                metodo_pago: formData.get('metodo_pago') || null,
                numero_factura: formData.get('numero_factura') || null,
                estado: formData.get('estado') || 'pendiente',
                es_estimacion: es_estimacion,
                frecuencia_pago: formData.get('frecuencia_pago') || null,
                monto_estimado: formData.get('monto_estimado') ? parseFloat(formData.get('monto_estimado')) : null,
                observaciones: formData.get('observaciones') || null
            };
            
            // Si es estimaci√≥n y no hay monto, usar monto_estimado
            if (es_estimacion && !data.monto && data.monto_estimado) {
                data.monto = data.monto_estimado;
            }
            
            // Limpiar valores vac√≠os
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hidePagoProveedorModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/proveedores`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showPagoProveedorModalSuccess('Pago a proveedor registrado exitosamente');
                    setTimeout(() => {
                        closeModal('modalPagoProveedor');
                        loadFacturacion(); // Recargar la lista
                    }, 1500);
                } else {
                    showPagoProveedorModalError(result.error || 'Error al guardar el pago');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showPagoProveedorModalError('Error de conexi√≥n: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        function showProveedorModalError(message) {
            const alert = document.getElementById('modalProveedorAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showProveedorModalSuccess(message) {
            const alert = document.getElementById('modalProveedorAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideProveedorModalAlert() {
            const alert = document.getElementById('modalProveedorAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        function showPagoProveedorModalError(message) {
            const alert = document.getElementById('modalPagoProveedorAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showPagoProveedorModalSuccess(message) {
            const alert = document.getElementById('modalPagoProveedorAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hidePagoProveedorModalAlert() {
            const alert = document.getElementById('modalPagoProveedorAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        let cobrosChart = null;

        async function loadCobrosChart() {
            const token = localStorage.getItem('violetas_token');
            const canvas = document.getElementById('cobrosChart');
            
            if (!canvas) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/cobros/estadisticas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Destruir gr√°fico anterior si existe
                    if (cobrosChart) {
                        cobrosChart.destroy();
                    }
                    
                    // Preparar datos para el gr√°fico
                    const historico = data.historico || [];
                    const estimaciones = data.estimaciones || [];
                    
                    // Combinar todos los meses (hist√≥rico + estimaciones)
                    const todosMeses = new Set();
                    historico.forEach(h => todosMeses.add(h.mes));
                    estimaciones.forEach(e => todosMeses.add(e.mes));
                    
                    const mesesOrdenados = Array.from(todosMeses).sort();
                    
                    // Crear mapas para acceso r√°pido
                    const historicoMap = {};
                    historico.forEach(h => {
                        historicoMap[h.mes] = h.total;
                    });
                    
                    const estimacionesMap = {};
                    estimaciones.forEach(e => {
                        estimacionesMap[e.mes] = e.total;
                    });
                    
                    // Preparar datos para Chart.js
                    const labels = mesesOrdenados.map(mes => {
                        const [a√±o, mesNum] = mes.split('-');
                        const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        return `${meses[parseInt(mesNum) - 1]} ${a√±o}`;
                    });
                    
                    const datosHistoricos = mesesOrdenados.map(mes => historicoMap[mes] || 0);
                    const datosEstimaciones = mesesOrdenados.map(mes => estimacionesMap[mes] || 0);
                    
                    // Crear el gr√°fico
                    const ctx = canvas.getContext('2d');
                    cobrosChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Cobros Realizados (Hist√≥rico)',
                                    data: datosHistoricos,
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                },
                                {
                                    label: 'Cobros Previstos (Estimaci√≥n)',
                                    data: datosEstimaciones,
                                    borderColor: '#ffc107',
                                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 15,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            label += '‚Ç¨' + context.parsed.y.toFixed(2);
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '‚Ç¨' + value.toFixed(0);
                                        },
                                        font: {
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                } else {
                    console.error('Error al cargar estad√≠sticas:', data.error);
                }
            } catch (error) {
                console.error('Error al cargar gr√°fico de cobros:', error);
            }
        }

        // Funci√≥n para cambiar entre pesta√±as de facturaci√≥n
        function switchFacturacionTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover clase active de todos los botones
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar la pesta√±a seleccionada
            const tabContent = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            
            // Activar el bot√≥n correspondiente
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((btn, index) => {
                if ((tabName === 'cobros' && index === 0) || (tabName === 'pagos' && index === 1)) {
                    btn.classList.add('active');
                }
            });
            
            if (tabContent) {
                tabContent.classList.add('active');
            }
        }

        // Mostrar/ocultar campos de estimaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            const esEstimacionCheckbox = document.getElementById('pago_es_estimacion');
            const estimacionFields = document.getElementById('estimacionFields');
            
            if (esEstimacionCheckbox && estimacionFields) {
                esEstimacionCheckbox.addEventListener('change', function() {
                    estimacionFields.style.display = this.checked ? 'block' : 'none';
                });
            }
        });

        async function loadPersonal() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando personal...</p>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/personal`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 15px;">üëî Personal (${data.total})</h3>
                            <button class="add-btn" onclick="alert('Funci√≥n de agregar personal pr√≥ximamente')">+ Agregar Personal</button>
                    `;
                    
                    if (data.personal && data.personal.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Cargo</th>
                                        <th>Tel√©fono</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.personal.forEach(p => {
                            html += `
                                <tr>
                                    <td>${p.nombre} ${p.apellido}</td>
                                    <td>${p.cargo || '-'}</td>
                                    <td>${p.telefono || '-'}</td>
                                    <td>${p.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No hay personal registrado.</p>';
                    }
                    
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: ${data.error}</p></div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexi√≥n: ${error.message}</p></div>`;
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            
            // Si es el modal de agregar residente, establecer residencia por defecto seg√∫n el token
            if (modalId === 'modalResidente') {
                const token = localStorage.getItem('violetas_token');
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const residenciaId = payload.id_residencia;
                        const selectResidencia = document.getElementById('res_id_residencia');
                        if (selectResidencia) {
                            selectResidencia.value = residenciaId; // Establecer como valor por defecto
                        }
                    } catch (e) {
                        console.error('Error al obtener residencia del token:', e);
                    }
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            const form = document.getElementById('formResidente');
            if (form) {
                form.reset();
                const activoCheckbox = document.getElementById('res_activo');
                if (activoCheckbox) {
                    activoCheckbox.checked = true;
                }
            }
            const formProveedor = document.getElementById('formProveedor');
            if (formProveedor) {
                formProveedor.reset();
                const activoCheckbox = document.getElementById('prov_activo');
                if (activoCheckbox) {
                    activoCheckbox.checked = true;
                }
            }
            const formPagoProveedor = document.getElementById('formPagoProveedor');
            if (formPagoProveedor) {
                formPagoProveedor.reset();
                const esEstimacion = document.getElementById('pago_es_estimacion');
                if (esEstimacion) {
                    esEstimacion.checked = false;
                    document.getElementById('estimacionFields').style.display = 'none';
                }
            }
            hideModalAlert();
            hideProveedorModalAlert();
            hidePagoProveedorModalAlert();
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modalResidente = document.getElementById('modalResidente');
            const modalViewResidente = document.getElementById('modalViewResidente');
            const modalProveedor = document.getElementById('modalProveedor');
            const modalPagoProveedor = document.getElementById('modalPagoProveedor');
            if (event.target == modalResidente) {
                closeModal('modalResidente');
            }
            if (event.target == modalViewResidente) {
                closeModal('modalViewResidente');
            }
            if (event.target == modalProveedor) {
                closeModal('modalProveedor');
            }
            if (event.target == modalPagoProveedor) {
                closeModal('modalPagoProveedor');
            }
        }

        let currentEditingResidenteId = null;

        // Funci√≥n auxiliar para formatear fechas a formato espa√±ol (DD/MM/YYYY)
        function formatearFechaEspanol(fechaString) {
            if (!fechaString) return '';
            try {
                const fecha = new Date(fechaString);
                if (isNaN(fecha.getTime())) return fechaString;
                const dia = String(fecha.getDate()).padStart(2, '0');
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const a√±o = fecha.getFullYear();
                return `${dia}/${mes}/${a√±o}`;
            } catch (e) {
                return fechaString;
            }
        }

        // Funci√≥n auxiliar para convertir fecha espa√±ola (DD/MM/YYYY) a formato ISO (YYYY-MM-DD)
        function fechaEspanolToISO(fechaEspanol) {
            if (!fechaEspanol) return '';
            try {
                const partes = fechaEspanol.split('/');
                if (partes.length === 3) {
                    const [dia, mes, a√±o] = partes;
                    return `${a√±o}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
                }
                return fechaEspanol;
            } catch (e) {
                return fechaEspanol;
            }
        }

        // Funci√≥n auxiliar para convertir fecha ISO (YYYY-MM-DD) a formato espa√±ol (DD/MM/YYYY)
        function fechaISOToEspanol(fechaISO) {
            if (!fechaISO) return '';
            try {
                const partes = fechaISO.split('-');
                if (partes.length === 3) {
                    const [a√±o, mes, dia] = partes;
                    return `${dia}/${mes}/${a√±o}`;
                }
                return fechaISO;
            } catch (e) {
                return fechaISO;
            }
        }

        // Funci√≥n para validar formato de fecha espa√±ola (DD/MM/YYYY)
        function validarFechaEspanol(fecha) {
            if (!fecha) return true; // Permitir vac√≠o
            const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = fecha.match(regex);
            if (!match) return false;
            
            const [, dia, mes, a√±o] = match;
            const diaNum = parseInt(dia, 10);
            const mesNum = parseInt(mes, 10);
            const a√±oNum = parseInt(a√±o, 10);
            
            // Validar rango de fechas
            if (mesNum < 1 || mesNum > 12) return false;
            if (diaNum < 1 || diaNum > 31) return false;
            if (a√±oNum < 1900 || a√±oNum > 2100) return false;
            
            // Validar d√≠as del mes
            const fechaObj = new Date(a√±oNum, mesNum - 1, diaNum);
            if (fechaObj.getDate() !== diaNum || fechaObj.getMonth() !== mesNum - 1 || fechaObj.getFullYear() !== a√±oNum) {
                return false;
            }
            
            return true;
        }

        // Funci√≥n para formatear autom√°ticamente mientras se escribe (DD/MM/YYYY)
        function formatearFechaInput(input) {
            let value = input.value.replace(/\D/g, ''); // Solo n√∫meros
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }
            
            input.value = value;
            
            // Validar y mostrar error si es necesario
            if (value.length === 10) {
                if (!validarFechaEspanol(value)) {
                    input.style.borderColor = '#dc3545';
                } else {
                    input.style.borderColor = '#e0e0e0';
                }
            } else if (value.length > 0) {
                input.style.borderColor = '#e0e0e0';
            }
        }

        async function viewResidente(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const content = document.getElementById('viewResidenteContent');
            
            content.innerHTML = '<p>Cargando informaci√≥n del residente...</p>';
            openModal('modalViewResidente');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const res = await response.json();
                
                if (response.ok) {
                    currentEditingResidenteId = idResidente;
                    
                    // Obtener nombre de residencia
                    const tokenPayload = JSON.parse(atob(token.split('.')[1]));
                    const residenciaNombre = tokenPayload.id_residencia === 1 ? 'Violetas 1' : 
                                           tokenPayload.id_residencia === 2 ? 'Violetas 2' : 
                                           `Residencia ${tokenPayload.id_residencia}`;
                    
                    let html = `
                        <form id="formEditResidente" onsubmit="updateResidente(event, ${idResidente})">
                            
                            <!-- SECCI√ìN: Informaci√≥n de Residencia -->
                            <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">üè† Informaci√≥n de Residencia</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="edit_id_residencia">Residencia *</label>
                                        <select id="edit_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="1" ${res.id_residencia === 1 ? 'selected' : ''}>Violetas 1</option>
                                            <option value="2" ${res.id_residencia === 2 ? 'selected' : ''}>Violetas 2</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_habitacion">Habitaci√≥n *</label>
                                        <input type="text" id="edit_habitacion" name="habitacion" value="${res.habitacion || ''}" required>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                    <div class="form-group">
                                        <label for="edit_fecha_ingreso">Fecha de Ingreso</label>
                                        <input type="text" id="edit_fecha_ingreso" name="fecha_ingreso" value="${res.fecha_ingreso ? fechaISOToEspanol(res.fecha_ingreso) : ''}" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_costo_habitacion">Costo de Habitaci√≥n (‚Ç¨)</label>
                                        <input type="number" id="edit_costo_habitacion" name="costo_habitacion" step="0.01" value="${res.costo_habitacion || ''}" placeholder="0.00">
                                    </div>
                                </div>
                                <div style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label for="edit_metodo_pago_preferido">M√©todo de Pago Preferido</label>
                                        <select id="edit_metodo_pago_preferido" name="metodo_pago_preferido" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione un m√©todo</option>
                                            <option value="transferencia" ${res.metodo_pago_preferido === 'transferencia' ? 'selected' : ''}>Transferencia</option>
                                            <option value="remesa" ${res.metodo_pago_preferido === 'remesa' ? 'selected' : ''}>Remesa</option>
                                            <option value="met√°lico" ${res.metodo_pago_preferido === 'met√°lico' ? 'selected' : ''}>Met√°lico</option>
                                            <option value="bizum" ${res.metodo_pago_preferido === 'bizum' ? 'selected' : ''}>Bizum</option>
                                            <option value="otro" ${res.metodo_pago_preferido && !['transferencia', 'remesa', 'met√°lico', 'bizum'].includes(res.metodo_pago_preferido) ? 'selected' : ''}>Otro</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCI√ìN: Informaci√≥n Personal -->
                            <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                                <h3 style="color: #f56565; margin-bottom: 15px; font-size: 18px;">üë§ Informaci√≥n Personal</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="edit_nombre">Nombre *</label>
                                        <input type="text" id="edit_nombre" name="nombre" value="${res.nombre || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_apellido">Apellido *</label>
                                        <input type="text" id="edit_apellido" name="apellido" value="${res.apellido || ''}" required>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                    <div class="form-group">
                                        <label for="edit_documento">Documento de Identidad</label>
                                        <input type="text" id="edit_documento" name="documento_identidad" value="${res.documento_identidad || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_fecha_nacimiento">Fecha de Nacimiento</label>
                                        <input type="text" id="edit_fecha_nacimiento" name="fecha_nacimiento" value="${res.fecha_nacimiento ? fechaISOToEspanol(res.fecha_nacimiento) : ''}" placeholder="DD/MM/YYYY" maxlength="10" oninput="formatearFechaInput(this)">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCI√ìN: Informaci√≥n de Contacto -->
                            <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                                <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;">üìû Informaci√≥n de Contacto</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="edit_telefono">Tel√©fono</label>
                                        <input type="tel" id="edit_telefono" name="telefono" value="${res.telefono || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_direccion">Direcci√≥n</label>
                                        <input type="text" id="edit_direccion" name="direccion" value="${res.direccion || ''}">
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                    <h4 style="color: #48bb78; margin-bottom: 10px; font-size: 14px; font-weight: 600;">Contacto de Emergencia</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div class="form-group">
                                            <label for="edit_contacto_emergencia">Nombre del Contacto</label>
                                            <input type="text" id="edit_contacto_emergencia" name="contacto_emergencia" value="${res.contacto_emergencia || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit_telefono_emergencia">Tel√©fono de Emergencia</label>
                                            <input type="tel" id="edit_telefono_emergencia" name="telefono_emergencia" value="${res.telefono_emergencia || ''}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCI√ìN: Informaci√≥n M√©dica y Servicios -->
                            <div style="background: #fffaf0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                                <h3 style="color: #ed8936; margin-bottom: 15px; font-size: 18px;">üè• Informaci√≥n M√©dica y Servicios</h3>
                                <div class="form-group">
                                    <label for="edit_medicaciones">Medicaciones</label>
                                    <textarea id="edit_medicaciones" name="medicaciones" rows="3" placeholder="Lista de medicaciones y horarios">${res.medicaciones || ''}</textarea>
                                </div>
                                <div class="form-group" style="margin-top: 15px;">
                                    <label for="edit_servicios_extra">Servicios Extra</label>
                                    <textarea id="edit_servicios_extra" name="servicios_extra" rows="3" placeholder="Ej: Lavander√≠a, Peluquer√≠a, etc.">${res.servicios_extra || ''}</textarea>
                                </div>
                                <div class="form-group" style="margin-top: 15px;">
                                    <label for="edit_peculiaridades">Peculiaridades / Notas Importantes</label>
                                    <textarea id="edit_peculiaridades" name="peculiaridades" rows="3" placeholder="Informaci√≥n adicional relevante">${res.peculiaridades || ''}</textarea>
                                </div>
                            </div>
                            
                            <!-- SECCI√ìN: Estado -->
                            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #718096;">
                                <h3 style="color: #718096; margin-bottom: 15px; font-size: 18px;">‚öôÔ∏è Estado</h3>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="edit_activo" name="activo" ${res.activo ? 'checked' : ''} style="width: auto; margin-right: 8px;">
                                        Residente Activo
                                    </label>
                                </div>
                            </div>
                            
                            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                            
                            <div class="form-group">
                                <h3 style="color: #667eea; margin-bottom: 15px;">üìÑ Documentaci√≥n</h3>
                                
                                <div id="documentosList" style="margin-bottom: 20px;">
                                    <p style="color: #666;">Cargando documentos...</p>
                                </div>
                                
                                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 15px;">
                                    <h4 style="color: #667eea; margin-bottom: 10px; font-size: 14px;">Agregar Nuevo Documento</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px;">
                                        <select id="doc_tipo" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #333;">
                                            <option value="">Tipo de documento</option>
                                            <option value="M√©dica">M√©dica</option>
                                            <option value="Bancaria">Bancaria</option>
                                            <option value="Legal">Legal</option>
                                            <option value="Seguro">Seguro</option>
                                            <option value="Identidad">Identidad</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                        <input type="file" id="doc_archivo" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #333;">
                                    </div>
                                    <textarea id="doc_descripcion" placeholder="Descripci√≥n (opcional)" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: white; color: #333; font-family: inherit;"></textarea>
                                    <button type="button" onclick="agregarDocumento(${idResidente})" style="width: auto; padding: 8px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">+ Subir Documento</button>
                                </div>
                            </div>
                            
                            <div id="editModalAlert" class="alert" style="display: none;"></div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" id="updateResidenteBtn" style="flex: 1;">Guardar Cambios</button>
                                <button type="button" onclick="closeModal('modalViewResidente')" style="flex: 1; background: #6c757d;">Cerrar</button>
                            </div>
                        </form>
                    `;
                    
                    content.innerHTML = html;
                    // Cargar documentos del residente
                    await loadDocumentos(idResidente);
                } else {
                    content.innerHTML = `<div class="alert error">Error: ${res.error}</div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="alert error">Error de conexi√≥n: ${error.message}</div>`;
            }
        }

        async function loadDocumentos(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const documentosList = document.getElementById('documentosList');
            
            if (!documentosList) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/documentos`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.documentos && data.documentos.length > 0) {
                        let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                        data.documentos.forEach(doc => {
                            const tama√±o = doc.tama√±o_bytes ? `(${(doc.tama√±o_bytes / 1024).toFixed(1)} KB)` : '';
                            html += `
                                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <strong style="color: #667eea;">${doc.tipo_documento}</strong>
                                        <p style="margin: 5px 0; color: #333;">${doc.nombre_archivo} ${tama√±o}</p>
                                        ${doc.descripcion ? `<p style="margin: 0; color: #666; font-size: 12px;">${doc.descripcion}</p>` : ''}
                                        <p style="margin: 5px 0 0 0; color: #999; font-size: 11px;">${new Date(doc.fecha_subida).toLocaleDateString('es-ES')}</p>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        ${doc.url_descarga ? `<button onclick="window.open('${doc.url_descarga}', '_blank')" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">üì• Descargar</button>` : ''}
                                        <button onclick="eliminarDocumento(${doc.id_documento}, ${idResidente})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">Eliminar</button>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        documentosList.innerHTML = html;
                    } else {
                        documentosList.innerHTML = '<p style="color: #666; font-style: italic;">No hay documentos registrados.</p>';
                    }
                } else {
                    documentosList.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                documentosList.innerHTML = `<p style="color: red;">Error de conexi√≥n: ${error.message}</p>`;
            }
        }

        async function agregarDocumento(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const tipo = document.getElementById('doc_tipo').value;
            const archivoInput = document.getElementById('doc_archivo');
            const archivo = archivoInput.files[0];
            const descripcion = document.getElementById('doc_descripcion').value;
            
            if (!tipo) {
                alert('Por favor seleccione el tipo de documento');
                return;
            }
            
            if (!archivo) {
                alert('Por favor seleccione un archivo');
                return;
            }
            
            // Validar tama√±o (m√°ximo 10MB)
            if (archivo.size > 10 * 1024 * 1024) {
                alert('El archivo es demasiado grande. M√°ximo 10MB');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('archivo', archivo);
                formData.append('tipo_documento', tipo);
                if (descripcion) {
                    formData.append('descripcion', descripcion);
                }
                
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/documentos`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Limpiar formulario
                    document.getElementById('doc_tipo').value = '';
                    archivoInput.value = '';
                    document.getElementById('doc_descripcion').value = '';
                    
                    // Recargar lista de documentos
                    await loadDocumentos(idResidente);
                } else {
                    alert('Error: ' + (result.error || 'Error al subir documento'));
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        }

        async function eliminarDocumento(idDocumento, idResidente) {
            if (!confirm('¬øEst√° seguro de que desea eliminar este documento?')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/documentos/${idDocumento}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Recargar lista de documentos
                    await loadDocumentos(idResidente);
                } else {
                    alert('Error: ' + (result.error || 'Error al eliminar documento'));
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        }

        async function updateResidente(event, idResidente) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const updateBtn = document.getElementById('updateResidenteBtn');
            const originalText = updateBtn.textContent;
            
            const formData = new FormData(form);
            const activoCheckbox = document.getElementById('edit_activo');
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showEditModalError('Debe seleccionar una residencia');
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
                return;
            }
            
            // Convertir fechas de formato espa√±ol a ISO antes de enviar
            const fecha_nacimiento_es = formData.get('fecha_nacimiento');
            const fecha_ingreso_es = formData.get('fecha_ingreso');
            
            // Validar fechas antes de convertir
            if (fecha_nacimiento_es && !validarFechaEspanol(fecha_nacimiento_es)) {
                showEditModalError('La fecha de nacimiento no es v√°lida. Use formato DD/MM/YYYY');
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
                return;
            }
            
            if (fecha_ingreso_es && !validarFechaEspanol(fecha_ingreso_es)) {
                showEditModalError('La fecha de ingreso no es v√°lida. Use formato DD/MM/YYYY');
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
                return;
            }
            
            const data = {
                id_residencia: parseInt(id_residencia),
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                habitacion: formData.get('habitacion'),
                documento_identidad: formData.get('documento_identidad') || null,
                telefono: formData.get('telefono') || null,
                fecha_nacimiento: fecha_nacimiento_es ? fechaEspanolToISO(fecha_nacimiento_es) : null,
                direccion: formData.get('direccion') || null,
                contacto_emergencia: formData.get('contacto_emergencia') || null,
                telefono_emergencia: formData.get('telefono_emergencia') || null,
                fecha_ingreso: fecha_ingreso_es ? fechaEspanolToISO(fecha_ingreso_es) : null,
                costo_habitacion: formData.get('costo_habitacion') ? parseFloat(formData.get('costo_habitacion')) : null,
                metodo_pago_preferido: formData.get('metodo_pago_preferido') || null,
                servicios_extra: formData.get('servicios_extra') || null,
                medicaciones: formData.get('medicaciones') || null,
                peculiaridades: formData.get('peculiaridades') || null,
                activo: activoCheckbox ? activoCheckbox.checked : true
            };
            
            // Limpiar valores vac√≠os
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            updateBtn.disabled = true;
            updateBtn.textContent = 'Guardando...';
            hideEditModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showEditModalSuccess('Residente actualizado exitosamente');
                    setTimeout(() => {
                        closeModal('modalViewResidente');
                        loadResidentes(); // Recargar la lista
                    }, 1500);
                } else {
                    showEditModalError(result.error || 'Error al actualizar el residente');
                    updateBtn.disabled = false;
                    updateBtn.textContent = originalText;
                }
            } catch (error) {
                showEditModalError('Error de conexi√≥n: ' + error.message);
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
            }
        }

        function showEditModalError(message) {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showEditModalSuccess(message) {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideEditModalAlert() {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        async function saveResidente(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveResidenteBtn');
            const originalText = saveBtn.textContent;
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            const activoCheckbox = document.getElementById('res_activo');
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showModalError('Debe seleccionar una residencia');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Convertir fechas de formato espa√±ol a ISO antes de enviar
            const fecha_nacimiento_es = formData.get('fecha_nacimiento');
            const fecha_ingreso_es = formData.get('fecha_ingreso');
            
            // Validar fechas antes de convertir
            if (fecha_nacimiento_es && !validarFechaEspanol(fecha_nacimiento_es)) {
                showModalError('La fecha de nacimiento no es v√°lida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            if (fecha_ingreso_es && !validarFechaEspanol(fecha_ingreso_es)) {
                showModalError('La fecha de ingreso no es v√°lida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            const data = {
                id_residencia: parseInt(id_residencia),
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                habitacion: formData.get('habitacion') || null,
                documento_identidad: formData.get('documento_identidad') || null,
                telefono: formData.get('telefono') || null,
                fecha_nacimiento: fecha_nacimiento_es ? fechaEspanolToISO(fecha_nacimiento_es) : null,
                direccion: formData.get('direccion') || null,
                contacto_emergencia: formData.get('contacto_emergencia') || null,
                telefono_emergencia: formData.get('telefono_emergencia') || null,
                fecha_ingreso: fecha_ingreso_es ? fechaEspanolToISO(fecha_ingreso_es) : null,
                costo_habitacion: formData.get('costo_habitacion') ? parseFloat(formData.get('costo_habitacion')) : null,
                metodo_pago_preferido: formData.get('metodo_pago_preferido') || null,
                servicios_extra: formData.get('servicios_extra') || null,
                medicaciones: formData.get('medicaciones') || null,
                peculiaridades: formData.get('peculiaridades') || null,
                activo: activoCheckbox ? activoCheckbox.checked : true
            };
            
            // Limpiar valores vac√≠os
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showModalSuccess('Residente agregado exitosamente');
                    setTimeout(() => {
                        closeModal('modalResidente');
                        loadResidentes(); // Recargar la lista
                    }, 1500);
                } else {
                    showModalError(result.error || 'Error al guardar el residente');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showModalError('Error de conexi√≥n: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        function showModalError(message) {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showModalSuccess(message) {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideModalAlert() {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }
    </script>
</body>
</html>

