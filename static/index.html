<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Violetas - Sistema de Gesti√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            box-sizing: border-box;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background-color: #ffffff;
            color: #333333;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background-color: #ffffff;
            color: #333333;
        }

        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            background-color: #ffffff;
            color: #333333;
            transition: all 0.3s;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert.success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        .token-display {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            display: none;
        }

        .token-display h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .token-value {
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            color: #666;
            border: 1px solid #ddd;
        }

        .copy-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: #667eea;
            font-size: 14px;
        }

        .user-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 10px;
            display: none;
        }

        .user-info h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .logout-btn {
            margin-top: 15px;
            background: #dc3545;
        }

        .logout-btn:hover {
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .module-btn {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .module-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .module-content {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            overflow-x: auto;
            max-width: 100%;
            box-sizing: border-box;
        }

        .data-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .data-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            background: white;
            color: #333;
        }

        .data-table tr:hover {
            background: #f0f0f0;
        }

        .data-table tr:hover td {
            background: #f0f0f0;
        }

        .add-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .add-btn:hover {
            background: #218838;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .close-modal:hover {
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>üè• Violetas</h1>
            <p>Sistema de Gesti√≥n de Residencias</p>
        </div>

        <div id="loginForm">
            <div id="alert" class="alert"></div>
            
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required 
                           placeholder="admin@violetas1.com" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" name="password" required 
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                </div>

                <button type="submit" id="loginBtn">Iniciar Sesi√≥n</button>
            </form>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="user-info" id="userInfo"></div>
            
            <div style="margin-top: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìã M√≥dulos del Sistema</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <button class="module-btn" onclick="showModule('residentes')">
                        üë• Residentes
                    </button>
                    <button class="module-btn" onclick="showModule('facturacion')">
                        üí∞ Facturaci√≥n
                    </button>
                    <button class="module-btn" onclick="showModule('personal')">
                        üëî Personal
                    </button>
                    <button class="module-btn" onclick="showModule('token')">
                        üîë Token JWT
                    </button>
                </div>
            </div>

            <div id="moduleContent" style="margin-top: 20px;"></div>

            <button class="logout-btn" onclick="logout()" style="margin-top: 20px;">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <!-- Modal para ver/editar residente -->
    <div id="modalViewResidente" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üë§ Detalle del Residente</h2>
                <button class="close-modal" onclick="closeModal('modalViewResidente')">&times;</button>
            </div>
            <div id="viewResidenteContent">
                <p>Cargando...</p>
            </div>
        </div>
    </div>

    <!-- Modal para agregar residente -->
    <div id="modalResidente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Agregar Residente</h2>
                <button class="close-modal" onclick="closeModal('modalResidente')">&times;</button>
            </div>
            <form id="formResidente" onsubmit="saveResidente(event)">
                <div class="form-group">
                    <label for="res_id_residencia">Residencia *</label>
                    <select id="res_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white;">
                        <option value="">Seleccione una residencia</option>
                        <option value="1">Violetas 1</option>
                        <option value="2">Violetas 2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="res_nombre">Nombre *</label>
                    <input type="text" id="res_nombre" name="nombre" required>
                </div>
                <div class="form-group">
                    <label for="res_apellido">Apellido *</label>
                    <input type="text" id="res_apellido" name="apellido" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="res_habitacion">Habitaci√≥n *</label>
                        <input type="text" id="res_habitacion" name="habitacion" required placeholder="Ej: 101, A-12">
                    </div>
                    <div class="form-group">
                        <label for="res_documento">Documento de Identidad</label>
                        <input type="text" id="res_documento" name="documento_identidad">
                    </div>
                </div>
                <div class="form-group">
                    <label for="res_telefono">Tel√©fono</label>
                    <input type="tel" id="res_telefono" name="telefono">
                </div>
                <div class="form-group">
                    <label for="res_fecha_nacimiento">Fecha de Nacimiento</label>
                    <input type="date" id="res_fecha_nacimiento" name="fecha_nacimiento">
                </div>
                <div class="form-group">
                    <label for="res_direccion">Direcci√≥n</label>
                    <input type="text" id="res_direccion" name="direccion">
                </div>
                <div class="form-group">
                    <label for="res_contacto_emergencia">Contacto de Emergencia</label>
                    <input type="text" id="res_contacto_emergencia" name="contacto_emergencia">
                </div>
                <div class="form-group">
                    <label for="res_telefono_emergencia">Tel√©fono de Emergencia</label>
                    <input type="tel" id="res_telefono_emergencia" name="telefono_emergencia">
                </div>
                <div class="form-group">
                    <label for="res_fecha_ingreso">Fecha de Ingreso</label>
                    <input type="date" id="res_fecha_ingreso" name="fecha_ingreso">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="res_activo" name="activo" checked style="width: auto; margin-right: 8px;">
                        Activo
                    </label>
                </div>
                <div id="modalAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveResidenteBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalResidente')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentToken = null;

        // Verificar si hay token guardado
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('violetas_token');
            if (savedToken) {
                verifyToken(savedToken);
            }
        });

        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const alert = document.getElementById('alert');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando sesi√≥n...';
            hideAlert();

            try {
                const response = await fetch(`${API_URL}/api/v1/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentToken = data.token;
                    localStorage.setItem('violetas_token', currentToken);
                    showSuccess('¬°Login exitoso!');
                    showDashboard(currentToken);
                } else {
                    showError(data.error || 'Error al iniciar sesi√≥n');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesi√≥n';
                }
            } catch (error) {
                showError('Error de conexi√≥n. Verifica que el servidor est√© corriendo.');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
            }
        });

        async function verifyToken(token) {
            try {
                // Decodificar el token (sin verificar, solo para mostrar info)
                const payload = JSON.parse(atob(token.split('.')[1]));
                
                // Mostrar dashboard
                showDashboard(token);
                
                // Mostrar informaci√≥n del usuario
                document.getElementById('userInfo').innerHTML = `
                    <h3>üë§ Informaci√≥n del Usuario</h3>
                    <p><strong>ID Usuario:</strong> ${payload.id_usuario}</p>
                    <p><strong>Rol ID:</strong> ${payload.id_rol}</p>
                    <p><strong>Residencia ID:</strong> ${payload.id_residencia}</p>
                    <p><strong>Expira:</strong> ${new Date(payload.exp * 1000).toLocaleString()}</p>
                `;
                document.getElementById('userInfo').style.display = 'block';
            } catch (error) {
                console.error('Error al verificar token:', error);
                logout();
            }
        }

        function showDashboard(token) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            // tokenValue solo existe cuando se muestra el m√≥dulo de token, as√≠ que verificamos primero
            const tokenValueEl = document.getElementById('tokenValue');
            if (tokenValueEl) {
                tokenValueEl.textContent = token;
            }
            // tokenDisplay no existe en el HTML inicial, solo se crea din√°micamente
            // No intentamos acceder a √©l aqu√≠ para evitar errores
        }

        function logout() {
            localStorage.removeItem('violetas_token');
            currentToken = null;
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            hideAlert();
        }

        function copyToken() {
            const tokenValue = document.getElementById('tokenValue').textContent;
            navigator.clipboard.writeText(tokenValue).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '¬°Copiado!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function showError(message) {
            const alert = document.getElementById('alert');
            alert.className = 'alert error';
            alert.textContent = message;
            alert.style.display = 'block';
        }

        function showSuccess(message) {
            const alert = document.getElementById('alert');
            alert.className = 'alert success';
            alert.textContent = message;
            alert.style.display = 'block';
        }

        function hideAlert() {
            document.getElementById('alert').style.display = 'none';
        }

        function showModule(module) {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            if (module === 'token') {
                content.innerHTML = `
                    <div class="module-content">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üîë Token JWT</h3>
                        <div class="token-display">
                            <div class="token-value" id="tokenValue">${token}</div>
                            <button class="copy-btn" onclick="copyToken()" style="margin-top: 10px;">Copiar Token</button>
                        </div>
                    </div>
                `;
            } else if (module === 'residentes') {
                loadResidentes();
            } else if (module === 'facturacion') {
                loadFacturacion();
            } else if (module === 'personal') {
                loadPersonal();
            }
        }

        async function loadResidentes() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = '<div class="module-content"><p>Cargando residentes...</p></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 15px;">üë• Residentes (${data.total})</h3>
                            <button class="add-btn" onclick="openModal('modalResidente')">+ Agregar Residente</button>
                    `;
                    
                    if (data.residentes && data.residentes.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Residencia</th>
                                        <th>Nombre</th>
                                        <th>Habitaci√≥n</th>
                                        <th>Documento</th>
                                        <th>Tel√©fono</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.residentes.forEach(res => {
                            html += `
                                <tr style="cursor: pointer;" onclick="viewResidente(${res.id_residente})">
                                    <td>${res.nombre_residencia || (res.id_residencia === 1 ? 'Violetas 1' : res.id_residencia === 2 ? 'Violetas 2' : `Residencia ${res.id_residencia}`)}</td>
                                    <td>${res.nombre} ${res.apellido}</td>
                                    <td>${res.habitacion || '-'}</td>
                                    <td>${res.documento_identidad || '-'}</td>
                                    <td>${res.telefono || '-'}</td>
                                    <td>${res.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No hay residentes registrados.</p>';
                    }
                    
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: ${data.error}</p></div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexi√≥n: ${error.message}</p></div>`;
            }
        }

        async function loadFacturacion() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = '<div class="module-content"><p>Cargando facturaci√≥n...</p></div>';
            
            try {
                // Cargar cobros y pagos a proveedores
                const [cobrosRes, proveedoresRes] = await Promise.all([
                    fetch(`${API_URL}/api/v1/facturacion/cobros`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_URL}/api/v1/facturacion/proveedores`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);
                
                const cobrosData = await cobrosRes.json();
                const proveedoresData = await proveedoresRes.json();
                
                if (cobrosRes.ok && proveedoresRes.ok) {
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 20px;">üí∞ Facturaci√≥n</h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <button class="add-btn" onclick="openModalCobro()">+ Cobro Previsto</button>
                                <button class="add-btn" onclick="openModalProveedor()">+ Pago Proveedor</button>
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #667eea; margin-bottom: 10px;">üìã Cobros Previstos (${cobrosData.total || 0})</h4>
                    `;
                    
                    if (cobrosData.cobros && cobrosData.cobros.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Residente</th>
                                        <th>Monto</th>
                                        <th>Fecha Prevista</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        cobrosData.cobros.forEach(cobro => {
                            const estadoColor = cobro.estado === 'cobrado' ? '#28a745' : 
                                               cobro.estado === 'pendiente' ? '#ffc107' : '#6c757d';
                            html += `
                                <tr>
                                    <td>${cobro.residente}</td>
                                    <td>‚Ç¨${parseFloat(cobro.monto).toFixed(2)}</td>
                                    <td>${cobro.fecha_prevista || cobro.fecha_pago || '-'}</td>
                                    <td><span style="color: ${estadoColor}; font-weight: 600;">${cobro.estado}</span></td>
                                    <td>
                                        <button onclick="cambiarEstadoCobro(${cobro.id_pago}, 'cobrado')" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Cobrado</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No hay cobros previstos.</p>';
                    }
                    
                    html += `
                            </div>
                            
                            <div>
                                <h4 style="color: #667eea; margin-bottom: 10px;">üè¢ Pagos a Proveedores (${proveedoresData.total || 0})</h4>
                    `;
                    
                    if (proveedoresData.pagos && proveedoresData.pagos.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Proveedor</th>
                                        <th>Concepto</th>
                                        <th>Monto</th>
                                        <th>Fecha Prevista</th>
                                        <th>Estado</th>
                                        <th>Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        proveedoresData.pagos.forEach(pago => {
                            const tipo = pago.es_estimacion ? 'üìä Estimaci√≥n' : 'üí∞ Real';
                            html += `
                                <tr>
                                    <td>${pago.proveedor}</td>
                                    <td>${pago.concepto}</td>
                                    <td>‚Ç¨${parseFloat(pago.monto || pago.monto_estimado || 0).toFixed(2)}</td>
                                    <td>${pago.fecha_prevista || pago.fecha_pago || '-'}</td>
                                    <td>${pago.estado}</td>
                                    <td>${tipo}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No hay pagos a proveedores registrados.</p>';
                    }
                    
                    html += '</div></div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error al cargar facturaci√≥n</p></div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexi√≥n: ${error.message}</p></div>`;
            }
        }
        
        function cambiarEstadoCobro(idPago, nuevoEstado) {
            // Implementar cambio de estado
            console.log(`Cambiar cobro ${idPago} a ${nuevoEstado}`);
        }
        
        function openModalCobro() {
            alert('Modal de cobro previsto - pr√≥ximamente');
        }
        
        function openModalProveedor() {
            alert('Modal de pago a proveedor - pr√≥ximamente');
        }

        async function loadPersonal() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = '<div class="module-content"><p>Cargando personal...</p></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/v1/personal`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 15px;">üëî Personal (${data.total})</h3>
                            <button class="add-btn" onclick="alert('Funci√≥n de agregar personal pr√≥ximamente')">+ Agregar Personal</button>
                    `;
                    
                    if (data.personal && data.personal.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Cargo</th>
                                        <th>Tel√©fono</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.personal.forEach(p => {
                            html += `
                                <tr>
                                    <td>${p.nombre} ${p.apellido}</td>
                                    <td>${p.cargo || '-'}</td>
                                    <td>${p.telefono || '-'}</td>
                                    <td>${p.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No hay personal registrado.</p>';
                    }
                    
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: ${data.error}</p></div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexi√≥n: ${error.message}</p></div>`;
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            
            // Si es el modal de agregar residente, establecer residencia por defecto seg√∫n el token
            if (modalId === 'modalResidente') {
                const token = localStorage.getItem('violetas_token');
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const residenciaId = payload.id_residencia;
                        const selectResidencia = document.getElementById('res_id_residencia');
                        if (selectResidencia) {
                            selectResidencia.value = residenciaId; // Establecer como valor por defecto
                        }
                    } catch (e) {
                        console.error('Error al obtener residencia del token:', e);
                    }
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            const form = document.getElementById('formResidente');
            if (form) {
                form.reset();
                const activoCheckbox = document.getElementById('res_activo');
                if (activoCheckbox) {
                    activoCheckbox.checked = true;
                }
            }
            hideModalAlert();
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modalResidente = document.getElementById('modalResidente');
            const modalViewResidente = document.getElementById('modalViewResidente');
            if (event.target == modalResidente) {
                closeModal('modalResidente');
            }
            if (event.target == modalViewResidente) {
                closeModal('modalViewResidente');
            }
        }

        let currentEditingResidenteId = null;

        async function viewResidente(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const content = document.getElementById('viewResidenteContent');
            
            content.innerHTML = '<p>Cargando informaci√≥n del residente...</p>';
            openModal('modalViewResidente');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const res = await response.json();
                
                if (response.ok) {
                    currentEditingResidenteId = idResidente;
                    
                    // Obtener nombre de residencia
                    const tokenPayload = JSON.parse(atob(token.split('.')[1]));
                    const residenciaNombre = tokenPayload.id_residencia === 1 ? 'Violetas 1' : 
                                           tokenPayload.id_residencia === 2 ? 'Violetas 2' : 
                                           `Residencia ${tokenPayload.id_residencia}`;
                    
                    let html = `
                        <form id="formEditResidente" onsubmit="updateResidente(event, ${idResidente})">
                            <div class="form-group">
                                <label for="edit_id_residencia">Residencia *</label>
                                <select id="edit_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                    <option value="1" ${res.id_residencia === 1 ? 'selected' : ''}>Violetas 1</option>
                                    <option value="2" ${res.id_residencia === 2 ? 'selected' : ''}>Violetas 2</option>
                                </select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="edit_nombre">Nombre *</label>
                                    <input type="text" id="edit_nombre" name="nombre" value="${res.nombre || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit_apellido">Apellido *</label>
                                    <input type="text" id="edit_apellido" name="apellido" value="${res.apellido || ''}" required>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="edit_habitacion">Habitaci√≥n *</label>
                                    <input type="text" id="edit_habitacion" name="habitacion" value="${res.habitacion || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit_documento">Documento de Identidad</label>
                                    <input type="text" id="edit_documento" name="documento_identidad" value="${res.documento_identidad || ''}">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="edit_telefono">Tel√©fono</label>
                                    <input type="tel" id="edit_telefono" name="telefono" value="${res.telefono || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="edit_fecha_nacimiento">Fecha de Nacimiento</label>
                                    <input type="date" id="edit_fecha_nacimiento" name="fecha_nacimiento" value="${res.fecha_nacimiento || ''}">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_direccion">Direcci√≥n</label>
                                <input type="text" id="edit_direccion" name="direccion" value="${res.direccion || ''}">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="edit_contacto_emergencia">Contacto de Emergencia</label>
                                    <input type="text" id="edit_contacto_emergencia" name="contacto_emergencia" value="${res.contacto_emergencia || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="edit_telefono_emergencia">Tel√©fono de Emergencia</label>
                                    <input type="tel" id="edit_telefono_emergencia" name="telefono_emergencia" value="${res.telefono_emergencia || ''}">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="edit_fecha_ingreso">Fecha de Ingreso</label>
                                    <input type="date" id="edit_fecha_ingreso" name="fecha_ingreso" value="${res.fecha_ingreso || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="edit_costo_habitacion">Costo de Habitaci√≥n (‚Ç¨)</label>
                                    <input type="number" id="edit_costo_habitacion" name="costo_habitacion" step="0.01" value="${res.costo_habitacion || ''}" placeholder="0.00">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_servicios_extra">Servicios Extra</label>
                                <textarea id="edit_servicios_extra" name="servicios_extra" rows="3" placeholder="Ej: Lavander√≠a, Peluquer√≠a, etc.">${res.servicios_extra || ''}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_medicaciones">Medicaciones</label>
                                <textarea id="edit_medicaciones" name="medicaciones" rows="3" placeholder="Lista de medicaciones y horarios">${res.medicaciones || ''}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit_peculiaridades">Peculiaridades / Notas Importantes</label>
                                <textarea id="edit_peculiaridades" name="peculiaridades" rows="3" placeholder="Informaci√≥n adicional relevante">${res.peculiaridades || ''}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="edit_activo" name="activo" ${res.activo ? 'checked' : ''} style="width: auto; margin-right: 8px;">
                                    Activo
                                </label>
                            </div>
                            
                            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                            
                            <div class="form-group">
                                <h3 style="color: #667eea; margin-bottom: 15px;">üìÑ Documentaci√≥n</h3>
                                
                                <div id="documentosList" style="margin-bottom: 20px;">
                                    <p style="color: #666;">Cargando documentos...</p>
                                </div>
                                
                                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 15px;">
                                    <h4 style="color: #667eea; margin-bottom: 10px; font-size: 14px;">Agregar Nuevo Documento</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px;">
                                        <select id="doc_tipo" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #333;">
                                            <option value="">Tipo de documento</option>
                                            <option value="M√©dica">M√©dica</option>
                                            <option value="Bancaria">Bancaria</option>
                                            <option value="Legal">Legal</option>
                                            <option value="Seguro">Seguro</option>
                                            <option value="Identidad">Identidad</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                        <input type="file" id="doc_archivo" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #333;">
                                    </div>
                                    <textarea id="doc_descripcion" placeholder="Descripci√≥n (opcional)" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: white; color: #333; font-family: inherit;"></textarea>
                                    <button type="button" onclick="agregarDocumento(${idResidente})" style="width: auto; padding: 8px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">+ Subir Documento</button>
                                </div>
                            </div>
                            
                            <div id="editModalAlert" class="alert" style="display: none;"></div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" id="updateResidenteBtn" style="flex: 1;">Guardar Cambios</button>
                                <button type="button" onclick="closeModal('modalViewResidente')" style="flex: 1; background: #6c757d;">Cerrar</button>
                            </div>
                        </form>
                    `;
                    
                    content.innerHTML = html;
                    // Cargar documentos del residente
                    await loadDocumentos(idResidente);
                } else {
                    content.innerHTML = `<div class="alert error">Error: ${res.error}</div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="alert error">Error de conexi√≥n: ${error.message}</div>`;
            }
        }

        async function loadDocumentos(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const documentosList = document.getElementById('documentosList');
            
            if (!documentosList) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/documentos`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.documentos && data.documentos.length > 0) {
                        let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                        data.documentos.forEach(doc => {
                            const tama√±o = doc.tama√±o_bytes ? `(${(doc.tama√±o_bytes / 1024).toFixed(1)} KB)` : '';
                            html += `
                                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <strong style="color: #667eea;">${doc.tipo_documento}</strong>
                                        <p style="margin: 5px 0; color: #333;">${doc.nombre_archivo} ${tama√±o}</p>
                                        ${doc.descripcion ? `<p style="margin: 0; color: #666; font-size: 12px;">${doc.descripcion}</p>` : ''}
                                        <p style="margin: 5px 0 0 0; color: #999; font-size: 11px;">${new Date(doc.fecha_subida).toLocaleDateString()}</p>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        ${doc.url_descarga ? `<button onclick="window.open('${doc.url_descarga}', '_blank')" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">üì• Descargar</button>` : ''}
                                        <button onclick="eliminarDocumento(${doc.id_documento}, ${idResidente})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">Eliminar</button>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        documentosList.innerHTML = html;
                    } else {
                        documentosList.innerHTML = '<p style="color: #666; font-style: italic;">No hay documentos registrados.</p>';
                    }
                } else {
                    documentosList.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                documentosList.innerHTML = `<p style="color: red;">Error de conexi√≥n: ${error.message}</p>`;
            }
        }

        async function agregarDocumento(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const tipo = document.getElementById('doc_tipo').value;
            const archivoInput = document.getElementById('doc_archivo');
            const archivo = archivoInput.files[0];
            const descripcion = document.getElementById('doc_descripcion').value;
            
            if (!tipo) {
                alert('Por favor seleccione el tipo de documento');
                return;
            }
            
            if (!archivo) {
                alert('Por favor seleccione un archivo');
                return;
            }
            
            // Validar tama√±o (m√°ximo 10MB)
            if (archivo.size > 10 * 1024 * 1024) {
                alert('El archivo es demasiado grande. M√°ximo 10MB');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('archivo', archivo);
                formData.append('tipo_documento', tipo);
                if (descripcion) {
                    formData.append('descripcion', descripcion);
                }
                
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/documentos`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Limpiar formulario
                    document.getElementById('doc_tipo').value = '';
                    archivoInput.value = '';
                    document.getElementById('doc_descripcion').value = '';
                    
                    // Recargar lista de documentos
                    await loadDocumentos(idResidente);
                } else {
                    alert('Error: ' + (result.error || 'Error al subir documento'));
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        }

        async function eliminarDocumento(idDocumento, idResidente) {
            if (!confirm('¬øEst√° seguro de que desea eliminar este documento?')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/documentos/${idDocumento}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Recargar lista de documentos
                    await loadDocumentos(idResidente);
                } else {
                    alert('Error: ' + (result.error || 'Error al eliminar documento'));
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        }

        async function updateResidente(event, idResidente) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const updateBtn = document.getElementById('updateResidenteBtn');
            const originalText = updateBtn.textContent;
            
            const formData = new FormData(form);
            const activoCheckbox = document.getElementById('edit_activo');
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showEditModalError('Debe seleccionar una residencia');
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
                return;
            }
            
            const data = {
                id_residencia: parseInt(id_residencia),
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                habitacion: formData.get('habitacion'),
                documento_identidad: formData.get('documento_identidad') || null,
                telefono: formData.get('telefono') || null,
                fecha_nacimiento: formData.get('fecha_nacimiento') || null,
                direccion: formData.get('direccion') || null,
                contacto_emergencia: formData.get('contacto_emergencia') || null,
                telefono_emergencia: formData.get('telefono_emergencia') || null,
                fecha_ingreso: formData.get('fecha_ingreso') || null,
                costo_habitacion: formData.get('costo_habitacion') ? parseFloat(formData.get('costo_habitacion')) : null,
                servicios_extra: formData.get('servicios_extra') || null,
                medicaciones: formData.get('medicaciones') || null,
                peculiaridades: formData.get('peculiaridades') || null,
                activo: activoCheckbox ? activoCheckbox.checked : true
            };
            
            // Limpiar valores vac√≠os
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            updateBtn.disabled = true;
            updateBtn.textContent = 'Guardando...';
            hideEditModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showEditModalSuccess('Residente actualizado exitosamente');
                    setTimeout(() => {
                        closeModal('modalViewResidente');
                        loadResidentes(); // Recargar la lista
                    }, 1500);
                } else {
                    showEditModalError(result.error || 'Error al actualizar el residente');
                    updateBtn.disabled = false;
                    updateBtn.textContent = originalText;
                }
            } catch (error) {
                showEditModalError('Error de conexi√≥n: ' + error.message);
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
            }
        }

        function showEditModalError(message) {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showEditModalSuccess(message) {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideEditModalAlert() {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        async function saveResidente(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveResidenteBtn');
            const originalText = saveBtn.textContent;
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            const activoCheckbox = document.getElementById('res_activo');
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showModalError('Debe seleccionar una residencia');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            const data = {
                id_residencia: parseInt(id_residencia),
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                habitacion: formData.get('habitacion') || null,
                documento_identidad: formData.get('documento_identidad') || null,
                telefono: formData.get('telefono') || null,
                fecha_nacimiento: formData.get('fecha_nacimiento') || null,
                direccion: formData.get('direccion') || null,
                contacto_emergencia: formData.get('contacto_emergencia') || null,
                telefono_emergencia: formData.get('telefono_emergencia') || null,
                fecha_ingreso: formData.get('fecha_ingreso') || null,
                costo_habitacion: formData.get('costo_habitacion') ? parseFloat(formData.get('costo_habitacion')) : null,
                servicios_extra: formData.get('servicios_extra') || null,
                medicaciones: formData.get('medicaciones') || null,
                peculiaridades: formData.get('peculiaridades') || null,
                activo: activoCheckbox ? activoCheckbox.checked : true
            };
            
            // Limpiar valores vac√≠os
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showModalSuccess('Residente agregado exitosamente');
                    setTimeout(() => {
                        closeModal('modalResidente');
                        loadResidentes(); // Recargar la lista
                    }, 1500);
                } else {
                    showModalError(result.error || 'Error al guardar el residente');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showModalError('Error de conexi√≥n: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        function showModalError(message) {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showModalSuccess(message) {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideModalAlert() {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }
    </script>
</body>
</html>

