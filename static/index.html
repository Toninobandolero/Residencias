<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Violetas - Sistema de Gestión</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <!-- Google Fonts - Tipografía moderna -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        // SEGURIDAD CRÍTICA: Limpiar credenciales de URL ANTES DE QUE CHROME PARSEE EL RESTO
        (function() {
            if (window.location && window.location.search) {
                var search = window.location.search;
                if (search.indexOf('email=') >= 0 || search.indexOf('password=') >= 0) {
                    // STOP INMEDIATO - Redirect sin credenciales
                    window.location.replace(window.location.pathname);
                    throw new Error('Redirect por seguridad');
                }
            }
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Flatpickr DESACTIVADO - Usamos type="date" nativo -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }
        
        /* Tipografía moderna para títulos */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', 'Inter', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        h1 {
            font-size: 32px;
            font-weight: 800;
        }
        
        h2 {
            font-size: 24px;
            font-weight: 700;
        }
        
        h3 {
            font-size: 20px;
            font-weight: 600;
        }


        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1400px;
            width: 100%;
            box-sizing: border-box;
        }

        .logo {
            text-align: left;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            color: #667eea;
            font-size: 36px;
            margin-bottom: 10px;
            letter-spacing: -0.03em;
        }

        .logo img {
            max-height: 80px;
            width: auto;
            display: block;
        }

        .logo p {
            font-family: 'Poppins', sans-serif;
            color: #8d2f77;
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header-logo {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo-text {
            display: flex;
            flex-direction: column;
        }

        .header-logo h1 {
            color: #667eea;
            font-size: 32px;
            margin: 0;
            margin-bottom: 5px;
        }


        .header-logo img {
            max-height: 60px;
            width: auto;
            display: block;
        }

        .user-menu-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }
        
        #userNameDisplay {
            font-size: 14px;
            font-weight: 500;
            color: #333333;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }
        
        #userNameText {
            font-size: 14px;
        }

        .user-icon-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .user-icon-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .user-icon-btn img {
            filter: brightness(0) invert(1);
        }

        .user-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .user-menu.show {
            display: block;
        }

        .user-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            font-size: 14px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .user-menu-item:hover {
            background: #f5f5f5;
        }

        .user-menu-item:first-child {
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .user-menu-item:last-child {
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        .user-menu-item.logout {
            color: #dc3545;
            border-top: 1px solid #e0e0e0;
        }

        .user-menu-item.logout:hover {
            background: #fee;
        }

        .user-menu-info {
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f9f9f9;
        }

        .user-menu-info-item {
            font-size: 11px;
            color: #666;
            margin: 4px 0;
            line-height: 1.4;
        }

        .user-menu-info-item strong {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            font-family: 'Inter', sans-serif;
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background-color: #ffffff;
            color: #333333;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background-color: #ffffff;
            color: #333333;
        }

        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            background-color: #ffffff;
            color: #333333;
            transition: all 0.3s;
        }

        button {
            font-family: 'Poppins', sans-serif;
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            letter-spacing: -0.01em;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert.success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        .token-display {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            display: none;
        }

        .token-display h3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
            letter-spacing: -0.01em;
        }

        .token-value {
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            color: #666;
            border: 1px solid #ddd;
        }

        .copy-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: #667eea;
            font-size: 14px;
        }

        .user-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 10px;
            display: none;
        }

        .user-info h3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
            letter-spacing: -0.01em;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .logout-btn {
            margin-top: 15px;
            background: #dc3545;
        }

        .logout-btn:hover {
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .module-btn {
            font-family: 'Poppins', sans-serif;
            padding: 15px;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            letter-spacing: -0.01em;
        }

        .module-btn-residentes {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .module-btn-residentes:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .module-btn-facturacion {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .module-btn-facturacion:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(72, 187, 120, 0.3);
        }

        .module-btn-personal {
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
        }

        .module-btn-personal:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(56, 178, 172, 0.3);
        }

        .module-btn-documentacion {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .module-btn-documentacion:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(237, 137, 54, 0.3);
        }

        .module-btn-historicos {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .module-btn-historicos:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 101, 101, 0.3);
        }

        .module-btn-configuracion {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        }

        .module-btn-configuracion:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(113, 128, 150, 0.3);
        }

        .module-btn img {
            filter: brightness(0) invert(1);
        }

        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: #f5f7fa;
            border: 2px solid #e1e4e8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            position: relative;
            margin-right: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        /* Responsive para pestañas en móviles */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
                gap: 0;
                border-bottom: none;
            }
            
            .tab {
                width: 100%;
                padding: 12px 16px;
                text-align: left;
                border: 2px solid #e1e4e8;
                margin-right: 0;
                margin-bottom: 8px;
                border-radius: 8px;
            }
            
            .tab.active {
                color: white;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-color: #667eea;
            }
            
            .tab.active img {
                filter: brightness(0) invert(1);
            }
            
            .tab:first-child {
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }
            
            .tab:last-child {
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px;
                border-bottom: 2px solid #e0e0e0;
            }
        }

        .tab:hover {
            color: #667eea;
            background: #f0f4ff;
            border-color: #b8c5f2;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.15);
        }
        
        .tab.active {
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .tab.active img {
            filter: brightness(0) invert(1);
        }
        
        .tab.active:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .module-content {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            overflow-x: auto;
            max-width: 100%;
            box-sizing: border-box;
        }

        .data-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .data-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            background: white;
            color: #333;
        }

        .data-table tr:hover {
            background: #f0f0f0;
        }

        .data-table tr:hover td {
            background: #f0f0f0;
        }
        
        /* Responsive para tablas de residentes en móviles */
        @media (max-width: 768px) {
            .data-table {
                min-width: 0;
                display: block;
            }
            
            .data-table thead {
                display: none; /* Ocultar encabezados en móviles */
            }
            
            .data-table tbody {
                display: block;
            }
            
            .data-table tbody tr {
                display: block;
                margin-bottom: 12px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
                padding: 10px;
                border: 1px solid #e0e0e0;
            }
            
            .data-table tbody tr:last-child {
                margin-bottom: 0;
            }
            
            .data-table tbody td {
                display: block;
                padding: 8px 0;
                text-align: left;
                border-bottom: none;
                border-top: 1px solid #f0f0f0;
            }
            
            .data-table tbody td:first-child {
                border-top: none;
                font-weight: 600;
                color: #667eea;
                font-size: 16px;
                padding-bottom: 8px;
                margin-bottom: 4px;
            }
            
            .data-table tbody td:first-child:before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: #667eea;
                display: inline-block;
                margin-right: 6px;
            }
            
            .data-table tbody td:not(:first-child):before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: #666;
                display: inline-block;
                margin-right: 6px;
            }
            
            .residencia-residentes-container {
                padding: 15px !important;
                margin-top: 20px !important;
            }
            
            .residencia-residentes-container h4 {
                font-size: 16px !important;
                margin-bottom: 12px !important;
            }
            
            .data-table tfoot {
                display: block;
                margin-top: 15px;
                padding: 12px;
                background: white;
                border-radius: 8px;
                text-align: right;
                font-weight: 600;
            }
            
            .data-table tfoot tr {
                display: block;
            }
            
            .data-table tfoot td {
                display: block;
                padding: 0;
                border: none;
                text-align: right;
            }
        }

        .add-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .add-btn:hover {
            background: #218838;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @media (min-width: 1200px) {
            .modal-content {
                max-width: 900px;
            }
        }

        /* Modal de usuarios más ancho para mostrar toda la información */
        #modalUsuarios .modal-content {
            max-width: 1200px;
        }

        @media (min-width: 1400px) {
            #modalUsuarios .modal-content {
                max-width: 1400px;
            }
        }

        @media (min-width: 1600px) {
            .modal-content {
                max-width: 1100px;
            }
        }
        
        /* Responsive para modales en móviles */
        @media (max-width: 768px) {
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 20px 15px !important;
                border-radius: 15px 15px 0 0 !important;
                max-height: 95vh !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }
            
            .modal-header {
                margin-bottom: 15px !important;
                flex-wrap: wrap;
            }
            
            .modal-header h2 {
                font-size: 18px !important;
                flex: 1;
                min-width: 0;
            }
            
            .close-modal {
                font-size: 24px !important;
                flex-shrink: 0;
            }
            
            /* Ajustar formularios en modales */
            .form-group {
                margin-bottom: 15px !important;
            }
            
            /* Grids de 2 columnas a 1 columna en móviles */
            .modal-content [style*="grid-template-columns: 1fr 1fr"],
            .modal-content [style*="grid-template-columns: repeat(2"],
            div[style*="grid-template-columns: 1fr 1fr"],
            div[style*="grid-template-columns: repeat(2"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            /* Grids de 3 columnas a 1 columna en móviles */
            .modal-content [style*="grid-template-columns: repeat(3"],
            div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* Prevenir desbordamiento de inputs */
            input, select, textarea {
                max-width: 100% !important;
                width: 100% !important;
                min-width: 0 !important;
                box-sizing: border-box !important;
                -webkit-box-sizing: border-box !important;
                -moz-box-sizing: border-box !important;
            }

            /* Inputs de fecha con mismo ancho que el resto */
            input[type="date"] {
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
            }
        }
        
        @media (max-width: 480px) {
            .modal {
                padding: 0;
            }
            
            .modal-content {
                padding: 15px 12px !important;
                border-radius: 0 !important;
                max-height: 100vh !important;
                overflow-x: hidden !important;
            }
            
            .modal-header h2 {
                font-size: 16px !important;
            }
            
            .modal-header {
                margin-bottom: 12px !important;
            }

            /* Grids más agresivos para iPhone */
            div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            /* Inputs extra compactos para iPhone */
            input, select, textarea {
                font-size: 13px !important;
                padding: 8px 10px !important;
                max-width: 100% !important;
                width: 100% !important;
                min-width: 0 !important;
                box-sizing: border-box !important;
                -webkit-box-sizing: border-box !important;
                -moz-box-sizing: border-box !important;
            }

            /* Normalizar inputs de fecha en iPhone */
            input[type="date"] {
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                padding: 8px 10px !important;
                font-size: 13px !important;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: #667eea;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .close-modal:hover {
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Optimización de espacio para móviles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                border-radius: 15px;
            }

            .module-content {
                padding: 15px;
                margin-top: 10px;
            }

            .header {
                padding: 15px;
                margin-bottom: 20px;
            }

            /* Botones de módulos en 2 columnas para tablets */
            #modulesGrid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            .module-btn {
                padding: 12px 10px;
                font-size: 14px;
            }

            .module-btn img {
                width: 18px !important;
                height: 18px !important;
                margin-right: 6px !important;
            }

            /* Inputs más pequeños para evitar desbordamiento */
            input[type="text"],
            input[type="number"],
            input[type="date"],
            input[type="tel"],
            input[type="email"],
            select,
            textarea {
                font-size: 14px !important;
                padding: 10px 12px !important;
            }
            
            .header-logo {
                gap: 12px;
            }
            
            .header-logo img {
                max-height: 50px;
            }
            
            .header-logo-text h1 {
                display: none; /* Ocultar título en tablets y móviles */
            }
            
            .user-menu-container {
                gap: 10px;
            }
            
            #userNameDisplay {
                display: none; /* Ocultar nombre en tablets */
            }
            
            .user-icon-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .user-menu {
                min-width: 180px;
                right: -10px; /* Ajustar posición en móviles */
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 12px;
                border-radius: 10px;
            }

            .module-content {
                padding: 10px;
                margin-top: 8px;
            }

            .header {
                padding: 10px;
                flex-wrap: wrap;
            }

            /* Botones de módulos MÁS compactos en móviles */
            #modulesGrid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }

            .module-btn {
                padding: 10px 8px;
                font-size: 13px;
                border-radius: 8px;
            }

            .module-btn img {
                width: 16px !important;
                height: 16px !important;
                margin-right: 5px !important;
            }

            /* Convertir todos los grids de 2 y 3 columnas a 1 columna en móviles */
            div[style*="grid-template-columns: 1fr 1fr"],
            div[style*="grid-template-columns: repeat(2"],
            div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* Inputs MÁS pequeños para iPhone */
            input[type="text"],
            input[type="number"],
            input[type="date"],
            input[type="tel"],
            input[type="email"],
            input[type="password"],
            select,
            textarea {
                font-size: 13px !important;
                padding: 8px 10px !important;
                width: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important;
                box-sizing: border-box !important;
                -webkit-box-sizing: border-box !important;
                -moz-box-sizing: border-box !important;
            }

            /* Forzar mismo ancho para inputs de fecha en iPhone */
            input[type="date"] {
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                padding: 8px 10px !important;
            }

            /* Labels más compactos */
            label {
                font-size: 12px !important;
                margin-bottom: 4px !important;
            }

            /* Form groups más compactos */
            .form-group {
                margin-bottom: 12px !important;
            }
            
            .header-logo {
                gap: 8px;
                flex: 1 1 auto;
                min-width: 0;
            }
            
            .header-logo img {
                max-height: 45px;
            }
            
            .header-logo-text {
                min-width: 0;
                overflow: hidden;
            }
            
            .header-logo-text h1 {
                display: none; /* Ocultar título en móviles */
            }
            
            .user-menu-container {
                gap: 8px;
                flex-shrink: 0;
            }
            
            .user-icon-btn {
                width: 38px;
                height: 38px;
                font-size: 16px;
            }
            
            .user-menu {
                min-width: 160px;
                right: -15px;
                top: 50px;
            }
            
            .user-menu-item {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .user-menu-info {
                padding: 10px 15px;
            }
            
            .user-menu-info-item {
                font-size: 10px;
            }
            
            /* Botones de proveedores apilados en móviles */
            .botones-proveedores-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Gráfico responsive en móviles */
            .chart-container {
                padding: 15px !important;
                height: 300px !important;
            }
        }
        
        @media (max-width: 768px) {
            /* Botones de proveedores apilados en tablets */
            .botones-proveedores-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Gráfico responsive en tablets */
            .chart-container {
                padding: 15px !important;
                height: 350px !important;
            }
        }

        /* Estilos para asegurar que flatpickr sea visible */
        .flatpickr-calendar {
            z-index: 10000 !important;
            position: fixed !important;
        }

        .flatpickr-calendar.open {
            z-index: 10000 !important;
        }

        /* Asegurar que input type="date" sea visible */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            z-index: 1;
        }

        /* Forzar mismo ancho para TODOS los inputs incluyendo fechas */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="tel"],
        input[type="email"],
        input[type="password"],
        select,
        textarea {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            -webkit-box-sizing: border-box !important;
            -moz-box-sizing: border-box !important;
        }

        /* Específico para inputs de fecha - eliminar padding extra del navegador */
        input[type="date"] {
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header para login -->
        <div class="logo" id="loginHeader">
            <img src="/static/logotipoRLV.svg" alt="Violetas Sistema de Gestión de Residencias" style="max-height: 80px; width: auto;">
            <p>Gestión Residencias</p>
        </div>

        <!-- Header para dashboard con menú de usuario -->
        <div class="header" id="dashboardHeader" style="display: none;">
            <div class="header-logo">
                <img src="/static/logotipoRLV.svg" alt="Violetas Sistema de Gestión de Residencias" style="max-height: 60px; width: auto;">
                <div class="header-logo-text">
                    <h1>Gestión Residencias</h1>
                </div>
            </div>
            <div class="user-menu-container">
                <div id="userNameDisplay">
                    <span id="userNameText">-</span>
                </div>
                <button class="user-icon-btn" onclick="toggleUserMenu()" title="Menú de usuario">
                    <img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 24px; height: 24px;">
                </button>
                <div class="user-menu" id="userMenu">
                    <div class="user-menu-info" id="userMenuInfo">
                        <div class="user-menu-info-item"><strong>ID Usuario:</strong> -</div>
                        <div class="user-menu-info-item"><strong>Rol ID:</strong> -</div>
                        <div class="user-menu-info-item"><strong>Residencia ID:</strong> -</div>
                        <div class="user-menu-info-item"><strong>Expira:</strong> -</div>
                    </div>
                    <button class="user-menu-item" onclick="showConfiguracion()">
                        <img src="/static/icons/medical/settings.svg" alt="Configuración" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Configuración
                    </button>
                    <button class="user-menu-item logout" onclick="logout()">
                        <img src="/static/icons/medical/log-out.svg" alt="Cerrar Sesión" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>

        <div id="loginForm">
            <div id="alert" class="alert"></div>
            
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required 
                           placeholder="admin@violetas1.com" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" required 
                           placeholder="••••••••" autocomplete="current-password">
                </div>

                <button type="submit" id="loginBtn">Iniciar Sesión</button>
            </form>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="user-info" id="userInfo" style="display: none;"></div>
            
            <div style="margin-top: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">Módulos del Sistema</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;" id="modulesGrid">
                    <button class="module-btn module-btn-residentes" onclick="showModule('residentes')">
                        <img src="/static/icons/medical/users.svg" alt="Residentes" style="width: 20px; height: 20px; margin-right: 8px;"> Residentes
                    </button>
                    <button class="module-btn module-btn-facturacion" onclick="showModule('facturacion')">
                        <span style="font-size: 20px; margin-right: 8px;">€</span> Facturación
                    </button>
                    <button class="module-btn module-btn-personal" onclick="showModule('personal')">
                        <img src="/static/icons/medical/user-medical.svg" alt="Personal" style="width: 20px; height: 20px; margin-right: 8px;"> Personal
                    </button>
                    <button class="module-btn module-btn-documentacion" onclick="showModule('documentacion')">
                        <img src="/static/icons/medical/file-medical.svg" alt="Documentación" style="width: 20px; height: 20px; margin-right: 8px;"> Documentación
                    </button>
                    <button class="module-btn module-btn-historicos" onclick="showModule('historicos')">
                        <img src="/static/icons/medical/calendar-medical.svg" alt="Históricos" style="width: 20px; height: 20px; margin-right: 8px;"> Históricos
                    </button>
                    <button class="module-btn module-btn-configuracion" id="configuracionBtn" onclick="showConfiguracion()" style="display: none;">
                        <img src="/static/icons/medical/settings.svg" alt="Configuración" style="width: 20px; height: 20px; margin-right: 8px;"> Configuración
                    </button>
                </div>
            </div>

            <div id="moduleContent" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Modal para ver/editar residente -->
    <div id="modalViewResidente" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Detalle del Residente</h2>
                <button class="close-modal" onclick="closeModal('modalViewResidente')">&times;</button>
            </div>
            <div id="viewResidenteContent">
                <p>Cargando...</p>
            </div>
        </div>
    </div>

    <!-- Modal para agregar residente -->
    <div id="modalResidente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Residente</h2>
                <button class="close-modal" onclick="closeModal('modalResidente')">&times;</button>
            </div>
            <form id="formResidente" onsubmit="saveResidente(event)">
                
                <!-- SECCIÓN: Información de Residencia -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/home.svg" alt="Residencia" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Residencia</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="res_id_residencia">Residencia *</label>
                            <select id="res_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione una residencia</option>
                                <option value="1">Violetas 1</option>
                                <option value="2">Violetas 2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="res_habitacion">Habitación *</label>
                            <select id="res_habitacion" name="habitacion" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione una habitación</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="res_fecha_ingreso">Fecha de Ingreso</label>
                            <input type="date" id="res_fecha_ingreso" name="fecha_ingreso" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        </div>
                        <div class="form-group">
                            <label for="res_costo_habitacion">Costo de Habitación (€)</label>
                            <input type="number" id="res_costo_habitacion" name="costo_habitacion" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="res_metodo_pago_preferido">Método de Pago Preferido</label>
                            <select id="res_metodo_pago_preferido" name="metodo_pago_preferido" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un método</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="remesa">Remesa</option>
                                <option value="metálico">Metálico</option>
                                <option value="bizum">Bizum</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información Personal -->
                <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                    <h3 style="color: #f56565; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Personal</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="res_nombre">Nombre *</label>
                            <input type="text" id="res_nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="res_apellido">Apellido *</label>
                            <input type="text" id="res_apellido" name="apellido" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="res_documento">Documento de Identidad</label>
                            <input type="text" id="res_documento" name="documento_identidad">
                        </div>
                        <div class="form-group">
                            <label for="res_fecha_nacimiento">Fecha de Nacimiento</label>
                            <input type="date" id="res_fecha_nacimiento" name="fecha_nacimiento" onchange="actualizarEdad('res_fecha_nacimiento', 'res_edad')" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        </div>
                        <div class="form-group">
                            <label for="res_edad">Edad</label>
                            <input type="text" id="res_edad" name="edad" readonly style="background-color: #f5f5f5; color: #666; cursor: not-allowed;" placeholder="Se calculará automáticamente">
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información de Contacto -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/phone.svg" alt="Contacto" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Contacto</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="res_telefono">Teléfono</label>
                            <input type="tel" id="res_telefono" name="telefono">
                        </div>
                        <div class="form-group">
                            <label for="res_direccion">Dirección</label>
                            <input type="text" id="res_direccion" name="direccion">
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <h4 style="color: #48bb78; margin-bottom: 10px; font-size: 14px; font-weight: 600;">Contacto de Emergencia</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="res_contacto_emergencia">Nombre del Contacto</label>
                                <input type="text" id="res_contacto_emergencia" name="contacto_emergencia">
                            </div>
                            <div class="form-group">
                                <label for="res_telefono_emergencia">Teléfono de Emergencia</label>
                                <input type="tel" id="res_telefono_emergencia" name="telefono_emergencia">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información Médica y Servicios -->
                <div style="background: #fffaf0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                    <h3 style="color: #ed8936; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Información Médica" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Médica y Servicios</h3>
                    
                    <!-- Datos Médicos Esenciales -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                            <label for="res_grupo_sanguineo">Grupo Sanguíneo</label>
                            <select id="res_grupo_sanguineo" name="grupo_sanguineo" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="res_nivel_dependencia">Nivel de Dependencia</label>
                            <select id="res_nivel_dependencia" name="nivel_dependencia" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione</option>
                                <option value="Autónomo">Autónomo</option>
                                <option value="Dependencia leve">Dependencia leve</option>
                                <option value="Dependencia moderada">Dependencia moderada</option>
                                <option value="Dependencia severa">Dependencia severa</option>
                                <option value="Gran dependencia">Gran dependencia</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="res_alergias">Alergias</label>
                            <textarea id="res_alergias" name="alergias" rows="2" placeholder="Ej: Penicilina, Lácteos, Polen"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="res_diagnosticos">Enfermedades / Diagnósticos</label>
                            <textarea id="res_diagnosticos" name="diagnosticos" rows="2" placeholder="Ej: Diabetes tipo 2, Hipertensión, Artritis"></textarea>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="res_restricciones_dieteticas">Restricciones Dietéticas</label>
                            <textarea id="res_restricciones_dieteticas" name="restricciones_dieteticas" rows="2" placeholder="Ej: Sin sal, Textura triturada, Sin gluten"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="res_movilidad">Movilidad / Ayudas Técnicas</label>
                            <select id="res_movilidad" name="movilidad" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione</option>
                                <option value="Deambulación autónoma">Deambulación autónoma</option>
                                <option value="Bastón">Bastón</option>
                                <option value="Andador">Andador</option>
                                <option value="Silla de ruedas">Silla de ruedas</option>
                                <option value="Cama">Cama</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="res_medico_referencia">Médico de Referencia</label>
                            <input type="text" id="res_medico_referencia" name="medico_referencia" placeholder="Nombre del médico o centro de salud">
                        </div>
                        <div class="form-group">
                            <label for="res_telefono_medico">Teléfono Médico</label>
                            <input type="text" id="res_telefono_medico" name="telefono_medico" placeholder="Teléfono del médico o centro">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="res_medicaciones">Medicaciones</label>
                        <textarea id="res_medicaciones" name="medicaciones" rows="3" placeholder="Lista de medicaciones y horarios"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Servicios Extra</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" name="servicio_extra" value="Peluquería" style="width: auto; margin-right: 8px;">
                                Peluquería
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" name="servicio_extra" value="Podólogo" style="width: auto; margin-right: 8px;">
                                Podólogo
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" name="servicio_extra" value="Fisio" style="width: auto; margin-right: 8px;">
                                Fisio
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" name="servicio_extra" value="Farmacia" style="width: auto; margin-right: 8px;">
                                Farmacia
                            </label>
                    </div>
                        <input type="text" id="res_servicios_extra_otros" name="servicios_extra_otros" placeholder="Otros servicios (separados por comas, ej: Lavandería, Masajes)" style="margin-top: 5px;">
                        <input type="hidden" id="res_servicios_extra" name="servicios_extra" value="">
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="res_peculiaridades">Peculiaridades / Notas Importantes</label>
                        <textarea id="res_peculiaridades" name="peculiaridades" rows="3" placeholder="Información adicional relevante"></textarea>
                    </div>
                </div>
                
                <!-- Los nuevos residentes siempre son activos -->
                <input type="hidden" id="res_activo" name="activo" value="true">
                <div id="modalAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveResidenteBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalResidente')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar personal -->
    <div id="modalPersonal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Personal</h2>
                <button class="close-modal" onclick="closeModal('modalPersonal')">&times;</button>
            </div>
            <form id="formPersonal" onsubmit="savePersonal(event)">
                <input type="hidden" id="per_id_personal" name="id_personal" value="">
                
                <!-- SECCIÓN: Información de Residencia -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/home.svg" alt="Residencia" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Residencia</h3>
                    <div class="form-group">
                        <label for="per_id_residencia">Residencia *</label>
                        <select id="per_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Seleccione una residencia</option>
                            <option value="1">Violetas 1</option>
                            <option value="2">Violetas 2</option>
                        </select>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información Personal -->
                <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                    <h3 style="color: #f56565; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Personal</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="per_nombre">Nombre *</label>
                            <input type="text" id="per_nombre" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="per_apellido">Apellido *</label>
                            <input type="text" id="per_apellido" name="apellido" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="per_documento">Documento de Identidad</label>
                            <input type="text" id="per_documento" name="documento_identidad">
                        </div>
                        <div class="form-group">
                            <label for="per_cargo">Cargo</label>
                            <input type="text" id="per_cargo" name="cargo" placeholder="Ej: Enfermero/a, Auxiliar, Director/a">
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información de Contacto -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/phone.svg" alt="Contacto" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Contacto</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="per_telefono">Teléfono</label>
                            <input type="tel" id="per_telefono" name="telefono">
                        </div>
                        <div class="form-group">
                            <label for="per_email">Email</label>
                            <input type="email" id="per_email" name="email">
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información Laboral -->
                <div style="background: #fffaf0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                    <h3 style="color: #ed8936; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Laboral" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Laboral</h3>
                    <div class="form-group">
                        <label for="per_fecha_contratacion">Fecha de Contratación</label>
                        <input type="date" id="per_fecha_contratacion" name="fecha_contratacion" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                    </div>
                </div>
                
                <!-- Los nuevos empleados siempre son activos -->
                <input type="hidden" id="per_activo" name="activo" value="true">
                <div id="modalPersonalAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="savePersonalBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalPersonal')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar/editar turno extra -->
    <div id="modalTurnoExtra" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/calendar-medical.svg" alt="Turno Extra" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> <span id="modalTurnoExtraTitle">Agregar Turno Extra</span></h2>
                <button class="close-modal" onclick="closeModal('modalTurnoExtra')">&times;</button>
            </div>
            <form id="formTurnoExtra" onsubmit="saveTurnoExtra(event)">
                <input type="hidden" id="turno_id_turno_extra" name="id_turno_extra" value="">
                
                <!-- SECCIÓN: Información del Turno -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/user-medical.svg" alt="Empleado" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Empleado</h3>
                    <div class="form-group">
                        <label for="turno_id_personal">Empleado *</label>
                        <select id="turno_id_personal" name="id_personal" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Seleccione un empleado</option>
                        </select>
                    </div>
                </div>
                
                <!-- SECCIÓN: Fecha y Horas -->
                <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                    <h3 style="color: #f56565; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/calendar-medical.svg" alt="Fecha" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Fecha y Horas</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="turno_fecha">Fecha *</label>
                            <div style="position: relative;">
                                <input type="date" id="turno_fecha" name="fecha" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;" required>
                                <svg style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; pointer-events: none; display: none;" fill="none" stroke="#333333" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="turno_hora_entrada">Hora Entrada *</label>
                            <div style="position: relative;">
                                <input type="time" id="turno_hora_entrada" name="hora_entrada" style="padding-right: 40px;" required>
                                <svg style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; pointer-events: none;" fill="none" stroke="#333333" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="turno_hora_salida">Hora Salida *</label>
                            <div style="position: relative;">
                                <input type="time" id="turno_hora_salida" name="hora_salida" style="padding-right: 40px;" required>
                                <svg style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; pointer-events: none;" fill="none" stroke="#333333" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Motivo -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Motivo" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Motivo</h3>
                    <div class="form-group">
                        <label for="turno_motivo">Motivo del Turno Extra</label>
                        <textarea id="turno_motivo" name="motivo" rows="3" placeholder="Describa el motivo del turno extra..."></textarea>
                    </div>
                </div>
                
                <div id="modalTurnoExtraAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveTurnoExtraBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalTurnoExtra')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar proveedor -->
    <div id="modalProveedor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Proveedor</h2>
                <button class="close-modal" onclick="closeModal('modalProveedor')">&times;</button>
            </div>
            <form id="formProveedor" onsubmit="saveProveedor(event)">
                <input type="hidden" id="prov_id_proveedor" name="id_proveedor" value="">
                
                <!-- SECCIÓN: Información Básica -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Información" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Básica</h3>
                    <div class="form-group">
                        <label for="prov_id_residencia">Residencia *</label>
                        <select id="prov_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Cargando residencias...</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="prov_nombre">Nombre del Proveedor *</label>
                        <input type="text" id="prov_nombre" name="nombre" required placeholder="Ej: Empresa de Limpieza SL">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="prov_nif_cif">NIF/CIF</label>
                            <input type="text" id="prov_nif_cif" name="nif_cif" placeholder="B12345678">
                        </div>
                        <div class="form-group">
                            <label for="prov_tipo_servicio">Tipo de Servicio</label>
                            <select id="prov_tipo_servicio" name="tipo_servicio" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un tipo</option>
                                <option value="Limpieza">Limpieza</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Alimentación">Alimentación</option>
                                <option value="Farmacia">Farmacia</option>
                                <option value="Servicios Médicos">Servicios Médicos</option>
                                <option value="Suministros">Suministros</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Información de Contacto -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/phone.svg" alt="Contacto" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Contacto</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="prov_telefono">Teléfono</label>
                            <input type="tel" id="prov_telefono" name="telefono" placeholder="666 555 444">
                        </div>
                        <div class="form-group">
                            <label for="prov_email">Email</label>
                            <input type="email" id="prov_email" name="email" placeholder="contacto@proveedor.com">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="prov_direccion">Dirección</label>
                            <input type="text" id="prov_direccion" name="direccion" placeholder="Calle, número, ciudad">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="prov_contacto">Persona de Contacto</label>
                            <input type="text" id="prov_contacto" name="contacto" placeholder="Nombre del contacto principal">
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Estado y Observaciones -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #718096;">
                    <h3 style="color: #718096; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/settings.svg" alt="Estado" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Estado y Observaciones</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="prov_activo" name="activo" checked style="width: auto; margin-right: 8px;">
                            Proveedor Activo
                        </label>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="prov_observaciones">Observaciones</label>
                        <textarea id="prov_observaciones" name="observaciones" rows="3" placeholder="Notas adicionales sobre el proveedor"></textarea>
                    </div>
                </div>
                
                <div id="modalProveedorAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveProveedorBtn" style="flex: 1;">Guardar</button>
                    <button type="button" id="bajaProveedorBtn" onclick="abrirModalBajaProveedor()" style="flex: 1; background: #dc3545; display: none;">Dar de Baja</button>
                    <button type="button" onclick="closeModal('modalProveedor')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Dar de Baja a Proveedor -->
    <div id="modalBajaProveedor" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/user-x.svg" alt="Dar de baja" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Archivar Proveedor</h2>
                <button class="close-modal" onclick="closeModal('modalBajaProveedor')">&times;</button>
            </div>
            <form id="formBajaProveedor" onsubmit="confirmarBajaProveedor(event)">
                <input type="hidden" id="baja_id_proveedor" name="id_proveedor">
                <div class="form-group">
                    <label for="baja_proveedor_motivo">Motivo de la Baja *</label>
                    <select id="baja_proveedor_motivo" name="motivo_baja" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                        <option value="">Seleccione un motivo</option>
                        <option value="Finalización de contrato">Finalización de contrato</option>
                        <option value="Incumplimiento de condiciones">Incumplimiento de condiciones</option>
                        <option value="Cambio de proveedor">Cambio de proveedor</option>
                        <option value="Cese de actividad">Cese de actividad</option>
                        <option value="Problemas de calidad">Problemas de calidad</option>
                        <option value="Problemas de pago">Problemas de pago</option>
                        <option value="Falta de documentación">Falta de documentación</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="baja_proveedor_observaciones">Observaciones (opcional)</label>
                    <textarea id="baja_proveedor_observaciones" name="observaciones" rows="3" placeholder="Información adicional sobre la baja"></textarea>
                </div>
                <div id="modalBajaProveedorAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="confirmarBajaProveedorBtn" style="flex: 1; background: #dc3545;">Confirmar Baja</button>
                    <button type="button" onclick="closeModal('modalBajaProveedor')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar cobro manual -->
    <div id="modalCobro" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalCobroTitulo"><img src="/static/icons/medical/bill.svg" alt="Cobro" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Cobro</h2>
                <button class="close-modal" onclick="closeModal('modalCobro')">&times;</button>
            </div>
            <form id="formCobro" onsubmit="saveCobro(event)">
                <input type="hidden" id="cobro_id_pago" name="id_pago" value="">
                <!-- SECCIÓN: Información del Cobro -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/bill.svg" alt="Cobro" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"> Información del Cobro</h3>
                    <div class="form-group">
                        <label for="cobro_id_residente">Residente *</label>
                        <select id="cobro_id_residente" name="id_residente" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Cargando residentes...</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="cobro_monto">Monto (€) *</label>
                            <input type="number" id="cobro_monto" name="monto" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="cobro_metodo_pago">Tipo de Pago</label>
                            <select id="cobro_metodo_pago" name="metodo_pago" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un método</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="remesa">Remesa</option>
                                <option value="metálico">Metálico</option>
                                <option value="bizum">Bizum</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="cobro_concepto">Concepto *</label>
                        <select id="cobro_concepto" name="concepto" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;" onchange="actualizarCampoConceptoOtros()">
                            <option value="">Seleccione un concepto</option>
                            <option value="Pago mensual habitación">Pago mensual habitación</option>
                            <option value="otros">Otros</option>
                        </select>
                        <input type="text" id="cobro_concepto_otros" name="concepto_otros" placeholder="Escriba el concepto personalizado" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333; margin-top: 10px; display: none;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="cobro_fecha_prevista">Fecha Prevista</label>
                            <input type="date" id="cobro_fecha_prevista" name="fecha_prevista" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        </div>
                        <div class="form-group">
                            <label for="cobro_fecha_pago">Fecha de Pago </label>
                            <input type="date" id="cobro_fecha_pago" name="fecha_pago" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="cobro_observaciones">Observaciones</label>
                        <textarea id="cobro_observaciones" name="observaciones" rows="3" placeholder="Notas adicionales sobre el cobro"></textarea>
                    </div>
                    <p style="margin-top: 10px; font-size: 12px; color: #666; display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#667eea"/><path d="M12 16v-4m0-4h.01" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
                        <span><strong>Nota:</strong> Si no tiene fecha de pago, será un cobro previsto. Si tiene fecha de pago, será un cobro completado.</span>
                    </p>
                </div>
                
                <div id="modalCobroAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveCobroBtn" style="flex: 1; display: none;">Guardar</button>
                    <button type="button" id="deleteCobroBtn" onclick="confirmarEliminarCobro()" style="flex: 1; background: #dc3545; display: none;">Eliminar</button>
                    <button type="button" onclick="closeModal('modalCobro')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para dar de baja a un residente -->
    <div id="modalBajaResidente" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/user-x.svg" alt="Dar de baja" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Dar de Baja a Residente</h2>
                <button class="close-modal" onclick="closeModal('modalBajaResidente')">&times;</button>
            </div>
            <form id="formBajaResidente" onsubmit="confirmarBajaResidente(event)">
                <input type="hidden" id="baja_id_residente" name="id_residente">
                <div class="form-group">
                    <label for="baja_motivo">Motivo de la Baja *</label>
                    <select id="baja_motivo" name="motivo_baja" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                        <option value="">Seleccione un motivo</option>
                        <option value="Fallecimiento">Fallecimiento</option>
                        <option value="Traslado a hospital">Traslado a hospital</option>
                        <option value="Traslado a otra residencia">Traslado a otra residencia</option>
                        <option value="Alta médica">Alta médica</option>
                        <option value="Solicitud familiar">Solicitud familiar</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="baja_observaciones">Observaciones (opcional)</label>
                    <textarea id="baja_observaciones" name="observaciones" rows="3" placeholder="Información adicional sobre la baja"></textarea>
                </div>
                <div id="modalBajaAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="confirmarBajaBtn" style="flex: 1; background: #dc3545;">Confirmar Baja</button>
                    <button type="button" onclick="closeModal('modalBajaResidente')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para listar proveedores -->
    <div id="modalListaProveedores" class="modal">
        <div class="modal-content" style="max-width: 1400px; width: 95%;">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/package.svg" alt="Proveedores" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Listado de Proveedores</h2>
                <button class="close-modal" onclick="closeModal('modalListaProveedores')">&times;</button>
            </div>
            <div id="listaProveedoresContent" style="padding: 20px;">
                <div style="text-align: center; padding: 40px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 15px; color: #666;">Cargando proveedores...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar pago a proveedor -->
    <div id="modalPagoProveedor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span style="font-size: 24px; vertical-align: middle; margin-right: 8px;">€</span> Agregar Pago a Proveedor</h2>
                <button class="close-modal" onclick="closeModal('modalPagoProveedor')">&times;</button>
            </div>
            <form id="formPagoProveedor" onsubmit="savePagoProveedor(event)">
                <input type="hidden" id="pago_id_pago" name="id_pago" value="">
                
                <!-- SECCIÓN: Información del Pago -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/alert-circle.svg" alt="Información" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"> Información del Pago</h3>
                    <div class="form-group">
                        <label for="pago_id_residencia">Residencia *</label>
                        <select id="pago_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Cargando residencias...</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="pago_id_proveedor">Proveedor *</label>
                        <button type="button" id="btnNuevoProveedor" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap; margin-bottom: 10px; display: block;">+ Nuevo Proveedor</button>
                        <select id="pago_id_proveedor" name="id_proveedor" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Seleccione primero una residencia</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="pago_concepto">Concepto *</label>
                        <input type="text" id="pago_concepto" name="concepto" required placeholder="Se generará automáticamente: Nombre del proveedor y fecha">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_fecha_emision">Fecha de Emisión</label>
                            <input type="date" id="pago_fecha_emision" name="fecha_emision" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label for="pago_fecha_vencimiento">Fecha de Vencimiento</label>
                            <input type="date" id="pago_fecha_vencimiento" name="fecha_vencimiento" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_fecha_prevista">Fecha Prevista</label>
                            <input type="date" id="pago_fecha_prevista" name="fecha_prevista" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        </div>
                        <div class="form-group">
                            <label for="pago_fecha_pago">Fecha de Pago</label>
                            <input type="date" id="pago_fecha_pago" name="fecha_pago" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_base_imponible">Base Imponible (€)</label>
                            <input type="number" id="pago_base_imponible" name="base_imponible" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="pago_monto">Monto Total (€)</label>
                            <input type="number" id="pago_monto" name="monto" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_iva">IVA (%)</label>
                            <input type="number" id="pago_iva" name="iva" step="0.01" placeholder="21.00" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="pago_iva_monto">IVA (€)</label>
                            <input type="number" id="pago_iva_monto" name="iva_monto" step="0.01" placeholder="0.00" readonly style="background-color: #f5f5f5;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="pago_metodo_pago">Método de Pago</label>
                            <select id="pago_metodo_pago" name="metodo_pago" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                <option value="">Seleccione un método</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="remesa">Remesa</option>
                                <option value="metálico">Metálico</option>
                                <option value="cheque">Cheque</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pago_numero_factura">Número de Factura</label>
                            <input type="text" id="pago_numero_factura" name="numero_factura" placeholder="FAC-2025-001">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="pago_factura_archivo_manual" style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Adjuntar Factura (PDF)</label>
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <label for="pago_factura_archivo_manual" style="flex: 1; display: flex; align-items: center; padding: 12px 16px; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9ff; cursor: pointer; transition: all 0.3s ease;">
                                <input type="file" id="pago_factura_archivo_manual" accept=".pdf" style="position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none;" onchange="actualizarNombreArchivoManual()">
                                <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                                    <img src="/static/icons/medical/file-medical.svg" alt="Archivo" style="width: 24px; height: 24px; filter: brightness(0) saturate(100%) invert(27%) sepia(95%) saturate(1352%) hue-rotate(230deg) brightness(99%) contrast(96%);">
                                    <div style="flex: 1; min-width: 0;">
                                        <div id="pago_factura_texto_manual" style="color: #667eea; font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            Seleccionar archivo PDF...
                                        </div>
                                        <div style="color: #999; font-size: 12px; margin-top: 2px;">
                                            Máximo 10MB
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN: Observaciones -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #718096;">
                    <h3 style="color: #718096; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/settings.svg" alt="Observaciones" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Observaciones</h3>
                    <div class="form-group">
                        <label for="pago_observaciones">Observaciones</label>
                        <textarea id="pago_observaciones" name="observaciones" rows="3" placeholder="Notas adicionales sobre el pago"></textarea>
                    </div>
                    <p style="margin-top: 10px; font-size: 12px; color: #666; display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#667eea"/><path d="M12 16v-4m0-4h.01" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
                        <span><strong>Nota:</strong> Si tiene fecha de pago, será un pago completado. Si no tiene fecha de pago, será un pago pendiente.</span>
                    </p>
                </div>
                
                <div id="modalPagoProveedorAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="savePagoProveedorBtn" style="flex: 1; display: none;">Guardar</button>
                    <button type="button" id="pago_eliminar_factura_btn" onclick="eliminar_factura_pago()" style="display: none; flex: 1; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; align-items: center; justify-content: center; gap: 6px;">
                        <img src="/static/icons/medical/user-x.svg" alt="Eliminar" style="width: 16px; height: 16px; filter: brightness(0) invert(1);">
                        Eliminar
                    </button>
                    <button type="button" onclick="closeModal('modalPagoProveedor')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para procesar factura con IA -->
    <div id="modalProcesarFactura" class="modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h2>
                    <img src="/static/icons/medical/file-medical.svg" alt="Procesar Factura" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Procesar Factura con IA
                </h2>
                <button class="close-modal" onclick="closeModal('modalProcesarFactura')">&times;</button>
            </div>
            
            <div id="procesarFacturaContent">
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">Paso 1: Subir Factura PDF</h3>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="procesar_factura_archivo" style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Seleccionar Factura (PDF)</label>
                        <label for="procesar_factura_archivo" style="display: flex; align-items: center; padding: 15px; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9ff; cursor: pointer; transition: all 0.3s ease;">
                            <input type="file" id="procesar_factura_archivo" accept=".pdf" style="position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none;" onchange="actualizarNombreArchivoProcesar()">
                            <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                                <img src="/static/icons/medical/file-medical.svg" alt="Archivo" style="width: 32px; height: 32px; filter: brightness(0) saturate(100%) invert(27%) sepia(95%) saturate(1352%) hue-rotate(230deg) brightness(99%) contrast(96%);">
                                <div style="flex: 1;">
                                    <div id="procesar_factura_texto" style="color: #667eea; font-weight: 500; font-size: 16px;">
                                        Seleccionar archivo PDF...
                                    </div>
                                    <div style="color: #999; font-size: 12px; margin-top: 4px;">
                                        Máximo 10MB
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" onclick="procesarFacturaCompleta()" id="btnProcesarFacturaCompleta" style="flex: 1; padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: brightness(0) invert(1);">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="currentColor"/>
                            </svg>
                            Procesar Factura
                        </button>
                    </div>
                </div>
                <div id="procesarFacturaAlert" class="alert" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal para Subir Documento -->
    <div id="modalSubirDocumento" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>
                    <img src="/static/icons/medical/file-medical.svg" alt="Subir Documento" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Subir Documento
                </h2>
                <button class="close-modal" onclick="closeModal('modalSubirDocumento')">&times;</button>
            </div>
            <form id="formSubirDocumento" onsubmit="saveDocumento(event)">
                <div class="form-group">
                    <label for="doc_tipo_entidad">Tipo de Entidad *</label>
                    <select id="doc_tipo_entidad" name="tipo_entidad" required onchange="actualizarEntidadesDocumento()" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                        <option value="">Seleccione un tipo</option>
                        <option value="residente">Residente</option>
                        <option value="proveedor">Proveedor</option>
                        <option value="personal">Personal</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="doc_id_entidad">Entidad *</label>
                    <select id="doc_id_entidad" name="id_entidad" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                        <option value="">Seleccione primero el tipo de entidad</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="doc_categoria_documento">Categoría *</label>
                    <select id="doc_categoria_documento" name="categoria_documento" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                        <option value="">Seleccione una categoría</option>
                        <option value="medica">Médica</option>
                        <option value="fiscal">Fiscal</option>
                        <option value="sanitaria">Sanitaria</option>
                        <option value="laboral">Laboral</option>
                        <option value="Pagos">Pagos</option>
                        <option value="otra">Otra</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="doc_tipo_documento">Tipo de Documento *</label>
                    <input type="text" id="doc_tipo_documento" name="tipo_documento" required placeholder="Ej: DNI, Informe médico, Contrato" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="doc_archivo">Archivo *</label>
                    <input type="file" id="doc_archivo" name="archivo" required accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Formatos permitidos: PDF, JPG, PNG. Máximo 10MB</small>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="doc_descripcion">Descripción (opcional)</label>
                    <textarea id="doc_descripcion" name="descripcion" rows="3" placeholder="Descripción adicional del documento" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;"></textarea>
                </div>
                <div id="documentoAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveDocumentoBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalSubirDocumento')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Gestión de Usuarios (Solo Admin) -->
    <div id="modalUsuarios" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalUsuariosTitulo">
                    <img src="/static/icons/medical/users.svg" alt="Usuarios" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Gestión de Usuarios
                </h2>
                <button class="close-modal" onclick="closeModal('modalUsuarios')">&times;</button>
            </div>
            <div id="usuariosContent" style="max-height: 70vh; overflow-y: auto;">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <!-- Modal para Crear/Editar Usuario -->
    <div id="modalUsuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalUsuarioTitulo">
                    <img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Usuario
                </h2>
                <button class="close-modal" onclick="closeModal('modalUsuario')">&times;</button>
            </div>
            <form id="formUsuario" onsubmit="saveUsuario(event)">
                <input type="hidden" id="usuario_id_usuario" name="id_usuario" value="">
                <div id="usuarioAlert" class="alert" style="display: none;"></div>
                
                <div class="form-section">
                    <h3>Información de Acceso</h3>
                    <div class="form-group">
                        <label for="usuario_email">Email *</label>
                        <input type="email" id="usuario_email" name="email" required placeholder="usuario@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label for="usuario_password">Contraseña <span id="passwordRequired" style="color: red;">*</span></label>
                        <input type="password" id="usuario_password" name="password" placeholder="Mínimo 8 caracteres, con mayúscula, minúscula, número y carácter especial" required>
                        <small id="passwordHelp" style="color: #666; font-size: 12px;">Requerida al crear. Mínimo 8 caracteres, debe incluir mayúscula, minúscula, número y carácter especial (!@#$%^&*...)</small>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Información Personal</h3>
                    <div class="form-group">
                        <label for="usuario_nombre">Nombre</label>
                        <input type="text" id="usuario_nombre" name="nombre" placeholder="Nombre del usuario">
                    </div>
                    <div class="form-group">
                        <label for="usuario_apellido">Apellido</label>
                        <input type="text" id="usuario_apellido" name="apellido" placeholder="Apellido del usuario">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Permisos y Residencias</h3>
                    <div class="form-group">
                        <label for="usuario_id_rol">Rol *</label>
                        <select id="usuario_id_rol" name="id_rol" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                            <option value="">Seleccione un rol</option>
                        </select>
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Roles disponibles: Administrador, Director y Personal</small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Residencias de Acceso *</label>
                        <div id="usuario_residencias_container" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f9f9f9; max-height: 200px; overflow-y: auto;">
                            <div style="text-align: center; color: #666; padding: 20px;">Cargando residencias...</div>
                        </div>
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Seleccione al menos una residencia a la que el usuario tendrá acceso</small>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Módulos y Permisos</label>
                        <div id="usuario_modulos_container" style="margin-top: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f9f9f9; max-height: 600px; overflow-y: auto; overflow-x: hidden; position: relative;">
                            <style>
                                #usuario_modulos_container::-webkit-scrollbar {
                                    width: 12px;
                                }
                                #usuario_modulos_container::-webkit-scrollbar-track {
                                    background: #f1f1f1;
                                    border-radius: 6px;
                                }
                                #usuario_modulos_container::-webkit-scrollbar-thumb {
                                    background: #667eea;
                                    border-radius: 6px;
                                }
                                #usuario_modulos_container::-webkit-scrollbar-thumb:hover {
                                    background: #5568d3;
                                }
                            </style>
                            <div style="text-align: center; color: #666; padding: 20px;">Cargando módulos...</div>
                        </div>
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Seleccione los módulos y permisos a los que el usuario tendrá acceso dentro de las residencias seleccionadas. <strong>Desplázate hacia abajo para ver todos los módulos disponibles.</strong></small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="usuario_activo" name="activo" checked style="width: auto; margin-right: 8px;"> Usuario Activo
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveUsuarioBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalUsuario')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Gestión de Residencias (Solo SuperAdmin) -->
    <div id="modalResidencias" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh;">
            <div class="modal-header">
                <h2 id="modalResidenciasTitulo">
                    <img src="/static/icons/medical/hospital.svg" alt="Residencias" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Gestión de Residencias
                </h2>
                <button class="close-modal" onclick="closeModal('modalResidencias')">&times;</button>
            </div>
            <div id="residenciasContent" style="max-height: calc(90vh - 100px); overflow-y: auto; padding: 0 5px;">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <!-- Modal para Crear/Editar Residencia -->
    <div id="modalResidencia" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalResidenciaTitulo">
                    <img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Residencia
                </h2>
                <button class="close-modal" onclick="closeModal('modalResidencia')">&times;</button>
            </div>
            <form id="formResidencia" onsubmit="saveResidencia(event)">
                <input type="hidden" id="residencia_id_residencia" name="id_residencia" value="">
                <div id="residenciaAlert" class="alert" style="display: none;"></div>
                
                <div class="form-section">
                    <h3>Información de la Residencia</h3>
                    <div class="form-group">
                        <label for="residencia_nombre">Nombre *</label>
                        <input type="text" id="residencia_nombre" name="nombre" required placeholder="Ej: Violetas 3" maxlength="255">
                    </div>
                    <div class="form-group">
                        <label for="residencia_direccion">Dirección</label>
                        <input type="text" id="residencia_direccion" name="direccion" placeholder="Calle y número" maxlength="500">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="residencia_codigo_postal">Código Postal</label>
                            <input type="text" id="residencia_codigo_postal" name="codigo_postal" placeholder="28001" maxlength="10">
                        </div>
                        <div class="form-group">
                            <label for="residencia_ciudad">Ciudad</label>
                            <input type="text" id="residencia_ciudad" name="ciudad" placeholder="Madrid" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="residencia_provincia">Provincia</label>
                            <input type="text" id="residencia_provincia" name="provincia" placeholder="Madrid" maxlength="100">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="residencia_telefono">Teléfono</label>
                            <input type="text" id="residencia_telefono" name="telefono" placeholder="612345678" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="residencia_email">Email</label>
                            <input type="email" id="residencia_email" name="email" placeholder="contacto@residencia.es" maxlength="255">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="residencia_web">Web</label>
                        <input type="url" id="residencia_web" name="web" placeholder="https://www.residencia.es" maxlength="255">
                    </div>
                    <div class="form-group">
                        <label for="residencia_observaciones">Observaciones</label>
                        <textarea id="residencia_observaciones" name="observaciones" placeholder="Notas adicionales sobre la residencia" rows="3" maxlength="1000"></textarea>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="residencia_activa" name="activa" checked style="width: auto; margin-right: 8px;"> Residencia Activa
                        </label>
                    </div>
                </div>
                
                <div class="form-section" id="residenciaEntidadesFiscalesSection" style="display: none;">
                    <h3>Entidades Fiscales (Sociedades)</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        Las entidades fiscales son las sociedades que gestionan esta residencia. Puede haber más de una.
                    </p>
                    <div id="residenciaReceiversList" style="margin-bottom: 15px;">
                        <!-- Lista de receivers asociados se cargará aquí -->
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 15px;">
                        <button type="button" onclick="nuevaEntidadFiscal()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; white-space: nowrap;">
                            + Nueva Entidad
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveResidenciaBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalResidencia')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Nueva Entidad Fiscal -->
    <div id="modalEntidadFiscal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Nueva Entidad Fiscal</h2>
                <button class="close-modal" onclick="closeModal('modalEntidadFiscal')">&times;</button>
            </div>
            <form id="formEntidadFiscal" onsubmit="saveEntidadFiscal(event)">
                <!-- SECCIÓN: Información Básica -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Información" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Básica</h3>
                    <div class="form-group">
                        <label for="entidad_nombre">Nombre / Razón Social *</label>
                        <input type="text" id="entidad_nombre" name="nombre" required placeholder="Ej: Sociedad Gestora Violetas SL" maxlength="255">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="entidad_nif_cif">NIF / CIF</label>
                        <input type="text" id="entidad_nif_cif" name="nif_cif" placeholder="A12345678 o B12345678" maxlength="50">
                    </div>
                </div>
                
                <!-- SECCIÓN: Información de Contacto -->
                <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/phone.svg" alt="Contacto" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Contacto</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="entidad_telefono">Teléfono</label>
                            <input type="tel" id="entidad_telefono" name="telefono" placeholder="666 555 444" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="entidad_email">Email</label>
                            <input type="email" id="entidad_email" name="email" placeholder="contacto@entidad.com" maxlength="255">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="entidad_direccion">Dirección</label>
                            <input type="text" id="entidad_direccion" name="direccion" placeholder="Calle, número, ciudad">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="entidad_cuenta_bancaria">Cuenta Bancaria (IBAN)</label>
                            <input type="text" id="entidad_cuenta_bancaria" name="cuenta_bancaria" placeholder="ES91 2100 0418 4502 0005 1332" maxlength="34">
                        </div>
                    </div>
                </div>
                
                <div id="modalEntidadFiscalAlert" class="alert" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveEntidadFiscalBtn" style="flex: 1;">Guardar</button>
                    <button type="button" onclick="closeModal('modalEntidadFiscal')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Mi Cuenta -->
    <div id="modalMiCuenta" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <img src="/static/icons/medical/user-medical.svg" alt="Mi Cuenta" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Mi Cuenta
                </h2>
                <button class="close-modal" onclick="closeModal('modalMiCuenta')">&times;</button>
            </div>
            <form id="formMiCuenta" onsubmit="saveMiCuenta(event)">
                <div id="miCuentaAlert" class="alert" style="display: none;"></div>
                
                <div class="form-section">
                    <h3>Información Personal</h3>
                    <div class="form-group">
                        <label for="micuenta_nombre">Nombre</label>
                        <input type="text" id="micuenta_nombre" name="nombre" placeholder="Tu nombre">
                    </div>
                    <div class="form-group">
                        <label for="micuenta_apellido">Apellido</label>
                        <input type="text" id="micuenta_apellido" name="apellido" placeholder="Tu apellido">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Cambiar Contraseña</h3>
                    <div class="form-group">
                        <label for="micuenta_password">Nueva Contraseña</label>
                        <input type="password" id="micuenta_password" name="password" placeholder="Mínimo 6 caracteres">
                        <small style="color: #666; font-size: 12px;">Dejar vacío para no cambiar</small>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="saveMiCuentaBtn" style="flex: 1;">Guardar Cambios</button>
                    <button type="button" onclick="closeModal('modalMiCuenta')" style="flex: 1; background: #6c757d;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        
        // Función para formatear números en formato español (sin decimales, con separador de miles)
        function formatearNumeroEspanol(numero) {
            if (numero === null || numero === undefined || isNaN(numero)) {
                return '0,00';
            }
            // Formatear con 2 decimales y separador de miles
            const numeroFloat = parseFloat(numero);
            return numeroFloat.toLocaleString('es-ES', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        }
        let currentToken = null;
        
        // Función helper para insertar iconos SVG inline
        function getIconSVG(iconName, size = 20, color = 'currentColor') {
            const icons = {
                'hospital': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M3 21h18"/><path d="M5 21V7l8-4v18"/><path d="M19 21V11l-6-4"/><line x1="9" y1="9" x2="9" y2="9.01"/><line x1="9" y1="12" x2="9" y2="12.01"/><line x1="9" y1="15" x2="9" y2="15.01"/><line x1="9" y1="18" x2="9" y2="18.01"/></svg>`,
                'user': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
                'users': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
                'user-medical': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 11v6"/><path d="M19 14h6"/></svg>`,
                'money': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
                'clipboard': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><rect x="9" y="2" width="6" height="4" rx="1"/><path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"/><path d="M12 11h4"/><path d="M12 15h4"/><path d="M14 13v4"/></svg>`,
                'plus': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
                'check': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
                'alert': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
                'activity': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
                'package': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>`,
                'file': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
                'settings': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
                'log-out': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: ${size}px; height: ${size}px; display: inline-block; vertical-align: middle;"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`
            };
            return icons[iconName] || '';
        }

        // Verificar si hay token guardado
        window.addEventListener('DOMContentLoaded', () => {
            // La limpieza de credenciales ya se hizo en el script inline del <head>
            // Verificar una vez más y mostrar advertencia si es necesario
            try {
                var search = window.location.search || '';
                if (search.indexOf('email=') >= 0 || search.indexOf('password=') >= 0) {
                    console.warn('⚠️ ADVERTENCIA DE SEGURIDAD: Las credenciales nunca deben estar en la URL. Usa el formulario de login.');
                    // Intentar limpiar de nuevo por si acaso
                    var params = new URLSearchParams(search);
                    params.delete('email');
                    params.delete('password');
                    var newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '') + (window.location.hash || '');
                    window.history.replaceState(null, '', newUrl);
                }
            } catch (e) {
                // Ignorar errores silenciosamente
            }
            
            const savedToken = localStorage.getItem('violetas_token');
            if (savedToken) {
                verifyToken(savedToken);
            }
        });

        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const alert = document.getElementById('alert');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando sesión...';
            hideAlert();

            try {
                const response = await fetch(`${API_URL}/api/v1/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentToken = data.token;
                    localStorage.setItem('violetas_token', currentToken);
                    showSuccess('¡Login exitoso!');
                    showDashboard(currentToken);
                } else {
                    showError(data.error || 'Error al iniciar sesión');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Iniciar Sesión';
                }
            } catch (error) {
                showError('Error de conexión. Verifica que el servidor esté corriendo.');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
            }
        });

        async function verifyToken(token) {
            try {
                // Decodificar el token (sin verificar, solo para mostrar info)
                const payload = JSON.parse(atob(token.split('.')[1]));
                
                // Mostrar dashboard
                await showDashboard(token);
                
                // Actualizar información del usuario en el menú
                const userMenuInfo = document.getElementById('userMenuInfo');
                if (userMenuInfo) {
                    userMenuInfo.innerHTML = `
                        <div class="user-menu-info-item"><strong>ID Usuario:</strong> ${payload.id_usuario}</div>
                        <div class="user-menu-info-item"><strong>Rol ID:</strong> ${payload.id_rol}</div>
                        <div class="user-menu-info-item"><strong>Residencia ID:</strong> ${payload.id_residencia || 'N/A'}</div>
                        <div class="user-menu-info-item"><strong>Expira:</strong> ${new Date(payload.exp * 1000).toLocaleString('es-ES')}</div>
                    `;
                }
                
                // Ocultar la sección userInfo antigua
                document.getElementById('userInfo').style.display = 'none';
            } catch (error) {
                console.error('Error al verificar token:', error);
                logout();
            }
        }
        
        // Variable global para almacenar permisos del usuario
        let usuarioActual = null;

        // ============================================
        // FUNCIONES HELPER PARA BOTONES CON PERMISOS
        // ============================================
        
        /**
         * Genera un botón solo si el usuario tiene el permiso requerido
         * @param {string} permiso - Nombre del permiso (ej: 'crear:cobro')
         * @param {object} config - Configuración del botón
         * @returns {string} HTML del botón o string vacío
         */
        function botonSiPermiso(permiso, config) {
            if (!usuarioTienePermiso(permiso)) return '';
            
            const {
                texto = '',
                onclick = '',
                id = '',
                estilo = '',
                clase = 'add-btn',
                icono = null
            } = config;
            
            const idAttr = id ? `id="${id}"` : '';
            const onclickAttr = onclick ? `onclick="${onclick}"` : '';
            const estiloAttr = estilo ? `style="${estilo}"` : '';
            
            let contenido = texto;
            if (icono) {
                contenido = `${icono} ${texto}`;
            }
            
            return `<button ${idAttr} ${onclickAttr} class="${clase}" ${estiloAttr}>${contenido}</button>`;
        }

        /**
         * Genera un botón con ID dinámico (ej: onclick con parámetros)
         * @param {string} permiso - Nombre del permiso
         * @param {object} config - Configuración del botón
         * @param {number|string} id - ID del elemento para onclick
         * @returns {string} HTML del botón o string vacío
         */
        function botonConIdSiPermiso(permiso, config, ...params) {
            if (!usuarioTienePermiso(permiso)) return '';
            
            const {
                texto = '',
                funcionOnclick = '',
                idBtn = '',
                estilo = '',
                clase = '',
                icono = null
            } = config;
            
            const idAttr = idBtn ? `id="${idBtn}"` : '';
            const paramsStr = params.join(', ');
            const onclickAttr = funcionOnclick ? `onclick="${funcionOnclick}(${paramsStr})"` : '';
            const estiloAttr = estilo ? `style="${estilo}"` : '';
            const claseAttr = clase ? `class="${clase}"` : '';
            
            let contenido = texto;
            if (icono) {
                contenido = icono + ' ' + texto;
            }
            
            return '<button ' + idAttr + ' ' + onclickAttr + ' ' + claseAttr + ' ' + estiloAttr + '>' + contenido + '</button>';
        }
        
        async function cargarNombreUsuario(token) {
            try {
                const response = await fetch(`${API_URL}/api/v1/usuarios/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    usuarioActual = await response.json();
                    const userNameText = document.getElementById('userNameText');
                    if (userNameText) {
                        // Mostrar nombre completo o solo nombre si no hay apellido
                        const nombreCompleto = usuarioActual.nombre || '';
                        const apellido = usuarioActual.apellido || '';
                        const nombreMostrar = nombreCompleto + (apellido ? ` ${apellido}` : '');
                        userNameText.textContent = nombreMostrar || usuarioActual.email || 'Usuario';
                    }
                } else {
                    console.error('Error al cargar información del usuario');
                    usuarioActual = null;
                    const userNameText = document.getElementById('userNameText');
                    if (userNameText) {
                        userNameText.textContent = 'Usuario';
                    }
                }
            } catch (error) {
                console.error('Error al cargar nombre del usuario:', error);
                usuarioActual = null;
                const userNameText = document.getElementById('userNameText');
                if (userNameText) {
                    userNameText.textContent = 'Usuario';
                }
            }
        }

        // Función helper para verificar si el usuario tiene un permiso
        function usuarioTienePermiso(nombrePermiso) {
            // Administrador tiene acceso a todo
            if (usuarioActual && usuarioActual.id_rol === 2) {
                return true;
            }
            // Verificar en permisos individuales
            if (usuarioActual && usuarioActual.permisos && Array.isArray(usuarioActual.permisos)) {
                return usuarioActual.permisos.includes(nombrePermiso);
            }
            return false;
        }

        async function showDashboard(token) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('loginHeader').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('dashboardHeader').style.display = 'flex';
            // tokenValue solo existe cuando se muestra el módulo de token, así que verificamos primero
            const tokenValueEl = document.getElementById('tokenValue');
            if (tokenValueEl) {
                tokenValueEl.textContent = token;
            }
            // tokenDisplay no existe en el HTML inicial, solo se crea dinámicamente
            // No intentamos acceder a él aquí para evitar errores
            
            // Cargar información del usuario para mostrar su nombre y permisos
            await cargarNombreUsuario(token);
            
            // Mostrar/ocultar módulos según permisos del usuario
            actualizarVisibilidadModulos();
        }

        // Función para mostrar/ocultar módulos según permisos del usuario
        function actualizarVisibilidadModulos() {
            // Mapeo de módulos a permisos de lectura necesarios
            const modulosPermisos = {
                'residentes': 'leer:residente',
                'facturacion': ['leer:cobro', 'leer:pago_proveedor'],  // Acceso si tiene cualquiera
                'personal': 'leer:personal',
                'documentacion': 'leer:documento',
                'historicos': 'leer:registro_asistencial',
                'configuracion': ['leer:usuario', 'leer:residencia']  // Configuración requiere permisos específicos
            };

            // Botones de módulos
            const botonesModulos = {
                'residentes': document.querySelector('.module-btn-residentes'),
                'facturacion': document.querySelector('.module-btn-facturacion'),
                'personal': document.querySelector('.module-btn-personal'),
                'documentacion': document.querySelector('.module-btn-documentacion'),
                'historicos': document.querySelector('.module-btn-historicos'),
                'configuracion': document.getElementById('configuracionBtn')
            };

            // Verificar y mostrar/ocultar cada módulo
            for (const [modulo, permisoRequerido] of Object.entries(modulosPermisos)) {
                const boton = botonesModulos[modulo];
                if (!boton) continue;

                let tieneAcceso = false;
                
                if (Array.isArray(permisoRequerido)) {
                    // Si es array, el usuario necesita al menos uno de los permisos
                    tieneAcceso = permisoRequerido.some(perm => usuarioTienePermiso(perm));
                } else {
                    // Si es string, necesita ese permiso específico
                    tieneAcceso = usuarioTienePermiso(permisoRequerido);
                }

                // Mostrar u ocultar el botón
                boton.style.display = tieneAcceso ? 'block' : 'none';
            }
        }

        function logout() {
            localStorage.removeItem('violetas_token');
            currentToken = null;
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('loginHeader').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('dashboardHeader').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            hideAlert();
            closeUserMenu();
        }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('show');
        }

        function closeUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.remove('show');
        }

        async function showConfiguracion() {
            closeUserMenu();
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            if (!token) {
                content.innerHTML = '<div class="module-content"><p style="color: red;">No hay sesión activa. Por favor, inicia sesión.</p></div>';
                return;
            }
            
            // Obtener información del usuario actual
            let usuarioActual = null;
            let esAdmin = false;
            
            try {
                console.log('Obteniendo información del usuario con token:', token ? token.substring(0, 20) + '...' : 'NO TOKEN');
                const response = await fetch(`${API_URL}/api/v1/usuarios/me`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Respuesta del servidor:', response.status, response.statusText);
                
                if (response.ok) {
                    usuarioActual = await response.json();
                    esAdmin = usuarioActual.id_rol === 2; // Administrador (id_rol=2)
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Error desconocido' }));
                    console.error('Error al obtener usuario:', errorData);
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error al obtener información del usuario: ${errorData.error || 'Error desconocido'}</p></div>`;
                    return;
                }
            } catch (error) {
                console.error('Error al obtener información del usuario:', error);
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexión: ${error.message}</p></div>`;
                return;
            }
            
            content.innerHTML = `
                <div class="module-content">
                    <h2 style="color: #667eea; margin-bottom: 30px; display: flex; align-items: center; gap: 10px;">
                        <img src="/static/icons/medical/settings.svg" alt="Configuración" style="width: 32px; height: 32px;"> Configuración
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: ${esAdmin ? '1fr 1fr 1fr' : '1fr'}; gap: 30px; margin-bottom: 30px;">
                        ${esAdmin ? `
                        <div style="background: #f7fafc; padding: 25px; border-radius: 15px; border: 2px solid #e0e0e0;">
                            <h3 style="color: #667eea; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <img src="/static/icons/medical/users.svg" alt="Usuarios" style="width: 24px; height: 24px;"> Gestión de Usuarios
                            </h3>
                            <p style="color: #666; margin-bottom: 20px;">Administra los usuarios del sistema, sus roles y permisos.</p>
                            <button class="add-btn" onclick="loadUsuarios()" style="width: 100%; padding: 12px; font-size: 16px;">
                                <img src="/static/icons/medical/users.svg" alt="Usuarios" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px; filter: brightness(0) invert(1);"> Ver Usuarios
                            </button>
                        </div>
                        <div style="background: #f7fafc; padding: 25px; border-radius: 15px; border: 2px solid #e0e0e0;">
                            <h3 style="color: #667eea; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <img src="/static/icons/medical/hospital.svg" alt="Residencias" style="width: 24px; height: 24px;"> Gestión de Residencias
                            </h3>
                            <p style="color: #666; margin-bottom: 20px;">Administra las residencias del sistema, crea nuevas o edita existentes.</p>
                            <button class="add-btn" onclick="loadResidencias()" style="width: 100%; padding: 12px; font-size: 16px;">
                                <img src="/static/icons/medical/hospital.svg" alt="Residencias" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px; filter: brightness(0) invert(1);"> Ver Residencias
                            </button>
                        </div>
                        ` : ''}
                        
                        <div style="background: #f7fafc; padding: 25px; border-radius: 15px; border: 2px solid #e0e0e0;">
                            <h3 style="color: #667eea; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <img src="/static/icons/medical/user-medical.svg" alt="Mi Cuenta" style="width: 24px; height: 24px;"> Mi Cuenta
                            </h3>
                            <p style="color: #666; margin-bottom: 20px;">Edita tu información personal y cambia tu contraseña.</p>
                            <button class="add-btn" onclick="editarMiCuenta()" style="width: 100%; padding: 12px; font-size: 16px;">
                                <img src="/static/icons/medical/settings.svg" alt="Editar" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px; filter: brightness(0) invert(1);"> Editar Mi Cuenta
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Cerrar el menú al hacer clic fuera
        document.addEventListener('click', function(event) {
            const menuContainer = document.querySelector('.user-menu-container');
            const menu = document.getElementById('userMenu');
            if (menuContainer && !menuContainer.contains(event.target) && menu.classList.contains('show')) {
                closeUserMenu();
            }
        });

        // Función eliminada - módulo Token JWT ya no se usa
        /*
        function copyToken() {
            const tokenValue = document.getElementById('tokenValue').textContent;
            navigator.clipboard.writeText(tokenValue).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '¡Copiado!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
        */

        function showError(message) {
            const alert = document.getElementById('alert');
            alert.className = 'alert error';
            alert.textContent = message;
            alert.style.display = 'block';
        }

        function showSuccess(message) {
            const alert = document.getElementById('alert');
            alert.className = 'alert success';
            alert.textContent = message;
            alert.style.display = 'block';
        }

        function hideAlert() {
            document.getElementById('alert').style.display = 'none';
        }

        function showModule(module) {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            // Limpiar parámetros de URL al cambiar de módulo
            // Solo mantener parámetros si vamos a históricos o documentación (ellos los manejan)
            if (module === 'historicos') {
                // Los históricos manejan sus propios parámetros (tipo, estado, etc.)
                // No limpiar aquí, loadHistoricos los manejará
            } else if (module === 'documentacion') {
                // La documentación maneja sus propios parámetros (tipo_entidad, categoria, etc.)
                // Limpiar solo parámetros que no son de documentación
                const urlParams = new URLSearchParams(window.location.search);
                const paramsToKeep = ['tipo_entidad', 'categoria', 'id_residencia'];
                const newParams = new URLSearchParams();
                urlParams.forEach((value, key) => {
                    if (paramsToKeep.includes(key)) {
                        newParams.append(key, value);
                    }
                });
                window.history.pushState({}, '', newParams.toString() ? `?${newParams.toString()}` : window.location.pathname);
            } else {
                // Para otros módulos (residentes, facturación, personal), limpiar completamente la URL
                window.history.pushState({}, '', window.location.pathname);
            }
            
            if (module === 'residentes') {
                loadResidentes();
            } else if (module === 'facturacion') {
                loadFacturacion();
            } else if (module === 'personal') {
                loadPersonal();
            } else if (module === 'documentacion') {
                loadDocumentacion();
            } else if (module === 'historicos') {
                loadHistoricos();
            }
        }

        async function loadResidentes() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando residentes...</p>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON:', text);
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${response.status}</p></div>`;
                    return;
                }
                
                if (response.ok) {
                    // Cargar residencias desde la API para obtener nombres reales
                    let residenciasMap = {};
                    try {
                        const residenciasResponse = await fetch(`${API_URL}/api/v1/residencias`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (residenciasResponse.ok) {
                            const residenciasData = await residenciasResponse.json();
                            residenciasData.residencias.forEach(res => {
                                residenciasMap[res.id_residencia] = res.nombre;
                            });
                        }
                    } catch (error) {
                        console.error('Error al cargar residencias:', error);
                        // Fallback a nombres por defecto
                        residenciasMap[1] = 'Violetas 1';
                        residenciasMap[2] = 'Violetas 2';
                    }
                    
                    // Separar residentes activos e inactivos
                    const residentesActivos = (data.residentes || []).filter(r => r.activo);
                    const residentesInactivos = (data.residentes || []).filter(r => !r.activo);
                    
                    // Agrupar residentes activos por residencia usando nombres reales
                    const residentesPorResidencia = {};
                    residentesActivos.forEach(res => {
                        const residenciaId = res.id_residencia;
                        if (!residentesPorResidencia[residenciaId]) {
                            residentesPorResidencia[residenciaId] = [];
                        }
                        residentesPorResidencia[residenciaId].push(res);
                    });
                    
                    // Verificar permisos para mostrar botón de agregar
                    const puedeCrear = usuarioTienePermiso('crear:residente');
                    
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 15px;"><img src="/static/icons/medical/users.svg" alt="Residentes" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Residentes Activos (${residentesActivos.length})</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 200px;">
                                    <input type="text" id="filtroBusquedaResidentes" placeholder="Buscar por nombre, habitación, contacto..." oninput="aplicarBusquedaResidentes()" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; width: 100%;">
                                </div>
                                ${puedeCrear ? `<button class="add-btn" onclick="openModal('modalResidente')" style="display: inline-flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap;"><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 16px; height: 16px; filter: brightness(0) invert(1);"> Agregar Residente</button>` : ''}
                            </div>
                    `;
                    
                    // Colores para diferentes residencias
                    const coloresResidencias = {
                        1: '#667eea',
                        2: '#48bb78'
                    };
                    
                    // Mostrar todas las residencias con sus nombres reales
                    Object.keys(residentesPorResidencia).sort((a, b) => parseInt(a) - parseInt(b)).forEach(residenciaId => {
                        const residentesResidencia = residentesPorResidencia[residenciaId];
                        const nombreResidencia = residenciasMap[residenciaId] || residentesResidencia[0]?.nombre_residencia || `Residencia ${residenciaId}`;
                        const color = coloresResidencias[residenciaId] || '#718096';
                        
                        html += `
                            <div class="residencia-residentes-container" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid ${color};">
                                <h4 style="color: ${color}; margin-bottom: 15px; font-size: 18px; font-weight: 600;">${nombreResidencia} (${residentesResidencia.length})</h4>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Habitación</th>
                                            <th>Nombre</th>
                                            <th>Contacto de Emergencia</th>
                                            <th>Teléfono de Emergencia</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        residentesResidencia.forEach(res => {
                            html += `
                                <tr style="cursor: pointer;" onclick="viewResidente(${res.id_residente})">
                                    <td data-label="Habitación">${res.habitacion || '-'}</td>
                                    <td data-label="Nombre">${res.nombre} ${res.apellido}</td>
                                    <td data-label="Contacto de Emergencia">${res.contacto_emergencia || '-'}</td>
                                    <td data-label="Teléfono de Emergencia">${res.telefono_emergencia || '-'}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: white; font-weight: 600;">
                                            <td colspan="4" style="padding: 10px; text-align: right; color: ${color}; border-top: 2px solid #e0e0e0;">
                                                Total: ${residentesResidencia.length}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        `;
                    });
                    
                    if (residentesActivos.length === 0) {
                        html += '<p style="margin-top: 20px;">No hay residentes activos registrados.</p>';
                    }
                    
                    // Lista de residentes inactivos (usuarios de baja)
                    if (residentesInactivos.length > 0) {
                        // Agrupar residentes inactivos por residencia
                        const inactivosPorResidencia = {};
                        residentesInactivos.forEach(res => {
                            const residenciaId = res.id_residencia;
                            if (!inactivosPorResidencia[residenciaId]) {
                                inactivosPorResidencia[residenciaId] = [];
                            }
                            inactivosPorResidencia[residenciaId].push(res);
                        });
                        
                        html += `
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                                <h3 style="color: #dc3545; margin-bottom: 20px;"><img src="/static/icons/medical/user-x.svg" alt="Bajas" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Usuarios de Baja (${residentesInactivos.length})</h3>
                        `;
                        
                        // Mostrar todas las residencias inactivas con sus nombres reales
                        Object.keys(inactivosPorResidencia).sort((a, b) => parseInt(a) - parseInt(b)).forEach(residenciaId => {
                            const residentesResidencia = inactivosPorResidencia[residenciaId];
                            const nombreResidencia = residenciasMap[residenciaId] || residentesResidencia[0]?.nombre_residencia || `Residencia ${residenciaId}`;
                            
                            html += `
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Habitación</th>
                                                <th>Nombre</th>
                                                <th>Motivo de Baja</th>
                                                <th>Fecha de Baja</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            residentesResidencia.forEach(res => {
                                const fechaBaja = res.fecha_baja ? fechaISOToEspanol(res.fecha_baja) : '-';
                                const motivoBaja = res.motivo_baja || '-';
                                html += `
                                    <tr style="cursor: pointer;" onclick="viewResidente(${res.id_residente})">
                                        <td data-label="Habitación">${res.habitacion || '-'}</td>
                                        <td data-label="Nombre">${res.nombre} ${res.apellido}</td>
                                        <td data-label="Motivo de Baja">${motivoBaja}</td>
                                        <td data-label="Fecha de Baja">${fechaBaja}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: white; font-weight: 600;">
                                                <td colspan="4" style="padding: 10px; text-align: right; color: #dc3545; border-top: 2px solid #e0e0e0;">
                                                    Total: ${residentesResidencia.length}
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                    
                    // Calcular totales para el resumen
                    const totalResidentes = residentesActivos.length + residentesInactivos.length;
                    
                    // Construir resumen por residencia
                    let resumenHtml = '';
                    Object.keys(residentesPorResidencia).sort((a, b) => parseInt(a) - parseInt(b)).forEach(residenciaId => {
                        const nombreResidencia = residenciasMap[residenciaId] || `Residencia ${residenciaId}`;
                        const cantidad = residentesPorResidencia[residenciaId].length;
                        resumenHtml += `
                            <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${cantidad}</div>
                                <div style="font-size: 13px; opacity: 0.9;">${nombreResidencia} Activos</div>
                            </div>
                        `;
                    });
                    
                    html += `
                        <div style="margin-top: 40px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                            <h3 style="color: white; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/users.svg" alt="Total" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; filter: brightness(0) invert(1);"> Resumen Total</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                                ${resumenHtml}
                                <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${residentesInactivos.length}</div>
                                    <div style="font-size: 13px; opacity: 0.9;">Usuarios de Baja</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.3); padding: 15px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.5);">
                                    <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${totalResidentes}</div>
                                    <div style="font-size: 14px; opacity: 0.9; font-weight: 600;">Total de Residentes</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        content.innerHTML = `<div class="module-content"><p style="color: red;">Error: Sesión expirada. Por favor, <a href="javascript:location.reload()">recarga la página</a> para iniciar sesión nuevamente.</p></div>`;
                        localStorage.removeItem('violetas_token');
                    } else {
                        content.innerHTML = `<div class="module-content"><p style="color: red;">Error (${response.status}): ${data.error || 'Error desconocido'}</p></div>`;
                    }
                    console.error('Error al cargar residentes:', response.status, data);
                }
            } catch (error) {
                console.error('Error de conexión al cargar residentes:', error);
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexión: ${error.message}. Verifica que el servidor esté corriendo.</p></div>`;
            }
        }

        async function loadFacturacion() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando facturación...</p>
                    </div>
                </div>
            `;
            
            try {
                // Cargar cobros y pagos a proveedores
                let cobrosRes = await fetch(`${API_URL}/api/v1/facturacion/cobros`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const cobrosContentType = cobrosRes.headers.get('content-type');
                let cobrosData;
                
                if (cobrosContentType && cobrosContentType.includes('application/json')) {
                    cobrosData = await cobrosRes.json();
                } else {
                    const text = await cobrosRes.text();
                    console.error('Respuesta de cobros no es JSON:', text);
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${cobrosRes.status}</p></div>`;
                    return;
                }
                
                // NUEVA LÓGICA: Verificar si hay residentes que necesitan cobros previstos para el mes siguiente
                // El sistema ahora genera automáticamente solo el cobro del mes siguiente (no histórico)
                // Los cobros históricos se generan manualmente desde el módulo Históricos
                
                // Verificar si hay cobros previstos pendientes para el mes siguiente
                const mesSiguiente = new Date();
                mesSiguiente.setMonth(mesSiguiente.getMonth() + 1);
                const mesSiguienteStr = mesSiguiente.toISOString().slice(0, 7); // YYYY-MM
                
                const tieneCobrosPrevistos = cobrosRes.ok && cobrosData.cobros && cobrosData.cobros.length > 0 && 
                                            cobrosData.cobros.some(c => {
                                                const esPrevisto = c.es_cobro_previsto === true || 
                                                                  c.es_cobro_previsto === 'true' || 
                                                                  c.es_cobro_previsto === 'True' ||
                                                                  c.es_cobro_previsto === 1;
                                                if (!esPrevisto) return false;
                                                const estado = (c.estado || '').toLowerCase().trim();
                                                const esPendiente = estado === 'pendiente' || estado === '' || !c.estado;
                                                if (!esPendiente) return false;
                                                // Verificar que sea del mes siguiente
                                                const mesCobro = c.mes_pagado || (c.fecha_prevista ? c.fecha_prevista.slice(0, 7) : null);
                                                return mesCobro === mesSiguienteStr;
                                            });
                
                // Verificar si hay cobros con conceptos antiguos (para compatibilidad)
                const tieneConceptosAntiguos = cobrosData.cobros && cobrosData.cobros.some(c => {
                    const esPrevisto = c.es_cobro_previsto === true || 
                                      c.es_cobro_previsto === 'true' || 
                                      c.es_cobro_previsto === 'True' ||
                                      c.es_cobro_previsto === 1;
                    if (!esPrevisto) return false;
                    const estado = (c.estado || '').toLowerCase().trim();
                    const esPendiente = estado === 'pendiente' || estado === '' || !c.estado;
                    if (!esPendiente) return false;
                    // Verificar si tiene concepto antiguo
                    const concepto = (c.concepto || '').toLowerCase();
                    return concepto.includes('mensual habitación') || concepto.includes('pepe') || concepto.includes('maría');
                });
                
                // Generar cobros automáticamente si:
                // 1. No hay cobros previstos pendientes para el mes siguiente (residentes nuevos o sin cobros)
                // 2. Hay conceptos antiguos que necesitan actualizarse
                // La lógica del backend ahora genera solo el cobro del mes siguiente (no histórico)
                if (cobrosRes.ok && (!tieneCobrosPrevistos || tieneConceptosAntiguos)) {
                    try {
                        console.log('Generando cobros previstos automáticamente...');
                        const generarRes = await fetch(`${API_URL}/api/v1/facturacion/cobros/generar-previstos`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({})
                        });
                        
                        const generarContentType = generarRes.headers.get('content-type');
                        if (generarContentType && generarContentType.includes('application/json')) {
                        const generarData = await generarRes.json();
                        
                        if (generarRes.ok) {
                                console.log(`✅ Cobros generados: ${generarData.cobros_generados || 0}, eliminados: ${generarData.cobros_eliminados || 0}`);
                            // Recargar los cobros después de generarlos
                            cobrosRes = await fetch(`${API_URL}/api/v1/facturacion/cobros`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                                const reloadContentType = cobrosRes.headers.get('content-type');
                                if (reloadContentType && reloadContentType.includes('application/json')) {
                            cobrosData = await cobrosRes.json();
                                }
                        } else {
                            console.warn('⚠️ No se pudieron generar cobros previstos:', generarData.error || 'Error desconocido');
                            }
                        }
                    } catch (e) {
                        console.error('❌ Error al generar cobros previstos automáticamente:', e);
                    }
                }
                
                const proveedoresRes = await fetch(`${API_URL}/api/v1/facturacion/proveedores`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const proveedoresContentType = proveedoresRes.headers.get('content-type');
                let proveedoresData;
                
                if (proveedoresContentType && proveedoresContentType.includes('application/json')) {
                    proveedoresData = await proveedoresRes.json();
                } else {
                    const text = await proveedoresRes.text();
                    console.error('Respuesta de proveedores no es JSON:', text);
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${proveedoresRes.status}</p></div>`;
                    return;
                }
                
                if (cobrosRes.ok && proveedoresRes.ok) {
                    // NUEVA LÓGICA: El backend ahora devuelve solo el período cercano:
                    // - Todos los cobros pendientes
                    // - El último cobro completado de cada residente
                    // - Cobros completados del mes actual y mes anterior
                    // Todo lo demás va a Históricos
                    
                    // Usar estructura agrupada si está disponible
                    const cobrosAgrupados = cobrosData.cobros_agrupados || [];
                    
                    // Si no hay estructura agrupada, crear una desde la lista plana
                    let cobrosPorResidencia = {};
                    if (cobrosAgrupados.length === 0 && cobrosData.cobros) {
                        cobrosData.cobros.forEach(c => {
                            // Intentar obtener id_residencia del nombre o usar un valor por defecto
                            const nombreRes = c.nombre_residencia || '';
                            let idRes = null;
                            if (nombreRes.includes('Violetas 1') || nombreRes.includes('1')) {
                                idRes = 1;
                            } else if (nombreRes.includes('Violetas 2') || nombreRes.includes('2')) {
                                idRes = 2;
                            }
                            
                            if (idRes) {
                                if (!cobrosPorResidencia[idRes]) {
                                    cobrosPorResidencia[idRes] = {
                                        id_residencia: idRes,
                                        nombre_residencia: c.nombre_residencia || `Residencia ${idRes}`,
                                        cobros: []
                                    };
                                }
                                cobrosPorResidencia[idRes].cobros.push(c);
                            }
                        });
                    } else {
                        cobrosAgrupados.forEach(grupo => {
                            cobrosPorResidencia[grupo.id_residencia] = grupo;
                        });
                    }
                    
                    // Filtrar y agrupar cobros previstos y completados por residencia
                    // Nota: Estos son solo del período cercano (mes siguiente, mes actual, mes anterior)
                    const cobrosPrevistosPorResidencia = {};
                    const cobrosCompletadosPorResidencia = {};
                    
                    Object.keys(cobrosPorResidencia).forEach(idRes => {
                        const grupo = cobrosPorResidencia[idRes];
                        
                        // Filtrar previstos pendientes
                        const previstos = grupo.cobros.filter(c => {
                            const esPrevisto = c.es_cobro_previsto === true || 
                                              c.es_cobro_previsto === 'true' || 
                                              c.es_cobro_previsto === 'True' ||
                                              c.es_cobro_previsto === 1;
                            const estado = (c.estado || '').toLowerCase().trim();
                            const esPendiente = estado === 'pendiente' || estado === '' || !c.estado;
                            return esPrevisto && esPendiente;
                        });
                        
                        // Ordenar previstos por fecha más cercana a hoy (ascendente - más cercanos primero)
                        previstos.sort((a, b) => {
                            const fechaA = a.fecha_prevista ? new Date(a.fecha_prevista) : new Date('9999-12-31');
                            const fechaB = b.fecha_prevista ? new Date(b.fecha_prevista) : new Date('9999-12-31');
                            return fechaA - fechaB;
                        });
                        
                        // Filtrar completados
                        const completados = grupo.cobros.filter(c => {
                            const estado = (c.estado || '').toLowerCase().trim();
                            return estado === 'cobrado';
                        });
                        
                        // Ordenar completados por fecha de pago más cercana a hoy (descendente - más recientes primero)
                        completados.sort((a, b) => {
                            const fechaA = a.fecha_pago ? new Date(a.fecha_pago) : new Date('1970-01-01');
                            const fechaB = b.fecha_pago ? new Date(b.fecha_pago) : new Date('1970-01-01');
                            return fechaB - fechaA;
                        });
                        
                        if (previstos.length > 0) {
                            cobrosPrevistosPorResidencia[idRes] = {
                                ...grupo,
                                cobros: previstos
                            };
                        }
                        
                        if (completados.length > 0) {
                            cobrosCompletadosPorResidencia[idRes] = {
                                ...grupo,
                                cobros: completados
                            };
                        }
                    });
                    
                    // Calcular totales
                    const totalPrevistos = Object.values(cobrosPrevistosPorResidencia).reduce((sum, g) => sum + g.cobros.length, 0);
                    const totalCompletados = Object.values(cobrosCompletadosPorResidencia).reduce((sum, g) => sum + g.cobros.length, 0);
                    
                    // Lista plana para compatibilidad (mantener para debug)
                    const cobrosPrevistos = Object.values(cobrosPrevistosPorResidencia).flatMap(g => g.cobros);
                    
                    // Obtener últimos cobros completados (mensual y extra) de cada residente
                    let cobrosCompletados = [];
                    try {
                        const ultimosRes = await fetch(`${API_URL}/api/v1/facturacion/cobros/ultimos-completados`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const ultimosContentType = ultimosRes.headers.get('content-type');
                        if (ultimosContentType && ultimosContentType.includes('application/json')) {
                            const ultimosData = await ultimosRes.json();
                            if (ultimosRes.ok && ultimosData.cobros) {
                                cobrosCompletados = ultimosData.cobros;
                            }
                        }
                    } catch (e) {
                        console.error('Error al obtener últimos cobros completados:', e);
                    }
                    
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 20px;"><span style="font-size: 24px; vertical-align: middle; margin-right: 8px;">€</span> Facturación</h3>
                            
                            <div class="tabs-container">
                                <div class="tabs">
                                    <button class="tab active" onclick="switchFacturacionTab('cobros')"><img src="/static/icons/medical/bill.svg" alt="Cobros" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Cobros</button>
                                    <button class="tab" onclick="switchFacturacionTab('pagos')"><img src="/static/icons/medical/package.svg" alt="Pagos" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Pagos a Proveedores</button>
                                </div>
                                
                                <!-- Pestaña de Cobros -->
                                <div id="tabCobros" class="tab-content active">
                                    <div style="margin-bottom: 20px;">
                                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                            ${usuarioTienePermiso('crear:cobro') ? `<button class="add-btn" onclick="openModal('modalCobro')" style="padding: 8px 16px; font-size: 14px;">+ Agregar Cobro</button>` : ''}
                                        </div>
                                        <p style="font-size: 12px; color: #666; margin-top: -10px; margin-bottom: 15px; display: flex; align-items: center; gap: 6px;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#667eea"/><path d="M12 16v-4m0-4h.01" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
                                            <span><strong>Nota:</strong> Se muestran los cobros pendientes del mes siguiente y los cobros completados recientes. Para ver el historial completo, usa el módulo <strong>Históricos</strong>.</span>
                                        </p>
                                        
                                        <!-- Filtros de Cobros -->
                                        <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">Residencia</label>
                                                    <select id="filtroResidenciaCobros" onchange="aplicarFiltrosCobros()" style="width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                                        <option value="">Todas las residencias</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">Estado</label>
                                                    <select id="filtroEstadoCobros" onchange="aplicarFiltrosCobros()" style="width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                                        <option value="">Todos</option>
                                                        <option value="pendiente">Pendientes</option>
                                                        <option value="cobrado">Cobrados</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">Buscar</label>
                                                    <input type="text" id="filtroBusquedaCobros" placeholder="Buscar residente, concepto..." oninput="aplicarFiltrosCobros()" style="width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <h4 style="color: #667eea; margin: 0; margin-bottom: 15px; margin-top: 15px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Cobros" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Cobros Futuros (${totalPrevistos})</h4>
                                    </div>
                                    <div style="margin-bottom: 30px;">
                    `;
                    
                    if (totalPrevistos > 0) {
                        // Ordenar residencias por ID
                        const residenciasOrdenadas = Object.keys(cobrosPrevistosPorResidencia)
                            .map(id => parseInt(id))
                            .sort((a, b) => a - b);
                        
                        residenciasOrdenadas.forEach(idRes => {
                            const grupo = cobrosPrevistosPorResidencia[idRes];
                        html += `
                                <div style="margin-bottom: 30px;">
                                    <h5 style="color: #667eea; margin-bottom: 15px; padding: 10px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #667eea;">
                                        🏢 ${grupo.nombre_residencia} (${grupo.cobros.length} cobros pendientes)
                                    </h5>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Residente</th>
                                        <th>Monto</th>
                                                <th>Concepto</th>
                                                <th>Tipo Pago</th>
                                        <th>Fecha Prevista</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                            let totalGrupo = 0;
                            grupo.cobros.forEach(cobro => {
                            const fechaPrevista = cobro.fecha_prevista ? fechaISOToEspanol(cobro.fecha_prevista) : '-';
                                const concepto = cobro.concepto || '-';
                                const tipoPago = cobro.metodo_pago || '-';
                                totalGrupo += parseFloat(cobro.monto) || 0;
                                
                                // Verificar si la fecha prevista ya pasó (solo para pagos pendientes)
                                let fechaPrevistaStyle = 'color: #333;';
                                const estado = (cobro.estado || '').toLowerCase().trim();
                                const esPendiente = estado === 'pendiente' || estado === '' || !cobro.estado;
                                
                                if (esPendiente && cobro.fecha_prevista) {
                                    const fechaPrevistaDate = new Date(cobro.fecha_prevista);
                                    const hoy = new Date();
                                    hoy.setHours(0, 0, 0, 0);
                                    fechaPrevistaDate.setHours(0, 0, 0, 0);
                                    if (fechaPrevistaDate < hoy) {
                                        fechaPrevistaStyle = 'color: #dc3545; font-weight: 600;';
                                    }
                                }
                                
                            const puedeEditarCobro = usuarioTienePermiso('editar:cobro');
                            const puedeEliminarCobro = usuarioTienePermiso('eliminar:cobro');
                            html += `
                                    <tr data-tipo-cobro="previsto" data-estado="${(cobro.estado || 'pendiente').toLowerCase()}" data-residencia="${grupo.id_residencia}" data-busqueda="${(cobro.residente || '').toLowerCase()} ${(concepto || '').toLowerCase()}" style="cursor: ${puedeEditarCobro ? 'pointer' : 'default'};" ${puedeEditarCobro ? `onclick="editarCobro(${cobro.id_pago})" title="Haz clic para editar"` : 'title="Sin permisos para editar"'}>
                                    <td style="color: #333;">${cobro.residente}</td>
                                        <td style="color: #333;">${formatearNumeroEspanol(cobro.monto)} €</td>
                                        <td style="color: #333;">${concepto}</td>
                                        <td style="color: #333;">${tipoPago}</td>
                                    <td style="${fechaPrevistaStyle}">${fechaPrevista}</td>
                                    <td><span style="color: #ffc107; font-weight: 600;">Pendiente</span></td>
                                        <td onclick="event.stopPropagation();" style="display: flex; gap: 5px; align-items: center; justify-content: center;">
                                        ${puedeEditarCobro ? `<button onclick="cambiarEstadoCobro(${cobro.id_pago}, 'cobrado')" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Marcar como Cobrado</button>` : ''}
                                        ${puedeEliminarCobro ? `<button onclick="eliminarCobro(${cobro.id_pago})" style="padding: 0; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; line-height: 1; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;" title="Eliminar cobro previsto">×</button>` : ''}
                                    </td>
                                </tr>
                            `;
                        });
                        
                            html += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p style="color: #333;">No hay cobros previstos pendientes.</p>';
                    }
                    
                    html += `
                                    </div>
                                    
                                    <div style="margin-bottom: 30px;">
                                        <h4 style="color: #667eea; margin-bottom: 10px;"><img src="/static/icons/medical/check-circle.svg" alt="Completados" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Cobros Completados (${totalCompletados})</h4>
                    `;
                    
                    if (totalCompletados > 0) {
                        // Ordenar residencias por ID
                        const residenciasOrdenadas = Object.keys(cobrosCompletadosPorResidencia)
                            .map(id => parseInt(id))
                            .sort((a, b) => a - b);
                        
                        residenciasOrdenadas.forEach(idRes => {
                            const grupo = cobrosCompletadosPorResidencia[idRes];
                        html += `
                                <div style="margin-bottom: 30px;">
                                    <h5 style="color: #28a745; margin-bottom: 15px; padding: 10px; background: #f0fff4; border-radius: 8px; border-left: 4px solid #28a745;">
                                        🏢 ${grupo.nombre_residencia} (${grupo.cobros.length} cobros completados)
                                    </h5>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Residente</th>
                                        <th>Monto</th>
                                                <th>Concepto</th>
                                                <th>Tipo Pago</th>
                                        <th>Fecha Prevista</th>
                                        <th>Fecha de Pago</th>
                                        <th>Estado</th>
                                                <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                            let totalGrupo = 0;
                            grupo.cobros.forEach(cobro => {
                            const fechaPrevista = cobro.fecha_prevista ? fechaISOToEspanol(cobro.fecha_prevista) : '-';
                            const fechaPago = cobro.fecha_pago ? fechaISOToEspanol(cobro.fecha_pago) : '-';
                                const concepto = cobro.concepto || 'Pago mensual habitación';
                                const tipoPago = cobro.metodo_pago || '-';
                                totalGrupo += parseFloat(cobro.monto) || 0;
                                
                                // Verificar si la fecha prevista ya pasó (aunque esté cobrado, para referencia histórica)
                                // Verificar si la fecha prevista ya pasó (solo para pagos pendientes)
                                let fechaPrevistaStyle = 'color: #333;';
                                const estado = (cobro.estado || '').toLowerCase().trim();
                                const esPendiente = estado === 'pendiente' || estado === '' || !cobro.estado;
                                
                                if (esPendiente && cobro.fecha_prevista) {
                                    const fechaPrevistaDate = new Date(cobro.fecha_prevista);
                                    const hoy = new Date();
                                    hoy.setHours(0, 0, 0, 0);
                                    fechaPrevistaDate.setHours(0, 0, 0, 0);
                                    if (fechaPrevistaDate < hoy) {
                                        fechaPrevistaStyle = 'color: #dc3545; font-weight: 600;';
                                    }
                                }
                                
                            const puedeEditarCobroTabla = usuarioTienePermiso('editar:cobro');
                            html += `
                                <tr data-tipo-cobro="completado" data-estado="cobrado" data-residencia="${grupo.id_residencia}" data-busqueda="${(cobro.residente || '').toLowerCase()} ${(concepto || '').toLowerCase()}" style="cursor: ${puedeEditarCobroTabla ? 'pointer' : 'default'};" ${puedeEditarCobroTabla ? 'onclick="editarCobro(' + cobro.id_pago + ')" title="Haz clic para editar"' : 'title="Sin permisos para editar"'}>
                                    <td style="color: #333;">${cobro.residente}</td>
                                        <td style="color: #333;">${formatearNumeroEspanol(cobro.monto)} €</td>
                                        <td style="color: #333;">${concepto}</td>
                                        <td style="color: #333;">${tipoPago}</td>
                                    <td style="${fechaPrevistaStyle}">${fechaPrevista}</td>
                                    <td style="color: #333;">${fechaPago}</td>
                                        <td><span style="color: #28a745; font-weight: 600;">Cobrado</span></td>
                                        <td onclick="event.stopPropagation();">
                                            <button onclick="cambiarEstadoCobro(${cobro.id_pago}, 'pendiente')" style="padding: 4px 8px; background: #ffc107; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Revertir</button>
                                        </td>
                                </tr>
                            `;
                        });
                        
                            html += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p style="color: #333;">No hay cobros completados.</p>';
                    }
                    
                    html += `
                                    </div>
                                    
                                    <!-- Gráfico de Estimación Mensual e Histórico -->
                                    <div style="margin-bottom: 30px; margin-top: 30px;">
                                        <h4 style="color: #667eea; margin-bottom: 15px;"><img src="/static/icons/medical/activity.svg" alt="Gráfico" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Histórico de Cobros</h4>
                                        <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; height: 400px;">
                                            <canvas id="cobrosChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pestaña de Pagos a Proveedores -->
                                <div id="tabPagos" class="tab-content">
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: #667eea; margin: 0; margin-bottom: 15px;"><img src="/static/icons/medical/package.svg" alt="Proveedores" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Pagos a Proveedores (${proveedoresData.total || 0})</h4>
                                        
                                        <!-- Mensaje informativo -->
                                        <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px 15px; border-radius: 6px; margin-bottom: 15px;">
                                            <p style="margin: 0; color: #1565c0; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="currentColor"/>
                                                </svg>
                                                Mostrando pagos de <strong>este mes y el anterior</strong>. Para ver históricos completos, ve al módulo <strong>Históricos</strong>.
                                            </p>
                                        </div>
                                        
                                        <!-- Filtros de Pagos -->
                                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">Residencia</label>
                                                    <select id="filtroResidenciaPagos" onchange="aplicarFiltrosPagos()" style="width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                                        <option value="">Todas las residencias</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">Estado</label>
                                                    <select id="filtroEstadoPagos" onchange="aplicarFiltrosPagos()" style="width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                                        <option value="">Todos</option>
                                                        <option value="pendiente">Pendientes</option>
                                                        <option value="pagado">Pagados</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">Buscar</label>
                                                    <input type="text" id="filtroBusquedaPagos" placeholder="Buscar proveedor, concepto..." oninput="aplicarFiltrosPagos()" style="width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="botones-proveedores-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%;">
                                            ${usuarioTienePermiso('crear:pago_proveedor') ? `<button class="add-btn" onclick="openModalProveedor()" style="padding: 8px 16px; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%;">
                                                <img src="/static/icons/medical/file-medical.svg" alt="Factura" style="width: 16px; height: 16px; filter: brightness(0) invert(1);"> Factura Manual
                                            </button>` : ''}
                                            ${usuarioTienePermiso('crear:pago_proveedor') ? `<button class="add-btn" onclick="abrirModalProcesarFactura()" style="padding: 8px 16px; font-size: 14px; background: #667eea; display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: brightness(0) invert(1);">
                                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="currentColor"/>
                                                    <path d="M20 12l-3-3v2h-2v2h2v2l3-3z" fill="currentColor"/>
                                                </svg>
                                                <span>Procesar Factura</span>
                                            </button>` : ''}
                                            ${usuarioTienePermiso('leer:proveedor') ? `<button class="add-btn" onclick="abrirModalListaProveedores()" style="padding: 8px 16px; font-size: 14px; background: #17a2b8; display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%;">
                                                <img src="/static/icons/medical/package.svg" alt="Proveedores" style="width: 16px; height: 16px; filter: brightness(0) invert(1);"> Ver Proveedores
                                            </button>` : ''}
                                        </div>
                                    </div>
                    `;
                    
                    if (proveedoresData.pagos && proveedoresData.pagos.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Proveedor</th>
                                        <th>Concepto</th>
                                        <th>Monto</th>
                                        <th>Fecha Prevista</th>
                                        <th>Estado</th>
                                        <th>Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        let totalPagos = 0;
                        proveedoresData.pagos.forEach(pago => {
                            const estadoPago = (pago.estado || 'pendiente').toLowerCase();
                            const tipo = estadoPago === 'pagado' ? '<img src="/static/icons/medical/check-circle.svg" alt="Pagado" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"> Pagado' : '<img src="/static/icons/medical/alert-circle.svg" alt="Pendiente" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"> Pendiente';
                            const metodoPago = pago.metodo_pago || pago.tipo_pago || '-';
                            const monto = parseFloat(pago.monto || pago.monto_estimado || 0);
                            totalPagos += monto;
                            const puedeEditarPagoTabla = usuarioTienePermiso('editar:pago_proveedor');
                            html += `
                                <tr data-estado="${estadoPago}" data-residencia="${pago.id_residencia || ''}" data-busqueda="${(pago.proveedor || '').toLowerCase()} ${(pago.concepto || '').toLowerCase()}" style="cursor: ${puedeEditarPagoTabla ? 'pointer' : 'default'};" ${puedeEditarPagoTabla ? 'onclick="editarPagoProveedor(' + pago.id_pago + ')" title="Haz clic para editar"' : 'title="Sin permisos para editar"'}>
                                    <td>${pago.proveedor}</td>
                                    <td>${pago.concepto}</td>
                                    <td>${formatearNumeroEspanol(monto)} €</td>
                                    <td>${pago.fecha_prevista || pago.fecha_pago || '-'}</td>
                                    <td>${tipo}</td>
                                    <td>${metodoPago}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                </tbody>
                            </table>`;
                    } else {
                        html += '<p style="color: #333;">No hay pagos a proveedores registrados.</p>';
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                    content.innerHTML = html;
                    
                    // Llenar selects de residencias para filtros
                    setTimeout(async () => {
                        try {
                            const response = await fetch(`${API_URL}/api/v1/residencias`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                const selectCobros = document.getElementById('filtroResidenciaCobros');
                                const selectPagos = document.getElementById('filtroResidenciaPagos');
                                
                                if (selectCobros && data.residencias) {
                                    data.residencias.forEach(res => {
                                        selectCobros.innerHTML += `<option value="${res.id_residencia}">${res.nombre}</option>`;
                                    });
                                }
                                
                                if (selectPagos && data.residencias) {
                                    data.residencias.forEach(res => {
                                        selectPagos.innerHTML += `<option value="${res.id_residencia}">${res.nombre}</option>`;
                                    });
                                }
                            }
                        } catch (error) {
                            console.error('Error al cargar residencias para filtros:', error);
                        }
                    }, 100);
                    
                    // Cargar y mostrar gráfico de cobros
                    await loadCobrosChart();
                } else {
                    // Manejar errores específicos
                    let errorMsg = 'Error al cargar facturación.';
                    if (cobrosRes.status === 401 || proveedoresRes.status === 401) {
                        errorMsg = 'Sesión expirada. Por favor, <a href="javascript:location.reload()">recarga la página</a> para iniciar sesión nuevamente.';
                        localStorage.removeItem('violetas_token');
                    } else {
                        if (!cobrosRes.ok) {
                            errorMsg += ` Error al cargar cobros (${cobrosRes.status}): ${cobrosData?.error || 'Error desconocido'}.`;
                        }
                        if (!proveedoresRes.ok) {
                            errorMsg += ` Error al cargar proveedores (${proveedoresRes.status}): ${proveedoresData?.error || 'Error desconocido'}.`;
                        }
                    }
                    content.innerHTML = `<div class="module-content"><p style="color: red;">${errorMsg}</p></div>`;
                    console.error('Error al cargar facturación:', {
                        cobros: { status: cobrosRes.status, data: cobrosData },
                        proveedores: { status: proveedoresRes.status, data: proveedoresData }
                    });
                }
            } catch (error) {
                console.error('Error de conexión al cargar facturación:', error);
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexión: ${error.message}. Verifica que el servidor esté corriendo.</p></div>`;
            }
        }
        
        // Función eliminarCobro está definida más abajo (línea 3335) con confirmación y mejor manejo de errores
        
        async function cambiarEstadoCobro(idPago, nuevoEstado) {
            const token = localStorage.getItem('violetas_token');
            
            const mensaje = nuevoEstado === 'cobrado' 
                ? '¿Está seguro de marcar este cobro como cobrado?'
                : '¿Está seguro de revertir este cobro a pendiente?';
            
            if (!confirm(mensaje)) {
                return;
            }
            
            try {
                // Preparar datos para actualizar
                const data = {
                    estado: nuevoEstado
                };
                
                // Si se marca como cobrado, establecer la fecha de pago a hoy
                if (nuevoEstado === 'cobrado') {
                    const hoy = new Date();
                    const fechaHoy = hoy.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                    data.fecha_pago = fechaHoy;
                } else if (nuevoEstado === 'pendiente') {
                    // Si se revierte a pendiente, limpiar fecha de pago
                    data.fecha_pago = null;
                }
                
                const response = await fetch(`${API_URL}/api/v1/facturacion/cobros/${idPago}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Recargar la lista de cobros
                    await loadFacturacion();
                } else {
                    alert('Error: ' + (result.error || 'Error al actualizar el cobro'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }
        
        function aplicarFiltrosCobros() {
            const residencia = document.getElementById('filtroResidenciaCobros')?.value || '';
            const estado = document.getElementById('filtroEstadoCobros')?.value || '';
            const busqueda = document.getElementById('filtroBusquedaCobros')?.value?.toLowerCase() || '';
            
            // Filtrar filas de cobros en el cliente (sin recargar)
            const filas = document.querySelectorAll('#tabCobros tbody tr');
            let visibles = 0;
            
            filas.forEach(fila => {
                let mostrar = true;
                
                // Filtrar por residencia
                if (residencia && fila.dataset.residencia !== residencia) {
                    mostrar = false;
                }
                
                // Filtrar por estado
                if (estado && fila.dataset.estado !== estado) {
                    mostrar = false;
                }
                
                // Filtrar por búsqueda de texto
                if (busqueda && !fila.dataset.busqueda?.includes(busqueda)) {
                    mostrar = false;
                }
                
                // Mostrar/ocultar fila
                fila.style.display = mostrar ? '' : 'none';
                if (mostrar) visibles++;
            });
            
            // Ocultar bloques de residencia que queden vacíos (la "concha vacía")
            const tablas = document.querySelectorAll('#tabCobros .data-table');
            tablas.forEach(tabla => {
                const tbody = tabla.querySelector('tbody');
                if (tbody) {
                    // Contar filas visibles en esta tabla
                    const filasVisibles = Array.from(tbody.querySelectorAll('tr')).filter(fila => fila.style.display !== 'none').length;
                    
                    // Buscar el contenedor padre (el div con el h5 y la tabla)
                    const contenedorResidencia = tabla.closest('div[style*="margin-bottom: 30px"]');
                    if (contenedorResidencia) {
                        // Si no hay filas visibles, ocultar todo el bloque
                        contenedorResidencia.style.display = filasVisibles > 0 ? '' : 'none';
                    }
                }
            });
            
            // Mostrar mensaje si no hay resultados
            if (visibles === 0 && filas.length > 0) {
                const tabCobros = document.getElementById('tabCobros');
                let noResultados = tabCobros?.querySelector('.no-resultados-cobros');
                if (!noResultados) {
                    noResultados = document.createElement('div');
                    noResultados.className = 'no-resultados-cobros';
                    noResultados.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0;';
                    noResultados.innerHTML = '<p style="margin: 0; color: #856404; font-size: 16px;">No se encontraron cobros con los filtros seleccionados</p>';
                    tabCobros?.appendChild(noResultados);
                }
            } else {
                const noResultados = document.querySelector('.no-resultados-cobros');
                if (noResultados) noResultados.remove();
            }
        }
        
        function aplicarFiltrosPagos() {
            const residencia = document.getElementById('filtroResidenciaPagos')?.value || '';
            const estado = document.getElementById('filtroEstadoPagos')?.value || '';
            const busqueda = document.getElementById('filtroBusquedaPagos')?.value?.toLowerCase() || '';
            
            // Filtrar filas de pagos en el cliente (sin recargar)
            const filas = document.querySelectorAll('#tabPagos tbody tr');
            let visibles = 0;
            
            filas.forEach(fila => {
                let mostrar = true;
                
                // Filtrar por residencia
                if (residencia && fila.dataset.residencia !== residencia) {
                    mostrar = false;
                }
                
                // Filtrar por estado
                if (estado && fila.dataset.estado !== estado) {
                    mostrar = false;
                }
                
                // Filtrar por búsqueda de texto
                if (busqueda && !fila.dataset.busqueda?.includes(busqueda)) {
                    mostrar = false;
                }
                
                // Mostrar/ocultar fila
                fila.style.display = mostrar ? '' : 'none';
                if (mostrar) visibles++;
            });
            
            // Mostrar mensaje si no hay resultados
            if (visibles === 0 && filas.length > 0) {
                const tabPagos = document.getElementById('tabPagos');
                let noResultados = tabPagos?.querySelector('.no-resultados-pagos');
                if (!noResultados) {
                    noResultados = document.createElement('div');
                    noResultados.className = 'no-resultados-pagos';
                    noResultados.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0;';
                    noResultados.innerHTML = '<p style="margin: 0; color: #856404; font-size: 16px;">No se encontraron pagos con los filtros seleccionados</p>';
                    tabPagos?.appendChild(noResultados);
                }
            } else {
                const noResultados = document.querySelector('.no-resultados-pagos');
                if (noResultados) noResultados.remove();
            }
        }
        
        // Variables para flatpickr de cobros
        let flatpickrCobroPrevista = null;
        let flatpickrCobroPago = null;
        
        // Variables para flatpickr de pagos a proveedores
        let flatpickrPagoProveedorFechaPago = null;
        let flatpickrPagoProveedorFechaPrevista = null;
        
        async function loadResidentesForCobro(residenteSeleccionadoId = null) {
            const token = localStorage.getItem('violetas_token');
            const select = document.getElementById('cobro_id_residente');
            
            if (!select) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.residentes) {
                    select.innerHTML = '<option value="">Seleccione un residente</option>';
                    data.residentes.forEach(res => {
                        // Mostrar si está activo O si es el residente seleccionado (incluso si está inactivo)
                        if (res.activo || (residenteSeleccionadoId && res.id_residente == residenteSeleccionadoId)) {
                            const option = document.createElement('option');
                            option.value = res.id_residente;
                            option.textContent = `${res.nombre} ${res.apellido}${!res.activo ? ' (Inactivo)' : ''}`;
                            
                            // Marcar como seleccionado si coincide
                            if (residenteSeleccionadoId && res.id_residente == residenteSeleccionadoId) {
                                option.selected = true;
                            }
                            
                            select.appendChild(option);
                        }
                    });
                    
                    // Inicializar conceptos con servicios predefinidos
                    actualizarConceptosCobro([]);
                    
                    // Añadir event listener para cargar servicios extra cuando cambie el residente
                    select.addEventListener('change', function() {
                        const idResidente = this.value;
                        if (idResidente) {
                            cargarServiciosExtraResidente(idResidente);
                        } else {
                            actualizarConceptosCobro([]);
                        }
                    });
                    
                    // Si hay un residente seleccionado, cargar sus servicios extra
                    if (residenteSeleccionadoId) {
                        await cargarServiciosExtraResidente(residenteSeleccionadoId);
                    }
                } else {
                    select.innerHTML = '<option value="">Error al cargar residentes</option>';
                }
            } catch (error) {
                console.error('Error al cargar residentes:', error);
                select.innerHTML = '<option value="">Error al cargar residentes</option>';
            }
        }

        async function cargarServiciosExtraResidente(idResidente) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.residente) {
                    const serviciosExtra = data.residente.servicios_extra || '';
                    // Parsear servicios extra (pueden estar separados por comas)
                    const servicios = serviciosExtra.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    actualizarConceptosCobro(servicios);
                } else {
                    actualizarConceptosCobro([]);
                }
            } catch (error) {
                console.error('Error al cargar servicios extra del residente:', error);
                actualizarConceptosCobro([]);
            }
        }

        function actualizarConceptosCobro(serviciosExtra) {
            const selectConcepto = document.getElementById('cobro_concepto');
            if (!selectConcepto) return;
            
            // Guardar el valor actual si existe
            const valorActual = selectConcepto.value;
            
            // Limpiar opciones
            selectConcepto.innerHTML = '<option value="">Seleccione un concepto</option>';
            
            // Añadir opción básica
            selectConcepto.innerHTML += '<option value="Pago mensual habitación">Pago mensual habitación</option>';
            
            // Servicios extra predefinidos que siempre aparecen
            const serviciosPredefinidos = ['Peluquería', 'Podólogo', 'Fisio', 'Farmacia'];
            serviciosPredefinidos.forEach(servicio => {
                const option = document.createElement('option');
                option.value = servicio;
                option.textContent = servicio;
                selectConcepto.appendChild(option);
            });
            
            // Añadir servicios extra del residente (si no están ya en los predefinidos)
            if (serviciosExtra && serviciosExtra.length > 0) {
                serviciosExtra.forEach(servicio => {
                    // Solo añadir si no está ya en los predefinidos
                    if (!serviciosPredefinidos.includes(servicio)) {
                        const option = document.createElement('option');
                        option.value = servicio;
                        option.textContent = servicio;
                        selectConcepto.appendChild(option);
                    }
                });
            }
            
            // Añadir opción "Otros" al final
            selectConcepto.innerHTML += '<option value="otros">Otros</option>';
            
            // Restaurar el valor anterior si existe
            if (valorActual && Array.from(selectConcepto.options).some(opt => opt.value === valorActual)) {
                selectConcepto.value = valorActual;
            }
        }

        function actualizarCampoConceptoOtros() {
            const selectConcepto = document.getElementById('cobro_concepto');
            const campoOtros = document.getElementById('cobro_concepto_otros');
            
            if (!selectConcepto || !campoOtros) return;
            
            if (selectConcepto.value === 'otros') {
                campoOtros.style.display = 'block';
                campoOtros.required = true;
            } else {
                campoOtros.style.display = 'none';
                campoOtros.required = false;
                campoOtros.value = '';
            }
        }
        
        function initializeCobroDatePickers() {
            const fechaPrevistaInput = document.getElementById('cobro_fecha_prevista');
            const fechaPagoInput = document.getElementById('cobro_fecha_pago');
            
            // Destruir instancias anteriores
            if (flatpickrCobroPrevista) {
                flatpickrCobroPrevista.destroy();
            }
            if (flatpickrCobroPago) {
                flatpickrCobroPago.destroy();
            }
            
            // Verificar si estamos editando (hay id_pago)
            const idPagoOculto = document.getElementById('cobro_id_pago');
            const esEdicion = idPagoOculto && idPagoOculto.value;
            
            // Lógica simple: si hay fecha prevista, no puede haber fecha de pago y viceversa
            if (fechaPrevistaInput) {
                fechaPrevistaInput.addEventListener('change', function() {
                    if (this.value && fechaPagoInput) {
                        fechaPagoInput.value = ''; // Si se pone fecha prevista, se borra fecha de pago
                    }
                });
            }
            
            if (fechaPagoInput) {
                fechaPagoInput.addEventListener('change', function() {
                    if (this.value && fechaPrevistaInput) {
                        fechaPrevistaInput.value = ''; // Si se pone fecha de pago, se borra fecha prevista
                    }
                });
            }
        }
        
        async function saveCobro(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveCobroBtn');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            const id_residente = formData.get('id_residente');
            
            if (!id_residente) {
                showCobroModalError('Debe seleccionar un residente');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Obtener el concepto (del select o del campo "otros")
            let concepto = formData.get('concepto');
            if (concepto === 'otros') {
                const conceptoOtros = document.getElementById('cobro_concepto_otros').value.trim();
                if (!conceptoOtros) {
                    showCobroModalError('Debe escribir el concepto personalizado');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }
                concepto = conceptoOtros;
            }
            
            if (!concepto) {
                showCobroModalError('Debe seleccionar o escribir un concepto');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Obtener fechas (type="date" devuelve YYYY-MM-DD)
            const fecha_pago = formData.get('fecha_pago');
            const fecha_prevista = formData.get('fecha_prevista');
            
            // LÓGICA SIMPLE: Si hay fecha prevista → pago previsto. Si hay fecha pago → pago realizado
            const es_cobro_previsto = !!fecha_prevista && !fecha_pago;
            const estado = fecha_pago ? 'cobrado' : 'pendiente';
            
            // Calcular mes_pagado desde la fecha que tenga valor
            let mes_pagado = null;
            const fechaParaMes = fecha_pago || fecha_prevista;
            if (fechaParaMes) {
                const partes = fechaParaMes.split('-');
                if (partes.length === 3) {
                    mes_pagado = `${partes[0]}-${partes[1]}`; // YYYY-MM
                }
            }
            
            // Si el concepto es "Pago mensual habitación", generar el concepto basado en la fecha
            if (concepto === 'Pago mensual habitación' && fechaParaMes) {
                const mesesEspanol = {
                    1: 'enero', 2: 'febrero', 3: 'marzo', 4: 'abril',
                    5: 'mayo', 6: 'junio', 7: 'julio', 8: 'agosto',
                    9: 'septiembre', 10: 'octubre', 11: 'noviembre', 12: 'diciembre'
                };
                
                const partes = fechaParaMes.split('-');
                if (partes.length === 3) {
                    const año = parseInt(partes[0]);
                    const mes = parseInt(partes[1]);
                    const nombreMes = mesesEspanol[mes] || 'mes';
                    const añoCorto = año.toString().slice(-2);
                    concepto = `${nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1)} ${añoCorto}`;
                }
            }
            
            const data = {
                id_residente: parseInt(id_residente),
                monto: formData.get('monto') ? parseFloat(formData.get('monto')) : null,
                concepto: concepto,
                metodo_pago: formData.get('metodo_pago') || null,
                fecha_pago: fecha_pago || null,
                fecha_prevista: fecha_prevista || null,
                mes_pagado: mes_pagado,
                es_cobro_previsto: es_cobro_previsto,
                estado: estado,
                observaciones: formData.get('observaciones') || null
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideCobroModalAlert();
            
            try {
                const idPago = document.getElementById('cobro_id_pago').value;
                const url = idPago 
                    ? `${API_URL}/api/v1/facturacion/cobros/${idPago}`
                    : `${API_URL}/api/v1/facturacion/cobros`;
                const method = idPago ? 'PUT' : 'POST';
                
                console.log('Enviando cobro a:', url, 'Método:', method, 'Datos:', data);
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                let result;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        console.error('Respuesta no es JSON:', text);
                        throw new Error(`Error del servidor (${response.status}): ${text.substring(0, 100)}`);
                    }
                } catch (parseError) {
                    console.error('Error al parsear respuesta:', parseError);
                    showCobroModalError(`Error del servidor (${response.status}). Por favor, intenta de nuevo.`);
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }
                
                if (response.ok) {
                    showCobroModalSuccess(idPago ? 'Cobro actualizado exitosamente' : 'Cobro registrado exitosamente');
                    // Restablecer el botón antes de cerrar el modal
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    setTimeout(() => {
                        closeModal('modalCobro');
                        loadFacturacion(); // Recargar la lista
                    }, 1500);
                } else {
                    showCobroModalError(result.error || 'Error al guardar el cobro');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error al guardar cobro:', error);
                showCobroModalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }
        
        async function editarCobro(idPago) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/cobros/${idPago}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const contentType = response.headers.get('content-type');
                let cobro;
                
                if (contentType && contentType.includes('application/json')) {
                    cobro = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON al obtener cobro:', text);
                    showCobroModalError(`Error: No se pudo obtener el cobro. Status: ${response.status}`);
                    return;
                }
                
                if (response.ok) {
                    // Guardar el id_residente antes de cargar los residentes
                    const idResidenteSeleccionado = cobro.id_residente;
                    
                    // Cargar residentes pasando el ID seleccionado para asegurar que se seleccione
                    await loadResidentesForCobro(idResidenteSeleccionado);
                    
                    // Llenar el formulario con los datos del cobro
                    document.getElementById('cobro_id_pago').value = cobro.id_pago;
                    
                    // Asegurar que el valor esté establecido (redundancia por seguridad)
                    const selectResidente = document.getElementById('cobro_id_residente');
                    if (selectResidente) {
                        selectResidente.value = idResidenteSeleccionado;
                    }
                    
                    document.getElementById('cobro_monto').value = cobro.monto;
                    
                    // Establecer el concepto en el select o en "otros"
                    const selectConcepto = document.getElementById('cobro_concepto');
                    const campoOtros = document.getElementById('cobro_concepto_otros');
                    let concepto = cobro.concepto || '';
                    
                    // Cargar servicios extra del residente para tener todas las opciones disponibles
                    await cargarServiciosExtraResidente(idResidenteSeleccionado);
                    
                    // Verificar si el concepto es un pago mensual (formato: "[Mes] [Año]" o "Pago [Mes] [Año]")
                    // Ejemplos: "Enero 26", "Diciembre 25", "Pago Enero 26", etc.
                    const mesesEspanol = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
                                        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                    const conceptoLower = concepto.toLowerCase();
                    // Puede empezar con "pago " o directamente con el mes
                    const esPagoMensual = concepto && mesesEspanol.some(mes => {
                        return conceptoLower.startsWith(mes) || 
                               (conceptoLower.startsWith('pago ') && conceptoLower.includes(mes));
                    });
                    
                    if (esPagoMensual) {
                        // Si es un pago mensual, seleccionar "Pago mensual habitación"
                        selectConcepto.value = 'Pago mensual habitación';
                        campoOtros.style.display = 'none';
                        campoOtros.value = '';
                    } else {
                        // Verificar si el concepto está en las opciones del select
                        const opciones = Array.from(selectConcepto.options).map(opt => opt.value);
                        if (opciones.includes(concepto)) {
                            selectConcepto.value = concepto;
                            campoOtros.style.display = 'none';
                            campoOtros.value = '';
                        } else if (concepto) {
                            // Si no está en las opciones, usar "otros"
                            selectConcepto.value = 'otros';
                            campoOtros.style.display = 'block';
                            campoOtros.value = concepto;
                        } else {
                            selectConcepto.value = '';
                            campoOtros.style.display = 'none';
                            campoOtros.value = '';
                        }
                    }
                    
                    document.getElementById('cobro_metodo_pago').value = cobro.metodo_pago || '';
                    document.getElementById('cobro_observaciones').value = cobro.observaciones || '';
                    
                    // LÓGICA SIMPLE: O tiene fecha prevista O tiene fecha de pago, nunca ambas
                    document.getElementById('cobro_fecha_prevista').value = cobro.fecha_prevista || '';
                    document.getElementById('cobro_fecha_pago').value = cobro.fecha_pago || '';
                    
                    // Cambiar título del modal
                    document.getElementById('modalCobroTitulo').innerHTML = '<img src="/static/icons/medical/bill.svg" alt="Cobro" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Editar Cobro';
                    
                    // Mostrar botón de eliminar solo si tiene permiso
                    const deleteBtn = document.getElementById('deleteCobroBtn');
                    if (deleteBtn && usuarioTienePermiso('eliminar:cobro')) {
                        deleteBtn.style.display = 'block';
                    } else if (deleteBtn) {
                        deleteBtn.style.display = 'none';
                    }
                    
                    // Mostrar botón guardar si tiene permiso de editar
                    const saveBtn = document.getElementById('saveCobroBtn');
                    if (saveBtn && usuarioTienePermiso('editar:cobro')) {
                        saveBtn.style.display = 'block';
                    } else if (saveBtn) {
                        saveBtn.style.display = 'none';
                    }
                    
                    // Abrir modal primero
                    document.getElementById('modalCobro').style.display = 'block';
                    
                    // Inicializar date pickers
                    initializeCobroDatePickers();
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        showCobroModalError('Sesión expirada. Por favor, recarga la página para iniciar sesión nuevamente.');
                        localStorage.removeItem('violetas_token');
                    } else if (response.status === 404) {
                        showCobroModalError('El cobro no se encontró. Puede que haya sido eliminado o no tengas permisos para verlo.');
                        console.error('Cobro no encontrado:', cobro.error || 'Error desconocido');
                    } else {
                        showCobroModalError('Error al obtener el cobro: ' + (cobro.error || `Error ${response.status}`));
                        console.error('Error al obtener cobro:', response.status, cobro);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al obtener cobro:', error);
                showCobroModalError('Error de conexión: ' + error.message + '. Verifica que el servidor esté corriendo.');
            }
        }
        
        function showCobroModalError(message) {
            const alert = document.getElementById('modalCobroAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function showCobroModalSuccess(message) {
            const alert = document.getElementById('modalCobroAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function hideCobroModalAlert() {
            const alert = document.getElementById('modalCobroAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }
        
        function confirmarEliminarCobro() {
            // Esta función solo obtiene el ID del cobro del formulario y llama a eliminarCobro()
            // que ya tiene su propia confirmación
            const idPago = document.getElementById('cobro_id_pago').value;
            
            if (!idPago) {
                showCobroModalError('No se puede eliminar: no hay cobro seleccionado');
                return;
            }
            
            // Llamar a eliminarCobro que ya tiene su propia confirmación
            eliminarCobro(idPago);
        }
        
        async function eliminarCobro(idPago) {
            const token = localStorage.getItem('violetas_token');
            
            // Mostrar confirmación antes de eliminar
            if (!confirm('¿Estás seguro de eliminar este cobro? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/cobros/${idPago}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON al eliminar cobro:', text);
                    alert(`Error: No se pudo eliminar el cobro. Status: ${response.status}`);
                    return;
                }
                
                if (response.ok) {
                    alert('Cobro eliminado exitosamente');
                    loadFacturacion(); // Recargar la lista
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        showCobroModalError('Sesión expirada. Por favor, recarga la página para iniciar sesión nuevamente.');
                        localStorage.removeItem('violetas_token');
                    } else {
                        showCobroModalError('Error: ' + (result.error || 'Error al eliminar el cobro'));
                        console.error('Error al eliminar cobro:', response.status, result);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al eliminar cobro:', error);
                showCobroModalError('Error de conexión: ' + error.message + '. Verifica que el servidor esté corriendo.');
            }
        }
        
        async function openModalProveedor() {
            // Resetear formulario para nuevo pago
            resetPagoProveedorForm();
            // Cargar residencias antes de abrir el modal (no cargar proveedores todavía)
            await loadResidenciasIntoSelect('pago_id_residencia');
            openModal('modalPagoProveedor');
            // Inicializar date pickers
            initializePagoProveedorDatePickers();
            
            // Añadir event listener al campo de residencia para cargar proveedores cuando cambie
            const selectResidencia = document.getElementById('pago_id_residencia');
            if (selectResidencia) {
                // Remover listener anterior si existe
                selectResidencia.removeEventListener('change', handleResidenciaChange);
                // Añadir nuevo listener
                selectResidencia.addEventListener('change', handleResidenciaChange);
            }
        }
        
        async function handleResidenciaChange() {
            const selectResidencia = document.getElementById('pago_id_residencia');
            const id_residencia = selectResidencia ? selectResidencia.value : null;
            await loadProveedoresForSelect(id_residencia);
        }
        
        function resetPagoProveedorForm() {
            // Limpiar el formulario y restablecer el título
            const form = document.getElementById('formPagoProveedor');
            if (form) {
                form.reset();
            }
            
            const pagoIdPago = document.getElementById('pago_id_pago');
            if (pagoIdPago) {
                pagoIdPago.value = '';
            }
            
            // Limpiar factura procesada
            facturaProcesadaPath = null;
            const pagoFacturaArchivo = document.getElementById('pago_factura_archivo');
            if (pagoFacturaArchivo) {
                pagoFacturaArchivo.value = '';
            }
            
            const pagoFacturaInfo = document.getElementById('pago_factura_info');
            if (pagoFacturaInfo) {
                pagoFacturaInfo.style.display = 'none';
            }
            
            // Restablecer título del modal
            const modalHeader = document.querySelector('#modalPagoProveedor .modal-header h2');
            if (modalHeader) {
                modalHeader.innerHTML = '<span style="font-size: 24px; vertical-align: middle; margin-right: 8px;">€</span> Agregar Pago a Proveedor';
            }
            
            // Limpiar alertas
            hidePagoProveedorModalAlert();
        }
        
        function initializePagoProveedorDatePickers() {
            const fechaPagoInput = document.getElementById('pago_fecha_pago');
            const fechaPrevistaInput = document.getElementById('pago_fecha_prevista');
            
            // Destruir instancias anteriores
            if (flatpickrPagoProveedorFechaPago) {
                flatpickrPagoProveedorFechaPago.destroy();
            }
            if (flatpickrPagoProveedorFechaPrevista) {
                flatpickrPagoProveedorFechaPrevista.destroy();
            }
            
            // Inicializar flatpickr para fecha de pago
            if (fechaPagoInput) {
                // Establecer fecha de hoy por defecto si no tiene valor y no estamos editando
                const idPago = document.getElementById('pago_id_pago').value;
                if (!fechaPagoInput.value && !idPago) {
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    fechaPagoInput.value = `${dia}/${mes}/${año}`;
                }
                
                flatpickrPagoProveedorFechaPago = flatpickr(fechaPagoInput, {
                    dateFormat: "d/m/Y",
                    locale: "es",
                    allowInput: true,
                    clickOpens: true,
                    appendTo: document.body,
                    maxDate: "today",
                    defaultDate: fechaPagoInput.value || "today",
                    onChange: function(selectedDates, dateStr, instance) {
                        if (dateStr) {
                            const partes = dateStr.split('/');
                            if (partes.length === 3) {
                                const dia = partes[0].padStart(2, '0');
                                const mes = partes[1].padStart(2, '0');
                                const año = partes[2];
                                instance.input.value = `${dia}/${mes}/${año}`;
                            }
                            // Si se selecciona fecha de pago, limpiar fecha prevista
                            if (fechaPrevistaInput && flatpickrPagoProveedorFechaPrevista) {
                                fechaPrevistaInput.value = '';
                                flatpickrPagoProveedorFechaPrevista.clear();
                            }
                        }
                    }
                });
            }
            
            // Inicializar flatpickr para fecha prevista
            if (fechaPrevistaInput) {
                flatpickrPagoProveedorFechaPrevista = flatpickr(fechaPrevistaInput, {
                    dateFormat: "d/m/Y",
                    locale: "es",
                    allowInput: true,
                    clickOpens: true,
                    appendTo: document.body,
                    defaultDate: fechaPrevistaInput.value || null,
                    onChange: function(selectedDates, dateStr, instance) {
                        if (dateStr) {
                            const partes = dateStr.split('/');
                            if (partes.length === 3) {
                                const dia = partes[0].padStart(2, '0');
                                const mes = partes[1].padStart(2, '0');
                                const año = partes[2];
                                instance.input.value = `${dia}/${mes}/${año}`;
                            }
                            // Si se selecciona fecha prevista, limpiar fecha de pago
                            if (fechaPagoInput && flatpickrPagoProveedorFechaPago) {
                                fechaPagoInput.value = '';
                                flatpickrPagoProveedorFechaPago.clear();
                            }
                        }
                    }
                });
            }
        }
        
        // Función para abrir el modal de dar de baja
        function abrirModalBaja(idResidente) {
            document.getElementById('baja_id_residente').value = idResidente;
            document.getElementById('baja_motivo').value = '';
            document.getElementById('baja_observaciones').value = '';
            document.getElementById('modalBajaAlert').style.display = 'none';
            openModal('modalBajaResidente');
        }
        
        // Función para confirmar la baja de un residente
        async function confirmarBajaResidente(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const confirmarBtn = document.getElementById('confirmarBajaBtn');
            const originalText = confirmarBtn.textContent;
            
            const formData = new FormData(form);
            const idResidente = formData.get('id_residente');
            const motivoBaja = formData.get('motivo_baja');
            const observaciones = formData.get('observaciones');
            
            if (!motivoBaja) {
                showBajaModalError('Debe seleccionar un motivo de baja');
                return;
            }
            
            confirmarBtn.disabled = true;
            confirmarBtn.textContent = 'Procesando...';
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/baja`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        motivo_baja: motivoBaja,
                        observaciones: observaciones || null
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showBajaModalSuccess('Residente dado de baja exitosamente');
                    setTimeout(() => {
                        closeModal('modalBajaResidente');
                        closeModal('modalViewResidente');
                        loadResidentes(); // Recargar la lista
                    }, 1500);
                } else {
                    showBajaModalError(result.error || 'Error al dar de baja al residente');
                    confirmarBtn.disabled = false;
                    confirmarBtn.textContent = originalText;
                }
            } catch (error) {
                showBajaModalError('Error de conexión: ' + error.message);
                confirmarBtn.disabled = false;
                confirmarBtn.textContent = originalText;
            }
        }
        
        // Funciones para mostrar/ocultar alertas en el modal de baja
        function showBajaModalError(message) {
            const alert = document.getElementById('modalBajaAlert');
            alert.className = 'alert error';
            alert.textContent = message;
            alert.style.display = 'block';
        }
        
        function showBajaModalSuccess(message) {
            const alert = document.getElementById('modalBajaAlert');
            alert.className = 'alert success';
            alert.textContent = message;
            alert.style.display = 'block';
        }
        
        function hideBajaModalAlert() {
            document.getElementById('modalBajaAlert').style.display = 'none';
        }
        
        async function reactivarResidente(idResidente) {
            if (!confirm('¿Está seguro de que desea reactivar a este residente? La baja se eliminó por error.')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/alta`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON:', text);
                    alert('Error: No se pudo reactivar al residente. Status: ' + response.status);
                    return;
                }
                
                if (response.ok) {
                    alert('Residente reactivado exitosamente');
                    closeModal('modalViewResidente');
                    loadResidentes();
                } else {
                    alert('Error: ' + (result.error || 'Error al reactivar al residente'));
                }
            } catch (error) {
                console.error('Error al reactivar residente:', error);
                alert('Error de conexión: ' + error.message);
            }
        }
        
        function confirmarEliminarResidente(idResidente) {
            if (!confirm('⚠️ ADVERTENCIA: Esta acción es IRREVERSIBLE.\n\n¿Está seguro de que desea eliminar completamente a este residente?\n\nEsto eliminará todos los datos del residente de la base de datos.')) {
                return;
            }
            
            // Confirmación adicional
            if (!confirm('Esta acción NO se puede deshacer. ¿Está completamente seguro?')) {
                return;
            }
            
            eliminarResidente(idResidente);
        }
        
        async function eliminarResidente(idResidente) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON:', text);
                    alert('Error: No se pudo eliminar al residente. Status: ' + response.status);
                    return;
                }
                
                if (response.ok) {
                    alert('Residente eliminado completamente');
                    closeModal('modalViewResidente');
                    loadResidentes();
                } else {
                    alert('Error: ' + (result.error || 'Error al eliminar al residente'));
                }
            } catch (error) {
                console.error('Error al eliminar residente:', error);
                alert('Error de conexión: ' + error.message);
            }
        }
        
        async function openModalProveedorNuevo() {
            // Abrir modal de nuevo proveedor
            event.stopPropagation();
            event.preventDefault();
            await resetProveedorForm();
            openModal('modalProveedor');
        }
        
        function abrirModalBajaProveedor(idProveedor) {
            if (!idProveedor) {
                // Intentar obtener del formulario
                idProveedor = document.getElementById('prov_id_proveedor').value;
            }
            
            if (!idProveedor) {
                alert('Error: No se pudo identificar el proveedor');
                return;
            }
            
            document.getElementById('baja_id_proveedor').value = idProveedor;
            document.getElementById('baja_proveedor_motivo').value = '';
            document.getElementById('baja_proveedor_observaciones').value = '';
            hideBajaProveedorModalAlert();
            
            closeModal('modalProveedor');
            openModal('modalBajaProveedor');
        }
        
        async function confirmarBajaProveedor(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('confirmarBajaProveedorBtn');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            const idProveedor = formData.get('id_proveedor');
            const motivoBaja = formData.get('motivo_baja');
            
            if (!motivoBaja) {
                showBajaProveedorModalError('El motivo de baja es requerido');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Procesando...';
            hideBajaProveedorModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/proveedores/${idProveedor}/baja`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        motivo_baja: motivoBaja,
                        observaciones: formData.get('observaciones') || null
                    })
                });
                
                let result;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        throw new Error(`Error del servidor (${response.status}): ${text.substring(0, 100)}`);
                    }
                } catch (parseError) {
                    showBajaProveedorModalError(`Error del servidor (${response.status}). Por favor, intenta de nuevo.`);
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }
                
                if (response.ok) {
                    showBajaProveedorModalSuccess('Proveedor archivado exitosamente');
                    setTimeout(() => {
                        closeModal('modalBajaProveedor');
                        // Recargar lista de proveedores si el modal estaba abierto
                        const modalLista = document.getElementById('modalListaProveedores');
                        if (modalLista && modalLista.style.display === 'block') {
                            abrirModalListaProveedores();
                        }
                    }, 1500);
                } else {
                    showBajaProveedorModalError(result.error || 'Error al archivar el proveedor');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error al archivar proveedor:', error);
                showBajaProveedorModalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }
        
        function showBajaProveedorModalError(message) {
            const alert = document.getElementById('modalBajaProveedorAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function showBajaProveedorModalSuccess(message) {
            const alert = document.getElementById('modalBajaProveedorAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function hideBajaProveedorModalAlert() {
            const alert = document.getElementById('modalBajaProveedorAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }
        
        async function resetProveedorForm() {
            // Limpiar el formulario y restablecer el título
            document.getElementById('formProveedor').reset();
            document.getElementById('prov_id_proveedor').value = '';
            document.getElementById('prov_activo').checked = true;
            
            // Cargar residencias en el select
            await loadResidenciasIntoSelect('prov_id_residencia');
            
            // Ocultar botón de dar de baja al crear nuevo proveedor
            const bajaBtn = document.getElementById('bajaProveedorBtn');
            if (bajaBtn) {
                bajaBtn.style.display = 'none';
            }
            
            // Restablecer título del modal
            const modalHeader = document.querySelector('#modalProveedor .modal-header h2');
            if (modalHeader) {
                modalHeader.innerHTML = '<img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Proveedor';
            }
            
            // Limpiar alertas
            hideProveedorModalAlert();
        }

        async function loadProveedoresForSelect(id_residencia = null) {
            const token = localStorage.getItem('violetas_token');
            const select = document.getElementById('pago_id_proveedor');
            
            if (!select) return;
            
            // Si no hay residencia seleccionada, mostrar mensaje
            if (!id_residencia) {
                select.innerHTML = '<option value="">Seleccione primero una residencia</option>';
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/v1/proveedores`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    console.error('Respuesta de proveedores no es JSON');
                    select.innerHTML = '<option value="">Error al cargar proveedores</option>';
                    return;
                }
                
                if (response.ok && data.proveedores) {
                    select.innerHTML = '<option value="">Seleccione un proveedor</option>';
                    // Filtrar proveedores por residencia y que estén activos
                    data.proveedores
                        .filter(p => p.activo && p.id_residencia == id_residencia)
                        .forEach(prov => {
                            select.innerHTML += `<option value="${prov.id_proveedor}">${prov.nombre}${prov.tipo_servicio ? ' - ' + prov.tipo_servicio : ''}</option>`;
                        });
                    
                    // Si no hay proveedores para esa residencia
                    if (select.options.length === 1) {
                        select.innerHTML = '<option value="">No hay proveedores activos para esta residencia</option>';
                    }
                } else {
                    select.innerHTML = '<option value="">No hay proveedores disponibles</option>';
                    if (!response.ok) {
                        console.error('Error al cargar proveedores:', response.status, data.error);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al cargar proveedores:', error);
                select.innerHTML = '<option value="">Error al cargar proveedores</option>';
            }
        }

        async function abrirModalProcesarFactura() {
            // Limpiar variables de cámara al abrir el modal
            detenerCamara();
            imagenCapturada = null;
            
            // Resetear el modal
            document.getElementById('procesarFacturaContent').innerHTML = `
                <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">Paso 1: Subir o Capturar Factura</h3>
                    
                    <!-- Opciones: Archivo o Cámara -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <button type="button" onclick="mostrarOpcionArchivo()" id="btnOpcionArchivo" style="padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: brightness(0) invert(1);">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="currentColor"/>
                            </svg>
                            Seleccionar Archivo
                        </button>
                        <button type="button" onclick="mostrarOpcionCamara()" id="btnOpcionCamara" style="padding: 15px; background: #48bb78; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: brightness(0) invert(1);">
                                <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" fill="currentColor"/>
                                <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" fill="currentColor"/>
                            </svg>
                            Capturar con Cámara
                        </button>
                    </div>
                    
                    <!-- Contenedor para opción de archivo -->
                    <div id="opcionArchivoContainer" style="display: block;">
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="procesar_factura_archivo" style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Seleccionar Factura (PDF o Imagen)</label>
                            <label for="procesar_factura_archivo" style="display: flex; align-items: center; padding: 15px; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9ff; cursor: pointer; transition: all 0.3s ease;">
                                <input type="file" id="procesar_factura_archivo" accept=".pdf,.jpg,.jpeg,.png" style="position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none;" onchange="actualizarNombreArchivoProcesar()">
                                <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                                    <img src="/static/icons/medical/file-medical.svg" alt="Archivo" style="width: 32px; height: 32px; filter: brightness(0) saturate(100%) invert(27%) sepia(95%) saturate(1352%) hue-rotate(230deg) brightness(99%) contrast(96%);">
                                    <div style="flex: 1;">
                                        <div id="procesar_factura_texto" style="color: #667eea; font-weight: 500; font-size: 16px;">
                                            Seleccionar archivo PDF o imagen...
                                        </div>
                                        <div style="color: #999; font-size: 12px; margin-top: 4px;">
                                            Máximo 10MB (PDF, JPG, PNG)
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Contenedor para opción de cámara -->
                    <div id="opcionCamaraContainer" style="display: none;">
                        <div style="margin-top: 15px;">
                            <div id="camaraPreviewContainer" style="display: none; margin-bottom: 15px;">
                                <video id="camaraVideo" autoplay playsinline style="width: 100%; max-width: 100%; border-radius: 8px; background: #000;"></video>
                                <canvas id="camaraCanvas" style="display: none;"></canvas>
                                <img id="camaraPreview" style="display: none; width: 100%; max-width: 100%; border-radius: 8px; margin-top: 10px;">
                            </div>
                            <div id="camaraControls" style="display: flex; gap: 10px; justify-content: center;">
                                <button type="button" onclick="iniciarCamara()" id="btnIniciarCamara" style="padding: 12px 20px; background: #48bb78; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    Iniciar Cámara
                                </button>
                                <button type="button" onclick="capturarFoto()" id="btnCapturarFoto" style="display: none; padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    Capturar Foto
                                </button>
                                <button type="button" onclick="reiniciarCamara()" id="btnReiniciarCamara" style="display: none; padding: 12px 20px; background: #ed8936; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    Volver a Capturar
                                </button>
                                <button type="button" onclick="detenerCamara()" id="btnDetenerCamara" style="display: none; padding: 12px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    Detener Cámara
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" onclick="procesarFacturaCompleta()" id="btnProcesarFacturaCompleta" style="flex: 1; padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: brightness(0) invert(1);">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="currentColor"/>
                            </svg>
                            Procesar Factura
                        </button>
                    </div>
                </div>
                <div id="procesarFacturaAlert" class="alert" style="display: none;"></div>
            `;
            
            // Abrir modal
            openModal('modalProcesarFactura');
        }
        
        let streamCamara = null;
        let imagenCapturada = null;
        
        function mostrarOpcionArchivo() {
            document.getElementById('opcionArchivoContainer').style.display = 'block';
            document.getElementById('opcionCamaraContainer').style.display = 'none';
            document.getElementById('btnOpcionArchivo').style.background = '#667eea';
            document.getElementById('btnOpcionCamara').style.background = '#6c757d';
            detenerCamara();
        }
        
        function mostrarOpcionCamara() {
            document.getElementById('opcionArchivoContainer').style.display = 'none';
            document.getElementById('opcionCamaraContainer').style.display = 'block';
            document.getElementById('btnOpcionArchivo').style.background = '#6c757d';
            document.getElementById('btnOpcionCamara').style.background = '#48bb78';
        }
        
        async function iniciarCamara() {
            try {
                // Verificar si el navegador soporta getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    mostrarAlertaProcesarFactura('Tu navegador no soporta el acceso a la cámara', 'error');
                    return;
                }
                
                // Solicitar acceso a la cámara trasera (ideal) o frontal
                streamCamara = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Cámara trasera en móviles
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                
                const video = document.getElementById('camaraVideo');
                video.srcObject = streamCamara;
                
                document.getElementById('camaraPreviewContainer').style.display = 'block';
                document.getElementById('btnIniciarCamara').style.display = 'none';
                document.getElementById('btnCapturarFoto').style.display = 'inline-block';
                document.getElementById('btnDetenerCamara').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Error al acceder a la cámara:', error);
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    mostrarAlertaProcesarFactura('Se necesita permiso para acceder a la cámara', 'error');
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    mostrarAlertaProcesarFactura('No se encontró ninguna cámara disponible', 'error');
                } else {
                    mostrarAlertaProcesarFactura('Error al acceder a la cámara: ' + error.message, 'error');
                }
            }
        }
        
        function capturarFoto() {
            const video = document.getElementById('camaraVideo');
            const canvas = document.getElementById('camaraCanvas');
            const preview = document.getElementById('camaraPreview');
            
            if (!video || !streamCamara) {
                mostrarAlertaProcesarFactura('La cámara no está iniciada', 'error');
                return;
            }
            
            // Configurar canvas con las dimensiones del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Capturar frame del video
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convertir a blob y mostrar preview
            canvas.toBlob((blob) => {
                if (!blob) {
                    mostrarAlertaProcesarFactura('Error al capturar la imagen', 'error');
                    return;
                }
                
                // Crear un nuevo File desde el blob para tener mejor control
                const file = new File([blob], `factura_${Date.now()}.jpg`, { type: 'image/jpeg' });
                imagenCapturada = file;
                
                // Mostrar preview
                const imageUrl = URL.createObjectURL(blob);
                preview.src = imageUrl;
                preview.style.display = 'block';
                video.style.display = 'none';
                
                // Ocultar botones de captura y mostrar opción de reiniciar
                document.getElementById('btnCapturarFoto').style.display = 'none';
                document.getElementById('btnDetenerCamara').style.display = 'none';
                document.getElementById('btnReiniciarCamara').style.display = 'inline-block';
                
                // Detener la cámara
                detenerCamara();
            }, 'image/jpeg', 0.95);
        }
        
        function reiniciarCamara() {
            imagenCapturada = null;
            document.getElementById('camaraPreview').style.display = 'none';
            document.getElementById('camaraPreview').src = '';
            document.getElementById('camaraVideo').style.display = 'block';
            document.getElementById('btnReiniciarCamara').style.display = 'none';
            iniciarCamara();
        }
        
        function detenerCamara() {
            if (streamCamara) {
                streamCamara.getTracks().forEach(track => track.stop());
                streamCamara = null;
            }
        }
        
        function actualizarNombreArchivoProcesar() {
            const archivoInput = document.getElementById('procesar_factura_archivo');
            const textoArchivo = document.getElementById('procesar_factura_texto');
            
            if (archivoInput && archivoInput.files && archivoInput.files.length > 0) {
                const archivo = archivoInput.files[0];
                textoArchivo.textContent = archivo.name;
                textoArchivo.style.color = '#333';
            } else {
                textoArchivo.textContent = 'Seleccionar archivo PDF...';
                textoArchivo.style.color = '#667eea';
            }
        }
        
        async function procesarFacturaCompleta() {
            const token = localStorage.getItem('violetas_token');
            const archivoInput = document.getElementById('procesar_factura_archivo');
            const btnProcesar = document.getElementById('btnProcesarFacturaCompleta');
            const alertDiv = document.getElementById('procesarFacturaAlert');
            
            let archivo = null;
            let nombreArchivo = 'factura.jpg';
            
            // Verificar si hay imagen capturada o archivo seleccionado
            if (imagenCapturada) {
                // Usar imagen capturada de la cámara
                archivo = imagenCapturada;
                nombreArchivo = archivo.name || `factura_${Date.now()}.jpg`;
            } else if (archivoInput && archivoInput.files && archivoInput.files[0]) {
                // Usar archivo seleccionado
                archivo = archivoInput.files[0];
                nombreArchivo = archivo.name;
            } else {
                mostrarAlertaProcesarFactura('Por favor seleccione un archivo o capture una foto', 'error');
                return;
            }
            
            // Validar tipo de archivo (PDF o imagen)
            const tiposPermitidos = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            const extensionesPermitidas = ['.pdf', '.jpg', '.jpeg', '.png'];
            const nombreLower = nombreArchivo.toLowerCase();
            
            const tipoValido = tiposPermitidos.includes(archivo.type) || 
                              extensionesPermitidas.some(ext => nombreLower.endsWith(ext));
            
            if (!tipoValido) {
                mostrarAlertaProcesarFactura('Por favor seleccione un archivo PDF o imagen válida (JPG, PNG)', 'error');
                return;
            }
            
            // Validar tamaño (máximo 10MB)
            if (archivo.size > 10 * 1024 * 1024) {
                mostrarAlertaProcesarFactura('El archivo es demasiado grande. Máximo 10MB', 'error');
                return;
            }
            
            // Deshabilitar botón y mostrar loading
            const originalText = btnProcesar.innerHTML;
            btnProcesar.disabled = true;
            btnProcesar.innerHTML = '<div style="display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div> Procesando...';
            
            try {
                const formData = new FormData();
                formData.append('factura', archivo, nombreArchivo);
                
                const response = await fetch(`${API_URL}/api/v1/facturacion/procesar-factura`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Guardar entidades disponibles en localStorage para el mapeo
                    if (result.entidades_disponibles) {
                        localStorage.setItem('ultima_factura_procesada', JSON.stringify({
                            entidades_disponibles: result.entidades_disponibles,
                            timestamp: Date.now()
                        }));
                    }
                    // Mostrar resultados en el modal
                    mostrarResultadosProcesamiento(result, nombreArchivo);
                    // Limpiar imagen capturada después de procesar
                    imagenCapturada = null;
                } else {
                    mostrarAlertaProcesarFactura(result.error || 'Error al procesar la factura', 'error');
                }
            } catch (error) {
                console.error('Error al procesar factura:', error);
                mostrarAlertaProcesarFactura('Error de conexión al procesar la factura', 'error');
            } finally {
                btnProcesar.disabled = false;
                btnProcesar.innerHTML = originalText;
            }
        }
        
        function mostrarAlertaProcesarFactura(mensaje, tipo) {
            const alertDiv = document.getElementById('procesarFacturaAlert');
            if (alertDiv) {
                alertDiv.className = `alert ${tipo === 'error' ? 'alert-error' : 'alert-success'}`;
                alertDiv.textContent = mensaje;
                alertDiv.style.display = 'block';
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        async function mostrarResultadosProcesamiento(resultado, nombreArchivo) {
            const content = document.getElementById('procesarFacturaContent');
            const datosExtraidos = resultado.datos_extraidos || {};
            const textoCompleto = resultado.texto_completo || '';
            const blobPath = resultado.blob_path || '';
            const pdfUrl = resultado.pdf_url || '';
            const idResidenciaDetectada = resultado.id_residencia_detectada || null;
            const entidadesDisponibles = resultado.entidades_disponibles || {};

            // Log para debugging
            console.log('📄 PDF Debug Info:', {
                blobPath: blobPath,
                pdfUrl: pdfUrl,
                pdfUrlLength: pdfUrl ? pdfUrl.length : 0,
                hasPdfUrl: !!pdfUrl
            });
            
            // Guardar entidades disponibles para el mapeo
            window.entidadesDisponiblesFactura = entidadesDisponibles;
            
            // Buscar proveedores existentes que coincidan con el nombre extraído
            let proveedoresCoincidentes = [];
            if (datosExtraidos.proveedor) {
                try {
                    const token = localStorage.getItem('violetas_token');
                    const response = await fetch(`${API_URL}/api/v1/proveedores`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const nombreProveedorLower = datosExtraidos.proveedor.toLowerCase();
                        proveedoresCoincidentes = (data.proveedores || []).filter(p => 
                            p.nombre && (p.nombre.toLowerCase().includes(nombreProveedorLower) ||
                            nombreProveedorLower.includes(p.nombre.toLowerCase()))
                        );
                    }
                } catch (error) {
                    console.error('Error al buscar proveedores:', error);
                }
            }
            
            // Formatear fecha para el input en formato español
            let fechaFormateada = '';
            if (datosExtraidos.fecha_pago) {
                const fecha = new Date(datosExtraidos.fecha_pago);
                fechaFormateada = fechaISOToEspanol(fecha.toISOString().split('T')[0]); // DD/MM/YYYY
            }
            
            // Guardar datos en variables globales para usar al guardar
            window.facturaProcesadaDatos = {
                blobPath: blobPath,
                idResidenciaDetectada: idResidenciaDetectada,
                datosExtraidos: datosExtraidos
            };
            
            let html = `
                <div style="display: grid; grid-template-columns: ${pdfUrl ? '1fr 1fr' : '1fr'}; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/check-circle.svg" alt="OK" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Factura Procesada</h3>
                        <p style="color: #666; margin-bottom: 10px;"><strong>Archivo:</strong> ${nombreArchivo}</p>
                        ${pdfUrl ? `
                            <div style="margin-top: 15px;">
                                <button onclick="window.open('${pdfUrl}', '_blank')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 6px;">
                                    <img src="/static/icons/medical/file-medical.svg" alt="PDF" style="width: 16px; height: 16px; filter: brightness(0) invert(1);"> Abrir PDF en Nueva Pestaña
                                </button>
                            </div>
                        ` : `
                            <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px;">
                                <p style="color: #856404; margin: 0; font-size: 14px;"><strong>⚠️ Vista previa no disponible</strong></p>
                                <p style="color: #856404; margin: 5px 0 0 0; font-size: 13px;">El documento se guardó correctamente pero la vista previa no está disponible en este momento.</p>
                            </div>
                        `}
                    </div>
                    ${pdfUrl ? `
                    <div style="border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; height: 400px;">
                        <iframe src="${pdfUrl}" style="width: 100%; height: 100%; border: none;" title="Vista previa de la factura"></iframe>
                    </div>
                    ` : ''}
                </div>
                
                <form id="formFacturaProcesada" onsubmit="guardarFacturaProcesada(event)" style="background: #f8f9ff; padding: 20px; border-radius: 10px; border: 2px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 20px; font-size: 16px; display: flex; align-items: center;"><img src="/static/icons/medical/file-medical.svg" alt="Procesar Factura" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Editar Datos de la Factura</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="factura_numero">Número de Factura *</label>
                            <input type="text" id="factura_numero" name="numero_factura" value="${datosExtraidos.numero_factura || ''}" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label for="factura_fecha">Fecha de Pago *</label>
                            <input type="date" id="factura_fecha" name="fecha_pago" value="${datosExtraidos.fecha_pago || ''}" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="factura_total">Base Imponible (€) *</label>
                            <input type="number" id="factura_total" name="total" step="0.01" value="${datosExtraidos.total || ''}" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label for="factura_iva_porcentaje">IVA (%)</label>
                            <input type="number" id="factura_iva_porcentaje" name="iva_porcentaje" step="0.01" value="${datosExtraidos.iva_porcentaje || datosExtraidos.iva_porcentaje_efectivo || ''}" placeholder="4, 10 o 21" min="0" max="100" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            ${datosExtraidos.iva_porcentajes_detectados && datosExtraidos.iva_porcentajes_detectados.length > 1 ? `
                                <div style="margin-top: 5px; font-size: 11px; color: #667eea; font-style: italic;">
                                    ℹ️ Múltiples tipos de IVA detectados: ${datosExtraidos.iva_porcentajes_detectados.join('%, ')}%
                                    ${datosExtraidos.iva_porcentaje_efectivo ? ` (Efectivo: ${datosExtraidos.iva_porcentaje_efectivo.toFixed(2)}%)` : ''}
                                </div>
                            ` : datosExtraidos.iva_porcentaje_efectivo && datosExtraidos.iva_porcentaje_efectivo !== datosExtraidos.iva_porcentaje ? `
                                <div style="margin-top: 5px; font-size: 11px; color: #667eea; font-style: italic;">
                                    ℹ️ Porcentaje efectivo calculado: ${datosExtraidos.iva_porcentaje_efectivo.toFixed(2)}%
                                </div>
                            ` : ''}
                        </div>
                        <div class="form-group">
                            <label for="factura_impuestos">IVA (€)</label>
                            <input type="number" id="factura_impuestos" name="impuestos" step="0.01" value="${datosExtraidos.impuestos || datosExtraidos.iva || ''}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="factura_total_impuestos">TOTAL (€) *</label>
                            <input type="number" id="factura_total_impuestos" name="monto" step="0.01" value="${datosExtraidos.total_con_impuestos || datosExtraidos.monto || ''}" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="factura_concepto">Concepto *</label>
                        ${datosExtraidos.concepto ? `
                            <div style="background: #e6ffed; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #48bb78; font-size: 12px; color: #22543d;">
                                <span style="display: flex; align-items: center; gap: 4px;"><img src="/static/icons/medical/check-circle.svg" alt="OK" style="width: 12px; height: 12px;"> Concepto generado automáticamente</span>
                            </div>
                        ` : ''}
                        <input type="text" id="factura_concepto" name="concepto" value="${datosExtraidos.concepto || ''}" required placeholder="Descripción del pago" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="factura_residencia">Residencia *</label>
                        <select id="factura_residencia" name="id_residencia" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <option value="">Cargando residencias...</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="factura_receiver">Entidad Fiscal (Sociedad) *</label>
                        ${datosExtraidos.receiver ? `
                            <div style="background: #e6ffed; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #48bb78;">
                                <div style="font-size: 12px; color: #22543d; margin-bottom: 5px; font-weight: 600; display: flex; align-items: center; gap: 4px;"><img src="/static/icons/medical/check-circle.svg" alt="OK" style="width: 14px; height: 14px;"> Entidad detectada en la factura:</div>
                                <div style="font-size: 14px; color: #22543d; font-weight: 600;">${datosExtraidos.receiver}</div>
                                ${datosExtraidos.receiver_nif ? `<div style="font-size: 12px; color: #22543d; margin-top: 3px;">NIF: ${datosExtraidos.receiver_nif}</div>` : ''}
                            </div>
                        ` : ''}
                        <select id="factura_receiver" name="id_receiver" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <option value="">Seleccione una entidad fiscal...</option>
                        </select>
                        <input type="hidden" id="factura_receiver_detectado" value="${datosExtraidos.id_receiver || ''}">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="factura_proveedor">Proveedor *</label>
                        ${proveedoresCoincidentes.length > 0 ? `
                            <div style="background: #e6ffed; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #48bb78;">
                                <div style="font-size: 12px; color: #22543d; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 4px;"><img src="/static/icons/medical/check-circle.svg" alt="OK" style="width: 14px; height: 14px;"> Proveedores encontrados que coinciden:</div>
                                <select id="factura_proveedor_existente" style="width: 100%; padding: 8px; border: 2px solid #48bb78; border-radius: 6px; font-size: 14px; margin-bottom: 8px;">
                                    <option value="">Seleccione un proveedor existente</option>
                                    ${proveedoresCoincidentes.map(p => `<option value="${p.id_proveedor}" data-residencia="${p.id_residencia}">${p.nombre}${p.nif_cif ? ' - ' + p.nif_cif : ''}</option>`).join('')}
                                </select>
                                <div style="text-align: center; margin: 8px 0; color: #666; font-size: 12px;">O</div>
                            </div>
                        ` : ''}
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <input type="text" id="factura_proveedor_nuevo" name="proveedor_nuevo" value="${proveedoresCoincidentes.length === 0 ? (datosExtraidos.proveedor || '') : ''}" placeholder="Nombre del proveedor (si no existe)" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <button type="button" id="btnCrearProveedor" onclick="crearProveedorDesdeFactura()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; white-space: nowrap; align-self: flex-start;">+ Crear Proveedor</button>
                        </div>
                        <input type="hidden" id="factura_id_proveedor" name="id_proveedor" value="">
                        ${datosExtraidos.proveedor || datosExtraidos.proveedor_nif || datosExtraidos.proveedor_telefono || datosExtraidos.proveedor_email || datosExtraidos.proveedor_direccion ? `
                        <div style="margin-top: 10px; padding: 10px; background: #f0f7ff; border-radius: 6px; border-left: 3px solid #667eea;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                <img src="/static/icons/medical/clipboard-medical.svg" alt="Datos" style="width: 14px; height: 14px;"> Datos adicionales del proveedor extraídos:
                            </div>
                            ${datosExtraidos.proveedor ? `<div style="font-size: 12px; color: #333; margin-bottom: 3px;"><strong>Nombre:</strong> ${datosExtraidos.proveedor}</div>` : ''}
                            ${datosExtraidos.proveedor_nif ? `<div style="font-size: 12px; color: #333; margin-bottom: 3px;"><strong>NIF:</strong> ${datosExtraidos.proveedor_nif}</div>` : ''}
                            ${datosExtraidos.proveedor_telefono ? `<div style="font-size: 12px; color: #333; margin-bottom: 3px;"><strong>Teléfono:</strong> ${datosExtraidos.proveedor_telefono}</div>` : ''}
                            ${datosExtraidos.proveedor_email ? `<div style="font-size: 12px; color: #333; margin-bottom: 3px;"><strong>Email:</strong> ${datosExtraidos.proveedor_email}</div>` : ''}
                            ${datosExtraidos.proveedor_direccion ? `<div style="font-size: 12px; color: #333;"><strong>Dirección:</strong> ${datosExtraidos.proveedor_direccion}</div>` : ''}
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="factura_metodo_pago">Método de Pago</label>
                        ${datosExtraidos.metodo_pago ? `
                            <div style="background: #e6ffed; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #48bb78; font-size: 12px; color: #22543d;">
                                <span style="display: flex; align-items: center; gap: 4px;"><img src="/static/icons/medical/check-circle.svg" alt="OK" style="width: 12px; height: 12px;"> Método detectado: <strong>${datosExtraidos.metodo_pago}</strong></span>
                            </div>
                        ` : ''}
                        <select id="factura_metodo_pago" name="metodo_pago" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <option value="">Seleccione un método</option>
                            <option value="transferencia" ${datosExtraidos.metodo_pago === 'transferencia' ? 'selected' : ''}>Transferencia</option>
                            <option value="remesa" ${datosExtraidos.metodo_pago === 'remesa' ? 'selected' : ''}>Remesa</option>
                            <option value="metálico" ${datosExtraidos.metodo_pago === 'metálico' ? 'selected' : ''}>Metálico</option>
                            <option value="cheque" ${datosExtraidos.metodo_pago === 'cheque' ? 'selected' : ''}>Cheque</option>
                            <option value="tarjeta" ${datosExtraidos.metodo_pago === 'tarjeta' ? 'selected' : ''}>Tarjeta</option>
                            <option value="otro" ${datosExtraidos.metodo_pago && !['transferencia', 'remesa', 'metálico', 'cheque', 'tarjeta'].includes(datosExtraidos.metodo_pago) ? 'selected' : ''}>Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="factura_observaciones">Observaciones (opcional)</label>
                        <textarea id="factura_observaciones" name="observaciones" rows="3" placeholder="Observaciones adicionales sobre el pago" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px; background: #fff5f5; padding: 20px; border-radius: 10px; border-left: 4px solid #f56565;">
                        <h4 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">🔧 Configurar Mapeo de Campos de la IA</h4>
                        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                            Selecciona qué campo de la IA corresponde a cada campo del sistema. Los valores se aplicarán automáticamente al formulario.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="mapeo_numero_factura" style="font-weight: 600; color: #333; margin-bottom: 5px; display: block;">Número de Factura</label>
                                <select id="mapeo_numero_factura" onchange="aplicarMapeoCampo('numero_factura', 'factura_numero')" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                    <option value="">-- Seleccionar campo de la IA --</option>
                                    ${Object.keys(entidadesDisponibles).map(key => `
                                        <option value="${key}" ${datosExtraidos.numero_factura && entidadesDisponibles[key]?.ejemplo_valor?.includes(datosExtraidos.numero_factura) ? 'selected' : ''}>
                                            ${key}${entidadesDisponibles[key]?.ejemplo_valor ? ` (${entidadesDisponibles[key].ejemplo_valor.substring(0, 40)}...)` : ''}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="mapeo_fecha_pago" style="font-weight: 600; color: #333; margin-bottom: 5px; display: block;">Fecha de Pago</label>
                                <select id="mapeo_fecha_pago" onchange="aplicarMapeoCampo('fecha_pago', 'factura_fecha')" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                    <option value="">-- Seleccionar campo de la IA --</option>
                                    ${Object.keys(entidadesDisponibles).map(key => `
                                        <option value="${key}" ${datosExtraidos.fecha_pago && entidadesDisponibles[key]?.ejemplo_valor?.includes(datosExtraidos.fecha_pago.substring(0, 10)) ? 'selected' : ''}>
                                            ${key}${entidadesDisponibles[key]?.ejemplo_valor ? ` (${entidadesDisponibles[key].ejemplo_valor.substring(0, 40)}...)` : ''}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="mapeo_base_imponible" style="font-weight: 600; color: #333; margin-bottom: 5px; display: block;">Base Imponible (sin IVA)</label>
                                <select id="mapeo_base_imponible" onchange="aplicarMapeoCampo('base_imponible', 'factura_total')" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                    <option value="">-- Seleccionar campo de la IA --</option>
                                    ${Object.keys(entidadesDisponibles).map(key => `
                                        <option value="${key}" ${datosExtraidos.total && entidadesDisponibles[key]?.ejemplo_valor ? 'selected' : ''}>
                                            ${key}${entidadesDisponibles[key]?.ejemplo_valor ? ` (${entidadesDisponibles[key].ejemplo_valor.substring(0, 40)}...)` : ''}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="mapeo_iva" style="font-weight: 600; color: #333; margin-bottom: 5px; display: block;">IVA (€)</label>
                                <select id="mapeo_iva" onchange="aplicarMapeoCampo('impuestos', 'factura_impuestos')" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                    <option value="">-- Seleccionar campo de la IA --</option>
                                    ${Object.keys(entidadesDisponibles).map(key => `
                                        <option value="${key}" ${datosExtraidos.impuestos && entidadesDisponibles[key]?.ejemplo_valor ? 'selected' : ''}>
                                            ${key}${entidadesDisponibles[key]?.ejemplo_valor ? ` (${entidadesDisponibles[key].ejemplo_valor.substring(0, 40)}...)` : ''}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="mapeo_total" style="font-weight: 600; color: #333; margin-bottom: 5px; display: block;">Total de Factura (con IVA)</label>
                                <select id="mapeo_total" onchange="aplicarMapeoCampo('monto', 'factura_total_impuestos')" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                    <option value="">-- Seleccionar campo de la IA --</option>
                                    ${Object.keys(entidadesDisponibles).map(key => `
                                        <option value="${key}" ${datosExtraidos.monto && entidadesDisponibles[key]?.ejemplo_valor ? 'selected' : ''}>
                                            ${key}${entidadesDisponibles[key]?.ejemplo_valor ? ` (${entidadesDisponibles[key].ejemplo_valor.substring(0, 40)}...)` : ''}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #e0e0e0;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 10px; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                                <img src="/static/icons/medical/clipboard-medical.svg" alt="Campos" style="width: 16px; height: 16px;"> Todos los campos detectados por la IA:
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto;">
                                ${Object.keys(entidadesDisponibles).map(key => {
                                    const entidad = entidadesDisponibles[key];
                                    const ejemplo = entidad?.ejemplo_valor || 'Sin ejemplo';
                                    const confidence = entidad?.confidence || 0;
                                    return `
                                        <div style="padding: 8px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                                            <div style="font-weight: 600; color: #667eea; font-size: 12px; margin-bottom: 4px;">${key}</div>
                                            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">${ejemplo.substring(0, 50)}${ejemplo.length > 50 ? '...' : ''}</div>
                                            <div style="font-size: 10px; color: #999;">Confianza: ${(confidence * 100).toFixed(1)}%</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" style="flex: 1; padding: 12px 20px; background: #48bb78; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <img src="/static/icons/medical/check-circle.svg" alt="Guardar" style="width: 18px; height: 18px; filter: brightness(0) invert(1);"> Guardar Pago
                        </button>
                        <button type="button" onclick="abrirModalProcesarFactura()" style="flex: 1; padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <img src="/static/icons/medical/file-medical.svg" alt="Procesar" style="width: 18px; height: 18px; filter: brightness(0) invert(1);"> Procesar Otra Factura
                        </button>
                    </div>
                </form>
            `;
            
            content.innerHTML = html;
            
            // Cargar residencias en el select
            await loadResidenciasIntoSelect('factura_residencia', idResidenciaDetectada);
            
            // Cargar entidades fiscales (receivers) en el select
            try {
                const token = localStorage.getItem('violetas_token');
                const receiversResponse = await fetch(`${API_URL}/api/v1/receivers`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (receiversResponse.ok) {
                    const receiversData = await receiversResponse.json();
                    const selectReceiver = document.getElementById('factura_receiver');
                    
                    if (selectReceiver) {
                        selectReceiver.innerHTML = '<option value="">Seleccione una entidad fiscal...</option>';
                        
                        (receiversData.receivers || []).forEach(rec => {
                            const option = document.createElement('option');
                            option.value = rec.id_receiver;
                            option.textContent = `${rec.nombre}${rec.nif_cif ? ' - ' + rec.nif_cif : ''}`;
                            selectReceiver.appendChild(option);
                        });
                        
                        // Seleccionar automáticamente el receiver detectado
                        const idReceiverDetectado = resultado.id_receiver_detectado || datosExtraidos.id_receiver;
                        if (idReceiverDetectado) {
                            selectReceiver.value = idReceiverDetectado;
                            console.log('✅ Receiver detectado automáticamente:', idReceiverDetectado);
                        }
                    }
                }
            } catch (error) {
                console.error('Error al cargar entidades fiscales:', error);
            }
            
            // Calcular automáticamente el total con impuestos y el IVA desde el porcentaje
            const facturaTotal = document.getElementById('factura_total');
            const facturaIvaPorcentaje = document.getElementById('factura_iva_porcentaje');
            const facturaImpuestos = document.getElementById('factura_impuestos');
            const facturaTotalImpuestos = document.getElementById('factura_total_impuestos');
            
            function calcularIVAyTotal() {
                if (facturaTotal && facturaTotalImpuestos) {
                    const total = parseFloat(facturaTotal.value) || 0;
                    let impuestos = parseFloat(facturaImpuestos.value) || 0;
                    
                    // Si hay porcentaje de IVA, calcular el IVA desde ahí
                    if (facturaIvaPorcentaje && facturaIvaPorcentaje.value) {
                        const porcentajeIVA = parseFloat(facturaIvaPorcentaje.value) || 0;
                        if (porcentajeIVA > 0 && total > 0) {
                            impuestos = (total * porcentajeIVA / 100);
                            if (facturaImpuestos) {
                                facturaImpuestos.value = impuestos.toFixed(2);
                            }
                        }
                    } else if (total > 0 && impuestos > 0 && facturaIvaPorcentaje) {
                        // Si no hay porcentaje pero sí hay IVA y Base Imponible, calcular el porcentaje
                        const porcentajeCalculado = (impuestos / total) * 100;
                        // Redondear al porcentaje más cercano válido en España (4%, 10%, 21%)
                        const porcentajesValidos = [4, 10, 21];
                        const porcentajeMasCercano = porcentajesValidos.reduce((prev, curr) => 
                            Math.abs(curr - porcentajeCalculado) < Math.abs(prev - porcentajeCalculado) ? curr : prev
                        );
                        // Solo actualizar si la diferencia es razonable (menos de 2 puntos porcentuales)
                        if (Math.abs(porcentajeMasCercano - porcentajeCalculado) < 2) {
                            facturaIvaPorcentaje.value = porcentajeMasCercano.toFixed(2);
                        }
                    }
                    
                    facturaTotalImpuestos.value = (total + impuestos).toFixed(2);
                }
            }
            
            if (facturaTotal) {
                facturaTotal.addEventListener('input', calcularIVAyTotal);
            }
            if (facturaIvaPorcentaje) {
                facturaIvaPorcentaje.addEventListener('input', calcularIVAyTotal);
            }
            if (facturaImpuestos) {
                facturaImpuestos.addEventListener('input', calcularIVAyTotal);
            }
            
            // Manejar selección de proveedor existente y actualizar sus datos
            const selectProveedorExistente = document.getElementById('factura_proveedor_existente');
            if (selectProveedorExistente) {
                selectProveedorExistente.addEventListener('change', async function() {
                    if (this.value) {
                        const idProveedor = this.value;
                        document.getElementById('factura_id_proveedor').value = idProveedor;
                        document.getElementById('factura_proveedor_nuevo').value = '';
                        document.getElementById('factura_proveedor_nuevo').disabled = true;
                        
                        // Seleccionar la residencia del proveedor si es diferente
                        const option = this.options[this.selectedIndex];
                        const idResidenciaProveedor = option.getAttribute('data-residencia');
                        if (idResidenciaProveedor && document.getElementById('factura_residencia').value !== idResidenciaProveedor) {
                            document.getElementById('factura_residencia').value = idResidenciaProveedor;
                        }
                        
                        // Actualizar datos del proveedor con los extraídos de la factura
                        const datosExtraidos = window.facturaProcesadaDatos?.datosExtraidos || {};
                        if (datosExtraidos.proveedor_nif || datosExtraidos.proveedor_telefono || datosExtraidos.proveedor_email || datosExtraidos.proveedor_direccion) {
                            try {
                                const token = localStorage.getItem('violetas_token');
                                const proveedorData = {};
                                
                                if (datosExtraidos.proveedor_nif) proveedorData.nif_cif = datosExtraidos.proveedor_nif;
                                if (datosExtraidos.proveedor_telefono) proveedorData.telefono = datosExtraidos.proveedor_telefono;
                                if (datosExtraidos.proveedor_email) proveedorData.email = datosExtraidos.proveedor_email;
                                if (datosExtraidos.proveedor_direccion) proveedorData.direccion = datosExtraidos.proveedor_direccion;
                                
                                if (Object.keys(proveedorData).length > 0) {
                                    const response = await fetch(`${API_URL}/api/v1/proveedores/${idProveedor}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify(proveedorData)
                                    });
                                    
                                    if (response.ok) {
                                        console.log('Datos del proveedor actualizados exitosamente');
                                    } else {
                                        console.warn('No se pudieron actualizar algunos datos del proveedor');
                                    }
                                }
                            } catch (error) {
                                console.error('Error al actualizar datos del proveedor:', error);
                            }
                        }
                    } else {
                        document.getElementById('factura_id_proveedor').value = '';
                        document.getElementById('factura_proveedor_nuevo').disabled = false;
                    }
                });
            }
            
            // Si hay proveedores coincidentes y solo uno, seleccionarlo automáticamente
            if (proveedoresCoincidentes.length === 1 && selectProveedorExistente) {
                selectProveedorExistente.value = proveedoresCoincidentes[0].id_proveedor;
                selectProveedorExistente.dispatchEvent(new Event('change'));
            }
            
            // Aplicar valores iniciales basados en los datos extraídos
            aplicarValoresIniciales(datosExtraidos, entidadesDisponibles);
        }
        
        function aplicarMapeoCampo(campoSistema, idInput) {
            const select = document.getElementById(`mapeo_${campoSistema}`);
            const input = document.getElementById(idInput);
            
            // Verificar que ambos elementos existan antes de continuar
            if (!select || !input) return;
            
            const campoIA = select.value;
            
            if (!campoIA) return;
            
            // Obtener el valor del campo de la IA desde las entidades disponibles
            const entidadesDisponibles = window.entidadesDisponiblesFactura || {};
            const entidad = entidadesDisponibles[campoIA];
            
            if (entidad && entidad.ejemplo_valor) {
                let valor = entidad.ejemplo_valor;
                
                // Procesar según el tipo de campo
                if (campoSistema === 'fecha_pago') {
                    // Intentar convertir fecha a formato DD/MM/YYYY
                    // La fecha puede venir en diferentes formatos
                    const fechaMatch = valor.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
                    if (fechaMatch) {
                        const [, dia, mes, anio] = fechaMatch;
                        const anioCompleto = anio.length === 2 ? '20' + anio : anio;
                        valor = `${dia.padStart(2, '0')}/${mes.padStart(2, '0')}/${anioCompleto}`;
                    } else {
                        const fecha = new Date(valor);
                        if (!isNaN(fecha.getTime())) {
                            valor = fechaISOToEspanol(fecha.toISOString().split('T')[0]);
                        }
                    }
                } else if (campoSistema === 'base_imponible' || campoSistema === 'iva' || campoSistema === 'monto') {
                    // Limpiar y convertir montos
                    valor = valor.toString().replace(/[^\d.,]/g, '').replace(/\./g, '').replace(',', '.');
                    if (valor && !isNaN(parseFloat(valor))) {
                        valor = parseFloat(valor).toFixed(2);
                    } else {
                        valor = '';
                    }
                }
                
                input.value = valor;
                
                // Si es un campo numérico, disparar evento para recalcular totales
                if (campoSistema === 'base_imponible' || campoSistema === 'iva') {
                    input.dispatchEvent(new Event('input'));
                }
            }
        }
        
        function aplicarValoresIniciales(datosExtraidos, entidadesDisponibles) {
            // Aplicar valores iniciales basados en los datos extraídos
            if (datosExtraidos.numero_factura && Object.keys(entidadesDisponibles).length > 0) {
                const select = document.getElementById('mapeo_numero_factura');
                if (select) {
                    // Buscar el campo que contiene el número de factura
                    for (const [key, entidad] of Object.entries(entidadesDisponibles)) {
                        if (entidad.ejemplo_valor && entidad.ejemplo_valor.includes(datosExtraidos.numero_factura)) {
                            select.value = key;
                            aplicarMapeoCampo('numero_factura', 'factura_numero');
                            break;
                        }
                    }
                }
            }
            
            if (datosExtraidos.fecha_pago && Object.keys(entidadesDisponibles).length > 0) {
                const select = document.getElementById('mapeo_fecha_pago');
                if (select) {
                    // Buscar el campo que contiene la fecha (buscar por invoice_date o due_date)
                    for (const [key, entidad] of Object.entries(entidadesDisponibles)) {
                        if (key.toLowerCase().includes('date') && entidad.ejemplo_valor) {
                            select.value = key;
                            aplicarMapeoCampo('fecha_pago', 'factura_fecha');
                            break;
                        }
                    }
                }
            }
            
            // Aplicar valores numéricos si existen
            if (datosExtraidos.total && Object.keys(entidadesDisponibles).length > 0) {
                const select = document.getElementById('mapeo_base_imponible');
                if (select) {
                    // Buscar campo net_amount o subtotal
                    for (const [key, entidad] of Object.entries(entidadesDisponibles)) {
                        if ((key.toLowerCase().includes('net') || key.toLowerCase().includes('subtotal')) && entidad.ejemplo_valor) {
                            select.value = key;
                            aplicarMapeoCampo('base_imponible', 'factura_total');
                            break;
                        }
                    }
                }
            }
            
            if ((datosExtraidos.impuestos || datosExtraidos.iva) && Object.keys(entidadesDisponibles).length > 0) {
                const select = document.getElementById('mapeo_iva');
                if (select) {
                    // Buscar campo vat o tax
                    for (const [key, entidad] of Object.entries(entidadesDisponibles)) {
                        if ((key.toLowerCase().includes('vat') || key.toLowerCase().includes('tax')) && entidad.ejemplo_valor) {
                            select.value = key;
                            aplicarMapeoCampo('impuestos', 'factura_impuestos');
                            break;
                        }
                    }
                }
            }
            
            if ((datosExtraidos.monto || datosExtraidos.total_con_impuestos) && Object.keys(entidadesDisponibles).length > 0) {
                const select = document.getElementById('mapeo_total');
                if (select) {
                    // Buscar campo total_amount
                    for (const [key, entidad] of Object.entries(entidadesDisponibles)) {
                        if (key.toLowerCase().includes('total') && entidad.ejemplo_valor) {
                            select.value = key;
                            aplicarMapeoCampo('monto', 'factura_total_impuestos');
                            break;
                        }
                    }
                }
            }
        }
        
        async function crearProveedorDesdeFactura() {
            const nombreProveedor = document.getElementById('factura_proveedor_nuevo').value.trim();
            const idResidencia = document.getElementById('factura_residencia').value;
            
            if (!nombreProveedor) {
                alert('Por favor ingrese el nombre del proveedor');
                return;
            }
            
            if (!idResidencia) {
                alert('Por favor seleccione una residencia primero');
                return;
            }
            
            // Obtener datos adicionales extraídos de la factura
            const datosExtraidos = window.facturaProcesadaDatos?.datosExtraidos || {};
            
            // Cerrar el modal de procesar factura temporalmente
            closeModal('modalProcesarFactura');
            
            // Abrir el modal de proveedor y prellenarlo con los datos
            await resetProveedorForm();
            
            // Prellenar el formulario con los datos extraídos
            document.getElementById('prov_id_residencia').value = idResidencia;
            document.getElementById('prov_nombre').value = nombreProveedor;
            if (datosExtraidos.proveedor_nif) {
                document.getElementById('prov_nif_cif').value = datosExtraidos.proveedor_nif;
            }
            if (datosExtraidos.proveedor_telefono) {
                document.getElementById('prov_telefono').value = datosExtraidos.proveedor_telefono;
            }
            if (datosExtraidos.proveedor_email) {
                document.getElementById('prov_email').value = datosExtraidos.proveedor_email;
            }
            if (datosExtraidos.proveedor_direccion) {
                document.getElementById('prov_direccion').value = datosExtraidos.proveedor_direccion;
            }
            
            // Guardar referencia para cuando se guarde el proveedor
            window.proveedorDesdeFactura = {
                nombre: nombreProveedor,
                idResidencia: idResidencia
            };
            
            // Abrir modal de proveedor
            openModal('modalProveedor');
        }
        
        async function guardarFacturaProcesada(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = form.querySelector('button[type="submit"]');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            const id_proveedor = document.getElementById('factura_id_proveedor').value;
            const proveedor_nuevo = document.getElementById('factura_proveedor_nuevo').value.trim();
            
            // Validar que hay un proveedor seleccionado o un nombre para crear uno nuevo
            if (!id_proveedor && !proveedor_nuevo) {
                alert('Debe seleccionar un proveedor existente o crear uno nuevo');
                return;
            }
            
            // Si hay un proveedor nuevo pero no se ha creado, verificar si ya se creó desde el modal
            let idProveedorFinal = id_proveedor;
            if (!idProveedorFinal && proveedor_nuevo) {
                // Si el proveedor ya se creó desde el modal, usar ese ID
                const facturaIdProveedor = document.getElementById('factura_id_proveedor');
                if (facturaIdProveedor && facturaIdProveedor.value) {
                    idProveedorFinal = facturaIdProveedor.value;
                } else {
                    // Si no se ha creado, mostrar error
                    alert('Por favor, cree el proveedor usando el botón "+ Crear Proveedor" para verificar los datos antes de guardar la factura');
                    return;
                }
            }
            
            // Obtener nombre del proveedor
            let nombreProveedor = proveedor_nuevo;
            if (idProveedorFinal) {
                const selectProveedorExistente = document.getElementById('factura_proveedor_existente');
                if (selectProveedorExistente && selectProveedorExistente.value === idProveedorFinal) {
                    nombreProveedor = selectProveedorExistente.options[selectProveedorExistente.selectedIndex].text.split(' - ')[0];
                } else {
                    // Buscar el proveedor por ID
                    try {
                        const proveedorResponse = await fetch(`${API_URL}/api/v1/proveedores/${idProveedorFinal}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        if (proveedorResponse.ok) {
                            const proveedorData = await proveedorResponse.json();
                            nombreProveedor = proveedorData.nombre || proveedor_nuevo;
                        } else {
                            // Si no se encuentra el proveedor, usar el nombre nuevo
                            console.warn(`Proveedor ${idProveedorFinal} no encontrado, usando nombre nuevo: ${proveedor_nuevo}`);
                            nombreProveedor = proveedor_nuevo;
                        }
                    } catch (error) {
                        console.error('Error al obtener proveedor:', error);
                        // En caso de error, usar el nombre nuevo
                        nombreProveedor = proveedor_nuevo;
                    }
                }
            }
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                alert('Debe seleccionar una residencia');
                return;
            }
            
            const fecha_pago = formData.get('fecha_pago');
            if (!fecha_pago) {
                alert('Debe ingresar la fecha de pago');
                return;
            }
            
            const concepto = formData.get('concepto');
            if (!concepto || concepto.trim() === '') {
                alert('Debe ingresar un concepto para el pago');
                return;
            }
            
            const id_receiver = formData.get('id_receiver');
            
            const data = {
                proveedor: nombreProveedor,
                concepto: formData.get('concepto'),
                monto: formData.get('monto') ? parseFloat(formData.get('monto')) : null,
                id_residencia: parseInt(id_residencia),
                id_receiver: id_receiver ? parseInt(id_receiver) : null,
                fecha_pago: fecha_pago,
                metodo_pago: formData.get('metodo_pago') || null,
                numero_factura: formData.get('numero_factura') || null,
                estado: 'pagado', // Si tiene fecha_pago, está pagado
                factura_blob_path: window.facturaProcesadaDatos?.blobPath || null
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/proveedores`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Verificar si el pago está fuera del rango visible
                    const fechaPago = new Date(fecha_pago);
                    const hoy = new Date();
                    const primerDiaMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                    
                    let mensaje = '✅ Pago guardado exitosamente';
                    if (fechaPago < primerDiaMesAnterior) {
                        const fechaFormateada = fechaPago.toLocaleDateString('es-ES', { year: 'numeric', month: 'long' });
                        mensaje += `\n\n⚠️ La factura es de ${fechaFormateada}, por lo que no aparecerá en el listado actual.\n\nPara verla, ve al módulo "Históricos" o ajusta los filtros de fecha.`;
                    }
                    
                    alert(mensaje);
                    closeModal('modalProcesarFactura');
                    // Recargar la sección de facturación
                    if (typeof loadFacturacion === 'function') {
                        loadFacturacion();
                    }
                    // Limpiar variables globales
                    window.facturaProcesadaDatos = null;
                    window.facturaProcesadaBlobPath = null;
                } else {
                    alert(result.error || 'Error al guardar el pago');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error al guardar pago:', error);
                alert('Error de conexión al guardar el pago');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }
        
        function toggleTextoCompleto() {
            const container = document.getElementById('textoCompletoContainer');
            const icon = document.getElementById('toggleTextoIcon');
            if (container) {
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    if (icon) icon.textContent = '▲';
                } else {
                    container.style.display = 'none';
                    if (icon) icon.textContent = '▼';
                }
            }
        }
        
        function usarDatosExtraidos(datos, blobPath, idResidenciaDetectada) {
            // Cerrar modal de procesamiento
            closeModal('modalProcesarFactura');
            
            // Guardar blob_path en una variable global para usarlo al guardar el pago
            window.facturaProcesadaBlobPath = blobPath || null;
            
            // Abrir modal de pago proveedor
            setTimeout(async () => {
                resetPagoProveedorForm();
                
                // Si se detectó una residencia automáticamente, seleccionarla
                if (idResidenciaDetectada) {
                    // Cargar residencias y seleccionar la detectada
                    await loadResidenciasIntoSelect('pago_id_residencia', idResidenciaDetectada);
                } else {
                    await loadResidenciasIntoSelect('pago_id_residencia');
                }
                
                openModal('modalPagoProveedor');
                
                // Rellenar campos con los datos extraídos (solo campos relevantes)
                if (datos.numero_factura) {
                    document.getElementById('pago_numero_factura').value = datos.numero_factura;
                }
                // El monto se calcula desde base_imponible + iva_monto, no se establece directamente
                if (datos.fecha_pago) {
                    // Convertir fecha ISO a formato español para el input
                    const fecha = new Date(datos.fecha_pago);
                    const fechaEsp = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    document.getElementById('pago_fecha_pago').value = fechaEsp;
                }
                if (datos.concepto) {
                    document.getElementById('pago_concepto').value = datos.concepto;
                }
                if (datos.proveedor) {
                    // Intentar buscar y seleccionar el proveedor si existe
                    const proveedorSelect = document.getElementById('pago_id_proveedor');
                    if (proveedorSelect) {
                        // Cargar proveedores de la residencia seleccionada primero
                        const residenciaSelect = document.getElementById('pago_id_residencia');
                        if (residenciaSelect && residenciaSelect.value) {
                            await loadProveedoresForSelect(residenciaSelect.value);
                        }
                        
                        // Buscar opción que contenga el nombre del proveedor
                        for (let option of proveedorSelect.options) {
                            if (option.text.toLowerCase().includes(datos.proveedor.toLowerCase())) {
                                proveedorSelect.value = option.value;
                                break;
                            }
                        }
                    }
                }
                
                // Mostrar mensaje de éxito
                const mensaje = idResidenciaDetectada 
                    ? `Residencia "${datos.nombre_residencia_detectada || 'detectada'}" seleccionada automáticamente. Datos extraídos aplicados. El PDF de la factura se asociará automáticamente al guardar.`
                    : 'Datos extraídos aplicados. El PDF de la factura se asociará automáticamente al guardar. Por favor, complete los campos faltantes.';
                showPagoProveedorModalSuccess(mensaje);
            }, 300);
        }
        
        async function abrirModalListaProveedores() {
            const token = localStorage.getItem('violetas_token');
            const content = document.getElementById('listaProveedoresContent');
            
            // Mostrar loading
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 15px; color: #666;">Cargando proveedores...</p>
                </div>
            `;
            
            // Abrir modal
            openModal('modalListaProveedores');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/proveedores`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    content.innerHTML = `<p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${response.status}</p>`;
                    return;
                }
                
                if (response.ok && data.proveedores) {
                    if (data.proveedores.length > 0) {
                        // Cargar residencias para obtener nombres
                        let residenciasMap = {};
                        try {
                            const residenciasResponse = await fetch(`${API_URL}/api/v1/residencias`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (residenciasResponse.ok) {
                                const residenciasData = await residenciasResponse.json();
                                residenciasData.residencias.forEach(res => {
                                    residenciasMap[res.id_residencia] = res.nombre;
                                });
                            }
                        } catch (error) {
                            console.error('Error al cargar residencias:', error);
                        }
                        
                        // Agrupar proveedores por residencia
                        const proveedoresPorResidencia = {};
                        data.proveedores.forEach(prov => {
                            if (!prov.id_proveedor) {
                                console.error('Proveedor sin id_proveedor:', prov);
                                return;
                            }
                            const residenciaId = prov.id_residencia || 1;
                            if (!proveedoresPorResidencia[residenciaId]) {
                                proveedoresPorResidencia[residenciaId] = [];
                            }
                            proveedoresPorResidencia[residenciaId].push(prov);
                        });
                        
                        // Ordenar proveedores por nombre dentro de cada residencia
                        Object.keys(proveedoresPorResidencia).forEach(residenciaId => {
                            proveedoresPorResidencia[residenciaId].sort((a, b) => {
                                const nombreA = (a.nombre || '').toLowerCase();
                                const nombreB = (b.nombre || '').toLowerCase();
                                return nombreA.localeCompare(nombreB);
                            });
                        });
                        
                        let html = `
                            <div style="margin-bottom: 20px;">
                                <p style="color: #666; margin-bottom: 15px;">Total de proveedores: <strong>${data.proveedores.length}</strong></p>
                                <button class="add-btn" onclick="sessionStorage.setItem('modalListaProveedoresAbierto', 'true'); closeModal('modalListaProveedores'); resetProveedorForm(); setTimeout(() => openModal('modalProveedor'), 100);" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 14px;"><img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 16px; height: 16px; filter: brightness(0) invert(1);"> Agregar Proveedor</button>
                            </div>
                        `;
                        
                        // Colores para diferentes residencias
                        const coloresResidencias = {
                            1: '#667eea',
                            2: '#48bb78'
                        };
                        
                        // Mostrar proveedores agrupados por residencia
                        Object.keys(proveedoresPorResidencia).sort((a, b) => parseInt(a) - parseInt(b)).forEach(residenciaId => {
                            const proveedoresResidencia = proveedoresPorResidencia[residenciaId];
                            const nombreResidencia = residenciasMap[residenciaId] || `Residencia ${residenciaId}`;
                            const color = coloresResidencias[residenciaId] || '#718096';
                            
                            html += `
                                <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid ${color};">
                                    <h4 style="color: ${color}; margin-bottom: 15px; font-size: 18px; font-weight: 600;">
                                        <img src="/static/icons/medical/hospital.svg" alt="Residencia" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"> 
                                        ${nombreResidencia} (${proveedoresResidencia.length})
                                    </h4>
                                    <div style="overflow-x: auto;">
                                        <table class="data-table" style="width: 100%; table-layout: auto;">
                                            <thead>
                                                <tr>
                                                    <th style="width: 22%;">Nombre</th>
                                                    <th style="width: 16%;">Tipo de Servicio</th>
                                                    <th style="width: 13%;">Teléfono</th>
                                                    <th style="width: 24%;">Email</th>
                                                    <th style="width: 17%;">Contacto</th>
                                                    <th style="width: 8%; text-align: center;">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                            `;
                            
                            proveedoresResidencia.forEach(prov => {
                                const estado = prov.activo ? 
                                    '<img src="/static/icons/medical/check-circle.svg" alt="Activo" style="width: 16px; height: 16px; vertical-align: middle;">' :
                                    '<img src="/static/icons/medical/alert-circle.svg" alt="Inactivo" style="width: 16px; height: 16px; vertical-align: middle;">';
                                
                                html += `
                                    <tr style="cursor: pointer;" onclick="editarProveedor(${prov.id_proveedor})" title="Haz clic para editar">
                                        <td style="color: #333; font-weight: 600;">${prov.nombre || '-'}</td>
                                        <td style="color: #333;">${prov.tipo_servicio || '-'}</td>
                                        <td style="color: #333;">${prov.telefono || '-'}</td>
                                        <td style="color: #333; overflow: hidden; text-overflow: ellipsis;">${prov.email || '-'}</td>
                                        <td style="color: #333;">${prov.contacto || '-'}</td>
                                        <td style="text-align: center;">${estado}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                            </tbody>
                                            <tfoot>
                                                <tr style="background: white; font-weight: 600;">
                                                    <td colspan="6" style="padding: 10px; text-align: right; color: ${color}; border-top: 2px solid #e0e0e0;">
                                                        Total: ${proveedoresResidencia.length}
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            `;
                        });
                        
                        content.innerHTML = html;
                    } else {
                        content.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 40px;">No hay proveedores registrados.</p>';
                    }
                } else {
                    content.innerHTML = `<p style="color: red;">Error (${response.status}): ${data.error || 'Error desconocido'}</p>`;
                }
            } catch (error) {
                console.error('Error de conexión al cargar proveedores:', error);
                content.innerHTML = `<p style="color: red;">Error de conexión: ${error.message}</p>`;
            }
        }

        async function saveProveedor(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveProveedorBtn');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            const activoCheckbox = document.getElementById('prov_activo');
            
            const data = {
                nombre: formData.get('nombre'),
                nif_cif: formData.get('nif_cif') || null,
                direccion: formData.get('direccion') || null,
                telefono: formData.get('telefono') || null,
                email: formData.get('email') || null,
                contacto: formData.get('contacto') || null,
                tipo_servicio: formData.get('tipo_servicio') || null,
                activo: activoCheckbox ? activoCheckbox.checked : true,
                observaciones: formData.get('observaciones') || null
            };
            
            // Agregar id_residencia - siempre requerido
            let id_residencia = formData.get('id_residencia');
            if (!id_residencia || id_residencia === '') {
                // Si no hay id_residencia en el formulario, usar 1 por defecto
                // (para super_admin debe especificarse, pero si no se especifica usamos 1)
                id_residencia = 1;
            }
            data.id_residencia = parseInt(id_residencia);
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideProveedorModalAlert();
            
            const idProveedor = document.getElementById('prov_id_proveedor').value;
            const method = idProveedor ? 'PUT' : 'POST';
            const url = idProveedor ? `${API_URL}/api/v1/proveedores/${idProveedor}` : `${API_URL}/api/v1/proveedores`;
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showProveedorModalSuccess(idProveedor ? 'Proveedor actualizado exitosamente' : 'Proveedor agregado exitosamente');
                    // Restablecer el botón antes de cerrar el modal
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    
                    // Si se creó desde el modal de factura, actualizar el campo y volver al modal de factura
                    if (window.proveedorDesdeFactura && !idProveedor) {
                        const idProveedorCreado = result.id_proveedor;
                        setTimeout(() => {
                            closeModal('modalProveedor');
                            // Actualizar el campo de proveedor en el formulario de factura
                            const facturaIdProveedor = document.getElementById('factura_id_proveedor');
                            const facturaProveedorNuevo = document.getElementById('factura_proveedor_nuevo');
                            if (facturaIdProveedor) {
                                facturaIdProveedor.value = idProveedorCreado;
                            }
                            if (facturaProveedorNuevo) {
                                facturaProveedorNuevo.value = result.nombre || window.proveedorDesdeFactura.nombre;
                                facturaProveedorNuevo.disabled = true;
                            }
                            // Limpiar la referencia
                            delete window.proveedorDesdeFactura;
                            // Volver a abrir el modal de factura
                            setTimeout(() => {
                                openModal('modalProcesarFactura');
                            }, 100);
                        }, 1000);
                        return;
                    }
                    
                    // Guardar si el modal de pago estaba abierto antes de abrir el de proveedor
                    const modalPagoEstabaAbierto = sessionStorage.getItem('modalPagoAbierto') === 'true';
                    const modalListaEstabaAbierto = document.getElementById('modalListaProveedores').style.display === 'block';
                    
                    setTimeout(() => {
                        closeModal('modalProveedor');
                        // Si el modal de pago estaba abierto, volver a abrirlo y recargar proveedores
                        if (modalPagoEstabaAbierto) {
                            setTimeout(async () => {
                                await loadProveedoresForSelect();
                                openModal('modalPagoProveedor');
                                sessionStorage.removeItem('modalPagoAbierto');
                            }, 100);
                        }
                        // Si el modal de lista estaba abierto, recargarlo
                        if (modalListaEstabaAbierto || sessionStorage.getItem('modalListaProveedoresAbierto') === 'true') {
                            sessionStorage.removeItem('modalListaProveedoresAbierto');
                            setTimeout(async () => {
                                await abrirModalListaProveedores();
                            }, 100);
                        }
                        // Recargar proveedores en el select si existe y hay residencia seleccionada
                        const selectResidencia = document.getElementById('pago_id_residencia');
                        const selectProveedor = document.getElementById('pago_id_proveedor');
                        if (selectResidencia && selectProveedor && selectResidencia.value) {
                            loadProveedoresForSelect(selectResidencia.value);
                        }
                    }, 1500);
                } else {
                    showProveedorModalError(result.error || 'Error al guardar el proveedor');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error al guardar proveedor:', error);
                showProveedorModalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        async function editarProveedor(idProveedor) {
            console.log('editarProveedor llamado con id:', idProveedor);
            
            if (!idProveedor) {
                console.error('idProveedor no está definido');
                showProveedorModalError('Error: ID de proveedor no válido');
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            if (!token) {
                showProveedorModalError('No hay sesión activa. Por favor, inicia sesión nuevamente.');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/v1/proveedores/${idProveedor}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Respuesta del servidor:', response.status);
                
                const contentType = response.headers.get('content-type');
                let proveedor;
                
                if (contentType && contentType.includes('application/json')) {
                    proveedor = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON al obtener proveedor:', text);
                    showProveedorModalError(`Error: No se pudo obtener el proveedor. Status: ${response.status}`);
                    return;
                }
                
                if (response.ok) {
                    console.log('Proveedor obtenido:', proveedor);
                    
                    // Cargar residencias antes de llenar el formulario
                    await loadResidenciasIntoSelect('prov_id_residencia', proveedor.id_residencia);
                    
                    // Llenar el formulario con los datos del proveedor
                    const idProveedorInput = document.getElementById('prov_id_proveedor');
                    if (!idProveedorInput) {
                        console.error('No se encontró el campo prov_id_proveedor');
                        showProveedorModalError('Error: No se pudo encontrar el formulario de edición');
                        return;
                    }
                    
                    idProveedorInput.value = proveedor.id_proveedor;
                    document.getElementById('prov_id_residencia').value = proveedor.id_residencia || '';
                    document.getElementById('prov_nombre').value = proveedor.nombre || '';
                    document.getElementById('prov_nif_cif').value = proveedor.nif_cif || '';
                    document.getElementById('prov_tipo_servicio').value = proveedor.tipo_servicio || '';
                    document.getElementById('prov_telefono').value = proveedor.telefono || '';
                    document.getElementById('prov_email').value = proveedor.email || '';
                    document.getElementById('prov_direccion').value = proveedor.direccion || '';
                    document.getElementById('prov_contacto').value = proveedor.contacto || '';
                    document.getElementById('prov_observaciones').value = proveedor.observaciones || '';
                    document.getElementById('prov_activo').checked = proveedor.activo !== false;
                    
                    // Cambiar título del modal
                    const modalHeader = document.querySelector('#modalProveedor .modal-header h2');
                    if (modalHeader) {
                        modalHeader.innerHTML = '<img src="/static/icons/medical/settings.svg" alt="Editar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Editar Proveedor';
                    }
                    
                    // Mostrar botón de dar de baja si el proveedor está activo
                    const bajaBtn = document.getElementById('bajaProveedorBtn');
                    if (bajaBtn) {
                        if (proveedor.activo) {
                            bajaBtn.style.display = 'block';
                            bajaBtn.onclick = () => abrirModalBajaProveedor(proveedor.id_proveedor);
                        } else {
                            bajaBtn.style.display = 'none';
                        }
                    }
                    
                    // Cerrar el modal de lista si está abierto
                    closeModal('modalListaProveedores');
                    
                    // Abrir modal de edición (sin resetear porque ya llenamos los campos)
                    document.getElementById('modalProveedor').style.display = 'block';
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        showProveedorModalError('Sesión expirada. Por favor, recarga la página para iniciar sesión nuevamente.');
                        localStorage.removeItem('violetas_token');
                    } else if (response.status === 404) {
                        showProveedorModalError('El proveedor no se encontró. Puede que haya sido eliminado o no tengas permisos para verlo.');
                        console.error('Proveedor no encontrado:', proveedor.error || 'Error desconocido');
                    } else {
                        showProveedorModalError('Error al obtener el proveedor: ' + (proveedor.error || `Error ${response.status}`));
                        console.error('Error al obtener proveedor:', response.status, proveedor);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al obtener proveedor:', error);
                showProveedorModalError('Error de conexión: ' + error.message + '. Verifica que el servidor esté corriendo.');
            }
        }

        // Variable para almacenar la ruta del archivo de factura procesado
        let facturaProcesadaPath = null;
        
        function actualizarNombreArchivo() {
            const archivoInput = document.getElementById('pago_factura_archivo');
            const textoArchivo = document.getElementById('pago_factura_texto');
            
            if (archivoInput && archivoInput.files && archivoInput.files.length > 0) {
                const archivo = archivoInput.files[0];
                textoArchivo.textContent = archivo.name;
                textoArchivo.style.color = '#333';
            } else {
                textoArchivo.textContent = 'Seleccionar archivo PDF...';
                textoArchivo.style.color = '#667eea';
            }
        }
        
        function actualizarNombreArchivoManual() {
            const archivoInput = document.getElementById('pago_factura_archivo_manual');
            const textoArchivo = document.getElementById('pago_factura_texto_manual');
            if (archivoInput && archivoInput.files && archivoInput.files.length > 0) {
                const archivo = archivoInput.files[0];
                // Si hay un archivo nuevo, limpiar el atributo de blob_path actual
                archivoInput.removeAttribute('data-blob-path-actual');
                textoArchivo.innerHTML = `
                    <div style="color: #333; font-weight: 500; font-size: 14px;">${archivo.name}</div>
                    <div style="color: #999; font-size: 12px; margin-top: 2px;">Nuevo archivo seleccionado</div>
                `;
            } else {
                // Si no hay archivo nuevo, restaurar el texto por defecto o mantener el actual
                const blobPathActual = archivoInput ? archivoInput.getAttribute('data-blob-path-actual') : null;
                if (!blobPathActual) {
                    textoArchivo.innerHTML = 'Seleccionar archivo PDF...';
                }
            }
        }
        
        async function eliminar_factura_pago() {
            const idPago = document.getElementById('pago_id_pago')?.value;
            
            if (!idPago) {
                alert('No se puede eliminar: no hay pago seleccionado');
                return;
            }
            
            if (!confirm('¿Está seguro de que desea eliminar completamente este pago a proveedor? Esta acción eliminará TODOS los datos del registro de la base de datos, incluyendo la factura. Esta acción NO se puede deshacer.')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            if (!token) {
                alert('No hay sesión activa. Por favor, inicia sesión nuevamente.');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/proveedores/${idPago}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Pago a proveedor eliminado exitosamente');
                    closeModal('modalPagoProveedor');
                    // Recargar la sección de facturación
                    if (typeof loadFacturacion === 'function') {
                        loadFacturacion();
                    }
                } else {
                    alert(result.error || 'Error al eliminar el pago');
                }
            } catch (error) {
                console.error('Error al eliminar pago:', error);
                alert('Error de conexión al eliminar el pago');
            }
        }
        
        // Calcular IVA automáticamente cuando cambian base imponible o porcentaje
        function calcularIVA() {
            const baseImponible = parseFloat(document.getElementById('pago_base_imponible').value) || 0;
            const ivaPorcentaje = parseFloat(document.getElementById('pago_iva').value) || 0;
            const ivaMonto = (baseImponible * ivaPorcentaje) / 100;
            
            document.getElementById('pago_iva_monto').value = ivaMonto.toFixed(2);
            
            // El monto se calculará automáticamente desde base_imponible + iva_monto al guardar
        }
        
        async function procesarFactura() {
            const token = localStorage.getItem('violetas_token');
            const archivoInput = document.getElementById('pago_factura_archivo');
            const archivo = archivoInput.files[0];
            const btnProcesar = document.getElementById('btnProcesarFactura');
            const facturaInfo = document.getElementById('pago_factura_info');
            const facturaNombre = document.getElementById('pago_factura_nombre');
            
            if (!archivo) {
                alert('Por favor seleccione un archivo PDF');
                return;
            }
            
            // Validar que sea PDF
            if (archivo.type !== 'application/pdf' && !archivo.name.toLowerCase().endsWith('.pdf')) {
                alert('Por favor seleccione un archivo PDF');
                return;
            }
            
            // Validar tamaño (máximo 10MB)
            if (archivo.size > 10 * 1024 * 1024) {
                alert('El archivo es demasiado grande. Máximo 10MB');
                return;
            }
            
            const originalText = btnProcesar.innerHTML;
            btnProcesar.disabled = true;
            btnProcesar.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Procesando...';
            
            try {
                const formData = new FormData();
                formData.append('factura', archivo);
                
                // Obtener id_residencia si está disponible
                const idResidencia = document.getElementById('pago_id_residencia').value;
                if (idResidencia) {
                    formData.append('id_residencia', idResidencia);
                }
                
                const response = await fetch(`${API_URL}/api/v1/facturacion/procesar-factura`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                console.log('Respuesta del servidor:', result);
                
                if (response.ok) {
                    // Guardar la ruta del archivo para enviarla al guardar el pago
                    facturaProcesadaPath = result.blob_path;
                    
                    // Mostrar información de la factura procesada
                    facturaNombre.textContent = archivo.name;
                    facturaInfo.style.display = 'block';
                    
                    // Rellenar campos con datos extraídos
                    const datos = result.datos_extraidos || {};
                    console.log('Datos extraídos recibidos:', datos);
                    
                    let camposRellenados = [];
                    
                    if (datos.monto) {
                        // El monto se calcula desde base_imponible + iva_monto
                        if (datos.monto) {
                            camposRellenados.push(`Monto total: ${datos.monto}€`);
                        }
                    }
                    
                    if (datos.numero_factura) {
                        document.getElementById('pago_numero_factura').value = datos.numero_factura;
                        camposRellenados.push(`Número: ${datos.numero_factura}`);
                    }
                    
                    if (datos.fecha_factura) {
                        // Convertir fecha ISO a formato español si es necesario
                        let fecha = datos.fecha_factura;
                        if (fecha.includes('T')) {
                            fecha = fecha.split('T')[0];
                        }
                        const partes = fecha.split('-');
                        if (partes.length === 3) {
                            document.getElementById('pago_fecha_pago').value = `${partes[2]}/${partes[1]}/${partes[0]}`;
                            camposRellenados.push(`Fecha: ${partes[2]}/${partes[1]}/${partes[0]}`);
                        }
                    }
                    
                    if (datos.concepto) {
                        document.getElementById('pago_concepto').value = datos.concepto;
                        camposRellenados.push(`Concepto: ${datos.concepto}`);
                    }
                    
                    // Mostrar mensaje de éxito con información de qué se rellenó
                    if (camposRellenados.length > 0) {
                        showPagoProveedorModalSuccess(`Factura procesada exitosamente. Campos rellenados: ${camposRellenados.join(', ')}`);
                    } else {
                        showPagoProveedorModalSuccess('Factura subida exitosamente. No se pudieron extraer datos automáticamente. Por favor, completa los campos manualmente.');
                    }
                } else {
                    console.error('Error en respuesta:', result);
                    showPagoProveedorModalError(result.error || 'Error al procesar la factura');
                }
            } catch (error) {
                console.error('Error al procesar factura:', error);
                showPagoProveedorModalError('Error de conexión: ' + error.message);
            } finally {
                btnProcesar.disabled = false;
                btnProcesar.innerHTML = originalText;
            }
        }
        
        async function savePagoProveedor(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('savePagoProveedorBtn');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            const id_proveedor = formData.get('id_proveedor');
            
            if (!id_proveedor) {
                showPagoProveedorModalError('Debe seleccionar un proveedor');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Obtener nombre del proveedor del select
            const selectProveedor = document.getElementById('pago_id_proveedor');
            const nombreProveedor = selectProveedor.options[selectProveedor.selectedIndex].text.split(' - ')[0];
            
            // Obtener fechas (type="date" devuelve YYYY-MM-DD)
            const fecha_pago = formData.get('fecha_pago');
            const fecha_prevista = formData.get('fecha_prevista');
            
            // LÓGICA SIMPLE: Si hay fecha de pago → pagado. Si hay fecha prevista → pendiente
            const estado = fecha_pago ? 'pagado' : 'pendiente';
            
            const idPago = document.getElementById('pago_id_pago').value;
            const method = idPago ? 'PUT' : 'POST';
            const url = idPago ? `${API_URL}/api/v1/facturacion/proveedores/${idPago}` : `${API_URL}/api/v1/facturacion/proveedores`;
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showPagoProveedorModalError('Debe seleccionar una residencia');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Verificar si hay un archivo de factura para subir
            const archivoFactura = document.getElementById('pago_factura_archivo_manual');
            const tieneArchivoNuevo = archivoFactura && archivoFactura.files && archivoFactura.files.length > 0;
            const blobPathActual = archivoFactura ? archivoFactura.getAttribute('data-blob-path-actual') : null;
            const eliminarFactura = archivoFactura ? archivoFactura.getAttribute('data-eliminar-factura') === 'true' : false;
            
            // Si hay archivo nuevo (tanto para crear como para editar), usar FormData para multipart
            if (tieneArchivoNuevo) {
                // Calcular monto desde base_imponible + iva_monto
                const baseImponibleMultipart = parseFloat(formData.get('base_imponible')) || 0;
                const ivaMontoMultipart = parseFloat(formData.get('iva_monto')) || 0;
                const totalConImpuestosMultipart = parseFloat(formData.get('total_con_impuestos')) || 0;
                const montoCalculadoMultipart = totalConImpuestosMultipart > 0 ? totalConImpuestosMultipart : (baseImponibleMultipart + ivaMontoMultipart);
                const montoFinalMultipart = montoCalculadoMultipart > 0 ? montoCalculadoMultipart : baseImponibleMultipart;
                
                const formDataMultipart = new FormData();
                formDataMultipart.append('proveedor', nombreProveedor);
                formDataMultipart.append('concepto', formData.get('concepto'));
                formDataMultipart.append('monto', montoFinalMultipart > 0 ? montoFinalMultipart : '');
                formDataMultipart.append('id_residencia', id_residencia);
                if (fecha_pago) formDataMultipart.append('fecha_pago', fecha_pago);
                if (fecha_prevista) formDataMultipart.append('fecha_prevista', fecha_prevista);
                if (formData.get('fecha_emision')) formDataMultipart.append('fecha_emision', formData.get('fecha_emision'));
                if (formData.get('fecha_vencimiento')) formDataMultipart.append('fecha_vencimiento', formData.get('fecha_vencimiento'));
                if (formData.get('metodo_pago')) formDataMultipart.append('metodo_pago', formData.get('metodo_pago'));
                if (formData.get('numero_factura')) formDataMultipart.append('numero_factura', formData.get('numero_factura'));
                formDataMultipart.append('estado', estado);
                if (formData.get('observaciones')) formDataMultipart.append('observaciones', formData.get('observaciones'));
                formDataMultipart.append('factura', archivoFactura.files[0]);
                
                saveBtn.disabled = true;
                saveBtn.textContent = 'Guardando...';
                hidePagoProveedorModalAlert();
                
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${token}`
                            // No incluir Content-Type, el navegador lo añadirá automáticamente con el boundary
                        },
                        body: formDataMultipart
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        // Limpiar factura procesada después de guardar
                        facturaProcesadaPath = null;
                        if (archivoFactura) {
                            archivoFactura.value = '';
                            archivoFactura.removeAttribute('data-blob-path-actual');
                        }
                        const facturaTexto = document.getElementById('pago_factura_texto_manual');
                        if (facturaTexto) {
                            facturaTexto.innerHTML = 'Seleccionar archivo PDF...';
                        }
                        
                        showPagoProveedorModalSuccess(idPago ? 'Pago a proveedor actualizado exitosamente' : 'Pago a proveedor registrado exitosamente');
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                        setTimeout(() => {
                            closeModal('modalPagoProveedor');
                            loadFacturacion(); // Recargar la lista
                        }, 1500);
                    } else {
                        showPagoProveedorModalError(result.error || 'Error al guardar el pago');
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                    }
                } catch (error) {
                    console.error('Error al guardar pago:', error);
                    showPagoProveedorModalError('Error de conexión: ' + error.message);
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
                return;
            }
            
            // Si no hay archivo nuevo, usar JSON normal
            const data = {
                proveedor: nombreProveedor,
                concepto: formData.get('concepto'),
                monto: formData.get('monto') ? parseFloat(formData.get('monto')) : null,
                id_residencia: parseInt(id_residencia),
                fecha_pago: fecha_pago || null,
                fecha_prevista: fecha_prevista || null,
                fecha_emision: formData.get('fecha_emision') || null,
                fecha_vencimiento: formData.get('fecha_vencimiento') || null,
                metodo_pago: formData.get('metodo_pago') || null,
                numero_factura: formData.get('numero_factura') || null,
                estado: estado,
                observaciones: formData.get('observaciones') || null
            };
            
            // Manejar factura_blob_path
            if (eliminarFactura) {
                // Si se marca para eliminar la factura, enviar null explícitamente
                data.factura_blob_path = null;
            } else if (idPago && blobPathActual && !tieneArchivoNuevo) {
                // Si es edición y no hay archivo nuevo, mantener el blob_path actual si existe
                data.factura_blob_path = blobPathActual;
            } else if (facturaProcesadaPath) {
                // Si viene de procesar factura
                data.factura_blob_path = facturaProcesadaPath;
            } else if (window.facturaProcesadaDatos?.blobPath) {
                // Si viene de procesar factura (usando la variable global)
                data.factura_blob_path = window.facturaProcesadaDatos.blobPath;
            }
            
            // Limpiar valores vacíos, pero mantener factura_blob_path si es null (para eliminar)
            Object.keys(data).forEach(key => {
                if (data[key] === '' || (data[key] === null && key !== 'factura_blob_path')) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hidePagoProveedorModalAlert();
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Limpiar factura procesada después de guardar
                    facturaProcesadaPath = null;
                    document.getElementById('pago_factura_archivo').value = '';
                    document.getElementById('pago_factura_info').style.display = 'none';
                    
                    showPagoProveedorModalSuccess(idPago ? 'Pago a proveedor actualizado exitosamente' : 'Pago a proveedor registrado exitosamente');
                    // Restablecer el botón antes de cerrar el modal
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    setTimeout(() => {
                        closeModal('modalPagoProveedor');
                        loadFacturacion(); // Recargar la lista
                    }, 1500);
                } else {
                    showPagoProveedorModalError(result.error || 'Error al guardar el pago');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showPagoProveedorModalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        async function editarPagoProveedor(idPago) {
            const token = localStorage.getItem('violetas_token');
            
            if (!idPago) {
                console.error('idPago no está definido');
                showPagoProveedorModalError('Error: ID de pago no válido');
                return;
            }
            
            if (!token) {
                showPagoProveedorModalError('No hay sesión activa. Por favor, inicia sesión nuevamente.');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/proveedores/${idPago}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let pago;
                
                if (contentType && contentType.includes('application/json')) {
                    pago = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON al obtener pago:', text);
                    showPagoProveedorModalError(`Error: No se pudo obtener el pago. Status: ${response.status}`);
                    return;
                }
                
                if (response.ok) {
                    // Guardar el ID y nombre del proveedor antes de cargar los proveedores
                    const idProveedorSeleccionado = pago.id_proveedor;
                    const nombreProveedorSeleccionado = pago.proveedor;
                    
                    // Cambiar título del modal
                    const modalHeader = document.querySelector('#modalPagoProveedor .modal-header h2');
                    if (modalHeader) {
                        modalHeader.innerHTML = '<img src="/static/icons/medical/settings.svg" alt="Editar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Editar Pago a Proveedor';
                    }
                    
                    // Abrir modal de edición primero
                    openModal('modalPagoProveedor');
                    
                    // Esperar un momento para que el DOM se renderice
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Cargar residencias primero, luego proveedores de esa residencia
                    await loadResidenciasIntoSelect('pago_id_residencia', pago.id_residencia);
                    
                    // Cargar proveedores de la residencia del pago
                    await loadProveedoresForSelect(pago.id_residencia);
                    
                    // Esperar un poco más para que los proveedores se carguen
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Función auxiliar para establecer valor de forma segura
                    const setValue = (id, value) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = value || '';
                        } else {
                            console.warn(`Elemento con ID "${id}" no encontrado`);
                        }
                    };
                    
                    // Llenar el formulario con los datos del pago
                    setValue('pago_id_pago', pago.id_pago);
                    setValue('pago_id_residencia', pago.id_residencia || '');
                    
                    // Seleccionar el proveedor en el select
                    const selectProveedor = document.getElementById('pago_id_proveedor');
                    if (selectProveedor) {
                        // Primero intentar por ID si está disponible
                        if (idProveedorSeleccionado) {
                            const optionById = Array.from(selectProveedor.options).find(opt => opt.value == idProveedorSeleccionado);
                            if (optionById) {
                                selectProveedor.value = optionById.value;
                            } else {
                                // Si no se encuentra por ID, buscar por nombre
                                for (let i = 0; i < selectProveedor.options.length; i++) {
                                    const optionText = selectProveedor.options[i].text;
                                    if (optionText.includes(nombreProveedorSeleccionado)) {
                                        selectProveedor.value = selectProveedor.options[i].value;
                                        break;
                                    }
                                }
                            }
                        } else {
                            // Si no hay ID, buscar solo por nombre
                            for (let i = 0; i < selectProveedor.options.length; i++) {
                                const optionText = selectProveedor.options[i].text;
                                if (optionText.includes(nombreProveedorSeleccionado)) {
                                    selectProveedor.value = selectProveedor.options[i].value;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Añadir event listener al campo de residencia para cargar proveedores cuando cambie
                    const selectResidencia = document.getElementById('pago_id_residencia');
                    if (selectResidencia) {
                        // Remover listener anterior si existe
                        selectResidencia.removeEventListener('change', handleResidenciaChange);
                        // Añadir nuevo listener
                        selectResidencia.addEventListener('change', handleResidenciaChange);
                    }
                    
                    // El monto se calcula desde base_imponible + iva_monto, no se establece directamente
                    setValue('pago_metodo_pago', pago.metodo_pago || '');
                    setValue('pago_numero_factura', pago.numero_factura || '');
                    setValue('pago_observaciones', pago.observaciones || '');
                    
                    // Campos de fecha (formato ISO para type="date")
                    if (pago.fecha_prevista) {
                        setValue('pago_fecha_prevista', pago.fecha_prevista);
                    } else {
                        setValue('pago_fecha_prevista', '');
                    }
                    
                    if (pago.fecha_pago) {
                        setValue('pago_fecha_pago', pago.fecha_pago);
                    } else {
                        setValue('pago_fecha_pago', '');
                    }
                    
                    // Campos adicionales de factura procesada
                    if (pago.fecha_emision) {
                        setValue('pago_fecha_emision', pago.fecha_emision);
                    } else {
                        setValue('pago_fecha_emision', '');
                    }
                    
                    if (pago.fecha_vencimiento) {
                        setValue('pago_fecha_vencimiento', pago.fecha_vencimiento);
                    } else {
                        setValue('pago_fecha_vencimiento', '');
                    }
                    
                    setValue('pago_base_imponible', pago.base_imponible || '');
                    setValue('pago_iva', pago.iva || '');
                    setValue('pago_iva_monto', pago.iva_monto || '');
                    setValue('pago_monto', pago.monto || '');
                    
                    // Generar concepto automáticamente: Nombre del proveedor y fecha de factura
                    const generarConcepto = () => {
                        const selectProveedor = document.getElementById('pago_id_proveedor');
                        const fechaPago = document.getElementById('pago_fecha_pago');
                        const conceptoInput = document.getElementById('pago_concepto');
                        
                        if (selectProveedor && conceptoInput) {
                            const proveedorSeleccionado = selectProveedor.options[selectProveedor.selectedIndex];
                            const nombreProveedor = proveedorSeleccionado && proveedorSeleccionado.value 
                                ? proveedorSeleccionado.text.split(' - ')[0] 
                                : '';
                            
                            const fecha = fechaPago ? fechaPago.value : '';
                            
                            if (nombreProveedor && fecha) {
                                conceptoInput.value = `${nombreProveedor} ${fecha}`;
                            } else if (nombreProveedor) {
                                conceptoInput.value = nombreProveedor;
                            } else {
                                conceptoInput.value = pago.concepto || '';
                            }
                        }
                    };
                    
                    // Generar concepto inicial
                    generarConcepto();
                    
                    // Añadir event listeners para actualizar concepto automáticamente
                    const selectProveedorForConcepto = document.getElementById('pago_id_proveedor');
                    const fechaPagoForConcepto = document.getElementById('pago_fecha_pago');
                    
                    if (selectProveedorForConcepto) {
                        selectProveedorForConcepto.addEventListener('change', generarConcepto);
                    }
                    if (fechaPagoForConcepto) {
                        fechaPagoForConcepto.addEventListener('change', generarConcepto);
                        fechaPagoForConcepto.addEventListener('input', generarConcepto);
                    }
                    
                    // Mostrar factura actual si existe
                    const facturaInput = document.getElementById('pago_factura_archivo_manual');
                    const facturaTexto = document.getElementById('pago_factura_texto_manual');
                    // Si estamos editando un pago existente (tiene id_pago), siempre se puede eliminar
                    // No importa si tiene PDF adjunto o no, si hay registro de factura, se puede borrar
                    const tiene_factura = !!(pago.id_pago);
                    
                    // Verificar si hay PDF adjunto para mostrarlo
                    const tiene_pdf_adjunto = pago.factura_blob_path && 
                        pago.factura_blob_path !== null && 
                        pago.factura_blob_path !== '' && 
                        String(pago.factura_blob_path).toLowerCase() !== 'null' &&
                        String(pago.factura_blob_path).toLowerCase() !== 'none';
                    const tiene_url_factura = pago.factura_url && 
                        pago.factura_url !== null && 
                        pago.factura_url !== '' && 
                        String(pago.factura_url).toLowerCase() !== 'null' &&
                        String(pago.factura_url).toLowerCase() !== 'none';
                    
                    if (tiene_pdf_adjunto || tiene_url_factura) {
                        const nombreArchivo = pago.factura_blob_path ? pago.factura_blob_path.split('/').pop() : 'Factura actual.pdf';
                        if (facturaTexto) {
                            facturaTexto.innerHTML = `
                                <div style="color: #667eea; font-weight: 500; font-size: 14px;">${nombreArchivo}</div>
                                <div style="color: #999; font-size: 12px; margin-top: 2px;">
                                    ${pago.factura_url ? `<a href="${pago.factura_url}" target="_blank" style="color: #667eea; text-decoration: underline;">Ver factura actual</a> • ` : ''}Puede seleccionar un nuevo archivo para reemplazarla
                                </div>
                            `;
                        }
                        // Guardar blob_path actual para no perderlo si no se sube nuevo archivo
                        if (facturaInput) {
                            facturaInput.setAttribute('data-blob-path-actual', pago.factura_blob_path || '');
                        }
                    } else {
                        if (facturaTexto) {
                            facturaTexto.innerHTML = 'Seleccionar archivo PDF...';
                        }
                        if (facturaInput) {
                            facturaInput.removeAttribute('data-blob-path-actual');
                        }
                    }
                    
                    // Mostrar botón guardar si tiene permiso de editar
                    const savePagoBtn = document.getElementById('savePagoProveedorBtn');
                    if (savePagoBtn && usuarioTienePermiso('editar:pago_proveedor')) {
                        savePagoBtn.style.display = 'block';
                    } else if (savePagoBtn) {
                        savePagoBtn.style.display = 'none';
                    }
                    
                    // MOSTRAR el botón de eliminar solo si hay factura Y el usuario tiene permiso
                    const mostrar_boton_eliminar = () => {
                        const btn_eliminar_completa = document.getElementById('pago_eliminar_factura_btn');
                        // Solo mostrar si el usuario tiene permiso de eliminar
                        if (btn_eliminar_completa && !usuarioTienePermiso('eliminar:pago_proveedor')) {
                            btn_eliminar_completa.style.display = 'none';
                            return;
                        }
                        
                        if (btn_eliminar_completa) {
                            if (tiene_factura) {
                                btn_eliminar_completa.style.display = 'flex';
                                btn_eliminar_completa.style.visibility = 'visible';
                                btn_eliminar_completa.style.opacity = '1';
                                btn_eliminar_completa.removeAttribute('hidden');
                                console.log('✅ Botón eliminar factura MOSTRADO - tiene_factura:', tiene_factura);
                            } else {
                                btn_eliminar_completa.style.display = 'none';
                                console.log('❌ Botón OCULTADO - no hay factura');
                            }
                            return true;
                        } else {
                            console.error('❌ ERROR: Botón pago_eliminar_factura_btn NO ENCONTRADO en el DOM');
                            // Intentar buscar el botón de otra forma
                            const botones = document.querySelectorAll('button[id*="eliminar"][id*="factura"]');
                            return false;
                        }
                    };
                    
                    // Intentar múltiples veces para asegurar que se muestre
                    mostrar_boton_eliminar();
                    setTimeout(mostrar_boton_eliminar, 50);
                    setTimeout(mostrar_boton_eliminar, 150);
                    setTimeout(mostrar_boton_eliminar, 300);
                    setTimeout(mostrar_boton_eliminar, 500);
                    setTimeout(mostrar_boton_eliminar, 1000);
                    setTimeout(mostrar_boton_eliminar, 2000);
                    
                    // Inicializar date pickers después de abrir el modal
                    try {
                        initializePagoProveedorDatePickers();
                    } catch (error) {
                        console.error('Error al inicializar date pickers:', error);
                        // Continuar aunque falle la inicialización de date pickers
                    }
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        showPagoProveedorModalError('Sesión expirada. Por favor, recarga la página para iniciar sesión nuevamente.');
                        localStorage.removeItem('violetas_token');
                    } else if (response.status === 404) {
                        showPagoProveedorModalError('El pago no se encontró. Puede que haya sido eliminado o no tengas permisos para verlo.');
                        console.error('Pago no encontrado:', pago.error || 'Error desconocido');
                    } else {
                        showPagoProveedorModalError('Error al obtener el pago: ' + (pago.error || `Error ${response.status}`));
                        console.error('Error al obtener pago:', response.status, pago);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al obtener pago:', error);
                showPagoProveedorModalError('Error de conexión: ' + error.message + '. Verifica que el servidor esté corriendo.');
            }
        }

        function showProveedorModalError(message) {
            const alert = document.getElementById('modalProveedorAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showProveedorModalSuccess(message) {
            const alert = document.getElementById('modalProveedorAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideProveedorModalAlert() {
            const alert = document.getElementById('modalProveedorAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        function showPagoProveedorModalError(message) {
            // Asegurar que el modal esté abierto antes de mostrar el error
            const modal = document.getElementById('modalPagoProveedor');
            if (modal && modal.style.display !== 'block') {
                openModal('modalPagoProveedor');
            }
            
            const alert = document.getElementById('modalPagoProveedorAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            } else {
                // Si no existe el alert, mostrarlo en consola y con alert
                console.error('Error en modal de pago proveedor:', message);
                alert(message);
            }
        }

        function showPagoProveedorModalSuccess(message) {
            const alert = document.getElementById('modalPagoProveedorAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hidePagoProveedorModalAlert() {
            const alert = document.getElementById('modalPagoProveedorAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        let cobrosChart = null;

        async function loadCobrosChart() {
            const token = localStorage.getItem('violetas_token');
            const canvas = document.getElementById('cobrosChart');
            
            if (!canvas) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/facturacion/cobros/estadisticas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Destruir gráfico anterior si existe
                    if (cobrosChart) {
                        cobrosChart.destroy();
                    }
                    
                    // Preparar datos para el gráfico - SOLO COBRADO (histórico)
                    const historico = data.historico || [];
                    
                    // Obtener todos los meses del histórico
                    const todosMeses = new Set();
                    historico.forEach(h => todosMeses.add(h.mes));
                    
                    const mesesOrdenados = Array.from(todosMeses).sort();
                    
                    // Identificar residencias (si existen en los datos)
                    const residencias = new Map(); // id -> nombre
                    historico.forEach(h => {
                        if (h.id_residencia) residencias.set(h.id_residencia, h.nombre_residencia || `Residencia ${h.id_residencia}`);
                    });

                    // Si no hay info de residencia (usuario normal o datos antiguos), usar "General"
                    if (residencias.size === 0) {
                        residencias.set('default', 'General');
                    }
                    
                    const datasets = [];
                    const colorPalette = [
                        '#28a745', // Verde (Principal/Violetas)
                        '#007bff', // Azul (Secundaria)
                        '#6f42c1', // Púrpura
                        '#fd7e14', // Naranja
                    ];
                    
                    let colorIdx = 0;
                    residencias.forEach((nombre, id) => {
                        const color = colorPalette[colorIdx % colorPalette.length];
                        
                        // Preparar datos para esta residencia - SOLO COBRADO
                        const datosHistoricos = mesesOrdenados.map(mes => {
                            const entry = historico.find(h => h.mes === mes && (h.id_residencia === id || (id === 'default')));
                            return entry ? entry.total : 0;
                        });

                        // Dataset Histórico (Línea sólida) - SOLO COBRADO
                        datasets.push({
                            label: `${nombre} (Cobrado)`,
                            data: datosHistoricos,
                            borderColor: color,
                            backgroundColor: color + '1A', // 10% opacity
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        });
                        
                        colorIdx++;
                    });
                    
                    // Preparar etiquetas (Eje X)
                    const labels = mesesOrdenados.map(mes => {
                        const [año, mesNum] = mes.split('-');
                        const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        return `${meses[parseInt(mesNum) - 1]} ${año}`;
                    });
                    
                    // Crear el gráfico
                    const ctx = canvas.getContext('2d');
                    cobrosChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: window.innerWidth < 768 ? 1.5 : 2,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: window.innerWidth < 768 ? 'bottom' : 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: window.innerWidth < 768 ? 10 : 15,
                                        font: {
                                            size: window.innerWidth < 768 ? 10 : 12
                                        },
                                        boxWidth: window.innerWidth < 768 ? 10 : 12,
                                        boxHeight: window.innerWidth < 768 ? 10 : 12
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            label += Math.round(context.parsed.y) + '€';
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return Math.round(value) + '€';
                                        },
                                        font: {
                                            size: window.innerWidth < 768 ? 9 : 11
                                        },
                                        maxTicksLimit: window.innerWidth < 768 ? 5 : 10
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            size: window.innerWidth < 768 ? 9 : 11
                                        },
                                        maxRotation: window.innerWidth < 768 ? 45 : 0,
                                        minRotation: window.innerWidth < 768 ? 45 : 0
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                } else {
                    console.error('Error al cargar estadísticas:', data.error);
                }
            } catch (error) {
                console.error('Error al cargar gráfico de cobros:', error);
            }
        }

        // Función para cambiar entre pestañas de facturación
        function switchFacturacionTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover clase active de todos los botones
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar la pestaña seleccionada
            const tabContent = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            
            // Activar el botón correspondiente
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((btn, index) => {
                if ((tabName === 'cobros' && index === 0) || (tabName === 'pagos' && index === 1)) {
                    btn.classList.add('active');
                }
            });
            
            if (tabContent) {
                tabContent.classList.add('active');
            }
        }

        function switchPersonalTab(tabName) {
            // Ocultar todas las pestañas dentro del módulo de personal
            const personalModule = document.querySelector('#moduleContent .module-content');
            if (!personalModule) return;
            
            personalModule.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover clase active de todos los botones de personal
            personalModule.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar la pestaña seleccionada
            let tabContentId;
            if (tabName === 'personal') {
                tabContentId = 'tabPersonal';
            } else if (tabName === 'turnos-extra') {
                tabContentId = 'tabTurnosExtra';
                // Cargar turnos extra si no se han cargado aún
                const turnosContent = document.getElementById('turnosExtraContent');
                if (turnosContent && turnosContent.innerHTML.includes('Cargando')) {
                    loadTurnosExtra();
                }
            }
            
            const tabContent = document.getElementById(tabContentId);
            
            // Activar el botón correspondiente
            const tabs = personalModule.querySelectorAll('.tab');
            tabs.forEach((btn, index) => {
                if ((tabName === 'personal' && index === 0) || (tabName === 'turnos-extra' && index === 1)) {
                    btn.classList.add('active');
                }
            });
            
            if (tabContent) {
                tabContent.classList.add('active');
            }
        }

        // Event listeners para el DOM
        document.addEventListener('DOMContentLoaded', function() {
            
            // Event delegation para el botón de nuevo proveedor (funciona incluso si se carga dinámicamente)
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'btnNuevoProveedor') {
                    e.stopPropagation();
                    e.preventDefault();
                    // Guardar que el modal de pago estaba abierto
                    const modalPago = document.getElementById('modalPagoProveedor');
                    if (modalPago && modalPago.style.display === 'block') {
                        sessionStorage.setItem('modalPagoAbierto', 'true');
                    }
                    // Cerrar el modal de pago a proveedor primero
                    closeModal('modalPagoProveedor');
                    // Abrir el modal de nuevo proveedor después de un pequeño delay
                    setTimeout(() => {
                        openModal('modalProveedor');
                    }, 100);
                    return false;
                }
            });
        });

        async function loadPersonal() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando personal...</p>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/personal`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Verificar el tipo de contenido antes de parsear
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON:', text);
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${response.status}</p></div>`;
                    return;
                }
                
                if (response.ok) {
                    let html = `
                        <div class="module-content">
                            <h3 style="color: #667eea; margin-bottom: 20px;"><img src="/static/icons/medical/user-medical.svg" alt="Personal" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Personal</h3>
                            
                            <div class="tabs-container">
                                <div class="tabs">
                                    <button class="tab active" onclick="switchPersonalTab('personal')"><img src="/static/icons/medical/user-medical.svg" alt="Personal" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Personal (${data.total || 0})</button>
                                    <button class="tab" onclick="switchPersonalTab('turnos-extra')"><img src="/static/icons/medical/calendar-medical.svg" alt="Turnos" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Turnos Extra</button>
                                </div>
                                
                                <!-- Pestaña de Personal -->
                                <div id="tabPersonal" class="tab-content active">
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: #667eea; margin: 0; margin-bottom: 15px;"><img src="/static/icons/medical/user-medical.svg" alt="Personal" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Personal (${data.total || 0})</h4>
                                        ${usuarioTienePermiso('crear:personal') ? `<button class="add-btn" onclick="resetFormPersonal(); openModal('modalPersonal')" style="padding: 8px 16px; font-size: 14px;">+ Agregar Personal</button>` : ''}
                                    </div>
                    `;
                    
                    if (data.personal && data.personal.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Cargo</th>
                                        <th>Teléfono</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.personal.forEach(p => {
                            const puedeEditar = usuarioTienePermiso('editar:personal');
                            html += `
                                <tr style="cursor: ${puedeEditar ? 'pointer' : 'default'};" ${puedeEditar ? `onclick="editarPersonal(${p.id_personal})" title="Haz clic para editar"` : 'title="Sin permisos para editar"'}>
                                    <td>${p.nombre} ${p.apellido}</td>
                                    <td>${p.cargo || '-'}</td>
                                    <td>${p.telefono || '-'}</td>
                                    <td>${p.activo ? '<img src="/static/icons/medical/check-circle.svg" alt="Activo" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;"> Activo' : '<img src="/static/icons/medical/alert-circle.svg" alt="Inactivo" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;"> Inactivo'}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No hay personal registrado.</p>';
                    }
                    
                    html += `
                                </div>
                                
                                <!-- Pestaña de Turnos Extra -->
                                <div id="tabTurnosExtra" class="tab-content">
                                    <div id="turnosExtraContent">
                                        <div style="text-align: center; padding: 40px;">
                                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                            <p style="margin-top: 15px; color: #666;">Cargando turnos extra...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    content.innerHTML = html;
                    
                    // Cargar turnos extra cuando se muestre la pestaña
                    loadTurnosExtra();
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        content.innerHTML = `<div class="module-content"><p style="color: red;">Error: Sesión expirada. Por favor, <a href="javascript:location.reload()">recarga la página</a> para iniciar sesión nuevamente.</p></div>`;
                        localStorage.removeItem('violetas_token');
                    } else {
                        content.innerHTML = `<div class="module-content"><p style="color: red;">Error (${response.status}): ${data.error || 'Error desconocido'}</p></div>`;
                    }
                    console.error('Error al cargar personal:', response.status, data);
                }
            } catch (error) {
                console.error('Error de conexión al cargar personal:', error);
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexión: ${error.message}. Verifica que el servidor esté corriendo.</p></div>`;
            }
        }

        // Variables para almacenar instancias de flatpickr
        let flatpickrIngreso = null;
        let flatpickrNacimiento = null;
        let flatpickrEditIngreso = null;
        let flatpickrEditNacimiento = null;
        let flatpickrContratacion = null;

        async function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error(`Modal con ID "${modalId}" no encontrado`);
                return;
            }
            modal.style.display = 'block';
            
            // Asegurar que todos los botones de guardado estén habilitados al abrir cualquier modal
            const saveButtonIds = ['saveResidenteBtn', 'savePersonalBtn', 'saveTurnoExtraBtn', 'saveCobroBtn', 'saveProveedorBtn', 'savePagoProveedorBtn', 'updateResidenteBtn', 'saveDocumentoBtn', 'saveResidenciaBtn', 'saveUsuarioBtn', 'saveMiCuentaBtn', 'saveEntidadFiscalBtn'];
            const buttonTexts = {
                'saveResidenteBtn': 'Guardar',
                'savePersonalBtn': 'Guardar',
                'saveTurnoExtraBtn': 'Guardar',
                'saveCobroBtn': 'Guardar',
                'saveProveedorBtn': 'Guardar',
                'savePagoProveedorBtn': 'Guardar',
                'updateResidenteBtn': 'Actualizar',
                'saveDocumentoBtn': 'Guardar',
                'saveResidenciaBtn': 'Guardar',
                'saveUsuarioBtn': 'Guardar',
                'saveMiCuentaBtn': 'Guardar Cambios',
                'saveEntidadFiscalBtn': 'Guardar'
            };
            
            saveButtonIds.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = false;
                    // Restaurar texto original si está en "Guardando...", "Actualizando..." o "Subiendo..."
                    if (btn.textContent.includes('Guardando') || btn.textContent.includes('Actualizando') || btn.textContent.includes('Subiendo')) {
                        btn.textContent = buttonTexts[btnId] || 'Guardar';
                    }
                }
            });
            
            // Si es el modal de agregar cobro, cargar residentes (solo si no estamos editando)
            if (modalId === 'modalCobro') {
                const idPagoOculto = document.getElementById('cobro_id_pago');
                // Solo cargar residentes si no hay id_pago (no estamos editando)
                if (!idPagoOculto || !idPagoOculto.value) {
                    loadResidentesForCobro();
                    initializeCobroDatePickers();
                }
                
                // Controlar visibilidad de botones según permisos
                const saveBtn = document.getElementById('saveCobroBtn');
                const deleteBtn = document.getElementById('deleteCobroBtn');
                
                if (saveBtn) {
                    // Mostrar botón guardar si tiene permiso de crear o editar
                    if (usuarioTienePermiso('crear:cobro') || usuarioTienePermiso('editar:cobro')) {
                        saveBtn.style.display = 'block';
                    } else {
                        saveBtn.style.display = 'none';
                    }
                }
                
                // El botón eliminar se controla en editCobro
            }
            
            // Si es el modal de pago a proveedor, inicializar date pickers
            if (modalId === 'modalPagoProveedor') {
                initializePagoProveedorDatePickers();
                
                // Controlar visibilidad de botones según permisos
                const savePagoBtn = document.getElementById('savePagoProveedorBtn');
                const deletePagoBtn = document.getElementById('pago_eliminar_factura_btn');
                
                if (savePagoBtn) {
                    // Mostrar botón guardar si tiene permiso de crear o editar
                    if (usuarioTienePermiso('crear:pago_proveedor') || usuarioTienePermiso('editar:pago_proveedor')) {
                        savePagoBtn.style.display = 'block';
                    } else {
                        savePagoBtn.style.display = 'none';
                    }
                }
                
                // El botón eliminar se controla en editarPagoProveedor
            }
            
            // Si es el modal de usuario, cargar roles
            // NOTA: NO cargamos residencias aquí porque:
            // - editarUsuario() ya las carga con los datos del usuario
            // - resetUsuarioForm() ya las carga vacías para nuevo usuario
            if (modalId === 'modalUsuario') {
                loadRolesForSelect();
            }
            
            // Si es el modal de agregar residente, cargar residencias desde la API
            if (modalId === 'modalResidente') {
                const token = localStorage.getItem('violetas_token');
                const selectResidencia = document.getElementById('res_id_residencia');
                const selectHabitacion = document.getElementById('res_habitacion');
                
                // Cargar residencias desde la API
                await loadResidenciasIntoSelect('res_id_residencia');
                
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const residenciaId = payload.id_residencia;
                        if (selectResidencia) {
                            selectResidencia.value = residenciaId; // Establecer como valor por defecto
                            // Actualizar habitaciones según la residencia
                            await actualizarHabitaciones(residenciaId, 'res_habitacion');
                        }
                    } catch (e) {
                        console.error('Error al obtener residencia del token:', e);
                    }
                }
                
                // Añadir event listener para cuando cambie la residencia
                if (selectResidencia) {
                    selectResidencia.addEventListener('change', async function() {
                        await actualizarHabitaciones(this.value, 'res_habitacion');
                    });
                }
                
                // Inicializar calendarios con flatpickr
                const fechaIngresoInput = document.getElementById('res_fecha_ingreso');
                const fechaNacimientoInput = document.getElementById('res_fecha_nacimiento');
                
                // Destruir instancias anteriores si existen
                if (flatpickrIngreso) {
                    flatpickrIngreso.destroy();
                }
                if (flatpickrNacimiento) {
                    flatpickrNacimiento.destroy();
                }
                
                // Inicializar flatpickr para fecha de ingreso
                if (fechaIngresoInput) {
                    // Establecer fecha de hoy por defecto
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    const fechaHoy = `${dia}/${mes}/${año}`;
                    
                    if (!fechaIngresoInput.value) {
                        fechaIngresoInput.value = fechaHoy;
                    }
                    
                    flatpickrIngreso = flatpickr(fechaIngresoInput, {
                        dateFormat: "d/m/Y",
                        locale: "es",
                        allowInput: true,
                        clickOpens: true,
                        appendTo: document.body,
                        maxDate: "today", // La fecha de ingreso no puede ser mayor que hoy
                        onChange: function(selectedDates, dateStr, instance) {
                            // Asegurar formato DD/MM/YYYY
                            if (dateStr) {
                                const partes = dateStr.split('/');
                                if (partes.length === 3) {
                                    const dia = partes[0].padStart(2, '0');
                                    const mes = partes[1].padStart(2, '0');
                                    const año = partes[2];
                                    instance.input.value = `${dia}/${mes}/${año}`;
                                }
                            }
                        }
                    });
                }
                
                // Inicializar flatpickr para fecha de nacimiento
                if (fechaNacimientoInput) {
                    flatpickrNacimiento = flatpickr(fechaNacimientoInput, {
                        dateFormat: "d/m/Y",
                        locale: "es",
                        allowInput: true,
                        clickOpens: true,
                        appendTo: document.body,
                        maxDate: "today", // No permitir fechas futuras
                        onChange: function(selectedDates, dateStr, instance) {
                            // Asegurar formato DD/MM/YYYY
                            if (dateStr) {
                                const partes = dateStr.split('/');
                                if (partes.length === 3) {
                                    const dia = partes[0].padStart(2, '0');
                                    const mes = partes[1].padStart(2, '0');
                                    const año = partes[2];
                                    instance.input.value = `${dia}/${mes}/${año}`;
                                }
                            }
                            // Actualizar edad cuando cambia la fecha
                            actualizarEdad('res_fecha_nacimiento', 'res_edad');
                        }
                    });
                }
            }
            
            // Si es el modal de agregar personal, cargar residencias desde la API
            if (modalId === 'modalPersonal') {
                const idPersonal = document.getElementById('per_id_personal');
                // Solo cargar si no estamos editando (no hay ID de personal)
                if (!idPersonal || !idPersonal.value) {
                    const token = localStorage.getItem('violetas_token');
                    const selectResidencia = document.getElementById('per_id_residencia');
                    
                    // Cargar residencias desde la API
                    await loadResidenciasIntoSelect('per_id_residencia');
                    
                    if (token) {
                        try {
                            const payload = JSON.parse(atob(token.split('.')[1]));
                            const residenciaId = payload.id_residencia;
                            if (selectResidencia) {
                                selectResidencia.value = residenciaId; // Establecer como valor por defecto
                            }
                        } catch (e) {
                            console.error('Error al obtener residencia del token:', e);
                        }
                    }
                    
                    // Inicializar calendario con flatpickr para fecha de contratación
                    const fechaContratacionInput = document.getElementById('per_fecha_contratacion');
                    
                    // Destruir instancia anterior si existe
                    if (flatpickrContratacion) {
                        flatpickrContratacion.destroy();
                    }
                    
                    // Inicializar flatpickr para fecha de contratación
                    if (fechaContratacionInput) {
                        // Establecer fecha de hoy por defecto solo si no hay valor
                        if (!fechaContratacionInput.value) {
                            const hoy = new Date();
                            const dia = String(hoy.getDate()).padStart(2, '0');
                            const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                            const año = hoy.getFullYear();
                            const fechaHoy = `${dia}/${mes}/${año}`;
                            fechaContratacionInput.value = fechaHoy;
                        }
                        
                        flatpickrContratacion = flatpickr(fechaContratacionInput, {
                            dateFormat: 'd/m/Y',
                            locale: "es",
                            allowInput: false,
                            appendTo: document.body
                        });
                    }
                }
            }
            
            // Si es el modal de agregar proveedor, cargar residencias desde la API
            if (modalId === 'modalProveedor') {
                const idProveedor = document.getElementById('prov_id_proveedor');
                // Solo cargar si no estamos editando (no hay ID de proveedor)
                if (!idProveedor || !idProveedor.value) {
                    await loadResidenciasIntoSelect('prov_id_residencia');
                }
            }
            
            // Si es el modal de agregar turno extra
            if (modalId === 'modalTurnoExtra') {
                const token = localStorage.getItem('violetas_token');
                const selectPersonal = document.getElementById('turno_id_personal');
                const fechaInput = document.getElementById('turno_fecha');
                
                // Cargar personal para el select
                if (selectPersonal) {
                    fetch(`${API_URL}/api/v1/personal`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                    .then(res => res.json())
                    .then(data => {
                        selectPersonal.innerHTML = '<option value="">Seleccione un empleado</option>';
                        if (data.personal) {
                            data.personal.forEach(p => {
                                selectPersonal.innerHTML += `<option value="${p.id_personal}">${p.nombre} ${p.apellido}${p.cargo ? ' (' + p.cargo + ')' : ''}</option>`;
                            });
                        }
                    })
                    .catch(err => console.error('Error al cargar personal:', err));
                }
                
                // Inicializar date picker para fecha
                if (fechaInput) {
                    // Destruir instancia anterior si existe
                    if (window.flatpickrTurnoExtra) {
                        window.flatpickrTurnoExtra.destroy();
                    }
                    
                    // Establecer fecha de hoy por defecto si está vacío
                    if (!fechaInput.value) {
                        const hoy = new Date();
                        const dia = String(hoy.getDate()).padStart(2, '0');
                        const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                        const año = hoy.getFullYear();
                        fechaInput.value = `${dia}/${mes}/${año}`;
                    }
                    
                    window.flatpickrTurnoExtra = flatpickr(fechaInput, {
                        dateFormat: "d/m/Y",
                        locale: "es",
                        allowInput: true,
                        clickOpens: true,
                        appendTo: document.body,
                        onChange: function(selectedDates, dateStr, instance) {
                            if (dateStr) {
                                const partes = dateStr.split('/');
                                if (partes.length === 3) {
                                    const dia = partes[0].padStart(2, '0');
                                    const mes = partes[1].padStart(2, '0');
                                    const año = partes[2];
                                    instance.input.value = `${dia}/${mes}/${año}`;
                                }
                            }
                        }
                    });
                }
                
                // Resetear título del modal
                const modalTitle = document.getElementById('modalTurnoExtraTitle');
                if (modalTitle) {
                    modalTitle.textContent = 'Agregar Turno Extra';
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Si se cierra el modal de proveedor y el modal de lista estaba abierto, volver a abrirlo
            if (modalId === 'modalProveedor' && sessionStorage.getItem('modalListaProveedoresAbierto') === 'true') {
                sessionStorage.removeItem('modalListaProveedoresAbierto');
                setTimeout(async () => {
                    await abrirModalListaProveedores();
                }, 100);
            }
            
            // Restaurar todos los botones de guardado al cerrar cualquier modal
            const saveButtonIds = ['saveResidenteBtn', 'savePersonalBtn', 'saveTurnoExtraBtn', 'saveCobroBtn', 'saveProveedorBtn', 'savePagoProveedorBtn', 'updateResidenteBtn', 'saveResidenciaBtn', 'saveUsuarioBtn', 'saveMiCuentaBtn', 'saveDocumentoBtn'];
            const buttonTexts = {
                'saveResidenteBtn': 'Guardar',
                'savePersonalBtn': 'Guardar',
                'saveTurnoExtraBtn': 'Guardar',
                'saveCobroBtn': 'Guardar',
                'saveProveedorBtn': 'Guardar',
                'savePagoProveedorBtn': 'Guardar',
                'updateResidenteBtn': 'Actualizar',
                'saveResidenciaBtn': 'Guardar',
                'saveUsuarioBtn': 'Guardar',
                'saveMiCuentaBtn': 'Guardar Cambios',
                'saveDocumentoBtn': 'Guardar',
                'saveEntidadFiscalBtn': 'Guardar'
            };
            
            saveButtonIds.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = false;
                    // Restaurar texto original si está en "Guardando...", "Actualizando..." o "Subiendo..."
                    if (btn.textContent.includes('Guardando') || btn.textContent.includes('Actualizando') || btn.textContent.includes('Subiendo')) {
                        btn.textContent = buttonTexts[btnId] || 'Guardar';
                    }
                }
            });
            
            // Restaurar título del modal de ver residente
            if (modalId === 'modalViewResidente') {
                const modalTitle = document.querySelector('#modalViewResidente .modal-header h2');
                if (modalTitle) {
                    modalTitle.innerHTML = '<img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Detalle del Residente';
                }
            }
            const form = document.getElementById('formResidente');
            if (form) {
                form.reset();
                const activoCheckbox = document.getElementById('res_activo');
                if (activoCheckbox) {
                    activoCheckbox.checked = true;
                }
                
                // Destruir instancias de flatpickr
                if (flatpickrIngreso) {
                    flatpickrIngreso.destroy();
                    flatpickrIngreso = null;
                }
                if (flatpickrNacimiento) {
                    flatpickrNacimiento.destroy();
                    flatpickrNacimiento = null;
                }
                if (flatpickrEditIngreso) {
                    flatpickrEditIngreso.destroy();
                    flatpickrEditIngreso = null;
                }
                if (flatpickrEditNacimiento) {
                    flatpickrEditNacimiento.destroy();
                    flatpickrEditNacimiento = null;
                }
                
                // Establecer fecha de ingreso como hoy después del reset
                const fechaIngresoInput = document.getElementById('res_fecha_ingreso');
                if (fechaIngresoInput) {
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    fechaIngresoInput.value = `${dia}/${mes}/${año}`;
                }
            }
            const formPersonal = document.getElementById('formPersonal');
            if (formPersonal) {
                formPersonal.reset();
                const activoCheckbox = document.getElementById('per_activo');
                if (activoCheckbox) {
                    activoCheckbox.value = 'true';
                }
                
                // Destruir instancia de flatpickr de contratación
                if (flatpickrContratacion) {
                    flatpickrContratacion.destroy();
                    flatpickrContratacion = null;
                }
                
                // Establecer fecha de contratación como hoy después del reset
                const fechaContratacionInput = document.getElementById('per_fecha_contratacion');
                if (fechaContratacionInput) {
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    fechaContratacionInput.value = `${dia}/${mes}/${año}`;
                }
            }
            const formTurnoExtra = document.getElementById('formTurnoExtra');
            if (formTurnoExtra) {
                formTurnoExtra.reset();
                document.getElementById('turno_id_turno_extra').value = '';
                document.getElementById('modalTurnoExtraTitle').textContent = 'Agregar Turno Extra';
                
                // Destruir instancia de flatpickr de turno extra
                if (window.flatpickrTurnoExtra) {
                    window.flatpickrTurnoExtra.destroy();
                    window.flatpickrTurnoExtra = null;
                }
                
                // Establecer fecha como hoy después del reset
                const fechaInput = document.getElementById('turno_fecha');
                if (fechaInput) {
                    const hoy = new Date();
                    const dia = String(hoy.getDate()).padStart(2, '0');
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    const año = hoy.getFullYear();
                    fechaInput.value = `${dia}/${mes}/${año}`;
                }
            }
            const formProveedor = document.getElementById('formProveedor');
            if (formProveedor && modalId === 'modalProveedor') {
                // Solo resetear si no estamos editando (no hay ID de proveedor)
                const idProveedor = document.getElementById('prov_id_proveedor');
                if (!idProveedor || !idProveedor.value) {
                    formProveedor.reset();
                    const activoCheckbox = document.getElementById('prov_activo');
                    if (activoCheckbox) {
                        activoCheckbox.checked = true;
                    }
                    // Cargar residencias
                    loadResidenciasIntoSelect('prov_id_residencia');
                    // Restaurar título del modal
                    const modalHeader = document.querySelector('#modalProveedor .modal-header h2');
                    if (modalHeader) {
                        modalHeader.innerHTML = '<img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Proveedor';
                    }
                }
            }
            const formPagoProveedor = document.getElementById('formPagoProveedor');
            if (formPagoProveedor) {
                formPagoProveedor.reset();
                // Destruir flatpickr de pagos a proveedores
                if (flatpickrPagoProveedorFechaPago) {
                    flatpickrPagoProveedorFechaPago.destroy();
                    flatpickrPagoProveedorFechaPago = null;
                }
            }
            const formCobro = document.getElementById('formCobro');
            if (formCobro) {
                formCobro.reset();
                // Limpiar id_pago oculto
                document.getElementById('cobro_id_pago').value = '';
                // Restaurar título del modal
                document.getElementById('modalCobroTitulo').innerHTML = '<img src="/static/icons/medical/bill.svg" alt="Cobro" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Cobro';
                // Ocultar botón de eliminar cuando se está agregando
                const deleteBtn = document.getElementById('deleteCobroBtn');
                if (deleteBtn) {
                    deleteBtn.style.display = 'none';
                }
                const esPrevisto = document.getElementById('cobro_es_previsto');
                if (esPrevisto) {
                    esPrevisto.checked = true;
                }
                // Limpiar campo de concepto "otros"
                const campoOtros = document.getElementById('cobro_concepto_otros');
                if (campoOtros) {
                    campoOtros.style.display = 'none';
                    campoOtros.value = '';
                    campoOtros.required = false;
                }
                // Resetear select de concepto
                const selectConcepto = document.getElementById('cobro_concepto');
                if (selectConcepto) {
                    selectConcepto.value = '';
                }
                // Destruir flatpickr de cobros
                if (flatpickrCobroPrevista) {
                    flatpickrCobroPrevista.destroy();
                    flatpickrCobroPrevista = null;
                }
                if (flatpickrCobroPago) {
                    flatpickrCobroPago.destroy();
                    flatpickrCobroPago = null;
                }
            }
            hideModalAlert();
            hideProveedorModalAlert();
            hideCobroModalAlert();
            hidePagoProveedorModalAlert();
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modalResidente = document.getElementById('modalResidente');
            const modalViewResidente = document.getElementById('modalViewResidente');
            const modalProveedor = document.getElementById('modalProveedor');
            const modalPagoProveedor = document.getElementById('modalPagoProveedor');
            const modalListaProveedores = document.getElementById('modalListaProveedores');
            if (event.target == modalResidente) {
                closeModal('modalResidente');
            }
            const modalPersonal = document.getElementById('modalPersonal');
            if (event.target == modalPersonal) {
                closeModal('modalPersonal');
            }
            const modalTurnoExtra = document.getElementById('modalTurnoExtra');
            if (event.target == modalTurnoExtra) {
                closeModal('modalTurnoExtra');
            }
            if (event.target == modalViewResidente) {
                closeModal('modalViewResidente');
            }
            if (event.target == modalProveedor) {
                closeModal('modalProveedor');
            }
            if (event.target == modalPagoProveedor) {
                closeModal('modalPagoProveedor');
            }
            if (event.target == modalListaProveedores) {
                closeModal('modalListaProveedores');
            }
        }

        let currentEditingResidenteId = null;

        // Función auxiliar para formatear fechas a formato español (DD/MM/YYYY)
        function formatearFechaEspanol(fechaString) {
            if (!fechaString) return '';
            try {
                const fecha = new Date(fechaString);
                if (isNaN(fecha.getTime())) return fechaString;
                const dia = String(fecha.getDate()).padStart(2, '0');
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const año = fecha.getFullYear();
                return `${dia}/${mes}/${año}`;
            } catch (e) {
                return fechaString;
            }
        }

        // Función auxiliar para convertir fecha española (DD/MM/YYYY) a formato ISO (YYYY-MM-DD)
        function fechaEspanolToISO(fechaEspanol) {
            if (!fechaEspanol) return '';
            try {
                const partes = fechaEspanol.split('/');
                if (partes.length === 3) {
                    const [dia, mes, año] = partes;
                    return `${año}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
                }
                return fechaEspanol;
            } catch (e) {
                return fechaEspanol;
            }
        }

        // Función auxiliar para convertir fecha ISO (YYYY-MM-DD) a formato español (DD/MM/YYYY)
        function fechaISOToEspanol(fechaISO) {
            if (!fechaISO) return '';
            try {
                const partes = fechaISO.split('-');
                if (partes.length === 3) {
                    const [año, mes, dia] = partes;
                    return `${dia}/${mes}/${año}`;
                }
                return fechaISO;
            } catch (e) {
                return fechaISO;
            }
        }

        // Función para actualizar las opciones de habitación según la residencia
        async function actualizarHabitaciones(residenciaId, selectHabitacionId, habitacionSeleccionada = null) {
            const selectHabitacion = document.getElementById(selectHabitacionId);
            if (!selectHabitacion) return;
            
            // Limpiar opciones existentes excepto la primera
            selectHabitacion.innerHTML = '<option value="">Cargando habitaciones...</option>';
            selectHabitacion.disabled = true;
            
            if (!residenciaId) {
                selectHabitacion.innerHTML = '<option value="">Seleccione una residencia primero</option>';
                selectHabitacion.disabled = false;
                return;
            }
            
            // Determinar número de habitaciones según la residencia
            let numHabitaciones = 0;
            if (residenciaId === '1' || residenciaId === 1) {
                numHabitaciones = 8; // Violetas 1 tiene 8 habitaciones
            } else if (residenciaId === '2' || residenciaId === 2) {
                numHabitaciones = 20; // Violetas 2 tiene 20 habitaciones
            } else {
                selectHabitacion.innerHTML = '<option value="">Residencia no válida</option>';
                selectHabitacion.disabled = false;
                return;
            }
            
            // Obtener habitaciones ocupadas del backend
            const token = localStorage.getItem('violetas_token');
            let habitacionesOcupadas = [];
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residencias/${residenciaId}/habitaciones-ocupadas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    habitacionesOcupadas = data.habitaciones_ocupadas || [];
                }
            } catch (error) {
                console.error('Error al obtener habitaciones ocupadas:', error);
            }
            
            // Limpiar y reconstruir el select
            selectHabitacion.innerHTML = '<option value="">Seleccione una habitación</option>';
            
            // Añadir opciones de habitaciones disponibles
            for (let i = 1; i <= numHabitaciones; i++) {
                const habitacionStr = i.toString();
                const estaOcupada = habitacionesOcupadas.includes(habitacionStr);
                
                // Si está ocupada pero es la habitación seleccionada (al editar), incluirla
                const esHabitacionSeleccionada = habitacionSeleccionada && habitacionSeleccionada === habitacionStr;
                
                if (!estaOcupada || esHabitacionSeleccionada) {
                    const option = document.createElement('option');
                    option.value = habitacionStr;
                    option.textContent = `Habitación ${i}${estaOcupada && esHabitacionSeleccionada ? ' (actual)' : ''}`;
                    if (esHabitacionSeleccionada) {
                        option.selected = true;
                    }
                    selectHabitacion.appendChild(option);
                }
            }
            
            selectHabitacion.disabled = false;
        }
        
        // Función para calcular la edad desde una fecha en formato DD/MM/YYYY
        function calcularEdad(fechaEspanol) {
            if (!fechaEspanol || fechaEspanol.length !== 10) return '';
            
            try {
                const partes = fechaEspanol.split('/');
                if (partes.length !== 3) return '';
                
                const dia = parseInt(partes[0], 10);
                const mes = parseInt(partes[1], 10) - 1; // Los meses en JS van de 0-11
                const año = parseInt(partes[2], 10);
                
                if (isNaN(dia) || isNaN(mes) || isNaN(año)) return '';
                
                const fechaNacimiento = new Date(año, mes, dia);
                const hoy = new Date();
                
                // Verificar que la fecha es válida
                if (fechaNacimiento.getDate() !== dia || fechaNacimiento.getMonth() !== mes || fechaNacimiento.getFullYear() !== año) {
                    return '';
                }
                
                // Verificar que la fecha no sea futura
                if (fechaNacimiento > hoy) return '';
                
                let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
                const mesActual = hoy.getMonth();
                const diaActual = hoy.getDate();
                const mesNacimiento = fechaNacimiento.getMonth();
                const diaNacimiento = fechaNacimiento.getDate();
                
                // Ajustar si aún no ha cumplido años este año
                if (mesActual < mesNacimiento || (mesActual === mesNacimiento && diaActual < diaNacimiento)) {
                    edad--;
                }
                
                return edad >= 0 ? edad + ' años' : '';
            } catch (e) {
                return '';
            }
        }
        
        // Función para calcular la edad desde una fecha ISO (YYYY-MM-DD)
        function calcularEdadDesdeISO(fechaISO) {
            if (!fechaISO) return '';
            const fechaEspanol = fechaISOToEspanol(fechaISO);
            return calcularEdad(fechaEspanol);
        }
        
        // Función para actualizar el campo de edad cuando cambia la fecha de nacimiento
        function actualizarEdad(inputFechaId, inputEdadId) {
            const inputFecha = document.getElementById(inputFechaId);
            const inputEdad = document.getElementById(inputEdadId);
            
            if (!inputFecha || !inputEdad) return;
            
            const fechaEspanol = inputFecha.value.trim();
            const edad = calcularEdad(fechaEspanol);
            
            if (edad) {
                inputEdad.value = edad;
                inputEdad.style.color = '#333';
            } else {
                inputEdad.value = '';
                inputEdad.placeholder = 'Se calculará automáticamente';
            }
        }

        // Función para validar formato de fecha española (DD/MM/YYYY)
        function validarFechaEspanol(fecha) {
            if (!fecha) return true; // Permitir vacío
            const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = fecha.match(regex);
            if (!match) return false;
            
            const [, dia, mes, año] = match;
            const diaNum = parseInt(dia, 10);
            const mesNum = parseInt(mes, 10);
            const añoNum = parseInt(año, 10);
            
            // Validar rango de fechas
            if (mesNum < 1 || mesNum > 12) return false;
            if (diaNum < 1 || diaNum > 31) return false;
            if (añoNum < 1900 || añoNum > 2100) return false;
            
            // Validar días del mes
            const fechaObj = new Date(añoNum, mesNum - 1, diaNum);
            if (fechaObj.getDate() !== diaNum || fechaObj.getMonth() !== mesNum - 1 || fechaObj.getFullYear() !== añoNum) {
                return false;
            }
            
            return true;
        }

        // Función para formatear automáticamente mientras se escribe (DD/MM/YYYY)
        function formatearFechaInput(input) {
            let value = input.value.replace(/\D/g, ''); // Solo números
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }
            
            input.value = value;
            
            // Validar y mostrar error si es necesario
            if (value.length === 10) {
                if (!validarFechaEspanol(value)) {
                    input.style.borderColor = '#dc3545';
                } else {
                    input.style.borderColor = '#e0e0e0';
                }
            } else if (value.length > 0) {
                input.style.borderColor = '#e0e0e0';
            }
        }

        async function viewResidente(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const content = document.getElementById('viewResidenteContent');
            
            content.innerHTML = '<p>Cargando información del residente...</p>';
            openModal('modalViewResidente');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const res = await response.json();
                
                if (response.ok) {
                    currentEditingResidenteId = idResidente;
                    
                    // Actualizar el título del modal con el nombre del residente
                    const modalTitle = document.querySelector('#modalViewResidente .modal-header h2');
                    if (modalTitle) {
                        const nombreCompleto = `${res.nombre || ''} ${res.apellido || ''}`.trim();
                        modalTitle.innerHTML = `<img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Detalle del Residente${nombreCompleto ? ': ' + nombreCompleto : ''}`;
                    }
                    
                    // Obtener residencias desde la API para construir el select
                    let residenciasOptions = '';
                    try {
                        const residenciasResponse = await fetch(`${API_URL}/api/v1/residencias`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (residenciasResponse.ok) {
                            const residenciasData = await residenciasResponse.json();
                            residenciasData.residencias.forEach(residencia => {
                                if (residencia.activa || residenciasData.residencias.length <= 2) {
                                    residenciasOptions += `<option value="${residencia.id_residencia}" ${res.id_residencia === residencia.id_residencia ? 'selected' : ''}>${residencia.nombre}</option>`;
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Error al cargar residencias:', error);
                        // Fallback a valores por defecto si falla la carga
                        residenciasOptions = `<option value="1" ${res.id_residencia === 1 ? 'selected' : ''}>Violetas 1</option>
                                            <option value="2" ${res.id_residencia === 2 ? 'selected' : ''}>Violetas 2</option>`;
                    }
                    
                    let html = `
                        <form id="formEditResidente" onsubmit="updateResidente(event, ${idResidente})">
                            
                            <!-- SECCIÓN: Información de Residencia -->
                            <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/home.svg" alt="Residencia" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Residencia</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="edit_id_residencia">Residencia *</label>
                                        <select id="edit_id_residencia" name="id_residencia" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            ${residenciasOptions}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_habitacion">Habitación *</label>
                                        <select id="edit_habitacion" name="habitacion" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione una habitación</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                    <div class="form-group">
                                        <label for="edit_fecha_ingreso">Fecha de Ingreso</label>
                                        <input type="date" id="edit_fecha_ingreso" name="fecha_ingreso" value="${res.fecha_ingreso || ''}" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_costo_habitacion">Costo de Habitación (€)</label>
                                        <input type="number" id="edit_costo_habitacion" name="costo_habitacion" step="0.01" value="${res.costo_habitacion || ''}" placeholder="0.00">
                                    </div>
                                </div>
                                <div style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label for="edit_metodo_pago_preferido">Método de Pago Preferido</label>
                                        <select id="edit_metodo_pago_preferido" name="metodo_pago_preferido" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione un método</option>
                                            <option value="transferencia" ${res.metodo_pago_preferido === 'transferencia' ? 'selected' : ''}>Transferencia</option>
                                            <option value="remesa" ${res.metodo_pago_preferido === 'remesa' ? 'selected' : ''}>Remesa</option>
                                            <option value="metálico" ${res.metodo_pago_preferido === 'metálico' ? 'selected' : ''}>Metálico</option>
                                            <option value="bizum" ${res.metodo_pago_preferido === 'bizum' ? 'selected' : ''}>Bizum</option>
                                            <option value="otro" ${res.metodo_pago_preferido && !['transferencia', 'remesa', 'metálico', 'bizum'].includes(res.metodo_pago_preferido) ? 'selected' : ''}>Otro</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN: Información Personal -->
                            <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                                <h3 style="color: #f56565; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/user-medical.svg" alt="Usuario" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Personal</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="edit_nombre">Nombre *</label>
                                        <input type="text" id="edit_nombre" name="nombre" value="${res.nombre || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_apellido">Apellido *</label>
                                        <input type="text" id="edit_apellido" name="apellido" value="${res.apellido || ''}" required>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                    <div class="form-group">
                                        <label for="edit_documento">Documento de Identidad</label>
                                        <input type="text" id="edit_documento" name="documento_identidad" value="${res.documento_identidad || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_fecha_nacimiento">Fecha de Nacimiento</label>
                                        <input type="date" id="edit_fecha_nacimiento" name="fecha_nacimiento" value="${res.fecha_nacimiento || ''}" onchange="actualizarEdad('edit_fecha_nacimiento', 'edit_edad')" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_edad">Edad</label>
                                        <input type="text" id="edit_edad" name="edad" readonly style="background-color: #f5f5f5; color: #666; cursor: not-allowed;" placeholder="Se calculará automáticamente" value="${res.fecha_nacimiento ? calcularEdadDesdeISO(res.fecha_nacimiento) : ''}">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN: Información de Contacto -->
                            <div style="background: #f0fff4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                                <h3 style="color: #48bb78; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/phone.svg" alt="Contacto" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información de Contacto</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="edit_telefono">Teléfono</label>
                                        <input type="tel" id="edit_telefono" name="telefono" value="${res.telefono || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_direccion">Dirección</label>
                                        <input type="text" id="edit_direccion" name="direccion" value="${res.direccion || ''}">
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                    <h4 style="color: #48bb78; margin-bottom: 10px; font-size: 14px; font-weight: 600;">Contacto de Emergencia</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div class="form-group">
                                            <label for="edit_contacto_emergencia">Nombre del Contacto</label>
                                            <input type="text" id="edit_contacto_emergencia" name="contacto_emergencia" value="${res.contacto_emergencia || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit_telefono_emergencia">Teléfono de Emergencia</label>
                                            <input type="tel" id="edit_telefono_emergencia" name="telefono_emergencia" value="${res.telefono_emergencia || ''}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN: Información Médica y Servicios -->
                            <div style="background: #fffaf0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                                <h3 style="color: #ed8936; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/clipboard-medical.svg" alt="Información Médica" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Información Médica y Servicios</h3>
                                
                                <!-- Datos Médicos Esenciales -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div class="form-group">
                                        <label for="edit_grupo_sanguineo">Grupo Sanguíneo</label>
                                        <select id="edit_grupo_sanguineo" name="grupo_sanguineo" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione</option>
                                            <option value="A+" ${res.grupo_sanguineo === 'A+' ? 'selected' : ''}>A+</option>
                                            <option value="A-" ${res.grupo_sanguineo === 'A-' ? 'selected' : ''}>A-</option>
                                            <option value="B+" ${res.grupo_sanguineo === 'B+' ? 'selected' : ''}>B+</option>
                                            <option value="B-" ${res.grupo_sanguineo === 'B-' ? 'selected' : ''}>B-</option>
                                            <option value="AB+" ${res.grupo_sanguineo === 'AB+' ? 'selected' : ''}>AB+</option>
                                            <option value="AB-" ${res.grupo_sanguineo === 'AB-' ? 'selected' : ''}>AB-</option>
                                            <option value="O+" ${res.grupo_sanguineo === 'O+' ? 'selected' : ''}>O+</option>
                                            <option value="O-" ${res.grupo_sanguineo === 'O-' ? 'selected' : ''}>O-</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_nivel_dependencia">Nivel de Dependencia</label>
                                        <select id="edit_nivel_dependencia" name="nivel_dependencia" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione</option>
                                            <option value="Autónomo" ${res.nivel_dependencia === 'Autónomo' ? 'selected' : ''}>Autónomo</option>
                                            <option value="Dependencia leve" ${res.nivel_dependencia === 'Dependencia leve' ? 'selected' : ''}>Dependencia leve</option>
                                            <option value="Dependencia moderada" ${res.nivel_dependencia === 'Dependencia moderada' ? 'selected' : ''}>Dependencia moderada</option>
                                            <option value="Dependencia severa" ${res.nivel_dependencia === 'Dependencia severa' ? 'selected' : ''}>Dependencia severa</option>
                                            <option value="Gran dependencia" ${res.nivel_dependencia === 'Gran dependencia' ? 'selected' : ''}>Gran dependencia</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label for="edit_alergias">Alergias</label>
                                        <textarea id="edit_alergias" name="alergias" rows="2" placeholder="Ej: Penicilina, Lácteos, Polen">${res.alergias || ''}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_diagnosticos">Enfermedades / Diagnósticos</label>
                                        <textarea id="edit_diagnosticos" name="diagnosticos" rows="2" placeholder="Ej: Diabetes tipo 2, Hipertensión, Artritis">${res.diagnosticos || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label for="edit_restricciones_dieteticas">Restricciones Dietéticas</label>
                                        <textarea id="edit_restricciones_dieteticas" name="restricciones_dieteticas" rows="2" placeholder="Ej: Sin sal, Textura triturada, Sin gluten">${res.restricciones_dieteticas || ''}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_movilidad">Movilidad / Ayudas Técnicas</label>
                                        <select id="edit_movilidad" name="movilidad" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; color: #333333;">
                                            <option value="">Seleccione</option>
                                            <option value="Deambulación autónoma" ${res.movilidad === 'Deambulación autónoma' ? 'selected' : ''}>Deambulación autónoma</option>
                                            <option value="Bastón" ${res.movilidad === 'Bastón' ? 'selected' : ''}>Bastón</option>
                                            <option value="Andador" ${res.movilidad === 'Andador' ? 'selected' : ''}>Andador</option>
                                            <option value="Silla de ruedas" ${res.movilidad === 'Silla de ruedas' ? 'selected' : ''}>Silla de ruedas</option>
                                            <option value="Cama" ${res.movilidad === 'Cama' ? 'selected' : ''}>Cama</option>
                                            <option value="Otro" ${res.movilidad && !['Deambulación autónoma', 'Bastón', 'Andador', 'Silla de ruedas', 'Cama'].includes(res.movilidad) ? 'selected' : ''}>Otro</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label for="edit_medico_referencia">Médico de Referencia</label>
                                        <input type="text" id="edit_medico_referencia" name="medico_referencia" value="${res.medico_referencia || ''}" placeholder="Nombre del médico o centro de salud">
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_telefono_medico">Teléfono Médico</label>
                                        <input type="text" id="edit_telefono_medico" name="telefono_medico" value="${res.telefono_medico || ''}" placeholder="Teléfono del médico o centro">
                                    </div>
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <label for="edit_medicaciones">Medicaciones</label>
                                    <textarea id="edit_medicaciones" name="medicaciones" rows="3" placeholder="Lista de medicaciones y horarios">${res.medicaciones || ''}</textarea>
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <label>Servicios Extra</label>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                            <input type="checkbox" class="edit_servicio_extra" value="Peluquería" style="width: auto; margin-right: 8px;">
                                            Peluquería
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                            <input type="checkbox" class="edit_servicio_extra" value="Podólogo" style="width: auto; margin-right: 8px;">
                                            Podólogo
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                            <input type="checkbox" class="edit_servicio_extra" value="Fisio" style="width: auto; margin-right: 8px;">
                                            Fisio
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                            <input type="checkbox" class="edit_servicio_extra" value="Farmacia" style="width: auto; margin-right: 8px;">
                                            Farmacia
                                        </label>
                                </div>
                                    <input type="hidden" id="edit_servicios_extra" name="servicios_extra" value="${res.servicios_extra || ''}">
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <label for="edit_peculiaridades">Peculiaridades / Notas Importantes</label>
                                    <textarea id="edit_peculiaridades" name="peculiaridades" rows="3" placeholder="Información adicional relevante">${res.peculiaridades || ''}</textarea>
                                </div>
                            </div>
                            
                            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                            
                            <div class="form-group">
                                <h3 style="color: #667eea; margin-bottom: 15px;"><img src="/static/icons/medical/file-medical.svg" alt="Documentación" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Documentación</h3>
                                
                                <div id="documentosList" style="margin-bottom: 20px;">
                                    <p style="color: #666;">Cargando documentos...</p>
                                </div>
                                
                                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 15px;">
                                    <h4 style="color: #667eea; margin-bottom: 10px; font-size: 14px;">Agregar Nuevo Documento</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px;">
                                        <select id="doc_tipo" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #333;">
                                            <option value="">Tipo de documento</option>
                                            <option value="Médica">Médica</option>
                                            <option value="Bancaria">Bancaria</option>
                                            <option value="Legal">Legal</option>
                                            <option value="Seguro">Seguro</option>
                                            <option value="Identidad">Identidad</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                        <input type="file" id="doc_archivo" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #333;">
                                    </div>
                                    <textarea id="doc_descripcion" placeholder="Descripción (opcional)" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: white; color: #333; font-family: inherit;"></textarea>
                                    ${botonConIdSiPermiso('crear:documento', {
                                        texto: '+ Subir Documento',
                                        funcionOnclick: 'agregarDocumento',
                                        estilo: 'width: auto; padding: 8px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;'
                                    }, idResidente)}
                                </div>
                            </div>
                            
                            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                            
                            <!-- SECCIÓN: Estado -->
                            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #718096;">
                                <h3 style="color: #718096; margin-bottom: 15px; font-size: 18px;"><img src="/static/icons/medical/settings.svg" alt="Estado" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Estado</h3>
                                ${res.activo ? `
                                    <div class="form-group">
                                        <p style="color: #28a745; font-weight: 600; margin-bottom: 15px;">
                                            <img src="/static/icons/medical/check-circle.svg" alt="Activo" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Residente Activo
                                        </p>
                                        ${usuarioTienePermiso('editar:residente') ? '<button type="button" onclick="abrirModalBaja(' + res.id_residente + ')" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;"><img src="/static/icons/medical/user-x.svg" alt="Dar de baja" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px; filter: brightness(0) invert(1);"> Dar de Baja</button>' : ''}
                                    </div>
                                ` : `
                                    <div class="form-group">
                                        <p style="color: #dc3545; font-weight: 600; margin-bottom: 10px;">
                                            <img src="/static/icons/medical/user-x.svg" alt="Inactivo" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;"> Usuario de Baja
                                        </p>
                                        <p style="color: #666; margin-bottom: 5px;"><strong>Motivo:</strong> ${res.motivo_baja || 'No especificado'}</p>
                                        <p style="color: #666; margin-bottom: 15px;"><strong>Fecha de baja:</strong> ${res.fecha_baja ? fechaISOToEspanol(res.fecha_baja) : 'No especificada'}</p>
                                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                                            ${usuarioTienePermiso('editar:residente') ? '<button type="button" onclick="reactivarResidente(' + res.id_residente + ')" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;"><img src="/static/icons/medical/check-circle.svg" alt="Dar de alta" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px; filter: brightness(0) invert(1);"> Dar de Alta</button>' : ''}
                                            ${usuarioTienePermiso('eliminar:residente') ? '<button type="button" onclick="confirmarEliminarResidente(' + res.id_residente + ')" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;"><img src="/static/icons/medical/alert-circle.svg" alt="Eliminar" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px; filter: brightness(0) invert(1);"> Eliminar Completamente</button>' : ''}
                                        </div>
                                    </div>
                                `}
                            </div>
                            
                            <div id="editModalAlert" class="alert" style="display: none;"></div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                ${usuarioTienePermiso('editar:residente') ? `<button type="submit" id="updateResidenteBtn" style="flex: 1;">Guardar Cambios</button>` : ''}
                                <button type="button" onclick="closeModal('modalViewResidente')" style="flex: 1; background: #6c757d;">Cerrar</button>
                            </div>
                        </form>
                    `;
                    
                    content.innerHTML = html;
                    
                    // Cargar habitaciones según la residencia actual y establecer la habitación seleccionada
                    const editSelectResidencia = document.getElementById('edit_id_residencia');
                    const editSelectHabitacion = document.getElementById('edit_habitacion');
                    if (editSelectResidencia && editSelectHabitacion) {
                        // Cargar habitaciones para la residencia actual
                        await actualizarHabitaciones(res.id_residencia, 'edit_habitacion', res.habitacion);
                        
                        // Añadir event listener para cuando cambie la residencia
                        editSelectResidencia.addEventListener('change', async function() {
                            await actualizarHabitaciones(this.value, 'edit_habitacion');
                        });
                    }
                    
                    // Inicializar calendarios con flatpickr en el modal de edición
                    const editFechaIngresoInput = document.getElementById('edit_fecha_ingreso');
                    const editFechaNacimientoInput = document.getElementById('edit_fecha_nacimiento');
                    
                    // Destruir instancias anteriores si existen
                    if (flatpickrEditIngreso) {
                        flatpickrEditIngreso.destroy();
                    }
                    if (flatpickrEditNacimiento) {
                        flatpickrEditNacimiento.destroy();
                    }
                    
                    // Inicializar flatpickr para fecha de ingreso (edición)
                    if (editFechaIngresoInput) {
                        flatpickrEditIngreso = flatpickr(editFechaIngresoInput, {
                            dateFormat: "d/m/Y",
                            locale: "es",
                            allowInput: true,
                            clickOpens: true,
                            appendTo: document.body,
                            maxDate: "today", // La fecha de ingreso no puede ser mayor que hoy
                            onChange: function(selectedDates, dateStr, instance) {
                                // Asegurar formato DD/MM/YYYY
                                if (dateStr) {
                                    const partes = dateStr.split('/');
                                    if (partes.length === 3) {
                                        const dia = partes[0].padStart(2, '0');
                                        const mes = partes[1].padStart(2, '0');
                                        const año = partes[2];
                                        instance.input.value = `${dia}/${mes}/${año}`;
                                    }
                                }
                            }
                        });
                    }
                    
                    // Inicializar flatpickr para fecha de nacimiento (edición)
                    if (editFechaNacimientoInput) {
                        flatpickrEditNacimiento = flatpickr(editFechaNacimientoInput, {
                            dateFormat: "d/m/Y",
                            locale: "es",
                            allowInput: true,
                            clickOpens: true,
                            appendTo: document.body,
                            maxDate: "today", // No permitir fechas futuras
                            onChange: function(selectedDates, dateStr, instance) {
                                // Asegurar formato DD/MM/YYYY
                                if (dateStr) {
                                    const partes = dateStr.split('/');
                                    if (partes.length === 3) {
                                        const dia = partes[0].padStart(2, '0');
                                        const mes = partes[1].padStart(2, '0');
                                        const año = partes[2];
                                        instance.input.value = `${dia}/${mes}/${año}`;
                                    }
                                }
                                // Actualizar edad cuando cambia la fecha
                                actualizarEdad('edit_fecha_nacimiento', 'edit_edad');
                            }
                        });
                    }
                    
                    // Cargar servicios extra al editar
                    if (res.servicios_extra) {
                        const serviciosArray = res.servicios_extra.split(',').map(s => s.trim());
                        const serviciosPredefinidos = ['Peluquería', 'Podólogo', 'Fisio', 'Farmacia'];
                        const serviciosOtros = [];
                        
                        serviciosArray.forEach(servicio => {
                            if (serviciosPredefinidos.includes(servicio)) {
                                // Marcar el checkbox correspondiente
                                const checkbox = document.querySelector(`.edit_servicio_extra[value="${servicio}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                }
                            } else {
                                // Añadir a otros servicios
                                serviciosOtros.push(servicio);
                            }
                        });
                    }
                    
                    // Cargar documentos del residente
                    await loadDocumentos(idResidente);
                } else {
                    content.innerHTML = `<div class="alert error">Error: ${res.error}</div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="alert error">Error de conexión: ${error.message}</div>`;
            }
        }

        async function loadDocumentos(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const documentosList = document.getElementById('documentosList');
            
            if (!documentosList) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/documentos`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta de documentos no es JSON:', text);
                    documentosList.innerHTML = `<p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${response.status}</p>`;
                    return;
                }
                
                if (response.ok) {
                    if (data.documentos && data.documentos.length > 0) {
                        let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                        data.documentos.forEach(doc => {
                            const tamaño = doc.tamaño_bytes ? `(${(doc.tamaño_bytes / 1024).toFixed(1)} KB)` : '';
                            html += `
                                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <strong style="color: #667eea;">${doc.tipo_documento}</strong>
                                        <p style="margin: 5px 0; color: #333;">${doc.nombre_archivo} ${tamaño}</p>
                                        ${doc.descripcion ? `<p style="margin: 0; color: #666; font-size: 12px;">${doc.descripcion}</p>` : ''}
                                        <p style="margin: 5px 0 0 0; color: #999; font-size: 11px;">${new Date(doc.fecha_subida).toLocaleDateString('es-ES')}</p>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 100px;">
                                        ${doc.url_descarga ? `
                                            <button onclick="window.open('${doc.url_descarga}', '_blank')" style="padding: 8px; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Ver documento">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: brightness(0) invert(1);">
                                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" fill="currentColor"/>
                                                </svg>
                                            </button>
                                            <button onclick="window.open('${doc.url_descarga}', '_blank')" style="padding: 8px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Descargar documento">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: brightness(0) invert(1);">
                                                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" fill="currentColor"/>
                                                </svg>
                                            </button>
                                        ` : `
                                            <div></div>
                                            <div></div>
                                        `}
                                        ${usuarioTienePermiso('eliminar:documento') ? '<button onclick="eliminarDocumento(' + doc.id_documento + ', ' + idResidente + ')" style="padding: 8px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Eliminar documento"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: brightness(0) invert(1);"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/></svg></button>' : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        documentosList.innerHTML = html;
                    } else {
                        documentosList.innerHTML = '<p style="color: #666; font-style: italic;">No hay documentos registrados.</p>';
                    }
                } else {
                    if (response.status === 401) {
                        documentosList.innerHTML = `<p style="color: red;">Sesión expirada. Por favor, recarga la página.</p>`;
                    } else {
                        documentosList.innerHTML = `<p style="color: red;">Error (${response.status}): ${data.error || 'Error desconocido'}</p>`;
                    }
                    console.error('Error al cargar documentos:', response.status, data);
                }
            } catch (error) {
                console.error('Error de conexión al cargar documentos:', error);
                documentosList.innerHTML = `<p style="color: red;">Error de conexión: ${error.message}</p>`;
            }
        }

        async function agregarDocumento(idResidente) {
            const token = localStorage.getItem('violetas_token');
            const tipo = document.getElementById('doc_tipo').value;
            const archivoInput = document.getElementById('doc_archivo');
            const archivo = archivoInput.files[0];
            const descripcion = document.getElementById('doc_descripcion').value;
            
            if (!tipo) {
                alert('Por favor seleccione el tipo de documento');
                return;
            }
            
            if (!archivo) {
                alert('Por favor seleccione un archivo');
                return;
            }
            
            // Validar tamaño (máximo 10MB)
            if (archivo.size > 10 * 1024 * 1024) {
                alert('El archivo es demasiado grande. Máximo 10MB');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('archivo', archivo);
                formData.append('tipo_documento', tipo);
                if (descripcion) {
                    formData.append('descripcion', descripcion);
                }
                
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}/documentos`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Limpiar formulario
                    document.getElementById('doc_tipo').value = '';
                    archivoInput.value = '';
                    document.getElementById('doc_descripcion').value = '';
                    
                    // Recargar lista de documentos
                    await loadDocumentos(idResidente);
                } else {
                    alert('Error: ' + (result.error || 'Error al subir documento'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        async function eliminarDocumento(idDocumento, idResidente) {
            if (!confirm('¿Está seguro de que desea eliminar este documento?')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/documentos/${idDocumento}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Recargar lista de documentos
                    await loadDocumentos(idResidente);
                } else {
                    alert('Error: ' + (result.error || 'Error al eliminar documento'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        async function updateResidente(event, idResidente) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const updateBtn = document.getElementById('updateResidenteBtn');
            const originalText = updateBtn.textContent;
            
            const formData = new FormData(form);
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showEditModalError('Debe seleccionar una residencia');
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
                return;
            }
            
            // Convertir fechas de formato español a ISO antes de enviar
            const fecha_nacimiento_es = formData.get('fecha_nacimiento');
            const fecha_ingreso_es = formData.get('fecha_ingreso');
            
            // Validar fechas antes de convertir
            if (fecha_nacimiento_es && !validarFechaEspanol(fecha_nacimiento_es)) {
                showEditModalError('La fecha de nacimiento no es válida. Use formato DD/MM/YYYY');
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
                return;
            }
            
            if (fecha_ingreso_es && !validarFechaEspanol(fecha_ingreso_es)) {
                showEditModalError('La fecha de ingreso no es válida. Use formato DD/MM/YYYY');
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
                return;
            }
            
            const data = {
                id_residencia: parseInt(id_residencia),
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                habitacion: formData.get('habitacion'),
                documento_identidad: formData.get('documento_identidad') || null,
                telefono: formData.get('telefono') || null,
                fecha_nacimiento: fecha_nacimiento_es ? fechaEspanolToISO(fecha_nacimiento_es) : null,
                direccion: formData.get('direccion') || null,
                contacto_emergencia: formData.get('contacto_emergencia') || null,
                telefono_emergencia: formData.get('telefono_emergencia') || null,
                fecha_ingreso: fecha_ingreso_es ? fechaEspanolToISO(fecha_ingreso_es) : null,
                costo_habitacion: formData.get('costo_habitacion') ? parseFloat(formData.get('costo_habitacion')) : null,
                metodo_pago_preferido: formData.get('metodo_pago_preferido') || null,
                servicios_extra: (() => {
                    // Combinar servicios extra seleccionados en el formulario de edición
                    const serviciosSeleccionados = [];
                    const checkboxesServicios = document.querySelectorAll('.edit_servicio_extra:checked');
                    checkboxesServicios.forEach(cb => {
                        serviciosSeleccionados.push(cb.value);
                    });
                    return serviciosSeleccionados.length > 0 ? serviciosSeleccionados.join(', ') : null;
                })(),
                medicaciones: formData.get('medicaciones') || null,
                peculiaridades: formData.get('peculiaridades') || null,
                grupo_sanguineo: formData.get('grupo_sanguineo') || null,
                alergias: formData.get('alergias') || null,
                diagnosticos: formData.get('diagnosticos') || null,
                restricciones_dieteticas: formData.get('restricciones_dieteticas') || null,
                nivel_dependencia: formData.get('nivel_dependencia') || null,
                movilidad: formData.get('movilidad') || null,
                medico_referencia: formData.get('medico_referencia') || null,
                telefono_medico: formData.get('telefono_medico') || null
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            updateBtn.disabled = true;
            updateBtn.textContent = 'Guardando...';
            hideEditModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes/${idResidente}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showEditModalSuccess('Residente actualizado exitosamente');
                    setTimeout(() => {
                        closeModal('modalViewResidente');
                        loadResidentes(); // Recargar la lista
                    }, 1500);
                } else {
                    showEditModalError(result.error || 'Error al actualizar el residente');
                    updateBtn.disabled = false;
                    updateBtn.textContent = originalText;
                }
            } catch (error) {
                showEditModalError('Error de conexión: ' + error.message);
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
            }
        }

        function showEditModalError(message) {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showEditModalSuccess(message) {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideEditModalAlert() {
            const alert = document.getElementById('editModalAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        async function saveResidente(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveResidenteBtn');
            const originalText = saveBtn.textContent;
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showModalError('Debe seleccionar una residencia');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Convertir fechas de formato español a ISO antes de enviar
            const fecha_nacimiento_es = formData.get('fecha_nacimiento');
            const fecha_ingreso_es = formData.get('fecha_ingreso');
            
            // Validar fechas antes de convertir
            if (fecha_nacimiento_es && !validarFechaEspanol(fecha_nacimiento_es)) {
                showModalError('La fecha de nacimiento no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            if (fecha_ingreso_es && !validarFechaEspanol(fecha_ingreso_es)) {
                showModalError('La fecha de ingreso no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Combinar servicios extra seleccionados
            const serviciosSeleccionados = [];
            const checkboxesServicios = form.querySelectorAll('input[name="servicio_extra"]:checked');
            checkboxesServicios.forEach(cb => {
                serviciosSeleccionados.push(cb.value);
            });
            const otrosServicios = formData.get('servicios_extra_otros') || '';
            if (otrosServicios.trim()) {
                // Dividir por comas y limpiar espacios
                const otros = otrosServicios.split(',').map(s => s.trim()).filter(s => s);
                serviciosSeleccionados.push(...otros);
            }
            const serviciosExtraCombinados = serviciosSeleccionados.length > 0 ? serviciosSeleccionados.join(', ') : null;
            
            const data = {
                id_residencia: parseInt(id_residencia),
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                habitacion: formData.get('habitacion') || null,
                documento_identidad: formData.get('documento_identidad') || null,
                telefono: formData.get('telefono') || null,
                fecha_nacimiento: fecha_nacimiento_es ? fechaEspanolToISO(fecha_nacimiento_es) : null,
                direccion: formData.get('direccion') || null,
                contacto_emergencia: formData.get('contacto_emergencia') || null,
                telefono_emergencia: formData.get('telefono_emergencia') || null,
                fecha_ingreso: fecha_ingreso_es ? fechaEspanolToISO(fecha_ingreso_es) : null,
                costo_habitacion: formData.get('costo_habitacion') ? parseFloat(formData.get('costo_habitacion')) : null,
                metodo_pago_preferido: formData.get('metodo_pago_preferido') || null,
                servicios_extra: serviciosExtraCombinados,
                medicaciones: formData.get('medicaciones') || null,
                peculiaridades: formData.get('peculiaridades') || null,
                grupo_sanguineo: formData.get('grupo_sanguineo') || null,
                alergias: formData.get('alergias') || null,
                diagnosticos: formData.get('diagnosticos') || null,
                restricciones_dieteticas: formData.get('restricciones_dieteticas') || null,
                nivel_dependencia: formData.get('nivel_dependencia') || null,
                movilidad: formData.get('movilidad') || null,
                medico_referencia: formData.get('medico_referencia') || null,
                telefono_medico: formData.get('telefono_medico') || null,
                activo: true  // Los nuevos residentes siempre son activos
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residentes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showModalSuccess('Residente agregado exitosamente');
                    // Restablecer el botón antes de cerrar el modal
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    setTimeout(() => {
                        closeModal('modalResidente');
                        loadResidentes(); // Recargar la lista
                    }, 1500);
                } else {
                    showModalError(result.error || 'Error al guardar el residente');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showModalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        function showModalError(message) {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showModalSuccess(message) {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideModalAlert() {
            const alert = document.getElementById('modalAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        async function savePersonal(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('savePersonalBtn');
            const originalText = saveBtn.textContent;
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            
            const id_residencia = formData.get('id_residencia');
            if (!id_residencia) {
                showModalPersonalError('Debe seleccionar una residencia');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            // Convertir fecha de formato español a ISO antes de enviar
            const fecha_contratacion_es = formData.get('fecha_contratacion');
            
            // Validar fecha antes de convertir
            if (fecha_contratacion_es && !validarFechaEspanol(fecha_contratacion_es)) {
                showModalPersonalError('La fecha de contratación no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            const id_personal = formData.get('id_personal');
            const esEdicion = id_personal && id_personal !== '';
            
            const data = {
                id_residencia: parseInt(id_residencia),
                nombre: formData.get('nombre'),
                apellido: formData.get('apellido'),
                documento_identidad: formData.get('documento_identidad') || null,
                telefono: formData.get('telefono') || null,
                email: formData.get('email') || null,
                cargo: formData.get('cargo') || null,
                fecha_contratacion: fecha_contratacion_es ? fechaEspanolToISO(fecha_contratacion_es) : null,
                activo: formData.get('activo') === 'true'  // Usar el valor del formulario
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = esEdicion ? 'Actualizando...' : 'Guardando...';
            hideModalPersonalAlert();
            
            try {
                const url = esEdicion 
                    ? `${API_URL}/api/v1/personal/${id_personal}`
                    : `${API_URL}/api/v1/personal`;
                const method = esEdicion ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                let result;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        console.error('Respuesta no es JSON:', text);
                        throw new Error(`Error del servidor (${response.status}): ${text.substring(0, 100)}`);
                    }
                } catch (parseError) {
                    console.error('Error al parsear respuesta:', parseError);
                    showModalPersonalError(`Error del servidor (${response.status}). Por favor, intenta de nuevo.`);
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }
                
                if (response.ok) {
                    showModalPersonalSuccess(esEdicion ? 'Personal actualizado exitosamente' : 'Personal agregado exitosamente');
                    // Restablecer el botón antes de cerrar el modal
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    setTimeout(() => {
                        closeModal('modalPersonal');
                        resetFormPersonal();
                        loadPersonal(); // Recargar la lista
                    }, 1500);
                } else {
                    showModalPersonalError(result.error || 'Error al guardar el personal');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error al guardar personal:', error);
                showModalPersonalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        async function editarPersonal(idPersonal) {
            if (!idPersonal) {
                showModalPersonalError('Error: ID de personal no válido');
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            if (!token) {
                showModalPersonalError('No hay sesión activa. Por favor, inicia sesión nuevamente.');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/v1/personal/${idPersonal}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let personal;
                
                if (contentType && contentType.includes('application/json')) {
                    personal = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON al obtener personal:', text);
                    showModalPersonalError(`Error: No se pudo obtener el personal. Status: ${response.status}`);
                    return;
                }
                
                if (response.ok) {
                    // Cargar residencias antes de llenar el formulario
                    await loadResidenciasIntoSelect('per_id_residencia', personal.id_residencia);
                    
                    // Llenar el formulario con los datos del personal
                    document.getElementById('per_id_personal').value = personal.id_personal;
                    document.getElementById('per_id_residencia').value = personal.id_residencia || '';
                    document.getElementById('per_nombre').value = personal.nombre || '';
                    document.getElementById('per_apellido').value = personal.apellido || '';
                    document.getElementById('per_documento').value = personal.documento_identidad || '';
                    document.getElementById('per_telefono').value = personal.telefono || '';
                    document.getElementById('per_email').value = personal.email || '';
                    document.getElementById('per_cargo').value = personal.cargo || '';
                    document.getElementById('per_activo').value = personal.activo ? 'true' : 'false';
                    
                    // Formatear fecha de contratación si existe
                    if (personal.fecha_contratacion) {
                        const fechaISO = personal.fecha_contratacion;
                        const fechaParts = fechaISO.split('T')[0].split('-');
                        const fechaEspanol = `${fechaParts[2]}/${fechaParts[1]}/${fechaParts[0]}`;
                        document.getElementById('per_fecha_contratacion').value = fechaEspanol;
                    } else {
                        document.getElementById('per_fecha_contratacion').value = '';
                    }
                    
                    // Inicializar calendario con flatpickr para fecha de contratación
                    const fechaContratacionInput = document.getElementById('per_fecha_contratacion');
                    if (fechaContratacionInput) {
                        // Destruir instancia anterior si existe
                        if (flatpickrContratacion) {
                            flatpickrContratacion.destroy();
                        }
                        flatpickrContratacion = flatpickr(fechaContratacionInput, {
                            dateFormat: 'd/m/Y',
                            locale: "es",
                            allowInput: false,
                            appendTo: document.body
                        });
                    }
                    
                    // Cambiar título del modal
                    const modalHeader = document.querySelector('#modalPersonal .modal-header h2');
                    if (modalHeader) {
                        modalHeader.innerHTML = '<img src="/static/icons/medical/settings.svg" alt="Editar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Editar Personal';
                    }
                    
                    // Abrir modal de edición
                    openModal('modalPersonal');
                } else {
                    // Manejar errores de autenticación
                    if (response.status === 401) {
                        showModalPersonalError('Sesión expirada. Por favor, recarga la página para iniciar sesión nuevamente.');
                        localStorage.removeItem('violetas_token');
                    } else if (response.status === 404) {
                        showModalPersonalError('El personal no se encontró. Puede que haya sido eliminado o no tengas permisos para verlo.');
                    } else {
                        showModalPersonalError('Error al obtener el personal: ' + (personal.error || `Error ${response.status}`));
                    }
                }
            } catch (error) {
                console.error('Error de conexión al obtener personal:', error);
                showModalPersonalError('Error de conexión: ' + error.message);
            }
        }

        function showModalPersonalError(message) {
            const alert = document.getElementById('modalPersonalAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showModalPersonalSuccess(message) {
            const alert = document.getElementById('modalPersonalAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideModalPersonalAlert() {
            const alert = document.getElementById('modalPersonalAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        function resetFormPersonal() {
            // Limpiar todos los campos del formulario
            document.getElementById('per_id_personal').value = '';
            document.getElementById('per_id_residencia').value = '';
            document.getElementById('per_nombre').value = '';
            document.getElementById('per_apellido').value = '';
            document.getElementById('per_documento').value = '';
            document.getElementById('per_telefono').value = '';
            document.getElementById('per_email').value = '';
            document.getElementById('per_cargo').value = '';
            document.getElementById('per_fecha_contratacion').value = '';
            document.getElementById('per_activo').value = 'true';
            
            // Restaurar título del modal
            const modalHeader = document.querySelector('#modalPersonal .modal-header h2');
            if (modalHeader) {
                modalHeader.innerHTML = '<img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Personal';
            }
            
            // Ocultar alertas
            hideModalPersonalAlert();
            
            // Destruir instancia de flatpickr si existe
            if (flatpickrContratacion) {
                flatpickrContratacion.destroy();
                flatpickrContratacion = null;
            }
        }

        async function loadTurnosExtra() {
            const turnosContent = document.getElementById('turnosExtraContent');
            if (!turnosContent) return;
            
            const token = localStorage.getItem('violetas_token');
            
            // Obtener filtros
            const filtroPersonal = document.getElementById('filtroPersonal');
            const filtroAprobado = document.getElementById('filtroAprobado');
            const idPersonal = filtroPersonal ? filtroPersonal.value : '';
            const aprobado = filtroAprobado ? filtroAprobado.value : '';
            
            let url = `${API_URL}/api/v1/turnos-extra`;
            const params = new URLSearchParams();
            if (idPersonal) params.append('id_personal', idPersonal);
            if (aprobado) params.append('aprobado', aprobado);
            if (params.toString()) url += '?' + params.toString();
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Respuesta no es JSON:', text);
                    turnosContent.innerHTML = `<p style="color: red;">Error: La respuesta del servidor no es válida. Status: ${response.status}</p>`;
                    return;
                }
                
                if (response.ok) {
                    let html = `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #667eea; margin: 0; margin-bottom: 15px;"><img src="/static/icons/medical/calendar-medical.svg" alt="Turnos" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px;"> Turnos Extra (${data.total || 0})</h4>
                            <button class="add-btn" onclick="openModal('modalTurnoExtra')" style="padding: 8px 16px; font-size: 14px;">+ Agregar Turno Extra</button>
                        </div>
                        
                        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: 600; color: #666;">Filtros:</label>
                            <select id="filtroPersonal" onchange="loadTurnosExtra()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="">Todos los empleados</option>
                            </select>
                            <select id="filtroAprobado" onchange="loadTurnosExtra()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="">Todos</option>
                                <option value="false">Pendientes</option>
                                <option value="true">Aprobados</option>
                            </select>
                        </div>
                    `;
                    
                    // Cargar lista de personal para el filtro
                    const personalResponse = await fetch(`${API_URL}/api/v1/personal`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    let personalData = { personal: [] };
                    if (personalResponse.ok) {
                        personalData = await personalResponse.json();
                    }
                    
                    // Actualizar select de personal
                    if (filtroPersonal) {
                        const currentValue = filtroPersonal.value;
                        filtroPersonal.innerHTML = '<option value="">Todos los empleados</option>';
                        personalData.personal.forEach(p => {
                            filtroPersonal.innerHTML += `<option value="${p.id_personal}" ${p.id_personal == currentValue ? 'selected' : ''}>${p.nombre} ${p.apellido}</option>`;
                        });
                    }
                    
                    if (filtroAprobado && aprobado) {
                        filtroAprobado.value = aprobado;
                    }
                    
                    if (data.turnos_extra && data.turnos_extra.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Empleado</th>
                                        <th>Fecha</th>
                                        <th>Hora Entrada</th>
                                        <th>Hora Salida</th>
                                        <th>Motivo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.turnos_extra.forEach(t => {
                            const fechaFormateada = t.fecha ? fechaISOToEspanol(t.fecha) : '-';
                            const estadoBadge = t.aprobado 
                                ? '<span style="background: #48bb78; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;"><img src="/static/icons/medical/check-circle.svg" alt="Aprobado" style="width: 14px; height: 14px; filter: brightness(0) invert(1);"> Aprobado</span>'
                                : '<span style="background: #ed8936; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;"><img src="/static/icons/medical/alert-circle.svg" alt="Pendiente" style="width: 14px; height: 14px; filter: brightness(0) invert(1);"> Pendiente</span>';
                            
                            html += `
                                <tr>
                                    <td>${t.nombre_personal || '-'}${t.cargo ? ' (' + t.cargo + ')' : ''}</td>
                                    <td>${fechaFormateada}</td>
                                    <td>${t.hora_entrada || '-'}</td>
                                    <td>${t.hora_salida || '-'}</td>
                                    <td>${t.motivo || '-'}</td>
                                    <td>${estadoBadge}</td>
                                    <td style="display: flex; gap: 5px;">
                                        ${!t.aprobado ? `<button onclick="aprobarTurnoExtra(${t.id_turno_extra})" style="padding: 6px 12px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Aprobar</button>` : ''}
                                        <button onclick="editarTurnoExtra(${t.id_turno_extra})" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Editar</button>
                                        <button onclick="eliminarTurnoExtra(${t.id_turno_extra})" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Eliminar</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                    } else {
                        html += '<p>No hay turnos extra registrados.</p>';
                    }
                    
                    turnosContent.innerHTML = html;
                } else {
                    if (response.status === 401) {
                        turnosContent.innerHTML = `<p style="color: red;">Error: Sesión expirada. Por favor, recarga la página.</p>`;
                        localStorage.removeItem('violetas_token');
                    } else {
                        turnosContent.innerHTML = `<p style="color: red;">Error (${response.status}): ${data.error || 'Error desconocido'}</p>`;
                    }
                }
            } catch (error) {
                console.error('Error de conexión al cargar turnos extra:', error);
                if (turnosContent) {
                    turnosContent.innerHTML = `<p style="color: red;">Error de conexión: ${error.message}</p>`;
                }
            }
        }

        async function saveTurnoExtra(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveTurnoExtraBtn');
            const originalText = saveBtn.textContent;
            const idTurnoExtra = document.getElementById('turno_id_turno_extra').value;
            
            const formData = new FormData(form);
            
            const fecha_es = formData.get('fecha');
            if (!fecha_es || !validarFechaEspanol(fecha_es)) {
                showModalTurnoExtraError('La fecha no es válida. Use formato DD/MM/YYYY');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                return;
            }
            
            const data = {
                id_personal: parseInt(formData.get('id_personal')),
                fecha: fechaEspanolToISO(fecha_es),
                hora_entrada: formData.get('hora_entrada'),
                hora_salida: formData.get('hora_salida'),
                motivo: formData.get('motivo') || null
            };
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideModalTurnoExtraAlert();
            
            try {
                const url = idTurnoExtra 
                    ? `${API_URL}/api/v1/turnos-extra/${idTurnoExtra}`
                    : `${API_URL}/api/v1/turnos-extra`;
                const method = idTurnoExtra ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showModalTurnoExtraSuccess(idTurnoExtra ? 'Turno extra actualizado exitosamente' : 'Turno extra creado exitosamente');
                    // Restablecer el botón antes de cerrar el modal
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    setTimeout(() => {
                        closeModal('modalTurnoExtra');
                        loadTurnosExtra();
                    }, 1500);
                } else {
                    showModalTurnoExtraError(result.error || 'Error al guardar el turno extra');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                showModalTurnoExtraError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        async function aprobarTurnoExtra(idTurnoExtra) {
            if (!confirm('¿Está seguro de aprobar este turno extra?')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/turnos-extra/${idTurnoExtra}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ aprobado: true })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Turno extra aprobado exitosamente');
                    loadTurnosExtra();
                } else {
                    alert('Error: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        async function editarTurnoExtra(idTurnoExtra) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/turnos-extra`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.turnos_extra) {
                    const turno = data.turnos_extra.find(t => t.id_turno_extra === idTurnoExtra);
                    
                    if (turno) {
                        // Cargar personal para el select
                        const personalResponse = await fetch(`${API_URL}/api/v1/personal`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const personalData = await personalResponse.json();
                        
                        const selectPersonal = document.getElementById('turno_id_personal');
                        selectPersonal.innerHTML = '<option value="">Seleccione un empleado</option>';
                        personalData.personal.forEach(p => {
                            selectPersonal.innerHTML += `<option value="${p.id_personal}" ${p.id_personal == turno.id_personal ? 'selected' : ''}>${p.nombre} ${p.apellido}</option>`;
                        });
                        
                        // Llenar formulario
                        document.getElementById('turno_id_turno_extra').value = turno.id_turno_extra;
                        document.getElementById('turno_fecha').value = turno.fecha ? fechaISOToEspanol(turno.fecha) : '';
                        document.getElementById('turno_hora_entrada').value = turno.hora_entrada || '';
                        document.getElementById('turno_hora_salida').value = turno.hora_salida || '';
                        document.getElementById('turno_motivo').value = turno.motivo || '';
                        document.getElementById('modalTurnoExtraTitle').textContent = 'Editar Turno Extra';
                        
                        // Inicializar date picker
                        const fechaInput = document.getElementById('turno_fecha');
                        if (fechaInput && !window.flatpickrTurnoExtra) {
                            window.flatpickrTurnoExtra = flatpickr(fechaInput, {
                                dateFormat: "d/m/Y",
                                locale: "es",
                                allowInput: true,
                                clickOpens: true,
                                appendTo: document.body,
                                onChange: function(selectedDates, dateStr, instance) {
                                    if (dateStr) {
                                        const partes = dateStr.split('/');
                                        if (partes.length === 3) {
                                            const dia = partes[0].padStart(2, '0');
                                            const mes = partes[1].padStart(2, '0');
                                            const año = partes[2];
                                            instance.input.value = `${dia}/${mes}/${año}`;
                                        }
                                    }
                                }
                            });
                        }
                        
                        openModal('modalTurnoExtra');
                    } else {
                        alert('Turno extra no encontrado');
                    }
                } else {
                    alert('Error al cargar el turno extra');
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        async function eliminarTurnoExtra(idTurnoExtra) {
            if (!confirm('¿Está seguro de eliminar este turno extra? Esta acción no se puede deshacer.')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/turnos-extra/${idTurnoExtra}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Turno extra eliminado exitosamente');
                    loadTurnosExtra();
                } else {
                    alert('Error: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        function showModalTurnoExtraError(message) {
            const alert = document.getElementById('modalTurnoExtraAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function showModalTurnoExtraSuccess(message) {
            const alert = document.getElementById('modalTurnoExtraAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }

        function hideModalTurnoExtraAlert() {
            const alert = document.getElementById('modalTurnoExtraAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }
        // ========================================================================
        // FUNCIONES DE CONFIGURACIÓN Y GESTIÓN DE USUARIOS
        // ========================================================================
        
        async function loadUsuarios() {
            const content = document.getElementById('usuariosContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 15px; color: #666;">Cargando usuarios...</p>
                </div>
            `;
            
            openModal('modalUsuarios');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/usuarios`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    let html = `
                        <div style="margin-bottom: 20px;">
                            <button class="add-btn" onclick="resetUsuarioForm(); openModal('modalUsuario')" style="padding: 10px 20px; font-size: 16px;">
                                <img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px; filter: brightness(0) invert(1);"> Agregar Usuario
                            </button>
                        </div>
                    `;
                    
                    if (data.usuarios && data.usuarios.length > 0) {
                        html += `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Nombre</th>
                                        <th>Rol</th>
                                        <th>Residencia</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.usuarios.forEach(usuario => {
                            html += `
                                <tr>
                                    <td>${usuario.email}</td>
                                    <td>${usuario.nombre || ''} ${usuario.apellido || ''}</td>
                                    <td>${usuario.nombre_rol || 'N/A'}</td>
                                    <td>${usuario.nombre_residencia || 'N/A'}</td>
                                    <td>
                                        <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; ${usuario.activo ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">
                                            ${usuario.activo ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </td>
                                    <td>
                                        <button onclick="editarUsuario(${usuario.id_usuario})" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                            Editar
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                </tbody>
                            </table>
                        `;
                    } else {
                        html += '<p style="color: #666; text-align: center; padding: 40px;">No hay usuarios registrados.</p>';
                    }
                    
                    content.innerHTML = html;
                } else {
                    const error = await response.json();
                    content.innerHTML = `<p style="color: red;">Error: ${error.error || 'Error desconocido'}</p>`;
                }
            } catch (error) {
                console.error('Error al cargar usuarios:', error);
                content.innerHTML = `<p style="color: red;">Error de conexión: ${error.message}</p>`;
            }
        }
        
        async function editarUsuario(idUsuario) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/usuarios`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const usuario = data.usuarios.find(u => u.id_usuario === idUsuario);
                    
                    if (usuario) {
                        // 🔍 DEBUG: Ver qué residencias tiene el usuario
                        if (Array.isArray(usuario.residencias)) {
                            usuario.residencias.forEach((res, index) => {
                            });
                        }
                        
                        document.getElementById('usuario_id_usuario').value = usuario.id_usuario;
                        document.getElementById('usuario_email').value = usuario.email || '';
                        document.getElementById('usuario_nombre').value = usuario.nombre || '';
                        document.getElementById('usuario_apellido').value = usuario.apellido || '';
                        document.getElementById('usuario_activo').checked = usuario.activo !== false;
                        document.getElementById('usuario_password').required = false;
                        document.getElementById('passwordRequired').style.display = 'none';
                        document.getElementById('passwordHelp').textContent = 'Dejar vacío para no cambiar la contraseña. Si desea cambiarla, debe cumplir los requisitos: mínimo 8 caracteres, mayúscula, minúscula, número y carácter especial';
                        
                        document.getElementById('modalUsuarioTitulo').innerHTML = '<img src="/static/icons/medical/settings.svg" alt="Editar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Editar Usuario';
                        
                        // IMPORTANTE: Cargar roles PRIMERO
                        await loadRolesForSelect();
                        
                        // Deshabilitar temporalmente el evento onchange para evitar que sobrescriba los datos al editar
                        const selectRol = document.getElementById('usuario_id_rol');
                        const originalOnchange = selectRol.onchange;
                        selectRol.onchange = null;
                        
                        // Establecer valor del rol
                        selectRol.value = usuario.id_rol;
                        
                        // Cargar residencias y marcarlas automáticamente
                        await loadResidenciasForSelect(usuario.residencias || []);
                        
                        // Cargar permisos del usuario (incluye individuales + heredados del rol)
                        await loadModulosForSelect(usuario.permisos || []);
                        
                        // Restaurar el evento onchange DESPUÉS de cargar todos los datos
                        selectRol.onchange = originalOnchange;
                        
                        closeModal('modalUsuarios');
                        openModal('modalUsuario');
                    }
                }
            } catch (error) {
                console.error('Error al obtener usuario:', error);
                alert('Error al obtener información del usuario');
            }
        }
        
        function resetUsuarioForm() {
            document.getElementById('formUsuario').reset();
            document.getElementById('usuario_id_usuario').value = '';
            document.getElementById('usuario_password').required = true;
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('passwordHelp').textContent = 'Requerida al crear. Mínimo 8 caracteres, debe incluir mayúscula, minúscula, número y carácter especial (!@#$%^&*...)';
            document.getElementById('modalUsuarioTitulo').innerHTML = '<img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Agregar Usuario';
            
            // Desmarcar todos los checkboxes de residencias
            const checkboxes = document.querySelectorAll('input[name="residencias[]"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            loadRolesForSelect();
            loadResidenciasForSelect();
            loadModulosForSelect();
        }
        
        async function loadRolesForSelect() {
            const select = document.getElementById('usuario_id_rol');
            const token = localStorage.getItem('violetas_token');
            
            if (!select) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/roles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Seleccione un rol</option>';
                    
                    data.roles.forEach(rol => {
                        // El backend devuelve: Administrador (id_rol=2), Director (id_rol=3), Personal (id_rol=4)
                        select.innerHTML += `<option value="${rol.id_rol}" ${rol.id_rol == currentValue ? 'selected' : ''}>${rol.nombre}</option>`;
                    });
                    
                    // Agregar evento onchange para seleccionar automáticamente permisos según el rol
                    select.onchange = function() {
                        const rolSeleccionado = parseInt(this.value);
                            setTimeout(() => {
                                const permisosCheckboxes = document.querySelectorAll('input[name="permisos[]"]');
                            
                            if (rolSeleccionado === 2) { 
                                // Administrador (id_rol = 2): Seleccionar TODOS los permisos
                                permisosCheckboxes.forEach(cb => {
                                    cb.checked = true;
                                });
                            } else if (rolSeleccionado === 3) { 
                                // Director (id_rol = 3): Seleccionar todos EXCEPTO Configuración
                                permisosCheckboxes.forEach(cb => {
                                    // Si el permiso es de Configuración, no seleccionarlo
                                    const permisoValue = cb.value;
                                    const esConfiguracion = permisoValue === 'leer:usuario' || 
                                                          permisoValue === 'crear:usuario' || 
                                                          permisoValue === 'editar:usuario' || 
                                                          permisoValue === 'eliminar:usuario' || 
                                                          permisoValue === 'leer:residencia' || 
                                                          permisoValue === 'editar:residencia';
                                    cb.checked = !esConfiguracion;
                                });
                            } else {
                                // Otros roles: No seleccionar ningún permiso por defecto
                                permisosCheckboxes.forEach(cb => {
                                    cb.checked = false;
                                });
                            }
                            
                            // Actualizar textos de los botones "Todo"/"Ninguno"
                            document.querySelectorAll('#usuario_modulos_container button[type="button"]').forEach(btn => {
                                if (btn.textContent === 'Todo' || btn.textContent === 'Ninguno') {
                                    const moduloDiv = btn.closest('div[style*="margin-bottom: 20px"]');
                                    if (moduloDiv) {
                                        const checkboxes = moduloDiv.querySelectorAll('input[name="permisos[]"]');
                                        const todosSeleccionados = Array.from(checkboxes).every(cb => cb.checked);
                                        btn.textContent = todosSeleccionados ? 'Ninguno' : 'Todo';
                                    }
                                }
                            });
                            }, 100); // Pequeño delay para asegurar que los checkboxes estén cargados
                    };
                }
            } catch (error) {
                console.error('Error al cargar roles:', error);
            }
        }
        
        async function loadModulosForSelect(permisosSeleccionados = []) {
            const container = document.getElementById('usuario_modulos_container');
            const token = localStorage.getItem('violetas_token');
            
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Cargando módulos...</div>';
            
            try {
                const response = await fetch(`${API_URL}/api/v1/modulos`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    container.innerHTML = '';
                    
                    if (data.modulos && data.modulos.length > 0) {
                        data.modulos.forEach(modulo => {
                            const moduloDiv = document.createElement('div');
                            moduloDiv.style.cssText = 'margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;';
                            
                            const moduloHeader = document.createElement('div');
                            moduloHeader.style.cssText = 'font-weight: 600; font-size: 16px; color: #667eea; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px;';
                            
                            const moduloTitle = document.createElement('span');
                            moduloTitle.textContent = modulo.nombre;
                            
                            const selectAllBtn = document.createElement('button');
                            selectAllBtn.type = 'button';
                            selectAllBtn.textContent = 'Todo';
                            selectAllBtn.style.cssText = 'padding: 3px 8px; font-size: 11px; background: rgb(85, 104, 211); color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s; white-space: nowrap; width: fit-content;';
                            selectAllBtn.onmouseover = () => selectAllBtn.style.background = '#5568d3';
                            selectAllBtn.onmouseout = () => selectAllBtn.style.background = 'rgb(85, 104, 211)';
                            
                            moduloHeader.appendChild(moduloTitle);
                            moduloHeader.appendChild(selectAllBtn);
                            
                            const permisosDiv = document.createElement('div');
                            permisosDiv.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;';
                            
                            // Almacenar todos los IDs de permisos de este módulo
                            const permisoIds = [];
                            
                            modulo.permisos.forEach(permiso => {
                                const permisoId = `permiso_${permiso.id}`;
                                const estaSeleccionado = permisosSeleccionados.includes(permiso.id);
                                permisoIds.push(permisoId); // Guardar ID para el botón "Seleccionar Todo"
                                
                                const permisoLabel = document.createElement('label');
                                permisoLabel.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9f9f9; border-radius: 6px; cursor: pointer; transition: background 0.2s;';
                                permisoLabel.onmouseover = function() { this.style.background = '#f0f0f0'; };
                                permisoLabel.onmouseout = function() { this.style.background = '#f9f9f9'; };
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.name = 'permisos[]';
                                checkbox.value = permiso.id;
                                checkbox.id = permisoId;
                                checkbox.checked = estaSeleccionado;
                                checkbox.style.cssText = 'width: auto; margin: 0;';
                                
                                // Actualizar estado del botón cuando se cambia manualmente un checkbox
                                // El texto siempre será "Todo", no se cambia
                                checkbox.onchange = function() {
                                    // Solo actualizar visualmente si es necesario (el botón siempre dice "Todo")
                                };
                                
                                const permisoText = document.createElement('span');
                                permisoText.style.cssText = 'font-size: 14px; color: #333;';
                                permisoText.innerHTML = `<strong>${permiso.nombre}</strong> - ${permiso.descripcion}`;
                                
                                permisoLabel.appendChild(checkbox);
                                permisoLabel.appendChild(permisoText);
                                permisosDiv.appendChild(permisoLabel);
                            });
                            
                            // Funcionalidad del botón "Todo" - toggle: seleccionar/deseleccionar todo
                            selectAllBtn.onclick = function() {
                                const todosSeleccionados = permisoIds.every(id => {
                                    const checkbox = document.getElementById(id);
                                    return checkbox && checkbox.checked;
                                });
                                
                                // Si todos están seleccionados, deseleccionar todos. Si no, seleccionar todos.
                                permisoIds.forEach(id => {
                                    const checkbox = document.getElementById(id);
                                    if (checkbox) {
                                        checkbox.checked = !todosSeleccionados;
                                        // Disparar evento change para que otros listeners se actualicen
                                        checkbox.dispatchEvent(new Event('change'));
                                    }
                                });
                                
                                // El texto siempre es "Todo", no se cambia
                            };
                            
                            moduloDiv.appendChild(moduloHeader);
                            moduloDiv.appendChild(permisosDiv);
                            container.appendChild(moduloDiv);
                        });
                    } else {
                        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No hay módulos disponibles</div>';
                    }
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Error al cargar módulos</div>';
                }
            } catch (error) {
                console.error('Error al cargar módulos:', error);
                container.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Error de conexión al cargar módulos</div>';
            }
        }
        
        // Función genérica para cargar residencias en cualquier select
        async function loadResidenciasIntoSelect(selectId, currentValue = null) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const token = localStorage.getItem('violetas_token');
            if (!token) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residencias`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const selectedValue = currentValue !== null ? currentValue : select.value;
                    select.innerHTML = '<option value="">Seleccione una residencia</option>';
                    data.residencias.forEach(res => {
                        // Mostrar todas las residencias (el backend ya filtra según permisos)
                        select.innerHTML += `<option value="${res.id_residencia}" ${res.id_residencia == selectedValue ? 'selected' : ''}>${res.nombre}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error al cargar residencias:', error);
            }
        }
        
        async function loadResidenciasForSelect(residenciasSeleccionadas = []) {
            // Cargar residencias para checkboxes múltiples
            const container = document.getElementById('usuario_residencias_container');
            const token = localStorage.getItem('violetas_token');

            // 🔍 DEBUG: Ver qué se recibe
            if (Array.isArray(residenciasSeleccionadas)) {
            }
            
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Cargando residencias...</div>';
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residencias`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    container.innerHTML = '';
                    
                    if (data.residencias && data.residencias.length > 0) {
                        // Filtrar solo residencias activas para asegurar que solo se asignen residencias válidas
                        const residenciasActivas = data.residencias.filter(res => res.activa === true);

                        if (residenciasActivas.length === 0) {
                            container.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px; font-weight: 600;">⚠️ No hay residencias activas disponibles. Debe crear o activar al menos una residencia antes de crear usuarios.</div>';
                            return;
                        }

                        // Filtrar residencias seleccionadas para que solo se marquen las que están activas
                        const residenciasSeleccionadasActivas = residenciasSeleccionadas.filter(r => {
                            const idResidencia = typeof r === 'object' ? r.id_residencia : r;
                            return residenciasActivas.some(res => res.id_residencia === idResidencia);
                        });

                        residenciasActivas.forEach(res => {
                            const checkboxId = `usuario_residencia_${res.id_residencia}`;
                            const estaSeleccionada = residenciasSeleccionadasActivas.some(r =>
                                (typeof r === 'object' ? r.id_residencia : r) === res.id_residencia
                            );
                            
                            const checkbox = document.createElement('div');
                            checkbox.style.display = 'flex';
                            checkbox.style.alignItems = 'center';
                            checkbox.style.gap = '8px';
                            checkbox.style.padding = '8px';
                            checkbox.style.borderRadius = '6px';
                            checkbox.style.transition = 'background-color 0.2s';
                            checkbox.onmouseover = () => checkbox.style.backgroundColor = '#f0f0f0';
                            checkbox.onmouseout = () => checkbox.style.backgroundColor = 'transparent';
                            
                            checkbox.innerHTML = `
                                <input type="checkbox" id="${checkboxId}" name="residencias[]" value="${res.id_residencia}" ${estaSeleccionada ? 'checked' : ''} style="width: auto; margin: 0; cursor: pointer;">
                                <label for="${checkboxId}" style="margin: 0; cursor: pointer; flex: 1; font-weight: 500;">${res.nombre}</label>
                            `;
                            container.appendChild(checkbox);
                        });
                        
                        // Asegurar que al menos una residencia esté seleccionada (si estamos editando y el usuario tenía residencias activas)
                        if (residenciasSeleccionadasActivas.length === 0 && residenciasActivas.length > 0) {
                            // Si no hay ninguna seleccionada pero hay residencias activas, seleccionar la primera por defecto
                            const firstCheckbox = document.getElementById(`usuario_residencia_${residenciasActivas[0].id_residencia}`);
                            if (firstCheckbox) {
                                firstCheckbox.checked = true;
                            }
                        }
                    } else {
                        container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No hay residencias disponibles</div>';
                    }
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Error al cargar residencias</div>';
                }
            } catch (error) {
                console.error('Error al cargar residencias:', error);
                container.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Error de conexión</div>';
            }
        }
        
        async function saveUsuario(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveUsuarioBtn');
            const originalText = saveBtn ? saveBtn.textContent : 'Guardar';
            
            // Resetear botón al inicio por si acaso
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
            
            if (!saveBtn) {
                console.error('Botón de guardar no encontrado');
                return;
            }
            
            const formData = new FormData(form);
            const idUsuario = formData.get('id_usuario');
            const password = formData.get('password');
            const isEditing = idUsuario && idUsuario.trim() !== '';
            
            // Validar email
            const email = formData.get('email');
            if (!email || !email.trim()) {
                showUsuarioModalError('El email es requerido');
                resetSaveButton('saveUsuarioBtn', originalText);
                return;
            }
            
            // Validar rol
            const idRol = formData.get('id_rol');
            if (!idRol || idRol.trim() === '' || isNaN(parseInt(idRol))) {
                showUsuarioModalError('Debe seleccionar un rol');
                resetSaveButton('saveUsuarioBtn', originalText);
                return;
            }
            
            // Validar contraseña: requerida al crear, opcional al editar
            if (!isEditing && (!password || !password.trim())) {
                showUsuarioModalError('La contraseña es requerida al crear un usuario nuevo');
                resetSaveButton('saveUsuarioBtn', originalText);
                return;
            }
            
            // Recoger residencias seleccionadas (checkboxes) - solo activas
            const residenciasCheckboxes = document.querySelectorAll('input[name="residencias[]"]:checked');
            const residencias = Array.from(residenciasCheckboxes).map(cb => {
                const val = parseInt(cb.value);
                return isNaN(val) ? null : val;
            }).filter(v => v !== null);
            
            
            if (residencias.length === 0) {
                showUsuarioModalError('Debe seleccionar al menos una residencia activa');
                resetSaveButton('saveUsuarioBtn', originalText);
                return;
            }
            
            // Recoger permisos seleccionados (checkboxes)
            const permisosCheckboxes = document.querySelectorAll('input[name="permisos[]"]:checked');
            const permisos = Array.from(permisosCheckboxes).map(cb => cb.value).filter(v => v && v.trim());
            
            // Preparar datos
            const data = {
                email: email.trim(),
                id_rol: parseInt(idRol),
                residencias: residencias,
                permisos: permisos,
                activo: document.getElementById('usuario_activo').checked
            };
            
            // Agregar campos opcionales solo si tienen valor
            const nombre = formData.get('nombre');
            if (nombre && nombre.trim()) {
                data.nombre = nombre.trim();
            }
            
            const apellido = formData.get('apellido');
            if (apellido && apellido.trim()) {
                data.apellido = apellido.trim();
            }
            
            // Si es edición y hay contraseña, incluirla; si es creación, siempre incluirla
            if (password && password.trim()) {
                data.password = password.trim();
                }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideUsuarioModalAlert();
            
            try {
                const url = idUsuario 
                    ? `${API_URL}/api/v1/usuarios/${idUsuario}`
                    : `${API_URL}/api/v1/usuarios`;
                const method = idUsuario ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                let result;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        console.error('Respuesta no JSON del servidor:', text);
                        showUsuarioModalError(`Error del servidor (${response.status}): ${text.substring(0, 200)}`);
                        resetSaveButton('saveUsuarioBtn', originalText);
                        return;
                    }
                } catch (parseError) {
                    console.error('Error al parsear respuesta:', parseError);
                    showUsuarioModalError(`Error del servidor (${response.status}). Por favor, intenta de nuevo.`);
                    resetSaveButton('saveUsuarioBtn', originalText);
                    return;
                }
                
                if (response.ok) {
                    showUsuarioModalSuccess(idUsuario ? 'Usuario actualizado exitosamente' : 'Usuario creado exitosamente');
                    // Resetear botón antes de cerrar
                    resetSaveButton('saveUsuarioBtn', originalText);
                    
                    // Si el usuario editado es el actual, recargar sus permisos
                    if (idUsuario && usuarioActual && idUsuario == usuarioActual.id_usuario) {
                        cargarNombreUsuario(token).then(() => {
                            actualizarVisibilidadModulos();
                            console.log('✅ Permisos actualizados');
                        });
                    }
                    
                    setTimeout(() => {
                        closeModal('modalUsuario');
                        loadUsuarios();
                    }, 1500);
                } else {
                    // Mostrar error más detallado
                    let errorMessage = 'Error al guardar el usuario';
                    if (result.error) {
                        errorMessage = result.error;
                    } else if (result.detalles && Array.isArray(result.detalles)) {
                        errorMessage = result.detalles.join(', ');
                    } else if (result.mensaje) {
                        errorMessage = result.mensaje;
                    }
                    console.error('Error del servidor:', response.status, result);
                    showUsuarioModalError(errorMessage);
                    resetSaveButton('saveUsuarioBtn', originalText);
                }
            } catch (error) {
                console.error('Error al guardar usuario:', error);
                showUsuarioModalError('Error de conexión: ' + error.message);
                resetSaveButton('saveUsuarioBtn', originalText);
            }
        }
        
        function showUsuarioModalError(message) {
            const alert = document.getElementById('usuarioAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function showUsuarioModalSuccess(message) {
            const alert = document.getElementById('usuarioAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function hideUsuarioModalAlert() {
            const alert = document.getElementById('usuarioAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }
        
        // ============================================================================
        // GESTIÓN DE RESIDENCIAS (Solo SuperAdmin)
        // ============================================================================
        
        async function loadResidencias() {
            const token = localStorage.getItem('violetas_token');
            const content = document.getElementById('residenciasContent');
            
            if (!token) {
                alert('No hay sesión activa');
                return;
            }
            
            try {
                content.innerHTML = '<p style="text-align: center; padding: 20px;">Cargando residencias...</p>';
                
                const response = await fetch(`${API_URL}/api/v1/residencias`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar residencias');
                }
                
                const data = await response.json();
                const residencias = data.residencias || [];
                
                let html = `
                    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="color: #667eea; margin: 0; font-size: 18px;">
                            <img src="/static/icons/medical/hospital.svg" alt="Residencias" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;"> 
                            Lista de Residencias
                        </h3>
                        <button class="add-btn" onclick="nuevaResidencia()" style="padding: 10px 20px; font-size: 14px; white-space: nowrap;">
                            <img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px; filter: brightness(0) invert(1);"> Nueva Residencia
                        </button>
                    </div>
                    <div style="overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <table class="data-table" style="width: 100%; min-width: 700px;">
                            <thead>
                                <tr>
                                    <th style="min-width: 50px; padding: 10px 8px; font-size: 13px;">ID</th>
                                    <th style="min-width: 140px; padding: 10px 8px; font-size: 13px;">Nombre</th>
                                    <th style="min-width: 180px; padding: 10px 8px; font-size: 13px;">Dirección</th>
                                    <th style="min-width: 110px; padding: 10px 8px; font-size: 13px;">Teléfono</th>
                                    <th style="min-width: 100px; padding: 10px 8px; font-size: 13px;">Estado</th>
                                    <th style="min-width: 140px; padding: 10px 8px; font-size: 13px; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                if (residencias.length === 0) {
                    html += `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                                <p style="margin: 0; font-size: 14px;">No hay residencias registradas</p>
                                <p style="margin: 8px 0 0 0; font-size: 12px; color: #999;">Haz clic en "Nueva Residencia" para crear una</p>
                            </td>
                        </tr>
                    `;
                } else {
                    residencias.forEach(residencia => {
                        const estadoBadge = residencia.activa 
                            ? '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; cursor: help;" title="Activa"><img src="/static/icons/medical/check-circle.svg" alt="Activa" style="width: 16px; height: 16px; filter: brightness(0) invert(1);"></span>'
                            : '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; cursor: help;" title="Inactiva"><img src="/static/icons/medical/alert-circle.svg" alt="Inactiva" style="width: 16px; height: 16px; filter: brightness(0) invert(1);"></span>';
                        
                        const direccion = residencia.direccion && residencia.direccion.trim() 
                            ? `<span style="color: #333; font-size: 13px;">${residencia.direccion.length > 40 ? residencia.direccion.substring(0, 40) + '...' : residencia.direccion}</span>` 
                            : '<span style="color: #999; font-style: italic; font-size: 12px;">Sin dirección</span>';
                        
                        const telefono = residencia.telefono && residencia.telefono.trim() 
                            ? `<span style="color: #333; font-size: 13px;">${residencia.telefono}</span>` 
                            : '<span style="color: #999; font-style: italic; font-size: 12px;">Sin teléfono</span>';
                        
                        html += `
                            <tr style="border-bottom: 1px solid #e0e0e0;">
                                <td style="padding: 10px 8px; font-weight: 600; color: #667eea; font-size: 13px;">#${residencia.id_residencia}</td>
                                <td style="padding: 10px 8px;">
                                    <strong style="color: #333; font-size: 14px;">${residencia.nombre || '<span style="color: #999; font-size: 12px;">Sin nombre</span>'}</strong>
                                </td>
                                <td style="padding: 10px 8px; color: #555; font-size: 13px;">${direccion}</td>
                                <td style="padding: 10px 8px; color: #555; font-size: 13px;">${telefono}</td>
                                <td style="padding: 10px 8px;">${estadoBadge}</td>
                                <td style="padding: 10px 8px; text-align: center;">
                                    <div style="display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: wrap;">
                                        <button onclick="editarResidencia(${residencia.id_residencia})" style="background: #667eea; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#667eea'; this.style.transform='translateY(0)'">
                                            <img src="/static/icons/medical/settings.svg" alt="Editar" style="width: 14px; height: 14px; filter: brightness(0) invert(1);"> Editar
                                        </button>
                                        ${residencia.activa ? `
                                        <button onclick="eliminarResidencia(${residencia.id_residencia}, '${residencia.nombre.replace(/'/g, "\\'")}')" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.background='#c82333'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#dc3545'; this.style.transform='translateY(0)'">
                                            <img src="/static/icons/medical/user-x.svg" alt="Desactivar" style="width: 14px; height: 14px; filter: brightness(0) invert(1);"> Desactivar
                                        </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <p style="margin: 0; color: #666; font-size: 14px;">
                            <strong style="color: #667eea;">Total:</strong> <span style="font-weight: 600; font-size: 16px;">${residencias.length}</span> residencia${residencias.length !== 1 ? 's' : ''}
                        </p>
                        <p style="margin: 0; color: #999; font-size: 12px;">
                            ${residencias.filter(r => r.activa).length} activa${residencias.filter(r => r.activa).length !== 1 ? 's' : ''} | 
                            ${residencias.filter(r => !r.activa).length} inactiva${residencias.filter(r => !r.activa).length !== 1 ? 's' : ''}
                        </p>
                    </div>
                `;
                
                content.innerHTML = html;
                openModal('modalResidencias');
                
            } catch (error) {
                console.error('Error al cargar residencias:', error);
                content.innerHTML = `
                    <div class="alert error">
                        Error al cargar residencias: ${error.message}
                    </div>
                `;
            }
        }
        
        function nuevaResidencia() {
            resetResidenciaForm();
            document.getElementById('modalResidenciaTitulo').innerHTML = `
                <img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Nueva Residencia
            `;
            openModal('modalResidencia');
        }
        
        async function editarResidencia(idResidencia) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residencias`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener residencias');
                }
                
                const data = await response.json();
                const residencia = data.residencias.find(r => r.id_residencia === idResidencia);
                
                if (!residencia) {
                    alert('Residencia no encontrada');
                    return;
                }
                
                document.getElementById('residencia_id_residencia').value = residencia.id_residencia;
                document.getElementById('residencia_nombre').value = residencia.nombre || '';
                document.getElementById('residencia_direccion').value = residencia.direccion || '';
                document.getElementById('residencia_codigo_postal').value = residencia.codigo_postal || '';
                document.getElementById('residencia_ciudad').value = residencia.ciudad || '';
                document.getElementById('residencia_provincia').value = residencia.provincia || '';
                document.getElementById('residencia_telefono').value = residencia.telefono || '';
                document.getElementById('residencia_email').value = residencia.email || '';
                document.getElementById('residencia_web').value = residencia.web || '';
                document.getElementById('residencia_observaciones').value = residencia.observaciones || '';
                document.getElementById('residencia_activa').checked = residencia.activa !== false;
                
                // Mostrar sección de entidades fiscales solo al editar
                document.getElementById('residenciaEntidadesFiscalesSection').style.display = 'block';
                
                // Cargar receivers asociados a esta residencia
                await cargarReceiversResidencia(idResidencia);
                
                document.getElementById('modalResidenciaTitulo').innerHTML = `
                    <img src="/static/icons/medical/settings.svg" alt="Editar" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> Editar Residencia
                `;
                
                hideResidenciaAlert();
                openModal('modalResidencia');
                
            } catch (error) {
                console.error('Error al obtener residencia:', error);
                alert('Error al obtener información de la residencia: ' + error.message);
            }
        }
        
        function resetResidenciaForm() {
            document.getElementById('formResidencia').reset();
            document.getElementById('residencia_id_residencia').value = '';
            document.getElementById('residencia_activa').checked = true;
            document.getElementById('residenciaEntidadesFiscalesSection').style.display = 'none';
            document.getElementById('residenciaReceiversList').innerHTML = '';
            hideResidenciaAlert();
        }
        
        async function cargarReceiversResidencia(idResidencia) {
            const token = localStorage.getItem('violetas_token');
            const container = document.getElementById('residenciaReceiversList');
            
            if (!idResidencia || !container) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residencias/${idResidencia}/receivers`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const receivers = data.receivers || [];
                    
                    if (receivers.length === 0) {
                        container.innerHTML = '<p style="color: #666; font-size: 14px; padding: 10px; background: #f8f9fa; border-radius: 6px;">No hay entidades fiscales asociadas. Añada una usando los botones de abajo.</p>';
                        return;
                    }
                    
                    container.innerHTML = receivers.map(r => `
                        <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #667eea;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${r.nombre}</div>
                                ${r.nif_cif ? `<div style="font-size: 12px; color: #666;">NIF/CIF: ${r.nif_cif}</div>` : ''}
                                ${r.direccion ? `<div style="font-size: 12px; color: #666;">${r.direccion}</div>` : ''}
                            <button type="button" onclick="eliminarReceiverResidencia(${r.id_receiver}, '${r.nombre.replace(/'/g, "\\'")}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 8px;">Eliminar</button>
                                ${r.cuenta_bancaria ? `<div style="font-size: 12px; color: #667eea; font-weight: 500; margin-top: 4px;">IBAN: ${r.cuenta_bancaria}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: #dc3545; font-size: 14px;">Error al cargar entidades fiscales</p>';
                }
            } catch (error) {
                console.error('Error al cargar receivers:', error);
                container.innerHTML = '<p style="color: #dc3545; font-size: 14px;">Error de conexión</p>';
            }
        }
        
        async function eliminarReceiverResidencia(idReceiver, nombreReceiver) {
            if (!confirm(`¿Está seguro de que desea eliminar la entidad fiscal "${nombreReceiver}" de esta residencia?`)) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            const idResidencia = document.getElementById('residencia_id_residencia').value;
            
            if (!idResidencia) return;
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residencias/${idResidencia}/receivers/${idReceiver}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    await cargarReceiversResidencia(idResidencia);
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al eliminar entidad fiscal');
                }
            } catch (error) {
                console.error('Error al eliminar receiver:', error);
                alert('Error de conexión');
            }
        }
        
        function nuevaEntidadFiscal() {
            // Limpiar formulario
            document.getElementById('formEntidadFiscal').reset();
            document.getElementById('modalEntidadFiscalAlert').style.display = 'none';
            
            // Abrir modal
            openModal('modalEntidadFiscal');
        }
        
        async function saveEntidadFiscal(event) {
            event.preventDefault();
            const token = localStorage.getItem('violetas_token');
            const saveBtn = document.getElementById('saveEntidadFiscalBtn');
            const originalText = saveBtn ? saveBtn.textContent : 'Guardar';
            
            if (!token) {
                showEntidadFiscalError('No hay sesión activa');
                return;
            }
            
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Guardando...';
            }
            
            hideEntidadFiscalAlert();
            
            try {
                const formData = new FormData(event.target);
                const data = {
                    nombre: formData.get('nombre').trim(),
                    nif_cif: formData.get('nif_cif')?.trim() || null,
                    direccion: formData.get('direccion')?.trim() || null,
                    telefono: formData.get('telefono')?.trim() || null,
                    email: formData.get('email')?.trim() || null,
                    cuenta_bancaria: formData.get('cuenta_bancaria')?.trim() || null
                };
                
                if (!data.nombre) {
                    showEntidadFiscalError('El nombre es requerido');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                    }
                    return;
                }
                
                // Crear receiver
                const response = await fetch(`${API_URL}/api/v1/receivers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                let result;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        throw new Error(`Error del servidor (${response.status}): ${text.substring(0, 100)}`);
                    }
                } catch (parseError) {
                    showEntidadFiscalError(`Error del servidor (${response.status}). Por favor, intenta de nuevo.`);
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                    }
                    return;
                }
                
                if (response.ok) {
                    const idReceiver = result.id_receiver;
                    
                    // Si estamos en el contexto de editar una residencia, asociar automáticamente
                    const idResidencia = document.getElementById('residencia_id_residencia')?.value;
                    if (idResidencia) {
                        try {
                            const associateResponse = await fetch(`${API_URL}/api/v1/residencias/${idResidencia}/receivers/${idReceiver}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (associateResponse.ok) {
                                // Recargar lista de receivers de la residencia
                                await cargarReceiversResidencia(idResidencia);
                            }
                        } catch (error) {
                            console.error('Error al asociar receiver a residencia:', error);
                            // No mostrar error, la entidad ya se creó
                        }
                    }
                    
                    showEntidadFiscalSuccess('Entidad fiscal creada exitosamente');
                    setTimeout(() => {
                        closeModal('modalEntidadFiscal');
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.textContent = originalText;
                        }
                    }, 1500);
                } else {
                    showEntidadFiscalError(result.error || 'Error al crear entidad fiscal');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                    }
                }
            } catch (error) {
                console.error('Error al guardar entidad fiscal:', error);
                showEntidadFiscalError('Error de conexión: ' + error.message);
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            }
        }
        
        function showEntidadFiscalError(message) {
            const alert = document.getElementById('modalEntidadFiscalAlert');
            alert.className = 'alert alert-error';
            alert.textContent = message;
            alert.style.display = 'block';
        }
        
        function showEntidadFiscalSuccess(message) {
            const alert = document.getElementById('modalEntidadFiscalAlert');
            alert.className = 'alert alert-success';
            alert.textContent = message;
            alert.style.display = 'block';
        }
        
        function hideEntidadFiscalAlert() {
            const alert = document.getElementById('modalEntidadFiscalAlert');
            alert.style.display = 'none';
        }
        
        async function crearReceiverYAsociar(nombre, nif, direccion, telefono, email) {
            const token = localStorage.getItem('violetas_token');
            const idResidencia = document.getElementById('residencia_id_residencia').value;
            
            if (!idResidencia) {
                alert('Debe guardar la residencia primero');
                return;
            }
            
            try {
                // Crear receiver
                const createResponse = await fetch(`${API_URL}/api/v1/receivers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        nombre,
                        nif_cif: nif || null,
                        direccion: direccion || null,
                        telefono: telefono || null,
                        email: email || null
                    })
                });
                
                if (createResponse.ok) {
                    const data = await createResponse.json();
                    const idReceiver = data.id_receiver;
                    
                    // Asociar a la residencia
                    const associateResponse = await fetch(`${API_URL}/api/v1/residencias/${idResidencia}/receivers/${idReceiver}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (associateResponse.ok) {
                        await cargarReceiversResidencia(idResidencia);
                    } else {
                        alert('Entidad creada pero error al asociarla a la residencia');
                    }
                } else {
                    const errorData = await createResponse.json();
                    alert(errorData.error || 'Error al crear entidad fiscal');
                }
            } catch (error) {
                console.error('Error al crear receiver:', error);
                alert('Error de conexión');
            }
        }
        
        // Función helper para resetear botones de guardado
        function resetSaveButton(buttonId, defaultText = 'Guardar') {
            const btn = document.getElementById(buttonId);
            if (btn) {
                btn.disabled = false;
                btn.textContent = defaultText;
            }
        }
        
        async function saveResidencia(event) {
            event.preventDefault();
            const token = localStorage.getItem('violetas_token');
            
            const saveBtn = document.getElementById('saveResidenciaBtn');
            const originalText = saveBtn ? saveBtn.textContent : 'Guardar';
            
            // Resetear botón al inicio por si acaso
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
            
            if (!token) {
                showResidenciaError('No hay sesión activa');
                resetSaveButton('saveResidenciaBtn', originalText);
                return;
            }
            
            if (!saveBtn) {
                console.error('Botón de guardar no encontrado');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            
            hideResidenciaAlert();
            
            try {
                const idResidencia = document.getElementById('residencia_id_residencia').value;
                const data = {
                    nombre: document.getElementById('residencia_nombre').value.trim(),
                    direccion: document.getElementById('residencia_direccion').value.trim() || null,
                    telefono: document.getElementById('residencia_telefono').value.trim() || null,
                    activa: document.getElementById('residencia_activa').checked
                };
                
                const url = idResidencia
                    ? `${API_URL}/api/v1/residencias/${idResidencia}`
                    : `${API_URL}/api/v1/residencias`;
                const method = idResidencia ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                let result;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        throw new Error(`Error del servidor (${response.status}): ${text.substring(0, 100)}`);
                    }
                } catch (parseError) {
                    showResidenciaError(`Error del servidor (${response.status}). Por favor, intenta de nuevo.`);
                    resetSaveButton('saveResidenciaBtn', originalText);
                    return;
                }
                
                if (response.ok) {
                    showResidenciaSuccess(idResidencia ? 'Residencia actualizada exitosamente' : 'Residencia creada exitosamente');
                    // Resetear botón antes de cerrar
                    resetSaveButton('saveResidenciaBtn', originalText);
                    setTimeout(() => {
                        closeModal('modalResidencia');
                        loadResidencias();
                    }, 1500);
                } else {
                    showResidenciaError(result.error || 'Error al guardar la residencia');
                    resetSaveButton('saveResidenciaBtn', originalText);
                }
            } catch (error) {
                console.error('Error al guardar residencia:', error);
                showResidenciaError('Error de conexión: ' + error.message);
                resetSaveButton('saveResidenciaBtn', originalText);
            }
        }
        
        async function eliminarResidencia(idResidencia, nombre) {
            if (!confirm(`¿Estás seguro de que deseas desactivar la residencia "${nombre}"?\n\nEsta acción desactivará la residencia (no se eliminará físicamente).`)) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            if (!token) {
                alert('No hay sesión activa');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/v1/residencias/${idResidencia}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    throw new Error(`Error del servidor (${response.status})`);
                }
                
                if (response.ok) {
                    alert(`Residencia "${nombre}" desactivada exitosamente.`);
                    loadResidencias();
                } else {
                    alert(result.error || 'Error al desactivar la residencia');
                }
            } catch (error) {
                console.error('Error al eliminar residencia:', error);
                alert('Error de conexión: ' + error.message);
            }
        }
        
        function showResidenciaError(message) {
            const alert = document.getElementById('residenciaAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function showResidenciaSuccess(message) {
            const alert = document.getElementById('residenciaAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function hideResidenciaAlert() {
            const alert = document.getElementById('residenciaAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }
        
        async function editarMiCuenta() {
            const token = localStorage.getItem('violetas_token');
            
            if (!token) {
                alert('No estás autenticado. Por favor, inicia sesión.');
                return;
            }
            
            try {
                console.log('Obteniendo información del usuario para editar cuenta con token:', token.substring(0, 20) + '...');
                const response = await fetch(`${API_URL}/api/v1/usuarios/me`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Respuesta del servidor:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Error desconocido' }));
                    console.error('Error al obtener usuario:', errorData);
                    alert(`Error al obtener información del usuario: ${errorData.error || 'Error desconocido'}`);
                    return;
                }
                
                if (response.ok) {
                    const usuario = await response.json();
                    
                    document.getElementById('micuenta_nombre').value = usuario.nombre || '';
                    document.getElementById('micuenta_apellido').value = usuario.apellido || '';
                    document.getElementById('micuenta_password').value = '';
                    
                    openModal('modalMiCuenta');
                } else {
                    alert('Error al obtener información del usuario');
                }
            } catch (error) {
                console.error('Error al obtener información del usuario:', error);
                alert('Error de conexión: ' + error.message);
            }
        }
        
        async function saveMiCuenta(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveMiCuentaBtn');
            const originalText = saveBtn ? saveBtn.textContent : 'Guardar Cambios';
            
            // Resetear botón al inicio por si acaso
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
            
            if (!saveBtn) {
                console.error('Botón de guardar no encontrado');
                return;
            }
            
            const formData = new FormData(form);
            const password = formData.get('password');
            
            const data = {
                nombre: formData.get('nombre') || null,
                apellido: formData.get('apellido') || null
            };
            
            if (password && password.trim()) {
                data.password = password;
            }
            
            // Limpiar valores vacíos
            Object.keys(data).forEach(key => {
                if (data[key] === '' || data[key] === null) {
                    delete data[key];
                }
            });
            
            // Obtener id_usuario del token
            let idUsuario = null;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                idUsuario = payload.id_usuario;
            } catch (e) {
                showMiCuentaModalError('Error al obtener información del usuario');
                resetSaveButton('saveMiCuentaBtn', originalText);
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            hideMiCuentaModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/usuarios/${idUsuario}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                let result;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        throw new Error(`Error del servidor (${response.status}): ${text.substring(0, 100)}`);
                    }
                } catch (parseError) {
                    showMiCuentaModalError(`Error del servidor (${response.status}). Por favor, intenta de nuevo.`);
                    resetSaveButton('saveMiCuentaBtn', originalText);
                    return;
                }
                
                if (response.ok) {
                    // Si se cambió la contraseña, recargar la página para obtener nuevo token
                    if (data.password && data.password.trim()) {
                        showMiCuentaModalSuccess('Contraseña actualizada exitosamente. Recargando...');
                        // No resetear botón aquí porque se va a recargar la página
                        setTimeout(() => {
                            window.location.reload(); // Recargar para obtener nuevo token y estado
                        }, 1500);
                    } else {
                        showMiCuentaModalSuccess('Información actualizada exitosamente');
                        // Resetear botón antes de cerrar
                        resetSaveButton('saveMiCuentaBtn', originalText);
                        setTimeout(() => {
                            closeModal('modalMiCuenta');
                        }, 1500);
                    }
                } else {
                    showMiCuentaModalError(result.error || 'Error al actualizar la información');
                    resetSaveButton('saveMiCuentaBtn', originalText);
                }
            } catch (error) {
                console.error('Error al guardar información:', error);
                showMiCuentaModalError('Error de conexión: ' + error.message);
                resetSaveButton('saveMiCuentaBtn', originalText);
            }
        }
        
        function showMiCuentaModalError(message) {
            const alert = document.getElementById('miCuentaAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function showMiCuentaModalSuccess(message) {
            const alert = document.getElementById('miCuentaAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function hideMiCuentaModalAlert() {
            const alert = document.getElementById('miCuentaAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        // ========================================================================
        // FUNCIONES DEL MÓDULO DE DOCUMENTACIÓN
        // ========================================================================
        
        async function loadDocumentacion() {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando documentación...</p>
                    </div>
                </div>
            `;
            
            try {
                console.log('📥 Cargando TODOS los documentos desde el servidor...');
                
                // Guardar filtros de URL para aplicar DESPUÉS en el cliente
                const urlParams = new URLSearchParams(window.location.search);
                const tipoEntidadFiltro = urlParams.get('tipo_entidad') || '';
                const categoriaFiltro = urlParams.get('categoria') || '';
                const residenciaFiltro = urlParams.get('id_residencia') || '';
                
                // IMPORTANTE: NO enviar filtros al servidor - traer TODOS los documentos
                let url = `${API_URL}/api/v1/documentacion`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Cargar residencias para el filtro
                    let residenciasOptions = '<option value="">Todas las residencias</option>';
                    try {
                        const residenciasResponse = await fetch(`${API_URL}/api/v1/residencias`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (residenciasResponse.ok) {
                            const residenciasData = await residenciasResponse.json();
                            if (residenciasData.residencias) {
                                residenciasData.residencias.forEach(res => {
                                    residenciasOptions += `<option value="${res.id_residencia}">${res.nombre}</option>`;
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Error al cargar residencias:', error);
                    }
                    
                    let html = `
                        <div class="module-content">
                            <div style="margin-bottom: 30px;">
                                <h2 style="color: #667eea; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                                    <img src="/static/icons/medical/file-medical.svg" alt="Documentación" style="width: 32px; height: 32px;"> Documentación
                                </h2>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    ${usuarioTienePermiso('crear:documento') ? `<button class="add-btn" onclick="resetFormDocumento(); openModal('modalSubirDocumento')" style="padding: 10px 20px; font-size: 16px; white-space: nowrap; width: 100%;">
                                        <img src="/static/icons/medical/plus.svg" alt="Agregar" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px; filter: brightness(0) invert(1);"> Subir Documento
                                    </button>` : ''}
                                    <button onclick="limpiarFiltrosDocumentacion()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;">Limpiar Filtros</button>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <label style="font-weight: 600; color: #333; font-size: 14px;">Residencia</label>
                                    <select id="filtroResidenciaDocumentacion" onchange="aplicarFiltrosDocumentacion()" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; width: 100%;">
                                        ${residenciasOptions}
                                    </select>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <label style="font-weight: 600; color: #333; font-size: 14px;">Tipo de Entidad</label>
                                    <select id="filtroTipoEntidad" onchange="aplicarFiltrosDocumentacion()" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; width: 100%;">
                                        <option value="">Todos los tipos</option>
                                        <option value="residente">Residentes</option>
                                        <option value="proveedor">Proveedores</option>
                                        <option value="personal">Personal</option>
                                    </select>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <label style="font-weight: 600; color: #333; font-size: 14px;">Categoría</label>
                                    <select id="filtroCategoria" onchange="aplicarFiltrosDocumentacion()" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; width: 100%;">
                                        <option value="">Todas las categorías</option>
                                        <option value="medica">Médica</option>
                                        <option value="fiscal">Fiscal</option>
                                        <option value="sanitaria">Sanitaria</option>
                                        <option value="laboral">Laboral</option>
                                        <option value="Pagos">Pagos</option>
                                        <option value="Pagos">Pagos</option>
                                        <option value="otra">Otra</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; color: #333; font-size: 14px; display: block; margin-bottom: 10px;">Buscar</label>
                                <input type="text" id="filtroBusquedaDocumentacion" placeholder="Buscar por nombre de archivo, descripción, tipo..." oninput="aplicarFiltrosDocumentacion()" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; width: 100%;">
                            </div>
                    `;
                    
                    // Crear contenedor para tablas (se llenará con actualizarTablaDocumentos)
                    html += '<div id="contenidoTablas"></div>';
                    html += '</div>';
                    content.innerHTML = html;
                    
                    // Cargar documentos usando el nuevo sistema de filtrado
                    console.log('📥 Cargando documentos iniciales desde servidor...');
                    await aplicarFiltrosDocumentacion();
                } else {
                    const error = await response.json();
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: ${error.error || 'Error desconocido'}</p></div>`;
                }
            } catch (error) {
                console.error('Error al cargar documentación:', error);
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexión: ${error.message}</p></div>`;
            }
        }
        
        async function aplicarFiltrosDocumentacion() {
            const residencia = document.getElementById('filtroResidenciaDocumentacion')?.value || '';
            const tipoEntidad = document.getElementById('filtroTipoEntidad')?.value || '';
            const categoria = document.getElementById('filtroCategoria')?.value || '';
            const busqueda = document.getElementById('filtroBusquedaDocumentacion')?.value?.toLowerCase() || '';
            
            console.log('🔍 Aplicando filtros en servidor:', { residencia, tipoEntidad, categoria, busqueda });
            
            // Construir URL con filtros
            const params = new URLSearchParams();
            if (tipoEntidad) params.append('tipo_entidad', tipoEntidad);
            if (categoria) params.append('categoria', categoria);
            if (residencia) params.append('id_residencia', residencia);
            params.append('limit', '200');  // Límite de 200 documentos
            
            const url = `${API_URL}/api/v1/documentacion${params.toString() ? '?' + params.toString() : ''}`;
            
            try {
                // Mostrar indicador de carga
                const contenidoTablas = document.getElementById('contenidoTablas');
                if (contenidoTablas) {
                    contenidoTablas.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;"><p>⏳ Cargando documentos...</p></div>';
                }
                
                const token = localStorage.getItem('violetas_token');
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`✅ Servidor devolvió: ${data.mostrados} de ${data.total} documentos (límite: ${data.limit})`);
                    
                    // Actualizar solo el contenido de documentos
                    actualizarTablaDocumentos(data);
                    
                    // Aplicar filtro de búsqueda local si existe
                    if (busqueda) {
                        aplicarBusquedaLocalDocumentacion(busqueda);
                    }
                } else {
                    console.error('❌ Error al aplicar filtros:', response.status);
                    if (contenidoTablas) {
                        contenidoTablas.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;"><p>❌ Error al cargar documentos</p></div>';
                    }
                }
            } catch (error) {
                console.error('❌ Error en aplicarFiltrosDocumentacion:', error);
            }
        }
        
        function aplicarBusquedaLocalDocumentacion(busqueda) {
            // Búsqueda local en los documentos ya cargados (sin nueva petición)
            const filas = document.querySelectorAll('#moduleContent tbody tr');
            let visibles = 0;
            
            filas.forEach(fila => {
                const filaNombre = (fila.dataset.nombre || '').toLowerCase();
                const mostrar = filaNombre.includes(busqueda);
                
                fila.style.display = mostrar ? '' : 'none';
                if (mostrar) visibles++;
            });
            
            console.log(`🔎 Búsqueda local: ${visibles}/${filas.length} filas visibles`);
            
            // Ocultar bloques vacíos después de búsqueda local
            ocultarBloquesVaciosDocumentacion();
        }
        
        function ocultarBloquesVaciosDocumentacion() {
            // Ocultar bloques de categoría que queden vacíos (nivel más interno)
            const tablas = document.querySelectorAll('#moduleContent .data-table');
            tablas.forEach(tabla => {
                const tbody = tabla.querySelector('tbody');
                if (tbody) {
                    // Contar filas visibles en esta tabla (excluyendo .no-resultados)
                    const filasVisibles = Array.from(tbody.querySelectorAll('tr')).filter(fila => 
                        fila.style.display !== 'none' && !fila.classList.contains('no-resultados')
                    ).length;
                    
                    // Buscar el contenedor de categoría (tiene h4)
                    const contenedorCategoria = tabla.closest('div[style*="margin-bottom: 20px"]');
                    if (contenedorCategoria && contenedorCategoria.querySelector('h4')) {
                        contenedorCategoria.style.display = filasVisibles > 0 ? '' : 'none';
                    }
                }
            });
            
            // Ocultar bloques de tipo de entidad que queden vacíos (nivel externo)
            const seccionesTipo = document.querySelectorAll('#moduleContent > div > div[style*="margin-bottom: 40px"]');
            seccionesTipo.forEach(seccion => {
                // Contar categorías visibles dentro de esta sección de tipo
                const categoriasVisibles = Array.from(seccion.querySelectorAll('div[style*="margin-bottom: 20px"]')).filter(cat => 
                    cat.style.display !== 'none'
                ).length;
                
                // Si no hay categorías visibles, ocultar toda la sección de tipo
                seccion.style.display = categoriasVisibles > 0 ? '' : 'none';
            });
            
            // Contar cuántas secciones de tipo quedan visibles
            const seccionesTipoVisibles = Array.from(seccionesTipo).filter(seccion => 
                seccion.style.display !== 'none'
            ).length;
            
            // Mostrar mensaje si no hay resultados
            const moduleContent = document.getElementById('moduleContent');
            let noResultados = moduleContent?.querySelector('.no-resultados-documentacion');
            if (noResultados) noResultados.remove();
            
            if (visibles === 0 && filas.length > 0) {
                noResultados = document.createElement('div');
                noResultados.className = 'no-resultados-documentacion';
                noResultados.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 30px; text-align: center; margin: 20px 0;';
                noResultados.innerHTML = '<p style="margin: 0; color: #856404; font-size: 16px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px;"><img src="/static/icons/medical/file-medical.svg" alt="Documentos" style="width: 18px; height: 18px;"> No se encontraron documentos con los filtros seleccionados</p>';
                
                // Insertar después de los filtros
                const filtrosDiv = moduleContent?.querySelector('div[style*="background: #f0f7ff"]');
                if (filtrosDiv && filtrosDiv.parentNode) {
                    filtrosDiv.parentNode.insertBefore(noResultados, filtrosDiv.nextSibling);
                } else {
                    moduleContent?.appendChild(noResultados);
                }
            }
        }
        
        function actualizarTablaDocumentos(data) {
            // Generar HTML con los documentos del servidor
            const contenidoTablas = document.getElementById('contenidoTablas');
            if (!contenidoTablas) return;
            
            let html = '';
            
            // Mensaje informativo de cantidad
            if (data.total > data.mostrados) {
                html += `
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                        <p style="margin: 0; color: #856404; font-weight: 500;">
                            ℹ️ Mostrando los <strong>${data.mostrados}</strong> documentos más recientes de un total de <strong>${data.total}</strong>. 
                            ${data.total > data.limit ? 'Use filtros para encontrar documentos específicos.' : ''}
                        </p>
                    </div>
                `;
            } else if (data.total > 0) {
                html += `
                    <div style="background: #d1ecf1; border-left: 4px solid #0c5460; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                        <p style="margin: 0; color: #0c5460; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                            Mostrando <strong>${data.mostrados}</strong> documento${data.mostrados !== 1 ? 's' : ''}
                        </p>
                    </div>
                `;
            }
            
            if (data.documentos && data.documentos.length > 0) {
                // Agrupar por tipo de entidad y categoría (mismo código que loadDocumentacion)
                const documentosPorTipo = {};
                data.documentos.forEach(doc => {
                    const tipoEntidad = doc.tipo_entidad || 'otro';
                    if (!documentosPorTipo[tipoEntidad]) documentosPorTipo[tipoEntidad] = {};
                    const categoria = doc.categoria_documento || 'otra';
                    if (!documentosPorTipo[tipoEntidad][categoria]) documentosPorTipo[tipoEntidad][categoria] = [];
                    documentosPorTipo[tipoEntidad][categoria].push(doc);
                });
                
                const tiposOrden = ['residente', 'proveedor', 'pago_proveedor', 'personal'];
                const nombresTipo = {'residente': 'Residentes', 'proveedor': 'Proveedores', 'pago_proveedor': 'Facturas de Pagos', 'personal': 'Personal'};
                const categoriasOrden = ['medica', 'fiscal', 'sanitaria', 'laboral', 'Pagos', 'otra'];
                const nombresCategoria = {'medica': 'Médica', 'fiscal': 'Fiscal', 'sanitaria': 'Sanitaria', 'laboral': 'Laboral', 'Pagos': 'Pagos', 'otra': 'Otra'};
                const coloresTipo = {'residente': '#667eea', 'proveedor': '#48bb78', 'pago_proveedor': '#ed8936', 'personal': '#9f7aea'};
                
                tiposOrden.forEach(tipo => {
                    if (documentosPorTipo[tipo]) {
                        const categorias = documentosPorTipo[tipo];
                        let totalTipo = 0;
                        Object.values(categorias).forEach(cat => totalTipo += cat.length);
                        
                        if (totalTipo > 0) {
                            html += `<div style="margin-bottom: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid ${coloresTipo[tipo]};">
                                <h3 style="color: ${coloresTipo[tipo]}; margin-bottom: 20px; font-size: 20px; font-weight: 600;">
                                    <img src="/static/icons/medical/${tipo === 'residente' ? 'users' : tipo === 'proveedor' ? 'package' : tipo === 'pago_proveedor' ? 'bill' : 'user-medical'}.svg" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;"> 
                                    ${nombresTipo[tipo]} (${totalTipo} documento${totalTipo !== 1 ? 's' : ''})
                                </h3>`;
                            
                            categoriasOrden.forEach(cat => {
                                if (categorias[cat] && categorias[cat].length > 0) {
                                    html += `<div style="margin-bottom: 25px;">
                                        <h4 style="color: #555; margin-bottom: 12px; font-size: 16px; font-weight: 600; padding: 8px; background: white; border-radius: 6px;">${nombresCategoria[cat]} (${categorias[cat].length})</h4>
                                        <div style="overflow-x: auto;"><table class="data-table"><thead><tr>
                                            <th style="min-width: 150px;">Entidad / Residencia</th>
                                            <th style="min-width: 120px;">Tipo de Documento</th>
                                            <th style="min-width: 200px;">Nombre del Archivo</th>
                                            <th style="min-width: 200px;">Descripción</th>
                                            <th style="min-width: 100px;">Fecha</th>
                                            <th style="min-width: 150px;">Acciones</th>
                                        </tr></thead><tbody>`;
                                    
                                    categorias[cat].forEach(doc => {
                                        const tipoEntidadNombre = {'residente': 'Residente', 'proveedor': 'Proveedor', 'pago_proveedor': 'Pago Proveedor', 'personal': 'Personal'};
                                        const fechaSubida = doc.fecha_subida ? fechaISOToEspanol(doc.fecha_subida.split('T')[0]) : '-';
                                        
                                        html += `<tr data-tipo-entidad="${doc.tipo_entidad}" data-categoria="${doc.categoria_documento || ''}" data-residencia="${doc.id_residencia || ''}" data-nombre="${(doc.nombre_entidad || '').toLowerCase()} ${(doc.tipo_documento || '').toLowerCase()} ${(doc.nombre_archivo || '').toLowerCase()} ${(doc.descripcion || '').toLowerCase()}">
                                            <td><div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="padding: 4px 8px; background: ${coloresTipo[doc.tipo_entidad]}; color: white; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; width: fit-content;">${tipoEntidadNombre[doc.tipo_entidad] || doc.tipo_entidad}</span>
                                                <span style="font-weight: 600; color: #333;">${doc.nombre_entidad || `ID: ${doc.id_entidad}`}</span>
                                                ${doc.nombre_residencia ? `<span style="font-size: 12px; color: #666;">${doc.nombre_residencia}</span>` : ''}
                                            </div></td>
                                            <td>${doc.tipo_documento || '-'}</td>
                                            <td style="word-break: break-word;">${doc.nombre_archivo || '-'}</td>
                                            <td style="word-break: break-word;">${doc.descripcion || '-'}</td>
                                            <td>${fechaSubida}</td>
                                            <td><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
                                                ${doc.url_descarga ? `<button onclick="verDocumento(${doc.id_documento}, '${doc.tipo_entidad}')" style="padding: 8px; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer;" title="Ver"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="filter: brightness(0) invert(1);"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" fill="currentColor"/></svg></button>
                                                <button onclick="descargarDocumento(${doc.id_documento}, '${doc.tipo_entidad}')" style="padding: 8px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;" title="Descargar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="filter: brightness(0) invert(1);"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" fill="currentColor"/></svg></button>` : '<div></div><div></div>'}
                                                ${doc.tipo_entidad === 'pago_proveedor' ? '' : usuarioTienePermiso('eliminar:documento') ? `<button onclick="eliminarDocumentoUnificado(${doc.id_documento})" style="padding: 8px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;" title="Eliminar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="filter: brightness(0) invert(1);"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/></svg></button>` : '<div></div>'}
                                            </div></td>
                                        </tr>`;
                                    });
                                    
                                    html += `</tbody></table></div></div>`;
                                }
                            });
                            html += `</div>`;
                        }
                    }
                });
            } else {
                html += '<p style="color: #666; text-align: center; padding: 40px;">No hay documentos registrados con los filtros seleccionados.</p>';
            }
            
            contenidoTablas.innerHTML = html;
        }
        
        function aplicarBusquedaDocumentacion(terminoBusqueda) {
            // Esta función ahora solo llama a aplicarFiltrosDocumentacion
            // que maneja todos los filtros de forma unificada
            aplicarFiltrosDocumentacion();
        }
        
        function aplicarBusquedaResidentes() {
            const terminoBusqueda = document.getElementById('filtroBusquedaResidentes')?.value || '';
            
            if (!terminoBusqueda || terminoBusqueda.trim() === '') {
                // Si no hay búsqueda, mostrar todas las filas y contenedores
                document.querySelectorAll('#moduleContent .data-table tbody tr').forEach(row => {
                    row.style.display = '';
                });
                document.querySelectorAll('.residencia-residentes-container').forEach(container => {
                    container.style.display = '';
                });
                // Mostrar también todas las tablas de residentes de baja
                document.querySelectorAll('#moduleContent .data-table').forEach(tabla => {
                    tabla.style.display = '';
                });
                return;
            }
            
            const busquedaLower = terminoBusqueda.toLowerCase().trim();
            let totalVisible = 0;
            
            // 1. Filtrar residentes ACTIVOS (contenedores con clase .residencia-residentes-container)
            document.querySelectorAll('.residencia-residentes-container').forEach(container => {
                const tabla = container.querySelector('.data-table');
                if (!tabla) return;
                
                const filas = tabla.querySelectorAll('tbody tr');
                let filasVisiblesEnContenedor = 0;
                
                filas.forEach(row => {
                    const textoCompleto = row.textContent.toLowerCase();
                    if (textoCompleto.includes(busquedaLower)) {
                        row.style.display = '';
                        filasVisiblesEnContenedor++;
                        totalVisible++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Mostrar u ocultar el contenedor según si tiene filas visibles
                if (filasVisiblesEnContenedor > 0) {
                    container.style.display = '';
                } else {
                    container.style.display = 'none';
                }
            });
            
            // 2. Filtrar residentes DE BAJA (tablas dentro de la sección de bajas)
            const seccionBajas = document.querySelector('#moduleContent h3[style*="color: #dc3545"]')?.parentElement;
            if (seccionBajas) {
                const tablasBaja = seccionBajas.querySelectorAll('.data-table');
                tablasBaja.forEach(tabla => {
                    const filas = tabla.querySelectorAll('tbody tr');
                    let filasVisiblesEnTabla = 0;
                    
                    filas.forEach(row => {
                        const textoCompleto = row.textContent.toLowerCase();
                        if (textoCompleto.includes(busquedaLower)) {
                            row.style.display = '';
                            filasVisiblesEnTabla++;
                            totalVisible++;
                        } else {
                            row.style.display = 'none';
                        }
                    });
                    
                    // Ocultar tabla completa si no tiene filas visibles (la "concha vacía")
                    tabla.style.display = filasVisiblesEnTabla > 0 ? '' : 'none';
                });
            }
        }
        
        async function limpiarFiltrosDocumentacion() {
            console.log('🧹 Limpiando filtros de documentación...');
            
            // Limpiar todos los campos de filtro
            const filtroResidencia = document.getElementById('filtroResidenciaDocumentacion');
            const filtroTipoEntidad = document.getElementById('filtroTipoEntidad');
            const filtroCategoria = document.getElementById('filtroCategoria');
            const filtroBusqueda = document.getElementById('filtroBusquedaDocumentacion');
            
            if (filtroResidencia) filtroResidencia.value = '';
            if (filtroTipoEntidad) filtroTipoEntidad.value = '';
            if (filtroCategoria) filtroCategoria.value = '';
            if (filtroBusqueda) filtroBusqueda.value = '';
            
            // Recargar documentos desde el servidor (sin filtros = todos los documentos)
            console.log('✅ Recargando todos los documentos desde el servidor...');
            await aplicarFiltrosDocumentacion();
        }
        
        async function actualizarEntidadesDocumento() {
            const tipoEntidad = document.getElementById('doc_tipo_entidad').value;
            const selectEntidad = document.getElementById('doc_id_entidad');
            const token = localStorage.getItem('violetas_token');
            
            selectEntidad.innerHTML = '<option value="">Cargando...</option>';
            
            if (!tipoEntidad) {
                selectEntidad.innerHTML = '<option value="">Seleccione primero el tipo de entidad</option>';
                return;
            }
            
            try {
                let url = '';
                if (tipoEntidad === 'residente') {
                    url = `${API_URL}/api/v1/residentes`;
                } else if (tipoEntidad === 'proveedor') {
                    url = `${API_URL}/api/v1/proveedores`;
                } else if (tipoEntidad === 'personal') {
                    url = `${API_URL}/api/v1/personal`;
                }
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    selectEntidad.innerHTML = '<option value="">Seleccione una entidad</option>';
                    
                    if (tipoEntidad === 'residente' && data.residentes) {
                        data.residentes.filter(r => r.activo).forEach(res => {
                            selectEntidad.innerHTML += `<option value="${res.id_residente}">${res.nombre} ${res.apellido}</option>`;
                        });
                    } else if (tipoEntidad === 'proveedor' && data.proveedores) {
                        data.proveedores.filter(p => p.activo).forEach(prov => {
                            selectEntidad.innerHTML += `<option value="${prov.id_proveedor}">${prov.nombre}</option>`;
                        });
                    } else if (tipoEntidad === 'personal' && data.personal) {
                        data.personal.filter(p => p.activo).forEach(per => {
                            selectEntidad.innerHTML += `<option value="${per.id_personal}">${per.nombre} ${per.apellido}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Error al cargar entidades:', error);
                selectEntidad.innerHTML = '<option value="">Error al cargar entidades</option>';
            }
        }
        
        function resetFormDocumento() {
            const form = document.getElementById('formSubirDocumento');
            if (form) {
                form.reset();
            }
            
            const selectEntidad = document.getElementById('doc_id_entidad');
            if (selectEntidad) {
                selectEntidad.innerHTML = '<option value="">Seleccione primero el tipo de entidad</option>';
            }
        }
        
        async function saveDocumento(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('violetas_token');
            const form = event.target;
            const saveBtn = document.getElementById('saveDocumentoBtn');
            const originalText = saveBtn.textContent;
            
            const formData = new FormData(form);
            
            // Validar campos requeridos
            const tipoEntidad = formData.get('tipo_entidad');
            const idEntidad = formData.get('id_entidad');
            const categoriaDocumento = formData.get('categoria_documento');
            const tipoDocumento = formData.get('tipo_documento');
            const archivoInput = document.getElementById('doc_archivo');
            
            // Validar cada campo individualmente para mostrar mensajes más específicos
            if (!tipoEntidad || tipoEntidad === '') {
                showDocumentoModalError('Debe seleccionar un tipo de entidad');
                return;
            }
            if (!idEntidad || idEntidad === '' || idEntidad === '0') {
                showDocumentoModalError('Debe seleccionar una entidad');
                return;
            }
            if (!categoriaDocumento || categoriaDocumento === '') {
                showDocumentoModalError('Debe seleccionar una categoría de documento');
                return;
            }
            if (!tipoDocumento || tipoDocumento.trim() === '') {
                showDocumentoModalError('Debe ingresar el tipo de documento');
                return;
            }
            if (!archivoInput || !archivoInput.files || !archivoInput.files[0]) {
                showDocumentoModalError('Debe seleccionar un archivo');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Subiendo...';
            hideDocumentoModalAlert();
            
            try {
                const response = await fetch(`${API_URL}/api/v1/documentacion`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                let result;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        throw new Error(`Error del servidor (${response.status}): ${text.substring(0, 100)}`);
                    }
                } catch (parseError) {
                    showDocumentoModalError(`Error del servidor (${response.status}). Por favor, intenta de nuevo.`);
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }
                
                if (response.ok) {
                    showDocumentoModalSuccess('Documento subido exitosamente');
                    // Restablecer el botón antes de cerrar el modal
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    setTimeout(() => {
                        closeModal('modalSubirDocumento');
                        loadDocumentacion();
                    }, 1500);
                } else {
                    showDocumentoModalError(result.error || 'Error al subir el documento');
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error al subir documento:', error);
                showDocumentoModalError('Error de conexión: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }
        
        async function verDocumento(idDocumento, tipoEntidad = null) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                const endpoint = `${API_URL}/api/v1/documentacion/${idDocumento}/descargar`;
                
                const response = await fetch(endpoint, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.url_descarga) {
                        window.open(data.url_descarga, '_blank');
                    } else {
                        alert('No se pudo generar la URL para ver el documento');
                    }
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Error al ver el documento'));
                }
            } catch (error) {
                console.error('Error al ver documento:', error);
                alert('Error de conexión: ' + error.message);
            }
        }
        
        async function descargarDocumento(idDocumento, tipoEntidad = null) {
            const token = localStorage.getItem('violetas_token');
            
            try {
                // Si es una factura de pago_proveedor, usar el endpoint de documentación
                const endpoint = tipoEntidad === 'pago_proveedor' 
                    ? `${API_URL}/api/v1/documentacion/${idDocumento}/descargar`
                    : `${API_URL}/api/v1/documentacion/${idDocumento}/descargar`;
                
                const response = await fetch(endpoint, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.url_descarga) {
                        // Crear un enlace temporal para descargar
                        const link = document.createElement('a');
                        link.href = data.url_descarga;
                        link.download = data.nombre_archivo || 'documento.pdf';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        alert('No se pudo generar la URL de descarga');
                    }
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Error al descargar el documento'));
                }
            } catch (error) {
                console.error('Error al descargar documento:', error);
                alert('Error de conexión: ' + error.message);
            }
        }
        
        async function eliminarDocumentoUnificado(idDocumento) {
            if (!confirm('¿Está seguro de que desea eliminar este documento?')) {
                return;
            }
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/documentacion/${idDocumento}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Documento eliminado exitosamente');
                    loadDocumentacion();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Error al eliminar el documento'));
                }
            } catch (error) {
                console.error('Error al eliminar documento:', error);
                alert('Error de conexión: ' + error.message);
            }
        }
        
        function showDocumentoModalError(message) {
            const alert = document.getElementById('documentoAlert');
            if (alert) {
                alert.className = 'alert error';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function showDocumentoModalSuccess(message) {
            const alert = document.getElementById('documentoAlert');
            if (alert) {
                alert.className = 'alert success';
                alert.textContent = message;
                alert.style.display = 'block';
            }
        }
        
        function hideDocumentoModalAlert() {
            const alert = document.getElementById('documentoAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        // ========================================================================
        // FUNCIONES DEL MÓDULO DE HISTÓRICOS
        // ========================================================================
        
        async function loadHistoricos(tipoParam = null, fechaDesdeParam = null, fechaHastaParam = null, estadoParam = null, residenciaParam = null) {
            const content = document.getElementById('moduleContent');
            const token = localStorage.getItem('violetas_token');
            
            content.innerHTML = `
                <div class="module-content">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 15px; color: #666;">Cargando históricos...</p>
                    </div>
                </div>
            `;
            
            try {
                // Usar parámetros pasados o leer de URL (para carga inicial)
                let tipoFiltro, fechaDesdeFiltro, fechaHastaFiltro, estadoFiltro, residenciaFiltro;
                
                if (tipoParam !== null) {
                    // Parámetros pasados desde aplicarFiltrosHistoricos() - PRIORITARIOS
                    tipoFiltro = tipoParam;
                    fechaDesdeFiltro = fechaDesdeParam || '';
                    fechaHastaFiltro = fechaHastaParam || '';
                    estadoFiltro = estadoParam || '';
                    residenciaFiltro = residenciaParam || '';
                } else {
                    // Leer de URL (solo primera carga)
                    const urlParams = new URLSearchParams(window.location.search);
                    tipoFiltro = urlParams.get('tipo') || 'todos';
                    fechaDesdeFiltro = urlParams.get('fecha_desde') || '';
                    fechaHastaFiltro = urlParams.get('fecha_hasta') || '';
                    estadoFiltro = urlParams.get('estado') || '';
                    residenciaFiltro = urlParams.get('id_residencia') || '';
                }
                
                // Construir URL con filtros
                console.log('📥 Cargando históricos desde servidor con filtros...');
                let url = `${API_URL}/api/v1/historicos`;
                const params = new URLSearchParams();
                params.append('tipo', tipoFiltro);
                if (fechaDesdeFiltro) params.append('fecha_desde', fechaDesdeFiltro);
                if (fechaHastaFiltro) params.append('fecha_hasta', fechaHastaFiltro);
                if (estadoFiltro) params.append('estado', estadoFiltro);
                if (residenciaFiltro) params.append('id_residencia', residenciaFiltro);
                params.append('limit', '500');  // Límite de 500 registros
                url += '?' + params.toString();
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Cargar residencias para el filtro
                    let residenciasOptions = '<option value="">Todas las residencias</option>';
                    try {
                        const residenciasResponse = await fetch(`${API_URL}/api/v1/residencias`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (residenciasResponse.ok) {
                            const residenciasData = await residenciasResponse.json();
                            if (residenciasData.residencias) {
                                residenciasData.residencias.forEach(res => {
                                    residenciasOptions += `<option value="${res.id_residencia}">${res.nombre}</option>`;
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Error al cargar residencias:', error);
                    }
                    
                    let html = `
                        <div class="module-content">
                            <h2 style="color: #667eea; margin-bottom: 30px; display: flex; align-items: center; gap: 10px;">
                                <img src="/static/icons/medical/calendar-medical.svg" alt="Históricos" style="width: 32px; height: 32px;"> Históricos de Cobros y Pagos
                            </h2>
                            
                            <div style="background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                                <h3 style="color: #667eea; margin-bottom: 15px;">Filtros</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Residencia</label>
                                        <select id="filtroResidenciaHistorico" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                            ${residenciasOptions}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Tipo</label>
                                        <select id="filtroTipoHistorico" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                            <option value="todos">Todos</option>
                                            <option value="cobros">Solo Cobros</option>
                                            <option value="pagos">Solo Pagos</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Fecha Desde</label>
                                        <input type="date" id="filtroFechaDesde" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Fecha Hasta</label>
                                        <input type="date" id="filtroFechaHasta" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Estado</label>
                                        <select id="filtroEstadoHistorico" style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                            <option value="">Todos</option>
                                            <option value="pendiente">Pendiente</option>
                                            <option value="cobrado">Cobrado</option>
                                            <option value="pagado">Pagado</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button onclick="aplicarFiltrosHistoricos()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <img src="/static/icons/medical/check-circle.svg" alt="Aplicar" style="width: 18px; height: 18px; filter: brightness(0) invert(1);"> Aplicar Filtros
                                    </button>
                                    <button onclick="limpiarFiltrosHistoricos()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                        <img src="/static/icons/medical/settings.svg" alt="Limpiar" style="width: 18px; height: 18px; filter: brightness(0) invert(1);"> Limpiar Filtros
                                    </button>
                                    <button onclick="exportarHistoricos('pdf')" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                        <img src="/static/icons/medical/file-medical.svg" alt="PDF" style="width: 18px; height: 18px; filter: brightness(0) invert(1);"> Exportar PDF
                                    </button>
                                    <button onclick="exportarHistoricos('excel')" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                        <img src="/static/icons/medical/file-medical.svg" alt="Excel" style="width: 18px; height: 18px; filter: brightness(0) invert(1);"> Exportar Excel
                                    </button>
                                </div>
                            </div>
                            
                    `;
                    
                    // Aplicar valores de filtros DESPUÉS de insertar el HTML
                    setTimeout(() => {
                        const filtroResidencia = document.getElementById('filtroResidenciaHistorico');
                        const filtroTipo = document.getElementById('filtroTipoHistorico');
                        const filtroFechaDesde = document.getElementById('filtroFechaDesde');
                        const filtroFechaHasta = document.getElementById('filtroFechaHasta');
                        const filtroEstado = document.getElementById('filtroEstadoHistorico');
                        
                        if (filtroResidencia && residenciaFiltro) filtroResidencia.value = residenciaFiltro;
                        if (filtroTipo) filtroTipo.value = tipoFiltro;
                        if (filtroFechaDesde && fechaDesdeFiltro) filtroFechaDesde.value = fechaDesdeFiltro;
                        if (filtroFechaHasta && fechaHastaFiltro) filtroFechaHasta.value = fechaHastaFiltro;
                        if (filtroEstado && estadoFiltro) filtroEstado.value = estadoFiltro;
                    }, 100);
                    
                    // Mensaje informativo de cantidad
                    const totalRegistros = (data.total_cobros || 0) + (data.total_pagos || 0);
                    const mostradosRegistros = (data.mostrados_cobros || data.cobros.length) + (data.mostrados_pagos || data.pagos.length);
                    
                    if (totalRegistros > mostradosRegistros) {
                        html += `
                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                                <p style="margin: 0; color: #856404; font-weight: 500;">
                                    ℹ️ Mostrando los <strong>${mostradosRegistros}</strong> registros más recientes de un total de <strong>${totalRegistros}</strong>. 
                                    Use filtros de fecha o residencia para encontrar registros específicos.
                                </p>
                            </div>
                        `;
                    } else if (totalRegistros > 0) {
                        html += `
                            <div style="background: #d1ecf1; border-left: 4px solid #0c5460; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                                <p style="margin: 0; color: #0c5460; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                                    Mostrando <strong>${mostradosRegistros}</strong> registro${mostradosRegistros !== 1 ? 's' : ''}
                                </p>
                            </div>
                        `;
                    }
                    
                    // Mostrar cobros
                    if (data.cobros && data.cobros.length > 0) {
                        html += `
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; padding: 10px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #667eea;">
                                    Cobros a Residentes (${data.cobros.length})
                                </h3>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Residente</th>
                                            <th>Monto</th>
                                            <th>Fecha Pago</th>
                                            <th>Fecha Prevista</th>
                                            <th>Estado</th>
                                            <th>Concepto</th>
                                            <th>Método Pago</th>
                                            <th>Residencia</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        data.cobros.forEach(cobro => {
                            const fechaPago = cobro.fecha_pago ? fechaISOToEspanol(cobro.fecha_pago.split('T')[0]) : '-';
                            const fechaPrevista = cobro.fecha_prevista ? fechaISOToEspanol(cobro.fecha_prevista.split('T')[0]) : '-';
                            const estadoColor = cobro.estado === 'cobrado' ? '#4caf50' : cobro.estado === 'pendiente' ? '#ff9800' : '#757575';
                            const fechaPagoOriginal = cobro.fecha_pago ? cobro.fecha_pago.split('T')[0] : '';
                            
                            html += `
                                <tr data-tipo="cobro" data-estado="${cobro.estado || ''}" data-residencia="${cobro.id_residencia || ''}" data-fecha="${fechaPagoOriginal}">
                                    <td>${cobro.residente || '-'}</td>
                                    <td style="font-weight: bold; color: #2e7d32;">${formatearNumeroEspanol(cobro.monto)} €</td>
                                    <td>${fechaPago}</td>
                                    <td>${fechaPrevista}</td>
                                    <td><span style="padding: 4px 8px; background: ${estadoColor}; color: white; border-radius: 4px; font-size: 12px;">${cobro.estado || '-'}</span></td>
                                    <td>${cobro.concepto || '-'}</td>
                                    <td>${cobro.metodo_pago || '-'}</td>
                                    <td>${cobro.nombre_residencia || '-'}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    // Mostrar pagos
                    if (data.pagos && data.pagos.length > 0) {
                        html += `
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #667eea; margin-bottom: 15px; padding: 10px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #667eea;">
                                    Pagos a Proveedores (${data.pagos.length})
                                </h3>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Proveedor</th>
                                            <th>TOTAL</th>
                                            <th>Fecha Pago</th>
                                            <th>Fecha Prevista</th>
                                            <th>Estado</th>
                                            <th>Concepto</th>
                                            <th>Nº Factura</th>
                                            <th>Residencia</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        data.pagos.forEach(pago => {
                            const fechaPago = pago.fecha_pago ? fechaISOToEspanol(pago.fecha_pago.split('T')[0]) : '-';
                            const fechaPrevista = pago.fecha_prevista ? fechaISOToEspanol(pago.fecha_prevista.split('T')[0]) : '-';
                            const estadoColor = pago.estado === 'pagado' ? '#4caf50' : pago.estado === 'pendiente' ? '#ff9800' : '#757575';
                            const fechaPagoOriginal = pago.fecha_pago ? pago.fecha_pago.split('T')[0] : '';
                            
                            html += `
                                <tr data-tipo="pago" data-estado="${pago.estado || ''}" data-residencia="${pago.id_residencia || ''}" data-fecha="${fechaPagoOriginal}">
                                    <td>${pago.proveedor || '-'}</td>
                                    <td style="font-weight: bold; color: #e65100;">${formatearNumeroEspanol(pago.monto)} €</td>
                                    <td>${fechaPago}</td>
                                    <td>${fechaPrevista}</td>
                                    <td><span style="padding: 4px 8px; background: ${estadoColor}; color: white; border-radius: 4px; font-size: 12px;">${pago.estado || '-'}</span></td>
                                    <td>${pago.concepto || '-'}</td>
                                    <td>${pago.numero_factura || '-'}</td>
                                    <td>${pago.nombre_residencia || '-'}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    if ((!data.cobros || data.cobros.length === 0) && (!data.pagos || data.pagos.length === 0)) {
                        html += '<p style="color: #666; text-align: center; padding: 40px;">No hay registros históricos para los filtros seleccionados.</p>';
                    } else {
                        // Resumen visual al final con formato elegante
                        html += `
                            <div style="margin-top: 40px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                                <h3 style="color: white; margin-bottom: 15px; font-size: 18px;">
                                    <img src="/static/icons/medical/activity.svg" alt="Resumen" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; filter: brightness(0) invert(1);"> 
                                    Resumen Total de Históricos
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${data.total_cobros || 0}</div>
                                        <div style="font-size: 13px; opacity: 0.9;">Cobros Registrados</div>
                                        <div style="font-size: 20px; font-weight: 600; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">${formatearNumeroEspanol(data.total_cobros_monto || 0)} €</div>
                                    </div>
                                    <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${data.total_pagos || 0}</div>
                                        <div style="font-size: 13px; opacity: 0.9;">Pagos a Proveedores</div>
                                        <div style="font-size: 20px; font-weight: 600; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">${formatearNumeroEspanol(data.total_pagos_monto || 0)} €</div>
                                    </div>
                                    <div style="background: rgba(255, 255, 255, 0.25); padding: 15px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.4);">
                                        <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${(data.total_cobros || 0) + (data.total_pagos || 0)}</div>
                                        <div style="font-size: 13px; opacity: 0.9;">Total de Registros</div>
                                        <div style="font-size: 20px; font-weight: 600; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">${formatearNumeroEspanol((data.total_cobros_monto || 0) + (data.total_pagos_monto || 0))} €</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    content.innerHTML = html;
                } else {
                    const error = await response.json();
                    content.innerHTML = `<div class="module-content"><p style="color: red;">Error: ${error.error || 'Error desconocido'}</p></div>`;
                }
            } catch (error) {
                console.error('Error al cargar históricos:', error);
                content.innerHTML = `<div class="module-content"><p style="color: red;">Error de conexión: ${error.message}</p></div>`;
            }
        }
        
        async function limpiarFiltrosHistoricos() {
            console.log('🧹 Limpiando filtros de históricos...');
            
            // Limpiar todos los campos de filtro
            const filtroResidencia = document.getElementById('filtroResidenciaHistorico');
            const filtroTipo = document.getElementById('filtroTipoHistorico');
            const filtroFechaDesde = document.getElementById('filtroFechaDesde');
            const filtroFechaHasta = document.getElementById('filtroFechaHasta');
            const filtroEstado = document.getElementById('filtroEstadoHistorico');
            
            if (filtroResidencia) filtroResidencia.value = '';
            if (filtroTipo) filtroTipo.value = 'todos';
            if (filtroFechaDesde) filtroFechaDesde.value = '';
            if (filtroFechaHasta) filtroFechaHasta.value = '';
            if (filtroEstado) filtroEstado.value = '';
            
            // Recargar todos los históricos desde el servidor
            console.log('✅ Recargando históricos desde el servidor...');
            await aplicarFiltrosHistoricos();
        }
        
        async function aplicarFiltrosHistoricos() {
            // Leer valores ANTES de cualquier recarga
            const residencia = document.getElementById('filtroResidenciaHistorico')?.value || '';
            const tipo = document.getElementById('filtroTipoHistorico')?.value || 'todos';
            const fechaDesde = document.getElementById('filtroFechaDesde')?.value || '';
            const fechaHasta = document.getElementById('filtroFechaHasta')?.value || '';
            const estado = document.getElementById('filtroEstadoHistorico')?.value || '';
            
            console.log('🔍 Aplicando filtros de históricos:', { residencia, tipo, fechaDesde, fechaHasta, estado });
            
            // Recargar con los filtros preservados
            await loadHistoricos(tipo, fechaDesde, fechaHasta, estado, residencia);
        }
        
        async function exportarHistoricos(formato) {
            const residencia = document.getElementById('filtroResidenciaHistorico').value;
            const tipo = document.getElementById('filtroTipoHistorico').value;
            const fechaDesde = document.getElementById('filtroFechaDesde').value;
            const fechaHasta = document.getElementById('filtroFechaHasta').value;
            const estado = document.getElementById('filtroEstadoHistorico').value;
            
            let url = `${API_URL}/api/v1/historicos?exportar=${formato}`;
            const params = new URLSearchParams();
            params.append('tipo', tipo);
            if (residencia) params.append('id_residencia', residencia);
            if (fechaDesde) params.append('fecha_desde', fechaDesde);
            if (fechaHasta) params.append('fecha_hasta', fechaHasta);
            if (estado) params.append('estado', estado);
            url += '&' + params.toString();
            
            const token = localStorage.getItem('violetas_token');
            
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = `historicos_${new Date().toISOString().split('T')[0]}.${formato === 'pdf' ? 'pdf' : 'xlsx'}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(downloadUrl);
                } else {
                    const error = await response.json();
                    alert('Error al exportar: ' + (error.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('Error de conexión: ' + error.message);
            }
        }

    </script>
    
</body>
</html>

